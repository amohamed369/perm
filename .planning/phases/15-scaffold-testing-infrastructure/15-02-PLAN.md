---
phase: 15-scaffold-testing-infrastructure
plan: 02
type: execute
---

<objective>
Configure testing infrastructure with Vitest + convex-test for unit tests and Playwright for E2E.

Purpose: Enable TDD from day one with proper testing patterns for Convex functions.
Output: Working test suites with verified "hello world" tests for both unit and E2E testing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-scaffold-testing-infrastructure/15-CONTEXT.md
@.planning/phases/15-scaffold-testing-infrastructure/15-RESEARCH.md
@.planning/phases/15-scaffold-testing-infrastructure/15-01-SUMMARY.md

**Prior decisions affecting this phase:**
- TDD throughout (tests before code, especially validation)
- 377 test behaviors from v1 will need to be replicated
- Testing infrastructure is just as important as app structure

**Research findings to apply:**
- Vitest 3.x with convex-test 0.0.21+ for Convex function testing
- Edge runtime required for convex-test (use @edge-runtime/vm)
- Use environmentMatchGlobs to set edge-runtime for convex/** tests
- Playwright 1.51+ with webServer config for E2E
- Tests co-located in convex/*.test.ts for unit tests
- E2E tests in tests/e2e/ directory

**Critical pitfall to avoid:**
- convex-test REQUIRES edge-runtime environment, not node or jsdom
- Without it, tests fail with "ReferenceError: Request is not defined"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Vitest with convex-test</name>
  <files>v2/vitest.config.ts, v2/package.json, v2/convex/testData.test.ts</files>
  <action>
    1. Install testing dependencies in v2/:
       ```bash
       cd v2
       pnpm add -D vitest @vitejs/plugin-react convex-test @edge-runtime/vm @testing-library/react jsdom
       ```

    2. Create v2/vitest.config.ts:
       ```typescript
       import { defineConfig } from "vitest/config";
       import react from "@vitejs/plugin-react";

       export default defineConfig({
         plugins: [react()],
         test: {
           // Edge runtime for Convex function tests (CRITICAL - convex-test requires this)
           environmentMatchGlobs: [
             ["convex/**/*.test.ts", "edge-runtime"],
             ["src/**/*.test.{ts,tsx}", "jsdom"],
           ],
           // Required for convex-test to work correctly
           server: {
             deps: {
               inline: ["convex-test"],
             },
           },
           globals: true,
           include: ["**/*.test.{ts,tsx}"],
         },
       });
       ```

    3. Add test scripts to v2/package.json:
       ```json
       {
         "scripts": {
           "test": "vitest",
           "test:run": "vitest run",
           "test:coverage": "vitest run --coverage"
         }
       }
       ```

    4. Create first Convex unit test at v2/convex/testData.test.ts:
       ```typescript
       import { convexTest } from "convex-test";
       import { describe, it, expect, beforeEach } from "vitest";
       import { api } from "./_generated/api";
       import schema from "./schema";

       // Load all Convex modules for testing
       const modules = import.meta.glob("./**/*.ts");

       describe("testData", () => {
         it("lists items (empty initially)", async () => {
           const t = convexTest(schema, modules);

           const items = await t.query(api.testData.list);
           expect(items).toEqual([]);
         });

         it("creates and lists items", async () => {
           const t = convexTest(schema, modules);

           // Create an item
           await t.mutation(api.testData.create, { text: "Hello World" });

           // Verify it's in the list
           const items = await t.query(api.testData.list);
           expect(items).toHaveLength(1);
           expect(items[0].text).toBe("Hello World");
         });

         it("creates multiple items with timestamps", async () => {
           const t = convexTest(schema, modules);

           await t.mutation(api.testData.create, { text: "First" });
           await t.mutation(api.testData.create, { text: "Second" });

           const items = await t.query(api.testData.list);
           expect(items).toHaveLength(2);

           // Verify timestamps exist and are numbers
           expect(typeof items[0].createdAt).toBe("number");
           expect(items[0].createdAt).toBeGreaterThan(0);
         });
       });
       ```

    5. Run tests to verify:
       ```bash
       cd v2 && pnpm test:run
       ```

    NOTE: If tests fail with "Request is not defined", the edge-runtime environment is not configured correctly.
  </action>
  <verify>
    cd v2 && pnpm test:run
    # Should show 3 passing tests for testData
  </verify>
  <done>
    - v2/vitest.config.ts exists with edge-runtime for convex tests
    - v2/convex/testData.test.ts has 3 passing tests
    - pnpm test:run executes without errors
    - Edge runtime correctly configured (no "Request is not defined" errors)
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure Playwright for E2E testing</name>
  <files>v2/playwright.config.ts, v2/tests/e2e/connection.spec.ts</files>
  <action>
    1. Install Playwright in v2/:
       ```bash
       cd v2
       pnpm add -D @playwright/test
       npx playwright install chromium
       ```

    2. Create v2/playwright.config.ts:
       ```typescript
       import { defineConfig, devices } from "@playwright/test";

       export default defineConfig({
         testDir: "./tests",
         fullyParallel: true,
         forbidOnly: !!process.env.CI,
         retries: process.env.CI ? 2 : 0,
         workers: process.env.CI ? 1 : undefined,
         reporter: "html",

         use: {
           baseURL: "http://localhost:3000",
           trace: "on-first-retry",
         },

         projects: [
           {
             name: "chromium",
             use: { ...devices["Desktop Chrome"] },
           },
         ],

         // Start dev servers before running E2E tests
         webServer: [
           {
             command: "npx convex dev",
             url: "http://127.0.0.1:3210",  // Convex local admin port
             reuseExistingServer: !process.env.CI,
             timeout: 120_000,
           },
           {
             command: "pnpm dev",
             url: "http://localhost:3000",
             reuseExistingServer: !process.env.CI,
             timeout: 120_000,
           },
         ],
       });
       ```

    3. Create E2E test directory and first test:
       ```bash
       mkdir -p v2/tests/e2e
       ```

    4. Create v2/tests/e2e/connection.spec.ts:
       ```typescript
       import { test, expect } from "@playwright/test";

       test.describe("Convex Connection", () => {
         test("homepage loads and shows connection test", async ({ page }) => {
           await page.goto("/");

           // Verify page loads
           await expect(page.getByRole("heading", { name: "v2 Connection Test" })).toBeVisible();

           // Verify Convex data loads (connection works)
           await expect(page.getByText("Convex connection verified")).toBeVisible({
             timeout: 10000, // Give Convex time to connect
           });
         });

         test("can add items via UI", async ({ page }) => {
           await page.goto("/");

           // Wait for connection
           await expect(page.getByText("Convex connection verified")).toBeVisible({
             timeout: 10000,
           });

           // Add a test item
           const testText = `E2E Test ${Date.now()}`;
           await page.getByPlaceholder("Enter test text").fill(testText);
           await page.getByRole("button", { name: "Add Item" }).click();

           // Verify it appears in real-time
           await expect(page.getByText(testText)).toBeVisible();
         });
       });
       ```

    5. Add Playwright scripts to v2/package.json:
       ```json
       {
         "scripts": {
           "test:e2e": "playwright test",
           "test:e2e:ui": "playwright test --ui",
           "test:e2e:debug": "playwright test --debug"
         }
       }
       ```

    NOTE: E2E tests require both Convex and Next.js dev servers running.
    The playwright.config.ts webServer config handles this automatically.
  </action>
  <verify>
    cd v2 && pnpm test:e2e
    # Should show 2 passing E2E tests
    # (May take longer first time as it starts dev servers)
  </verify>
  <done>
    - v2/playwright.config.ts exists with webServer config
    - v2/tests/e2e/connection.spec.ts has 2 passing E2E tests
    - pnpm test:e2e executes and handles server startup
    - Tests verify both page load and Convex real-time updates
  </done>
</task>

<task type="auto">
  <name>Task 3: Create test utilities and verify full test suite</name>
  <files>v2/convex/lib/testUtils.ts, v2/src/lib/testUtils.tsx, v2/package.json</files>
  <action>
    1. Create Convex test utilities at v2/convex/lib/testUtils.ts:
       ```typescript
       /**
        * Test utilities for Convex function testing.
        * These patterns will be used throughout v2 development.
        */

       import { convexTest, ConvexTestingHelper } from "convex-test";
       import schema from "../schema";

       // Load all Convex modules for testing
       const modules = import.meta.glob("../**/*.ts");

       /**
        * Create a new test context with clean database state.
        * Each test should call this to get isolated test data.
        */
       export function createTestContext() {
         return convexTest(schema, modules);
       }

       /**
        * Create a test context with a mock authenticated user.
        * Use for testing user-specific queries/mutations.
        */
       export function createAuthenticatedContext(userId: string, name?: string) {
         const t = createTestContext();
         return t.withIdentity({
           subject: userId,
           name: name ?? `Test User ${userId}`,
         });
       }

       /**
        * Example of test data factory (will expand in Phase 16+).
        * Creates consistent test fixtures.
        */
       export const fixtures = {
         testItem: (overrides?: Partial<{ text: string }>) => ({
           text: overrides?.text ?? "Test Item",
         }),
       };
       ```

    2. Create React test utilities at v2/src/lib/testUtils.tsx:
       ```tsx
       /**
        * Test utilities for React component testing.
        * Provides proper providers and helpers for testing Convex-connected components.
        */

       import { ReactNode } from "react";
       import { ConvexProvider, ConvexReactClient } from "convex/react";
       import { render, RenderOptions } from "@testing-library/react";

       // Mock Convex client for component testing
       // Note: For full integration tests, use Playwright E2E instead
       const mockConvexClient = {
         // Minimal mock - expand as needed
       };

       /**
        * Custom render that wraps components with necessary providers.
        * Use this instead of @testing-library/react's render.
        */
       export function renderWithProviders(
         ui: ReactNode,
         options?: Omit<RenderOptions, "wrapper">
       ) {
         function Wrapper({ children }: { children: ReactNode }) {
           // Note: For real Convex testing, E2E with Playwright is preferred
           // This is a placeholder for potential component-level mocking
           return <>{children}</>;
         }

         return render(ui, { wrapper: Wrapper, ...options });
       }

       // Re-export testing-library utilities for convenience
       export * from "@testing-library/react";
       ```

    3. Create a test script that runs all tests:
       Update v2/package.json scripts:
       ```json
       {
         "scripts": {
           "test": "vitest",
           "test:run": "vitest run",
           "test:coverage": "vitest run --coverage",
           "test:e2e": "playwright test",
           "test:e2e:ui": "playwright test --ui",
           "test:e2e:debug": "playwright test --debug",
           "test:all": "vitest run && playwright test"
         }
       }
       ```

    4. Run full test suite to verify:
       ```bash
       cd v2 && pnpm test:run && pnpm test:e2e
       ```

    5. Update README or create v2/TEST_README.md with testing instructions:
       ```markdown
       # v2 Testing Guide

       ## Unit Tests (Vitest + convex-test)

       ```bash
       pnpm test          # Watch mode
       pnpm test:run      # Single run
       pnpm test:coverage # With coverage
       ```

       ## E2E Tests (Playwright)

       ```bash
       pnpm test:e2e       # Headless
       pnpm test:e2e:ui    # Interactive UI
       pnpm test:e2e:debug # Debug mode
       ```

       ## All Tests

       ```bash
       pnpm test:all
       ```

       ## Writing Tests

       - Convex function tests: `convex/*.test.ts` (uses edge-runtime)
       - React component tests: `src/**/*.test.tsx` (uses jsdom)
       - E2E tests: `tests/e2e/*.spec.ts` (uses Playwright)

       See `convex/lib/testUtils.ts` and `src/lib/testUtils.tsx` for helpers.
       ```
  </action>
  <verify>
    cd v2 && pnpm test:all
    # Should run both Vitest and Playwright tests
    # Expected: 3 unit tests + 2 E2E tests = 5 total passing
  </verify>
  <done>
    - v2/convex/lib/testUtils.ts provides Convex testing helpers
    - v2/src/lib/testUtils.tsx provides React testing helpers
    - pnpm test:all runs complete test suite
    - TEST_README.md documents testing approach
    - All 5 tests pass (3 unit + 2 E2E)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pnpm test:run passes all Vitest unit tests (3 tests)
- [ ] pnpm test:e2e passes all Playwright E2E tests (2 tests)
- [ ] pnpm test:all runs both suites successfully
- [ ] Edge runtime correctly configured (no Request is not defined errors)
- [ ] Test utilities created and documented
- [ ] Testing approach documented in TEST_README.md
</verification>

<success_criteria>

- Vitest + convex-test working for Convex function unit tests
- Playwright working for E2E browser tests
- All tests passing (5 total: 3 unit + 2 E2E)
- Test utilities ready for TDD in future phases
- Testing approach documented
</success_criteria>

<output>
After completion, create `.planning/phases/15-scaffold-testing-infrastructure/15-02-SUMMARY.md`:

# Phase 15 Plan 02: Testing Infrastructure Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `v2/...` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Phase 15 complete, ready for Phase 16 (Deadline & Validation Core)

- Scaffold verified with working Convex connection
- Testing infrastructure ready for TDD
- 5 baseline tests passing (3 unit + 2 E2E)
</output>
