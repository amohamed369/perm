---
phase: 15-scaffold-testing-infrastructure
plan: 01
type: execute
---

<objective>
Create the v2 application foundation with Next.js 15 and Convex.

Purpose: Establish the project scaffold that all v2 features will build upon.
Output: Working `v2/` directory with Next.js 15 + Convex connected and a verified database connection.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-scaffold-testing-infrastructure/15-CONTEXT.md
@.planning/phases/15-scaffold-testing-infrastructure/15-RESEARCH.md

**Prior decisions affecting this phase:**
- v2 should be at `v2/` folder, sibling to existing `backend/` and `frontend/`
- Use pnpm as package manager (2-3x faster than npm, 70% less disk usage)
- TypeScript strict mode required from day 1
- v1 folders stay untouched (they're the production system and reference)

**Research findings to apply:**
- Use Next.js 15 with App Router (not Pages Router)
- Convex 1.17.x+ for real-time backend
- ConvexProvider must be "use client" component
- Use environment variable NEXT_PUBLIC_CONVEX_URL for Convex connection
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js 15 project with pnpm</name>
  <files>v2/</files>
  <action>
    Create v2 directory and initialize Next.js 15 project:

    1. From project root, run: `pnpm create next-app@latest v2 --typescript --tailwind --app --src-dir --import-alias "@/*"`
       - When prompted for ESLint: Yes
       - When prompted for Turbopack: Yes (faster dev server)

    2. After creation, verify structure exists:
       - v2/src/app/layout.tsx
       - v2/src/app/page.tsx
       - v2/tailwind.config.ts
       - v2/tsconfig.json

    3. Enable TypeScript strict mode - edit v2/tsconfig.json:
       - Ensure `"strict": true` is set
       - Add `"noUncheckedIndexedAccess": true`
       - Add `"noImplicitOverride": true`

    NOTE: If create-next-app prompts fail or hang, run with `--yes` flag to accept defaults.
  </action>
  <verify>
    cd v2 && pnpm dev
    # Should start on http://localhost:3000 with Next.js welcome page
    # Kill with Ctrl+C after verifying
  </verify>
  <done>
    - v2/ directory exists with Next.js 15 App Router structure
    - TypeScript strict mode enabled in tsconfig.json
    - pnpm dev successfully starts the dev server
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Convex and configure connection</name>
  <files>v2/convex/, v2/src/app/providers.tsx, v2/src/app/layout.tsx, v2/.env.local</files>
  <action>
    1. Install Convex in v2 directory:
       ```bash
       cd v2
       pnpm add convex
       ```

    2. Initialize Convex project:
       ```bash
       npx convex dev
       ```
       - This will create a Convex project in the cloud
       - It will generate `convex/` directory with _generated files
       - It will create `.env.local` with CONVEX_DEPLOYMENT and NEXT_PUBLIC_CONVEX_URL
       - Keep the process running during development (or kill it for now)

    3. Create ConvexClientProvider component at v2/src/app/providers.tsx:
       ```typescript
       "use client";

       import { ConvexProvider, ConvexReactClient } from "convex/react";
       import { ReactNode } from "react";

       const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

       export function ConvexClientProvider({ children }: { children: ReactNode }) {
         return <ConvexProvider client={convex}>{children}</ConvexProvider>;
       }
       ```

    4. Update v2/src/app/layout.tsx to use the provider:
       - Import ConvexClientProvider from "./providers"
       - Wrap {children} with <ConvexClientProvider>

    IMPORTANT: The NEXT_PUBLIC_CONVEX_URL must be set before the app can connect.
    The `npx convex dev` command will create this in .env.local automatically.
  </action>
  <verify>
    # Check Convex files exist
    ls v2/convex/_generated/

    # Check .env.local has Convex URL
    grep "NEXT_PUBLIC_CONVEX_URL" v2/.env.local

    # Start dev server (should not error on provider import)
    cd v2 && pnpm dev
  </verify>
  <done>
    - v2/convex/ directory exists with _generated files
    - v2/.env.local contains NEXT_PUBLIC_CONVEX_URL
    - v2/src/app/providers.tsx exports ConvexClientProvider
    - v2/src/app/layout.tsx wraps children with ConvexClientProvider
    - pnpm dev starts without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Create test schema and verify database connection</name>
  <files>v2/convex/schema.ts, v2/convex/testData.ts, v2/src/app/page.tsx</files>
  <action>
    1. Create minimal test schema at v2/convex/schema.ts:
       ```typescript
       import { defineSchema, defineTable } from "convex/server";
       import { v } from "convex/values";

       export default defineSchema({
         // Minimal test table for connection verification
         // Will be replaced with full schema in Phase 19
         testItems: defineTable({
           text: v.string(),
           createdAt: v.number(),
         }),
       });
       ```

    2. Create test query/mutation at v2/convex/testData.ts:
       ```typescript
       import { query, mutation } from "./_generated/server";
       import { v } from "convex/values";

       export const list = query({
         handler: async (ctx) => {
           return await ctx.db.query("testItems").collect();
         },
       });

       export const create = mutation({
         args: { text: v.string() },
         handler: async (ctx, args) => {
           return await ctx.db.insert("testItems", {
             text: args.text,
             createdAt: Date.now(),
           });
         },
       });
       ```

    3. Update v2/src/app/page.tsx to verify connection:
       ```tsx
       "use client";

       import { useQuery, useMutation } from "convex/react";
       import { api } from "../../convex/_generated/api";
       import { useState } from "react";

       export default function Home() {
         const items = useQuery(api.testData.list);
         const createItem = useMutation(api.testData.create);
         const [text, setText] = useState("");

         const handleCreate = async () => {
           if (text.trim()) {
             await createItem({ text: text.trim() });
             setText("");
           }
         };

         return (
           <main className="min-h-screen p-8">
             <h1 className="text-2xl font-bold mb-4">v2 Connection Test</h1>

             <div className="mb-4">
               <input
                 type="text"
                 value={text}
                 onChange={(e) => setText(e.target.value)}
                 className="border p-2 mr-2"
                 placeholder="Enter test text"
               />
               <button
                 onClick={handleCreate}
                 className="bg-blue-500 text-white px-4 py-2 rounded"
               >
                 Add Item
               </button>
             </div>

             {items === undefined ? (
               <p>Loading...</p>
             ) : (
               <ul className="list-disc pl-5">
                 {items.map((item) => (
                   <li key={item._id}>{item.text}</li>
                 ))}
               </ul>
             )}

             <p className="mt-4 text-green-600 font-semibold">
               ✓ Convex connection verified ({items?.length ?? 0} items)
             </p>
           </main>
         );
       }
       ```

    4. Run `npx convex dev` in one terminal, `pnpm dev` in another

    5. Visit http://localhost:3000, add an item, verify it appears in real-time
  </action>
  <verify>
    # Run Convex dev server (in v2/)
    cd v2 && npx convex dev &

    # Run Next.js dev server
    pnpm dev &

    # Wait for servers to start
    sleep 5

    # Verify page loads (curl test)
    curl -s http://localhost:3000 | grep -q "v2 Connection Test" && echo "Page loads ✓"
  </verify>
  <done>
    - v2/convex/schema.ts exists with testItems table
    - v2/convex/testData.ts exports list query and create mutation
    - v2/src/app/page.tsx shows connection test UI
    - Adding items via UI shows real-time updates
    - Both dev servers run without errors
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] v2/ directory exists at project root, sibling to backend/ and frontend/
- [ ] `cd v2 && pnpm dev` starts Next.js dev server on port 3000
- [ ] `cd v2 && npx convex dev` connects to Convex cloud project
- [ ] TypeScript strict mode enabled (tsconfig.json has strict: true)
- [ ] ConvexProvider wraps the app (layout.tsx)
- [ ] Test page shows Convex connection works (can add/list items)
</verification>

<success_criteria>

- v2/ is a self-contained Next.js 15 + Convex project
- TypeScript strict mode active with no errors
- Convex connection verified with working real-time query/mutation
- Project structure follows App Router conventions
</success_criteria>

<output>
After completion, create `.planning/phases/15-scaffold-testing-infrastructure/15-01-SUMMARY.md`:

# Phase 15 Plan 01: Next.js + Convex Scaffold Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `v2/...` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 15-02-PLAN.md (Testing Infrastructure)
</output>
