---
phase: 22-case-forms
plan: 04
type: execute
domain: forms
---

<objective>
Build Add Case and Edit Case pages, integrating all form sections with Convex mutations, validation, and navigation.

Purpose: Create the full pages that users interact with to add and edit cases.
Output: /cases/new and /cases/:id/edit pages with full form integration, tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<cascading_requirements>
## CRITICAL: These Requirements Apply to ALL Work in This Plan

### Mandatory Documentation (Must Read Before Any Work)

| Document | Path | Purpose |
|----------|------|---------|
| **perm_flow.md** | `/perm_flow.md` | **SOURCE OF TRUTH** - Case statuses, progress statuses, date validation, deadline logic |
| **FRONTEND_DESIGN_SKILL.md** | `.planning/FRONTEND_DESIGN_SKILL.md` | Design guidance, neobrutalist aesthetic, status colors |
| **Design Inspiration 1-5** | `.planning/phases/17-design-system/design1-5` | Design examples, hard shadows, animations |
| **Phase Context** | `.planning/phases/22-case-forms/22-CONTEXT.md` | Phase requirements |
| **V2 Design System** | `v2/docs/DESIGN_SYSTEM.md` | Component library, utility classes |

### Code Quality Standards (Non-Negotiable)

- **Clean** - No clutter, no dead code
- **Organized** - Logical structure, proper separation of concerns
- **Minimal** - No over-engineering, no unnecessary abstraction
- **Abstractable** - Reusable patterns where appropriate
- **Scalable** - Handles growth without refactoring
- **Maintainable** - Easy to modify and extend
- **Readable** - Self-documenting, clear naming
- **Global fixes** - Fix at the source, never repeat patterns

### TDD Requirements

- Tests BEFORE implementation (red-green-refactor)
- Full coverage of validation logic
- Edge case coverage

### Subagent/Task Tool Requirements

**ALL Task tools and subagents MUST have these instructions explicitly in their prompts:**

```
CRITICAL REQUIREMENTS:
1. Read these docs FIRST: perm_flow.md, .planning/FRONTEND_DESIGN_SKILL.md,
   .planning/phases/17-design-system/design1-5, .planning/phases/22-case-forms/22-CONTEXT.md
2. perm_flow.md is SOURCE OF TRUTH for all case logic
3. V1 feature parity - all features must be preserved
4. Code quality: clean, organized, minimal, abstractable, scalable, maintainable, readable
5. Global fixes only - no repeated patterns
6. Full TDD - tests before implementation
7. UI: animations, transitions, microinteractions per design docs
8. Use Explore and Task subagents for research and complex work
```
</cascading_requirements>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-case-forms/22-CONTEXT.md
@.planning/FRONTEND_DESIGN_SKILL.md
@perm_flow.md

**Prior plan context:**
@.planning/phases/22-case-forms/22-01-SUMMARY.md
@.planning/phases/22-case-forms/22-02-SUMMARY.md
@.planning/phases/22-case-forms/22-03-SUMMARY.md

**Form sections from 22-02 and 22-03:**
@v2/src/components/forms/sections/BasicInfoSection.tsx
@v2/src/components/forms/sections/PWDSection.tsx
@v2/src/components/forms/sections/RecruitmentSection.tsx
@v2/src/components/forms/sections/ETA9089Section.tsx
@v2/src/components/forms/sections/I140Section.tsx
@v2/src/components/forms/sections/RFIRFESection.tsx

**Convex mutations:**
@v2/convex/cases.ts (create, update, get mutations)

**Existing page patterns:**
@v2/src/app/(authenticated)/cases/page.tsx
@v2/src/app/(authenticated)/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CaseForm container component</name>
  <files>
    v2/src/components/forms/CaseForm.tsx
    v2/src/components/forms/__tests__/CaseForm.test.tsx
    v2/src/components/forms/CaseForm.stories.tsx
  </files>
  <exploration>
    Use Explore agent to:
    - Study page layout patterns from dashboard/cases pages
    - Review all form sections created in 22-02/22-03
    - Check Convex mutation patterns (useMutation, useQuery)
    - Look at form submission patterns from ImportModal
  </exploration>
  <action>
    Create CaseForm container that orchestrates all sections:

    1. **Component structure:**
       ```tsx
       <CaseForm
         mode="add" | "edit"
         initialData={caseData | undefined}
         onSuccess={(caseId) => void}
         onCancel={() => void}
       />
       ```

    2. **State management:**
       - Single formData state object with all fields
       - useFormCalculations hook for auto-fill cascade
       - Validation state (errors per field)
       - Submission state (loading, success, error)

    3. **Section composition:**
       - Render all sections in order:
         1. BasicInfoSection
         2. PWDSection
         3. RecruitmentSection
         4. ETA9089Section
         5. I140Section
         6. RFIRFESection
         7. NotesSection (notes textarea, calendar sync toggle, favorite toggle)
       - Each section receives relevant formData fields and onChange handlers
       - Pass validation errors to each section

    4. **Form actions bar (sticky footer):**
       - Cancel button (secondary style)
       - Save button (primary, disabled if has errors)
       - Loading spinner when submitting
       - Error toast on failure
       - Success toast + redirect on success

    5. **Validation flow:**
       - On blur: Validate individual field
       - On submit: Validate entire form with Zod + perm-engine
       - Block submit if any errors
       - Scroll to first error on failed submit

    6. **Keyboard navigation:**
       - Tab through fields
       - Enter submits if no focused input
       - Escape triggers cancel (with confirmation if dirty)

    TDD: Write tests FIRST covering:
    - Renders all sections
    - Validation errors display
    - Submit button disabled when errors
    - Loading state during submission
    - Success callback fires on save
    - Cancel callback fires on cancel
  </action>
  <verify>npm run test -- v2/src/components/forms/__tests__/CaseForm.test.tsx</verify>
  <done>CaseForm orchestrates all sections, handles validation and submission</done>
</task>

<task type="auto">
  <name>Task 2: Create Add Case page with duplicate detection</name>
  <files>
    v2/src/app/(authenticated)/cases/new/page.tsx
    v2/src/app/(authenticated)/cases/new/__tests__/page.test.tsx
  </files>
  <exploration>
    Use Explore agent to:
    - Study existing page patterns in v2/src/app/(authenticated)/
    - Check Convex useMutation for cases.create
    - Review duplicate detection logic (employer + beneficiary match)
    - Look at navigation patterns (useRouter)
  </exploration>
  <action>
    Create Add Case page at /cases/new:

    1. **Page layout:**
       - Page title: "Add New Case"
       - Breadcrumb: Cases > Add New Case
       - CaseForm in mode="add"
       - Full width with max-width container

    2. **Duplicate detection (from 22-CONTEXT.md):**
       - Before save, check for existing case with same employer + beneficiary
       - Use Convex query to check
       - If duplicate found:
         - Show warning dialog
         - "A case already exists for [Employer] / [Beneficiary]"
         - Options: "Cancel", "Create Anyway"
       - If user confirms, proceed with create

    3. **Save flow:**
       - Call Convex cases.create mutation
       - On success: Show toast, redirect to /cases/:id (case detail)
       - On error: Show error toast, stay on page

    4. **Cancel flow:**
       - If form is dirty (any field changed):
         - Show confirmation dialog: "Discard unsaved changes?"
         - Options: "Keep Editing", "Discard"
       - If clean or confirmed, navigate back to /cases

    5. **Empty state defaults:**
       - caseStatus: "pwd"
       - progressStatus: "working"
       - calendarSyncEnabled: true
       - isFavorite: false
       - All dates: undefined

    TDD: Write tests FIRST covering:
    - Page renders with empty form
    - Duplicate detection triggers on save
    - Duplicate warning dialog shows
    - Can override duplicate warning
    - Successful save redirects
    - Cancel navigates back
    - Dirty form shows confirmation
  </action>
  <verify>npm run test -- v2/src/app/(authenticated)/cases/new/__tests__/page.test.tsx</verify>
  <done>Add Case page works with duplicate detection, proper navigation</done>
</task>

<task type="auto">
  <name>Task 3: Create Edit Case page with pre-population</name>
  <files>
    v2/src/app/(authenticated)/cases/[id]/edit/page.tsx
    v2/src/app/(authenticated)/cases/[id]/edit/__tests__/page.test.tsx
  </files>
  <exploration>
    Use Explore agent to:
    - Study dynamic route patterns in Next.js ([id] folder)
    - Check Convex useQuery for cases.get
    - Review loading state patterns (Skeleton components)
    - Look at error handling for not found cases
  </exploration>
  <action>
    Create Edit Case page at /cases/:id/edit:

    1. **Data fetching:**
       - Use Convex useQuery(cases.get, { id }) to fetch case
       - Show loading skeleton while fetching
       - If case not found: Show 404 message with link to cases list
       - Pre-populate CaseForm with fetched data

    2. **Page layout:**
       - Page title: "Edit Case: [Employer] - [Position]"
       - Breadcrumb: Cases > [Case Name] > Edit
       - CaseForm in mode="edit" with initialData
       - Full width with max-width container

    3. **Save flow:**
       - Call Convex cases.update mutation
       - Only send changed fields (diff against initial data)
       - On success: Show toast, redirect to /cases/:id (case detail)
       - On error: Show error toast, stay on page

    4. **Cancel flow:**
       - If form is dirty:
         - Show confirmation dialog: "Discard unsaved changes?"
       - Navigate back to /cases/:id (case detail, not list)

    5. **Loading state:**
       - Use Skeleton components matching form layout
       - Disable form interactions while loading

    6. **Not found state:**
       - "Case not found"
       - "The case you're looking for doesn't exist or you don't have access."
       - Link: "Back to Cases"

    TDD: Write tests FIRST covering:
    - Page fetches case data
    - Form pre-populates correctly
    - Loading skeleton shows
    - Not found state shows
    - Save sends only changed fields
    - Cancel returns to case detail
  </action>
  <verify>npm run test -- v2/src/app/(authenticated)/cases/[id]/edit/__tests__/page.test.tsx</verify>
  <done>Edit Case page loads data, pre-populates form, saves changes correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test -- v2/src/components/forms/__tests__/CaseForm.test.tsx` passes
- [ ] `npm run test -- v2/src/app/(authenticated)/cases/new/__tests__/` passes
- [ ] `npm run test -- v2/src/app/(authenticated)/cases/[id]/edit/__tests__/` passes
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors
- [ ] /cases/new renders and submits correctly
- [ ] /cases/:id/edit loads, pre-populates, and saves
- [ ] Duplicate detection works
- [ ] Cancel with dirty form shows confirmation
- [ ] Navigation flows work correctly
</verification>

<success_criteria>
- All tests pass (expect 20+ new tests)
- Add Case page creates new cases
- Edit Case page updates existing cases
- Duplicate detection warns user
- Form validation blocks invalid saves
- Proper navigation and confirmation dialogs
- Loading and error states handled
</success_criteria>

<output>
After completion, create `.planning/phases/22-case-forms/22-04-SUMMARY.md`:

# Phase 22-04: Add/Edit Pages Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale]

## Issues Encountered
[Problems and resolutions]

## Next Step
Ready for 22-05-PLAN.md (Polish + Cleanup)
</output>
