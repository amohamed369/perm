---
phase: 22-case-forms
plan: 01
type: execute
domain: forms
---

<objective>
Build form infrastructure for case add/edit with Zod validation schemas, reusable form components, and auto-calculation hooks.

Purpose: Establish the foundation that all form sections will use - validation, state management, and UI primitives.
Output: FormField components, Zod schemas, useFormCalculations hook, comprehensive tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<cascading_requirements>
## CRITICAL: These Requirements Apply to ALL Work in This Plan

### Mandatory Documentation (Must Read Before Any Work)

| Document | Path | Purpose |
|----------|------|---------|
| **perm_flow.md** | `/perm_flow.md` | **SOURCE OF TRUTH** - Case statuses, progress statuses, date validation, deadline logic |
| **FRONTEND_DESIGN_SKILL.md** | `.planning/FRONTEND_DESIGN_SKILL.md` | Design guidance, neobrutalist aesthetic, status colors |
| **Design Inspiration 1-5** | `.planning/phases/17-design-system/design1-5` | Design examples, hard shadows, animations |
| **Phase Context** | `.planning/phases/22-case-forms/22-CONTEXT.md` | Phase requirements |
| **V2 Design System** | `v2/docs/DESIGN_SYSTEM.md` | Component library, utility classes |

### Code Quality Standards (Non-Negotiable)

- **Clean** - No clutter, no dead code
- **Organized** - Logical structure, proper separation of concerns
- **Minimal** - No over-engineering, no unnecessary abstraction
- **Abstractable** - Reusable patterns where appropriate
- **Scalable** - Handles growth without refactoring
- **Maintainable** - Easy to modify and extend
- **Readable** - Self-documenting, clear naming
- **Global fixes** - Fix at the source, never repeat patterns

### TDD Requirements

- Tests BEFORE implementation (red-green-refactor)
- Full coverage of validation logic
- Edge case coverage

### Subagent/Task Tool Requirements

**ALL Task tools and subagents MUST have these instructions explicitly in their prompts:**

```
CRITICAL REQUIREMENTS:
1. Read these docs FIRST: perm_flow.md, .planning/FRONTEND_DESIGN_SKILL.md,
   .planning/phases/17-design-system/design1-5, .planning/phases/22-case-forms/22-CONTEXT.md
2. perm_flow.md is SOURCE OF TRUTH for all case logic
3. V1 feature parity - all features must be preserved
4. Code quality: clean, organized, minimal, abstractable, scalable, maintainable, readable
5. Global fixes only - no repeated patterns
6. Full TDD - tests before implementation
7. UI: animations, transitions, microinteractions per design docs
8. Use Explore and Task subagents for research and complex work
```
</cascading_requirements>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-case-forms/22-CONTEXT.md
@.planning/FRONTEND_DESIGN_SKILL.md
@perm_flow.md

**Prior phase context:**
@.planning/phases/21-case-list/21-04-SUMMARY.md

**Existing infrastructure:**
@v2/src/lib/perm-engine/validators/index.ts
@v2/src/lib/perm-engine/calculators/index.ts
@v2/convex/schema.ts (lines 110-270 for case table)
@v2/src/components/ui/input.tsx
@v2/src/components/ui/label.tsx
@v2/src/components/ui/checkbox.tsx

**Codebase constraints:**
- Use Zod 4.x for validation (already installed)
- No react-hook-form - manual state management (matches ImportModal pattern)
- Reuse perm-engine validators and calculators
- Follow existing component patterns (neobrutalist, hard shadows)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod form schemas with perm-engine integration</name>
  <files>
    v2/src/lib/forms/case-form-schema.ts
    v2/src/lib/forms/__tests__/case-form-schema.test.ts
    v2/src/lib/forms/index.ts
  </files>
  <exploration>
    Use Explore agent to understand:
    - Existing Zod patterns in v2/src/lib/
    - Convex schema field definitions for cases (v2/convex/schema.ts)
    - perm-engine validator input types (v2/src/lib/perm-engine/validators/*.ts)
    - How perm-engine validators are called
  </exploration>
  <action>
    Create comprehensive Zod schemas for case form validation:

    1. **caseFormSchema** - Main schema matching Convex case fields:
       - Required: employerName, beneficiaryIdentifier, positionTitle
       - Enums: caseStatus (pwd|recruitment|eta9089|i140|closed), progressStatus (6 values)
       - Optional dates: All ISO date strings with format validation
       - Booleans: isProfessionalOccupation, isFavorite, calendarSyncEnabled
       - Arrays: additionalRecruitmentMethods, tags

    2. **Validation integration** - Create `validateCaseForm()` that:
       - Runs Zod schema validation first
       - Then runs perm-engine validators (validateCase)
       - Combines errors from both into unified format

    3. **Field-level helpers**:
       - `isISODateString(value)` - Validates YYYY-MM-DD format
       - `isSunday(date)` - For Sunday ad validation
       - Zod refinements for cross-field validation

    4. **Type exports**:
       - `CaseFormData` - Inferred from schema
       - `CaseFormErrors` - Error shape for UI
       - `FieldError` - Single field error with message

    TDD: Write tests FIRST covering:
    - Valid complete form passes
    - Missing required fields fail
    - Invalid date formats fail
    - Invalid enum values fail
    - Cross-field validation (e.g., second Sunday after first)
  </action>
  <verify>npm run test -- v2/src/lib/forms/__tests__/case-form-schema.test.ts</verify>
  <done>Zod schemas validate all case fields, integrate with perm-engine, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Create FormField components with validation display</name>
  <files>
    v2/src/components/forms/FormField.tsx
    v2/src/components/forms/FormSection.tsx
    v2/src/components/forms/DateInput.tsx
    v2/src/components/forms/SelectInput.tsx
    v2/src/components/forms/__tests__/FormField.test.tsx
    v2/src/components/forms/__tests__/DateInput.test.tsx
    v2/src/components/forms/index.ts
  </files>
  <exploration>
    Use Explore agent to:
    - Study v2/src/components/ui/input.tsx styling patterns
    - Check .planning/FRONTEND_DESIGN_SKILL.md for form field styling
    - Look at design1-5 files for input field aesthetics
    - Examine v2/src/components/cases/ImportModal.tsx for form patterns
  </exploration>
  <action>
    Create reusable form components following neobrutalist design:

    1. **FormField** - Wrapper component:
       - Label with required indicator (red asterisk)
       - Description/hint text below label
       - Error message display with shake animation
       - Success state with green border
       - Auto-calculated indicator (pulse animation when value auto-fills)
       - Props: label, name, error, hint, required, autoCalculated, children

    2. **FormSection** - Collapsible section wrapper:
       - Section title with icon
       - Collapsible with smooth animation (Framer Motion)
       - Status indicator (complete/incomplete/has-errors)
       - Props: title, icon, defaultOpen, status, children

    3. **DateInput** - Date field with validation:
       - Native date input with neobrutalist styling
       - Clear button
       - Validation feedback (red border on error)
       - Highlight pulse when auto-calculated
       - Props: extends input + onClear, autoCalculated

    4. **SelectInput** - Dropdown with styling:
       - Native select with neobrutalist styling
       - Consistent with design system (hard shadow, black border)
       - Props: options, placeholder, extends select

    **Styling requirements:**
    - Black 2px borders
    - Hard shadows (4px 4px 0px #000) on focus
    - Error state: red border + shake animation
    - Success state: green border
    - Auto-calculated: brief green pulse animation

    TDD: Write tests FIRST covering:
    - FormField renders label, hint, error correctly
    - DateInput handles date changes
    - SelectInput renders options
    - Error states display properly
    - Auto-calculated animation triggers
  </action>
  <verify>npm run test -- v2/src/components/forms/__tests__</verify>
  <done>Form components render correctly with all states, match design system, tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Create useFormCalculations hook for auto-fill cascade</name>
  <files>
    v2/src/hooks/useFormCalculations.ts
    v2/src/hooks/__tests__/useFormCalculations.test.ts
    v2/src/hooks/index.ts
  </files>
  <exploration>
    Use Explore agent to:
    - Study perm-engine calculators (v2/src/lib/perm-engine/calculators/)
    - Understand PWD expiration calculation logic
    - Check recruitment deadline calculations
    - Review perm_flow.md for cascade rules
  </exploration>
  <action>
    Create React hook that handles auto-calculation cascade:

    1. **useFormCalculations(formData, setFormData)** returns:
       - `autoCalculatedFields` - Set of field names that were auto-calculated
       - `triggerCalculation(fieldName)` - Called when a field changes

    2. **Cascade rules from perm_flow.md:**
       - PWD determination → PWD expiration (calculatePWDExpiration)
       - Notice of filing start → end (+10 business days)
       - Job order start → suggested end (+30 days minimum)
       - ETA 9089 certification → expiration (+180 days)
       - RFI received → due (+30 days, strict)

    3. **Implementation details:**
       - Use perm-engine calculators (don't duplicate logic)
       - Track which fields were auto-calculated vs manually set
       - When upstream field changes, recalculate downstream
       - Don't overwrite manually-set downstream fields unless user confirms

    4. **Auto-calculation markers:**
       - Return which fields are currently "auto" vs "manual"
       - UI uses this to show pulse animation
       - User can override auto values (marks as manual)

    TDD: Write tests FIRST covering:
    - PWD determination triggers expiration calculation
    - Notice of filing end calculated correctly (10 business days)
    - Job order end suggested correctly (+30 days)
    - Manual override prevents recalculation
    - Multiple cascades in sequence work correctly
  </action>
  <verify>npm run test -- v2/src/hooks/__tests__/useFormCalculations.test.ts</verify>
  <done>Hook manages auto-calculation cascade, integrates with perm-engine calculators, tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test -- v2/src/lib/forms/` passes all tests
- [ ] `npm run test -- v2/src/components/forms/` passes all tests
- [ ] `npm run test -- v2/src/hooks/__tests__/useFormCalculations` passes all tests
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors
- [ ] Zod schemas match Convex case schema fields exactly
- [ ] Auto-calculation uses perm-engine calculators (no duplicate logic)
</verification>

<success_criteria>
- All tests pass (expect 20+ new tests)
- Form components follow neobrutalist design system
- Zod schemas integrate with perm-engine validators
- Auto-calculation hook uses existing calculators
- No duplicate validation or calculation logic
- Code is clean, organized, minimal, abstractable
</success_criteria>

<output>
After completion, create `.planning/phases/22-case-forms/22-01-SUMMARY.md`:

# Phase 22-01: Form Infrastructure Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale]

## Issues Encountered
[Problems and resolutions]

## Next Step
Ready for 22-02-PLAN.md (Form Sections Part 1)
</output>
