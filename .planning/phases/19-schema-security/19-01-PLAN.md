---
phase: 19-schema-security
plan: 01
type: execute
---

<objective>
Define core Convex schema tables: users (extended), userProfiles (consolidated), and cases (full PERM tracking).

Purpose: Establish the foundational data layer with all fields needed for user profiles and case management.
Output: Updated schema.ts with 3 core tables, proper indexes, and TypeScript types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/V2_CONVEX_SCHEMA.md
@.planning/phases/19-schema-security/19-CONTEXT.md
@perm_flow.md

**Prior decisions affecting this phase:**
- Phase 18: Separate userProfiles from users (1:1 table for app-specific data)
- Phase 18: Users table extends @convex-dev/auth authTables
- Two-tier status system: 5 case statuses + 6 progress statuses

**Codebase constraints:**
- Convex schema uses defineTable/defineSchema from convex/server
- Dates stored as ISO strings (YYYY-MM-DD)
- Timestamps stored as Unix milliseconds (v.number())
- Currency stored as cents (v.int64())
- Soft deletes via deletedAt timestamp

**Current state:**
- Minimal schema exists with users, userProfiles (2 fields), testItems
- Need to expand to full ~40 field userProfiles and ~55 field cases
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand users table with extended auth fields</name>
  <files>v2/convex/schema.ts</files>
  <action>
Extend the users table definition to include:
- Keep existing fields: name, image, email, emailVerificationTime, isAnonymous
- Add: phone (optional string)
- Add: deletedAt (optional number for soft delete)
- Add index: by_deleted_at on ["deletedAt"]

The users table primarily holds auth-related data. App-specific data goes in userProfiles.

Use v.optional() for all nullable fields. Keep the existing "email" index.
  </action>
  <verify>npx convex dev --once succeeds without schema errors</verify>
  <done>Users table has extended fields and deletedAt index</done>
</task>

<task type="auto">
  <name>Task 2: Define complete userProfiles table (~40 fields)</name>
  <files>v2/convex/schema.ts</files>
  <action>
Replace the minimal userProfiles table with the full consolidated schema from V2_CONVEX_SCHEMA.md and 19-CONTEXT.md:

**Profile section:**
- fullName: v.optional(v.string())
- jobTitle: v.optional(v.string())
- company: v.optional(v.string())
- profilePhotoUrl: v.optional(v.string())

**Organization section:**
- userType: v.union(v.literal("individual"), v.literal("firm_admin"), v.literal("firm_member"))
- firmId: v.optional(v.id("users")) // Self-reference for firm hierarchy
- firmName: v.optional(v.string())

**Notification settings:**
- emailNotificationsEnabled: v.boolean()
- smsNotificationsEnabled: v.boolean()
- pushNotificationsEnabled: v.boolean()
- urgentDeadlineDays: v.int64() // Days before deadline to mark urgent
- reminderDaysBefore: v.array(v.int64()) // e.g., [1, 3, 7, 14, 30]

**Email preferences:**
- emailDeadlineReminders: v.boolean()
- emailStatusUpdates: v.boolean()
- emailRfeAlerts: v.boolean()
- preferredNotificationEmail: v.union(v.literal("signup"), v.literal("google"), v.literal("both"))

**Quiet hours:**
- quietHoursEnabled: v.boolean()
- quietHoursStart: v.optional(v.string()) // HH:MM format
- quietHoursEnd: v.optional(v.string())
- timezone: v.string() // IANA timezone

**Calendar sync:**
- calendarSyncEnabled: v.boolean()
- calendarSyncPwd: v.boolean()
- calendarSyncEta9089: v.boolean()
- calendarSyncI140: v.boolean()
- calendarSyncRfe: v.boolean()
- calendarSyncRfi: v.boolean()
- calendarSyncRecruitment: v.boolean()
- calendarSyncFilingWindow: v.boolean()

**Google OAuth:**
- googleEmail: v.optional(v.string())
- googleRefreshToken: v.optional(v.string())
- googleAccessToken: v.optional(v.string())
- googleTokenExpiry: v.optional(v.number())
- googleScopes: v.optional(v.array(v.string()))
- googleCalendarConnected: v.boolean()
- gmailConnected: v.boolean()

**UI preferences:**
- casesSortBy: v.string() // e.g., "updatedAt", "nextDeadline"
- casesSortOrder: v.union(v.literal("asc"), v.literal("desc"))
- casesPerPage: v.int64()
- dismissedDeadlines: v.array(v.object({
    caseId: v.id("cases"),
    deadlineType: v.string(),
    dismissedAt: v.number()
  }))
- darkModeEnabled: v.boolean()

**Privacy:**
- privacyModeEnabled: v.boolean()

**Timestamps:**
- createdAt: v.number()
- updatedAt: v.number()
- deletedAt: v.optional(v.number())

**Indexes:**
- by_user_id: ["userId"] (already exists, rename to match convention)
- by_firm_id: ["firmId"]
- by_deleted_at: ["deletedAt"]

Note: Keep userId as v.id("users") for the 1:1 relationship.
  </action>
  <verify>npx convex dev --once succeeds, schema shows userProfiles with ~40 fields</verify>
  <done>userProfiles table has all consolidated fields from v1's 3 tables</done>
</task>

<task type="auto">
  <name>Task 3: Define complete cases table (~55 fields)</name>
  <files>v2/convex/schema.ts</files>
  <action>
Add the full cases table from V2_CONVEX_SCHEMA.md with all PERM tracking fields:

**Core identity:**
- userId: v.id("users")
- caseNumber: v.optional(v.string()) // DOL case number
- internalCaseNumber: v.optional(v.string()) // Attorney's reference

**Employer info:**
- employerName: v.string()
- employerFein: v.optional(v.string())

**Beneficiary info:**
- beneficiaryIdentifier: v.string() // Privacy-safe identifier

**Position info:**
- positionTitle: v.string()
- jobTitle: v.optional(v.string())
- socCode: v.optional(v.string())
- socTitle: v.optional(v.string())
- jobOrderState: v.optional(v.string()) // 2-letter state code

**Case status (two-tier system from perm_flow.md):**
- caseStatus: v.union(v.literal("pwd"), v.literal("recruitment"), v.literal("eta9089"), v.literal("i140"), v.literal("closed"))
- progressStatus: v.union(v.literal("working"), v.literal("waiting_intake"), v.literal("filed"), v.literal("approved"), v.literal("under_review"), v.literal("rfi_rfe"))
- progressStatusOverride: v.optional(v.boolean())

**PWD phase:**
- pwdFilingDate: v.optional(v.string()) // ISO date YYYY-MM-DD
- pwdDeterminationDate: v.optional(v.string())
- pwdExpirationDate: v.optional(v.string()) // Auto-calculated
- pwdCaseNumber: v.optional(v.string())
- pwdWageAmount: v.optional(v.int64()) // Stored as cents
- pwdWageLevel: v.optional(v.string())

**Recruitment - Job Order:**
- jobOrderStartDate: v.optional(v.string())
- jobOrderEndDate: v.optional(v.string())

**Recruitment - Sunday Ads:**
- sundayAdFirstDate: v.optional(v.string())
- sundayAdSecondDate: v.optional(v.string())
- sundayAdNewspaper: v.optional(v.string())

**Recruitment - Additional Methods:**
- additionalRecruitmentStartDate: v.optional(v.string())
- additionalRecruitmentEndDate: v.optional(v.string())
- additionalRecruitmentMethods: v.array(v.object({
    method: v.string(),
    date: v.string(),
    description: v.optional(v.string())
  }))
- recruitmentNotes: v.optional(v.string())
- recruitmentApplicantsCount: v.int64()
- recruitmentSummaryCustom: v.optional(v.string())

**Professional occupation:**
- isProfessionalOccupation: v.boolean()

**Notice of Filing:**
- noticeOfFilingStartDate: v.optional(v.string())
- noticeOfFilingEndDate: v.optional(v.string())

**ETA 9089:**
- eta9089FilingDate: v.optional(v.string())
- eta9089AuditDate: v.optional(v.string())
- eta9089CertificationDate: v.optional(v.string())
- eta9089ExpirationDate: v.optional(v.string())
- eta9089CaseNumber: v.optional(v.string())

**RFI (strict 30-day due):**
- rfiReceivedDate: v.optional(v.string())
- rfiResponseDueDate: v.optional(v.string()) // Auto-calculated, NOT editable
- rfiResponseSubmittedDate: v.optional(v.string())

**RFE (editable due date):**
- rfeReceivedDate: v.optional(v.string())
- rfeResponseDueDate: v.optional(v.string()) // USER EDITABLE
- rfeResponseSubmittedDate: v.optional(v.string())

**I-140:**
- i140FilingDate: v.optional(v.string())
- i140ReceiptDate: v.optional(v.string())
- i140ReceiptNumber: v.optional(v.string())
- i140ApprovalDate: v.optional(v.string())
- i140DenialDate: v.optional(v.string())

**Organization & Metadata:**
- priorityLevel: v.union(v.literal("low"), v.literal("normal"), v.literal("high"), v.literal("urgent"))
- isFavorite: v.boolean()
- notes: v.optional(v.array(v.object({
    id: v.string(),
    content: v.string(),
    createdAt: v.number(),
    status: v.union(v.literal("pending"), v.literal("done"), v.literal("deleted"))
  })))
- tags: v.array(v.string())

**Calendar integration:**
- calendarEventIds: v.optional(v.any()) // Map of event type -> Google Calendar event ID
- calendarSyncEnabled: v.boolean()

**Timestamps:**
- createdAt: v.number()
- updatedAt: v.number()
- deletedAt: v.optional(v.number())

**Indexes:**
- by_user_id: ["userId"]
- by_user_and_status: ["userId", "caseStatus"]
- by_user_and_favorite: ["userId", "isFavorite"]
- by_user_and_priority: ["userId", "priorityLevel"]
- by_deleted_at: ["deletedAt"]

Remove the testItems table as it's no longer needed.
  </action>
  <verify>npx convex dev --once succeeds, schema shows cases with ~55 fields and 5 indexes</verify>
  <done>Cases table has all PERM tracking fields matching V2_CONVEX_SCHEMA.md</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` succeeds without errors
- [ ] Schema shows users table with extended fields
- [ ] Schema shows userProfiles with ~40 fields
- [ ] Schema shows cases with ~55 fields
- [ ] All indexes defined correctly
- [ ] testItems table removed
</verification>

<success_criteria>
- All 3 core tables defined with complete field lists
- Field types match V2_CONVEX_SCHEMA.md specifications
- Indexes support expected query patterns
- Schema deploys successfully to Convex
</success_criteria>

<output>
After completion, create `.planning/phases/19-schema-security/19-01-SUMMARY.md`:

# Phase 19 Plan 01: Core Schema Summary

**[One-liner describing what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `v2/convex/schema.ts` - Extended users, full userProfiles, full cases

## Decisions Made
- [Any field naming conventions, type choices]

## Issues Encountered
- [Problems and resolutions, or "None"]

## Next Step
Ready for 19-02-PLAN.md (Supporting schema tables)
</output>
