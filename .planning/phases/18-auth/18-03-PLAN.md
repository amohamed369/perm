---
phase: 18-auth
plan: 03
type: execute
domain: convex-auth
---

<objective>
Create auth UI pages (login, signup, password reset) and user queries for authenticated data access.

Purpose: Complete the auth user experience with branded pages and working authentication flows.
Output: Functional login, signup, and password reset pages with email/password and Google OAuth support.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-auth/18-RESEARCH.md
@.planning/phases/18-auth/18-CONTEXT.md
@.planning/phases/18-auth/18-01-SUMMARY.md
@.planning/phases/18-auth/18-02-SUMMARY.md
@.planning/FRONTEND_DESIGN_SKILL.md

**Prior decisions affecting this phase:**
- Match v1 login experience (simple, fast, no friction)
- Email/password + Google OAuth as two options
- Email verification before account is active
- Standard "Forgot password?" reset flow

**Deferred issues being addressed:**
None

**Concerns being verified:**
- Login experience matches v1 simplicity

**Relevant source files:**
@v2/src/components/ui/button.tsx
@v2/src/components/ui/input.tsx
@v2/src/components/ui/card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user queries and userProfile mutation</name>
  <files>v2/convex/users.ts</files>
  <action>
    Create v2/convex/users.ts with:

    **currentUser query:**
    - Use getAuthUserId from @convex-dev/auth/server
    - Return null if not authenticated
    - Return user document if authenticated

    **currentUserProfile query:**
    - Get authenticated user ID
    - Query userProfiles table by userId index
    - Return profile or null

    **ensureUserProfile mutation:**
    - Called after successful login/signup
    - Creates userProfile if it doesn't exist for user
    - Default values: calendarSyncEnabled=true, notificationPreferences.emailNotifications=true, deadlineReminders=true
    - Idempotent: does nothing if profile already exists

    These queries/mutations follow the pattern from 18-RESEARCH.md:
    ```typescript
    import { query, mutation } from "./_generated/server";
    import { getAuthUserId } from "@convex-dev/auth/server";
    ```
  </action>
  <verify>
    `cd v2 && npx convex dev` deploys functions successfully
  </verify>
  <done>User queries and userProfile mutation created</done>
</task>

<task type="auto">
  <name>Task 2: Create auth pages (login, signup, reset-password)</name>
  <files>v2/src/app/(auth)/login/page.tsx, v2/src/app/(auth)/signup/page.tsx, v2/src/app/(auth)/reset-password/page.tsx, v2/src/app/(auth)/layout.tsx</files>
  <exploration>
    Read @.planning/FRONTEND_DESIGN_SKILL.md before implementation for design system guidance.
    Check existing UI components in v2/src/components/ui/ for consistent styling.
  </exploration>
  <action>
    **Create (auth) route group with shared layout:**

    **v2/src/app/(auth)/layout.tsx:**
    - Centered layout with max-w-md card
    - PERM Tracker branding (logo/title at top)
    - Clean, minimal design matching neobrutalist aesthetic
    - Dark mode support

    **v2/src/app/(auth)/login/page.tsx:**
    - Email and password inputs
    - "Sign In" button
    - "Sign in with Google" button (secondary style)
    - "Don't have an account? Sign up" link
    - "Forgot password?" link
    - Use useAuthActions from @convex-dev/auth/react
    - Handle signIn("password", formData) and signIn("google")

    **v2/src/app/(auth)/signup/page.tsx:**
    - Email, password, and confirm password inputs
    - Name input (optional)
    - "Sign Up" button
    - "Sign up with Google" button
    - "Already have an account? Sign in" link
    - Handle multi-step flow:
      1. Initial: email + password
      2. After signup: verification code input
    - Use signIn("password", formData) with flow="signUp"

    **v2/src/app/(auth)/reset-password/page.tsx:**
    - Step 1: Email input + "Send Reset Code" button
    - Step 2: Code input + new password + "Reset Password" button
    - Use signIn("password", formData) with flow="reset" and flow="reset-verification"

    **Design requirements (from FRONTEND_DESIGN_SKILL.md):**
    - Use existing Button component with neobrutalist styling
    - Use Input component with proper validation states
    - Use Card for form container
    - Add proper error handling with toast notifications (Sonner)
    - Loading states on buttons during async operations
  </action>
  <verify>
    `cd v2 && npm run build` succeeds with all auth pages
  </verify>
  <done>Login, signup, and reset-password pages created with proper styling</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete auth flow with login, signup, password reset, and Google OAuth</what-built>
  <how-to-verify>
    **Prerequisites:**
    1. Set Convex environment variables:
       ```bash
       npx convex env set AUTH_GOOGLE_ID <your-google-client-id>
       npx convex env set AUTH_GOOGLE_SECRET <your-google-client-secret>
       npx convex env set AUTH_RESEND_KEY <your-resend-api-key>
       npx convex env set SITE_URL http://localhost:3000
       ```
    2. Add OAuth redirect URI in Google Cloud Console:
       `https://<your-convex-deployment>.convex.site/api/auth/callback/google`
    3. Start dev server: `cd v2 && npm run dev`

    **Test Email/Password Signup:**
    1. Visit http://localhost:3000/signup
    2. Enter email, password (8+ chars), confirm password
    3. Click "Sign Up"
    4. Check email for verification code
    5. Enter code on verification screen
    6. Should redirect to /dashboard after verification

    **Test Email/Password Login:**
    1. Visit http://localhost:3000/login
    2. Enter email and password from signup
    3. Click "Sign In"
    4. Should redirect to /dashboard

    **Test Google OAuth:**
    1. Visit http://localhost:3000/login
    2. Click "Sign in with Google"
    3. Complete Google OAuth flow
    4. Should redirect to /dashboard

    **Test Password Reset:**
    1. Visit http://localhost:3000/login
    2. Click "Forgot password?"
    3. Enter email
    4. Check email for reset code
    5. Enter code and new password
    6. Should be able to login with new password

    **Test Route Protection:**
    1. While logged out, visit http://localhost:3000/dashboard
    2. Should redirect to /login
    3. While logged in, visit http://localhost:3000/login
    4. Should redirect to /dashboard

    **Visual Check:**
    - Pages look clean and branded (PERM Tracker)
    - Buttons have neobrutalist styling with proper hover effects
    - Dark mode works correctly
    - Error messages display properly (toast notifications)
  </how-to-verify>
  <resume-signal>Type "approved" if all flows work, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] User queries (currentUser, currentUserProfile) work
- [ ] ensureUserProfile mutation creates profile on first login
- [ ] Login page works with email/password
- [ ] Login page works with Google OAuth
- [ ] Signup flow completes with email verification
- [ ] Password reset flow works
- [ ] Route protection redirects correctly
- [ ] Pages match design system (neobrutalist aesthetic)
</verification>

<success_criteria>
- All auth flows functional (email/password signup, login, Google OAuth, password reset)
- Email verification required before account active
- User profile created automatically on first successful login
- Route protection working (protected routes require auth)
- Pages styled with neobrutalist design system
- Dark mode supported
- Error handling with toast notifications
- Human checkpoint approved
</success_criteria>

<output>
After completion, create `.planning/phases/18-auth/18-03-SUMMARY.md`:

# Phase 18 Plan 03: Auth UI Pages Summary

**[One-liner: what was accomplished]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `v2/convex/users.ts` - User queries and profile mutation
- `v2/src/app/(auth)/layout.tsx` - Auth layout
- `v2/src/app/(auth)/login/page.tsx` - Login page
- `v2/src/app/(auth)/signup/page.tsx` - Signup page
- `v2/src/app/(auth)/reset-password/page.tsx` - Password reset page

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 18 complete, ready for Phase 19 (Schema + Security)
</output>
