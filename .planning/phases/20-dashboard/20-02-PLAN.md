# Phase 20-02: Dashboard Layout, Header & Summary Tiles

## Objective

Build the authenticated dashboard page layout with header navigation, dark mode toggle, and Summary Tiles with StageProgression hover effects. This establishes the dashboard shell that other components plug into.

**TDD Approach:** Write component tests FIRST, then implement components to pass tests.

## ⚠️ CRITICAL: Required Reading Before Implementation

**You MUST read these files before starting ANY implementation work:**

1. **Frontend Design Skill** (MANDATORY):
   - `/Users/adammohamed/cc/perm-tracker-test/.planning/FRONTEND_DESIGN_SKILL.md`
   - Contains design system rules, status colors, urgency colors, typography, neobrutalist aesthetic

2. **PERM Flow Source of Truth** (MANDATORY):
   - `/Users/adammohamed/cc/perm-tracker-test/perm_flow.md`
   - Defines case statuses, progress statuses, subtext requirements for tiles

3. **Design Reference Images** (MANDATORY for UI work):
   - `/Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design3`
   - `/Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design4` (Flash UI - primary reference)
   - `/Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design5`

4. **Design System Documentation**:
   - `v2/docs/DESIGN_SYSTEM.md` - Component library and utility classes

5. **Phase Context**:
   - `/Users/adammohamed/cc/perm-tracker-test/.planning/phases/20-dashboard/20-CONTEXT.md`

### Subagent Instructions

**If you spawn ANY subagents or use the Task tool, you MUST include in their prompt:**

```
REQUIRED READING - Read these files BEFORE any implementation:
1. /Users/adammohamed/cc/perm-tracker-test/.planning/FRONTEND_DESIGN_SKILL.md (design rules, colors, typography)
2. /Users/adammohamed/cc/perm-tracker-test/perm_flow.md (PERM workflow, statuses, deadline logic)
3. /Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design3 (design reference)
4. /Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design4 (Flash UI - primary reference)
5. /Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design5 (design reference)
6. v2/docs/DESIGN_SYSTEM.md (component library)
7. /Users/adammohamed/cc/perm-tracker-test/.planning/phases/20-dashboard/20-CONTEXT.md (phase context)
```

## Execution Context

```
@.planning/FRONTEND_DESIGN_SKILL.md
@.planning/phases/20-dashboard/20-CONTEXT.md
@.planning/V2_DESIGN_TOKENS.json
@v2/docs/DESIGN_SYSTEM.md
@v2/src/components/ui/
@v2/src/components/status/
```

## Context

**From 20-CONTEXT.md:**
- Summary Tiles show case counts by stage (PWD, Recruitment, ETA 9089, I-140, Complete, Closed)
- StageProgression component for expanding underline hover effect
- Each tile has gray subtext with breakdowns
- Clicking a tile navigates to Cases List filtered by that status
- Header with all nav links (Cases, Calendar, Notifications, Settings)
- Light/Dark mode toggle that persists

**Design requirements:**
- Neobrutalist aesthetic with hard shadows
- Grain overlay + dot pattern background
- Space Grotesk headings, Inter body, JetBrains Mono for numbers
- Status colors: PWD blue, Recruitment purple, ETA orange, I-140 green, Closed gray
- Premium polish: 150-200ms transitions, skeleton loading
- Progress rings that animate on scroll into view

**Deferred items to implement:**
- Hazard stripes component (from Phase 17.1)
- Corner label component (from Phase 17.1)

---

## Task 1: Create Test Fixtures for UI Components

**Files:**
- `v2/test-utils/ui-fixtures.ts`
- `v2/test-utils/render-utils.tsx`

### 1.1 Create UI Test Fixtures

```typescript
// v2/test-utils/ui-fixtures.ts
import { DashboardSummary, StatusCount, CaseStatus } from "@/convex/lib/dashboard-types";

/**
 * Factory for creating mock dashboard summary data for UI tests
 */
export function createMockDashboardSummary(
  overrides: Partial<DashboardSummary> = {}
): DashboardSummary {
  return {
    totalCases: 25,
    activeCases: 20,
    completedCases: 3,
    closedCases: 2,
    statusCounts: [
      createMockStatusCount("pwd", 5, "3 waiting, 2 received"),
      createMockStatusCount("recruitment", 8, "2 ads pending, 6 in progress"),
      createMockStatusCount("eta9089", 4, "1 drafting, 3 filed"),
      createMockStatusCount("i140", 3, "2 pending, 1 approved"),
    ],
    ...overrides,
  };
}

export function createMockStatusCount(
  status: CaseStatus,
  total: number,
  subtexts: string
): StatusCount {
  return { status, total, subtexts };
}

/**
 * Factory for empty dashboard state
 */
export function createEmptyDashboardSummary(): DashboardSummary {
  return {
    totalCases: 0,
    activeCases: 0,
    completedCases: 0,
    closedCases: 0,
    statusCounts: [],
  };
}

/**
 * Mock user data for authenticated tests
 */
export function createMockUser(overrides: Partial<{
  _id: string;
  name: string;
  email: string;
}> = {}) {
  return {
    _id: "user_123",
    name: "John Smith",
    email: "john@example.com",
    ...overrides,
  };
}

/**
 * Nav link configurations
 */
export const NAV_LINKS = [
  { href: "/dashboard", label: "Dashboard" },
  { href: "/cases", label: "Cases" },
  { href: "/calendar", label: "Calendar" },
  { href: "/notifications", label: "Notifications" },
  { href: "/settings", label: "Settings" },
] as const;

export const AUTH_NAV_LINKS = [
  { href: "/", label: "Home" },
  { href: "/demo", label: "Demo" },
] as const;

/**
 * Status color mappings for verification
 */
export const STATUS_COLORS = {
  pwd: { hex: "#0066FF", cssVar: "var(--status-pwd)" },
  recruitment: { hex: "#9333ea", cssVar: "var(--status-recruitment)" },
  eta9089: { hex: "#D97706", cssVar: "var(--status-eta9089)" },
  i140: { hex: "#059669", cssVar: "var(--status-i140)" },
  complete: { hex: "#059669", cssVar: "var(--status-i140)" },
  closed: { hex: "#6B7280", cssVar: "var(--status-closed)" },
} as const;
```

### 1.2 Create Render Test Utilities

```typescript
// v2/test-utils/render-utils.tsx
import React, { ReactElement } from "react";
import { render, RenderOptions } from "@testing-library/react";
import { ConvexProvider, ConvexReactClient } from "convex/react";
import { ThemeProvider } from "next-themes";

// Mock Convex client for testing
const mockConvexClient = {
  // Add mock methods as needed
} as unknown as ConvexReactClient;

/**
 * All providers needed for component rendering
 */
function AllProviders({ children }: { children: React.ReactNode }) {
  return (
    <ThemeProvider attribute="class" defaultTheme="light" enableSystem={false}>
      {children}
    </ThemeProvider>
  );
}

/**
 * Custom render with all providers
 */
export function renderWithProviders(
  ui: ReactElement,
  options?: Omit<RenderOptions, "wrapper">
) {
  return render(ui, { wrapper: AllProviders, ...options });
}

/**
 * Mock useQuery hook for testing
 */
export function createMockUseQuery<T>(data: T | undefined) {
  return jest.fn().mockReturnValue(data);
}

/**
 * Mock usePathname hook
 */
export function createMockUsePathname(pathname: string) {
  return jest.fn().mockReturnValue(pathname);
}
```

---

## Task 2: Write Component Tests FIRST (Header, ThemeToggle)

**File:** `v2/src/components/layout/__tests__/Header.test.tsx`

Write tests BEFORE implementing components. Tests define expected behavior.

```typescript
// v2/src/components/layout/__tests__/Header.test.tsx
import { render, screen, within } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { Header } from "../Header";
import { NAV_LINKS, createMockUser } from "@/test-utils/ui-fixtures";
import { renderWithProviders } from "@/test-utils/render-utils";

// Mock next/navigation
jest.mock("next/navigation", () => ({
  usePathname: jest.fn().mockReturnValue("/dashboard"),
}));

// Mock convex/react
const mockCurrentUser = createMockUser();
jest.mock("convex/react", () => ({
  useQuery: jest.fn().mockReturnValue(mockCurrentUser),
}));

describe("Header", () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe("rendering", () => {
    it("renders the logo with link to dashboard", () => {
      renderWithProviders(<Header />);

      const logo = screen.getByRole("link", { name: /perm tracker/i });
      expect(logo).toBeInTheDocument();
      expect(logo).toHaveAttribute("href", "/dashboard");
    });

    it("renders all navigation links", () => {
      renderWithProviders(<Header />);

      NAV_LINKS.forEach(({ href, label }) => {
        const link = screen.getByRole("link", { name: label });
        expect(link).toBeInTheDocument();
        expect(link).toHaveAttribute("href", href);
      });
    });

    it("renders the theme toggle button", () => {
      renderWithProviders(<Header />);

      const themeToggle = screen.getByRole("button", { name: /toggle theme/i });
      expect(themeToggle).toBeInTheDocument();
    });

    it("displays user name when authenticated", () => {
      renderWithProviders(<Header />);

      expect(screen.getByText(mockCurrentUser.name)).toBeInTheDocument();
    });
  });

  describe("active state", () => {
    it("highlights current page in navigation", () => {
      const { usePathname } = require("next/navigation");
      usePathname.mockReturnValue("/dashboard");

      renderWithProviders(<Header />);

      const dashboardLink = screen.getByRole("link", { name: "Dashboard" });
      expect(dashboardLink).toHaveClass("border-primary");
    });

    it("does not highlight non-active pages", () => {
      const { usePathname } = require("next/navigation");
      usePathname.mockReturnValue("/dashboard");

      renderWithProviders(<Header />);

      const casesLink = screen.getByRole("link", { name: "Cases" });
      expect(casesLink).not.toHaveClass("border-primary");
    });
  });

  describe("styling", () => {
    it("has sticky positioning", () => {
      renderWithProviders(<Header />);

      const header = screen.getByRole("banner");
      expect(header).toHaveClass("sticky", "top-0");
    });

    it("has neobrutalist border", () => {
      renderWithProviders(<Header />);

      const header = screen.getByRole("banner");
      expect(header).toHaveClass("border-b-4", "border-black");
    });
  });
});

describe("ThemeToggle", () => {
  it("renders sun and moon icons", () => {
    renderWithProviders(<Header />);

    const button = screen.getByRole("button", { name: /toggle theme/i });
    // Icons should be present (visual verification)
    expect(button).toBeInTheDocument();
  });

  it("has accessible label", () => {
    renderWithProviders(<Header />);

    const button = screen.getByRole("button", { name: /toggle theme/i });
    expect(button).toHaveAccessibleName();
  });

  it("has neobrutalist border styling", () => {
    renderWithProviders(<Header />);

    const button = screen.getByRole("button", { name: /toggle theme/i });
    expect(button).toHaveClass("border-2", "border-black");
  });
});
```

---

## Task 3: Write Component Tests FIRST (AuthHeader, AuthFooter)

**File:** `v2/src/components/layout/__tests__/AuthHeader.test.tsx`

```typescript
// v2/src/components/layout/__tests__/AuthHeader.test.tsx
import { render, screen } from "@testing-library/react";
import { AuthHeader } from "../AuthHeader";
import { AUTH_NAV_LINKS } from "@/test-utils/ui-fixtures";
import { renderWithProviders } from "@/test-utils/render-utils";

// Mock next/navigation
jest.mock("next/navigation", () => ({
  usePathname: jest.fn().mockReturnValue("/signin"),
}));

describe("AuthHeader", () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe("rendering", () => {
    it("renders the logo with link to home", () => {
      renderWithProviders(<AuthHeader />);

      const logo = screen.getByRole("link", { name: /perm tracker/i });
      expect(logo).toBeInTheDocument();
      expect(logo).toHaveAttribute("href", "/");
    });

    it("renders Home and Demo nav links", () => {
      renderWithProviders(<AuthHeader />);

      AUTH_NAV_LINKS.forEach(({ href, label }) => {
        const link = screen.getByRole("link", { name: label });
        expect(link).toBeInTheDocument();
        expect(link).toHaveAttribute("href", href);
      });
    });

    it("renders theme toggle", () => {
      renderWithProviders(<AuthHeader />);

      const themeToggle = screen.getByRole("button", { name: /toggle theme/i });
      expect(themeToggle).toBeInTheDocument();
    });
  });

  describe("context-aware auth buttons", () => {
    it("hides Sign In button when on signin page", () => {
      const { usePathname } = require("next/navigation");
      usePathname.mockReturnValue("/signin");

      renderWithProviders(<AuthHeader />);

      // Should NOT find Sign In as a link (it's the current page)
      const signInLinks = screen.queryAllByRole("link", { name: /sign in/i });
      expect(signInLinks.length).toBe(0);
    });

    it("shows Sign Up button when on signin page", () => {
      const { usePathname } = require("next/navigation");
      usePathname.mockReturnValue("/signin");

      renderWithProviders(<AuthHeader />);

      const signUpLink = screen.getByRole("link", { name: /sign up/i });
      expect(signUpLink).toBeInTheDocument();
      expect(signUpLink).toHaveAttribute("href", "/signup");
    });

    it("hides Sign Up button when on signup page", () => {
      const { usePathname } = require("next/navigation");
      usePathname.mockReturnValue("/signup");

      renderWithProviders(<AuthHeader />);

      const signUpLinks = screen.queryAllByRole("link", { name: /sign up/i });
      expect(signUpLinks.length).toBe(0);
    });

    it("shows Sign In button when on signup page", () => {
      const { usePathname } = require("next/navigation");
      usePathname.mockReturnValue("/signup");

      renderWithProviders(<AuthHeader />);

      const signInLink = screen.getByRole("link", { name: /sign in/i });
      expect(signInLink).toBeInTheDocument();
      expect(signInLink).toHaveAttribute("href", "/signin");
    });
  });

  describe("styling", () => {
    it("Sign Up button has neobrutalist primary style", () => {
      const { usePathname } = require("next/navigation");
      usePathname.mockReturnValue("/signin");

      renderWithProviders(<AuthHeader />);

      const signUpLink = screen.getByRole("link", { name: /sign up/i });
      expect(signUpLink).toHaveClass("border-4", "border-black", "bg-primary");
    });
  });
});
```

**File:** `v2/src/components/layout/__tests__/AuthFooter.test.tsx`

```typescript
// v2/src/components/layout/__tests__/AuthFooter.test.tsx
import { render, screen } from "@testing-library/react";
import { AuthFooter } from "../AuthFooter";

describe("AuthFooter", () => {
  describe("rendering", () => {
    it("renders Privacy Policy link", () => {
      render(<AuthFooter />);

      const link = screen.getByRole("link", { name: /privacy policy/i });
      expect(link).toBeInTheDocument();
      expect(link).toHaveAttribute("href", "/privacy");
    });

    it("renders Terms of Service link", () => {
      render(<AuthFooter />);

      const link = screen.getByRole("link", { name: /terms of service/i });
      expect(link).toBeInTheDocument();
      expect(link).toHaveAttribute("href", "/terms");
    });

    it("renders Contact link", () => {
      render(<AuthFooter />);

      const link = screen.getByRole("link", { name: /contact/i });
      expect(link).toBeInTheDocument();
      expect(link).toHaveAttribute("href", "/contact");
    });

    it("renders copyright with current year", () => {
      render(<AuthFooter />);

      const currentYear = new Date().getFullYear();
      expect(screen.getByText(new RegExp(`${currentYear}`))).toBeInTheDocument();
      expect(screen.getByText(/perm tracker/i)).toBeInTheDocument();
    });
  });

  describe("styling", () => {
    it("has neobrutalist top border", () => {
      render(<AuthFooter />);

      const footer = screen.getByRole("contentinfo");
      expect(footer).toHaveClass("border-t-4", "border-black");
    });
  });
});
```

---

## Task 4: Write Component Tests FIRST (SummaryTile, SummaryTilesGrid)

**File:** `v2/src/components/dashboard/__tests__/SummaryTile.test.tsx`

```typescript
// v2/src/components/dashboard/__tests__/SummaryTile.test.tsx
import { render, screen } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { SummaryTile } from "../SummaryTile";
import { STATUS_COLORS } from "@/test-utils/ui-fixtures";
import { renderWithProviders } from "@/test-utils/render-utils";

describe("SummaryTile", () => {
  const defaultProps = {
    status: "pwd" as const,
    count: 5,
    subtext: "3 waiting, 2 received",
    href: "/cases?status=pwd",
  };

  describe("rendering", () => {
    it("renders status label", () => {
      renderWithProviders(<SummaryTile {...defaultProps} />);

      expect(screen.getByText("PWD")).toBeInTheDocument();
    });

    it("renders count", () => {
      renderWithProviders(<SummaryTile {...defaultProps} />);

      // Count appears in corner label AND as main number
      const counts = screen.getAllByText("5");
      expect(counts.length).toBeGreaterThanOrEqual(1);
    });

    it("renders subtext", () => {
      renderWithProviders(<SummaryTile {...defaultProps} />);

      expect(screen.getByText("3 waiting, 2 received")).toBeInTheDocument();
    });

    it("is a link to filtered cases list", () => {
      renderWithProviders(<SummaryTile {...defaultProps} />);

      const link = screen.getByRole("link");
      expect(link).toHaveAttribute("href", "/cases?status=pwd");
    });
  });

  describe("status-specific rendering", () => {
    it("renders PWD with blue styling", () => {
      const { container } = renderWithProviders(
        <SummaryTile {...defaultProps} status="pwd" />
      );

      expect(screen.getByText("PWD")).toBeInTheDocument();
      // Blue background class
      expect(container.querySelector(".bg-\\[\\#0066FF\\]\\/10")).toBeInTheDocument();
    });

    it("renders Recruitment with purple styling", () => {
      const { container } = renderWithProviders(
        <SummaryTile {...defaultProps} status="recruitment" />
      );

      expect(screen.getByText("Recruitment")).toBeInTheDocument();
    });

    it("renders ETA 9089 with orange styling", () => {
      renderWithProviders(<SummaryTile {...defaultProps} status="eta9089" />);

      expect(screen.getByText("ETA 9089")).toBeInTheDocument();
    });

    it("renders I-140 with green styling", () => {
      renderWithProviders(<SummaryTile {...defaultProps} status="i140" />);

      expect(screen.getByText("I-140")).toBeInTheDocument();
    });

    it("renders Complete with green styling", () => {
      renderWithProviders(<SummaryTile {...defaultProps} status="complete" />);

      expect(screen.getByText("Complete")).toBeInTheDocument();
    });

    it("renders Closed with gray styling", () => {
      renderWithProviders(<SummaryTile {...defaultProps} status="closed" />);

      expect(screen.getByText("Closed")).toBeInTheDocument();
    });
  });

  describe("corner label", () => {
    it("renders corner label with count", () => {
      const { container } = renderWithProviders(
        <SummaryTile {...defaultProps} count={10} />
      );

      // Corner label has specific positioning
      const cornerLabel = container.querySelector(".-top-3.-left-3");
      expect(cornerLabel).toBeInTheDocument();
      expect(cornerLabel).toHaveTextContent("10");
    });
  });

  describe("StageProgression hover effect", () => {
    it("has expanding underline element", () => {
      const { container } = renderWithProviders(<SummaryTile {...defaultProps} />);

      // Should have underline span that expands on hover
      const underline = container.querySelector(".group-hover\\:w-full");
      expect(underline).toBeInTheDocument();
    });
  });

  describe("neobrutalist styling", () => {
    it("has 4px black border", () => {
      renderWithProviders(<SummaryTile {...defaultProps} />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("border-4", "border-black");
    });

    it("has hover transform effect", () => {
      renderWithProviders(<SummaryTile {...defaultProps} />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("hover:-translate-x-0.5", "hover:-translate-y-0.5");
    });

    it("has hover shadow effect", () => {
      renderWithProviders(<SummaryTile {...defaultProps} />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("hover:shadow-hard-lg");
    });
  });
});
```

**File:** `v2/src/components/dashboard/__tests__/SummaryTilesGrid.test.tsx`

```typescript
// v2/src/components/dashboard/__tests__/SummaryTilesGrid.test.tsx
import { render, screen } from "@testing-library/react";
import { SummaryTilesGrid } from "../SummaryTilesGrid";
import { createMockDashboardSummary, createEmptyDashboardSummary } from "@/test-utils/ui-fixtures";
import { renderWithProviders } from "@/test-utils/render-utils";

// Mock convex/react
let mockSummaryData: ReturnType<typeof createMockDashboardSummary> | undefined;
jest.mock("convex/react", () => ({
  useQuery: jest.fn(() => mockSummaryData),
}));

describe("SummaryTilesGrid", () => {
  beforeEach(() => {
    jest.clearAllMocks();
    mockSummaryData = undefined;
  });

  describe("loading state", () => {
    it("renders skeleton when data is loading", () => {
      mockSummaryData = undefined;

      const { container } = renderWithProviders(<SummaryTilesGrid />);

      // Should show 6 skeleton tiles
      const skeletons = container.querySelectorAll(".h-32");
      expect(skeletons.length).toBe(6);
    });

    it("renders section title skeleton", () => {
      mockSummaryData = undefined;

      const { container } = renderWithProviders(<SummaryTilesGrid />);

      // Title skeleton
      const titleSkeleton = container.querySelector(".h-8.w-40");
      expect(titleSkeleton).toBeInTheDocument();
    });
  });

  describe("with data", () => {
    beforeEach(() => {
      mockSummaryData = createMockDashboardSummary();
    });

    it("renders Case Summary heading", () => {
      renderWithProviders(<SummaryTilesGrid />);

      expect(screen.getByRole("heading", { name: /case summary/i })).toBeInTheDocument();
    });

    it("renders tiles for each status", () => {
      renderWithProviders(<SummaryTilesGrid />);

      expect(screen.getByText("PWD")).toBeInTheDocument();
      expect(screen.getByText("Recruitment")).toBeInTheDocument();
      expect(screen.getByText("ETA 9089")).toBeInTheDocument();
      expect(screen.getByText("I-140")).toBeInTheDocument();
    });

    it("renders Complete tile separately", () => {
      renderWithProviders(<SummaryTilesGrid />);

      expect(screen.getByText("Complete")).toBeInTheDocument();
    });

    it("renders Closed tile", () => {
      renderWithProviders(<SummaryTilesGrid />);

      expect(screen.getByText("Closed")).toBeInTheDocument();
    });

    it("passes correct href to each tile", () => {
      renderWithProviders(<SummaryTilesGrid />);

      const links = screen.getAllByRole("link");
      const hrefs = links.map(link => link.getAttribute("href"));

      expect(hrefs).toContain("/cases?status=pwd");
      expect(hrefs).toContain("/cases?status=recruitment");
      expect(hrefs).toContain("/cases?status=complete");
      expect(hrefs).toContain("/cases?status=closed");
    });
  });

  describe("responsive grid", () => {
    it("has responsive column classes", () => {
      mockSummaryData = createMockDashboardSummary();

      const { container } = renderWithProviders(<SummaryTilesGrid />);

      const grid = container.querySelector(".grid");
      expect(grid).toHaveClass("grid-cols-2", "md:grid-cols-3", "lg:grid-cols-6");
    });
  });
});
```

---

## Task 5: Implement Components to Pass Tests

Now implement the components. Run tests after each component to verify they pass.

### 5.1 ThemeToggle Component

**File:** `v2/src/components/layout/ThemeToggle.tsx`

```tsx
"use client";

import { useTheme } from "next-themes";
import { Button } from "@/components/ui/button";
import { Sun, Moon } from "lucide-react";

export function ThemeToggle() {
  const { theme, setTheme } = useTheme();

  return (
    <Button
      variant="ghost"
      size="icon"
      onClick={() => setTheme(theme === "dark" ? "light" : "dark")}
      aria-label="Toggle theme"
      className="border-2 border-black"
    >
      <Sun className="h-5 w-5 rotate-0 scale-100 transition-all dark:-rotate-90 dark:scale-0" />
      <Moon className="absolute h-5 w-5 rotate-90 scale-0 transition-all dark:rotate-0 dark:scale-100" />
    </Button>
  );
}
```

### 5.2 Header Component

**File:** `v2/src/components/layout/Header.tsx`

```tsx
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { ThemeToggle } from "./ThemeToggle";
import { cn } from "@/lib/utils";

const NAV_LINKS = [
  { href: "/dashboard", label: "Dashboard" },
  { href: "/cases", label: "Cases" },
  { href: "/calendar", label: "Calendar" },
  { href: "/notifications", label: "Notifications" },
  { href: "/settings", label: "Settings" },
];

export function Header() {
  const pathname = usePathname();
  const user = useQuery(api.users.currentUser);

  return (
    <header className="sticky top-0 z-50 bg-background border-b-4 border-black">
      <div className="container mx-auto px-4">
        <div className="flex items-center justify-between h-16">
          {/* Logo */}
          <Link href="/dashboard" className="flex items-center gap-2">
            <span className="font-heading text-xl font-bold">
              PERM Tracker
            </span>
          </Link>

          {/* Navigation */}
          <nav className="hidden md:flex items-center gap-1">
            {NAV_LINKS.map((link) => (
              <Link
                key={link.href}
                href={link.href}
                className={cn(
                  "px-4 py-2 font-medium transition-all duration-150",
                  "hover:bg-primary/10 border-b-2 border-transparent",
                  pathname === link.href
                    ? "border-primary text-primary"
                    : "text-muted-foreground hover:text-foreground"
                )}
              >
                {link.label}
              </Link>
            ))}
          </nav>

          {/* Right side: Theme toggle + User menu */}
          <div className="flex items-center gap-4">
            <ThemeToggle />
            {user && (
              <div className="flex items-center gap-2">
                <span className="text-sm font-medium hidden sm:inline">
                  {user.name || user.email}
                </span>
              </div>
            )}
          </div>
        </div>
      </div>
    </header>
  );
}
```

### 5.3 AuthHeader Component

**File:** `v2/src/components/layout/AuthHeader.tsx`

```tsx
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { ThemeToggle } from "./ThemeToggle";
import { cn } from "@/lib/utils";

const AUTH_NAV_LINKS = [
  { href: "/", label: "Home" },
  { href: "/demo", label: "Demo" },
];

export function AuthHeader() {
  const pathname = usePathname();
  const isSignIn = pathname === "/signin";
  const isSignUp = pathname === "/signup";

  return (
    <header className="sticky top-0 z-50 bg-background border-b-4 border-black">
      <div className="container mx-auto px-4">
        <div className="flex items-center justify-between h-16">
          {/* Logo */}
          <Link href="/" className="flex items-center gap-2">
            <span className="font-heading text-xl font-bold">
              PERM Tracker
            </span>
          </Link>

          {/* Navigation */}
          <nav className="hidden md:flex items-center gap-1">
            {AUTH_NAV_LINKS.map((link) => (
              <Link
                key={link.href}
                href={link.href}
                className={cn(
                  "px-4 py-2 font-medium transition-all duration-150",
                  "hover:bg-primary/10 border-b-2 border-transparent",
                  pathname === link.href
                    ? "border-primary text-primary"
                    : "text-muted-foreground hover:text-foreground"
                )}
              >
                {link.label}
              </Link>
            ))}
          </nav>

          {/* Right side: Theme toggle + Auth buttons */}
          <div className="flex items-center gap-3">
            <ThemeToggle />

            {!isSignIn && (
              <Link
                href="/signin"
                className={cn(
                  "px-4 py-2 font-medium border-2 border-black",
                  "transition-all duration-150",
                  "hover:bg-muted"
                )}
              >
                Sign In
              </Link>
            )}

            {!isSignUp && (
              <Link
                href="/signup"
                className={cn(
                  "px-4 py-2 font-medium border-4 border-black",
                  "bg-primary text-primary-foreground",
                  "shadow-hard transition-all duration-150",
                  "hover:-translate-x-0.5 hover:-translate-y-0.5 hover:shadow-hard-lg",
                  "active:translate-x-1 active:translate-y-1 active:shadow-none"
                )}
              >
                Sign Up
              </Link>
            )}
          </div>
        </div>
      </div>
    </header>
  );
}
```

### 5.4 AuthFooter Component

**File:** `v2/src/components/layout/AuthFooter.tsx`

```tsx
import Link from "next/link";

export function AuthFooter() {
  return (
    <footer className="border-t-4 border-black bg-background py-8">
      <div className="container mx-auto px-4">
        <div className="flex flex-col md:flex-row items-center justify-between gap-4">
          {/* Links */}
          <nav className="flex items-center gap-6 text-sm">
            <Link
              href="/privacy"
              className="text-muted-foreground hover:text-foreground transition-colors"
            >
              Privacy Policy
            </Link>
            <Link
              href="/terms"
              className="text-muted-foreground hover:text-foreground transition-colors"
            >
              Terms of Service
            </Link>
            <Link
              href="/contact"
              className="text-muted-foreground hover:text-foreground transition-colors"
            >
              Contact
            </Link>
          </nav>

          {/* Copyright */}
          <p className="text-sm text-muted-foreground">
            © {new Date().getFullYear()} PERM Tracker. All rights reserved.
          </p>
        </div>
      </div>
    </footer>
  );
}
```

### 5.5 SummaryTile Component

**File:** `v2/src/components/dashboard/SummaryTile.tsx`

```tsx
"use client";

import Link from "next/link";
import { cn } from "@/lib/utils";
import { CaseStatus } from "@/convex/lib/dashboard-types";

interface SummaryTileProps {
  status: CaseStatus | "complete" | "closed";
  count: number;
  subtext: string;
  href: string;
}

const STATUS_CONFIG: Record<string, { label: string; color: string; bgClass: string }> = {
  pwd: {
    label: "PWD",
    color: "var(--status-pwd)",
    bgClass: "bg-[#0066FF]/10 hover:bg-[#0066FF]/20",
  },
  recruitment: {
    label: "Recruitment",
    color: "var(--status-recruitment)",
    bgClass: "bg-[#9333ea]/10 hover:bg-[#9333ea]/20",
  },
  eta9089: {
    label: "ETA 9089",
    color: "var(--status-eta9089)",
    bgClass: "bg-[#D97706]/10 hover:bg-[#D97706]/20",
  },
  i140: {
    label: "I-140",
    color: "var(--status-i140)",
    bgClass: "bg-[#059669]/10 hover:bg-[#059669]/20",
  },
  complete: {
    label: "Complete",
    color: "var(--status-i140)",
    bgClass: "bg-[#059669]/10 hover:bg-[#059669]/20",
  },
  closed: {
    label: "Closed",
    color: "var(--status-closed)",
    bgClass: "bg-gray-500/10 hover:bg-gray-500/20",
  },
};

export function SummaryTile({ status, count, subtext, href }: SummaryTileProps) {
  const config = STATUS_CONFIG[status];

  return (
    <Link
      href={href}
      className={cn(
        "group relative block p-6 border-4 border-black",
        "transition-all duration-150 ease-out",
        "hover:-translate-x-0.5 hover:-translate-y-0.5",
        "hover:shadow-hard-lg active:translate-x-1 active:translate-y-1",
        "active:shadow-none",
        config.bgClass
      )}
    >
      {/* Corner label */}
      <div
        className="absolute -top-3 -left-3 w-8 h-8 border-4 border-black bg-background flex items-center justify-center font-mono text-sm font-bold"
        style={{ color: config.color }}
      >
        {count}
      </div>

      {/* Stage label with StageProgression effect */}
      <div className="relative inline-block mb-2">
        <span
          className="font-heading text-lg font-bold"
          style={{ color: config.color }}
        >
          {config.label}
        </span>
        {/* Expanding underline on hover */}
        <span
          className={cn(
            "absolute bottom-0 left-0 h-0.5 transition-all duration-200 ease-out",
            "w-0 group-hover:w-full"
          )}
          style={{ backgroundColor: config.color }}
        />
      </div>

      {/* Count */}
      <div className="font-mono text-4xl font-bold mb-1" style={{ color: config.color }}>
        {count}
      </div>

      {/* Subtext */}
      <p className="text-sm text-muted-foreground">
        {subtext}
      </p>
    </Link>
  );
}
```

### 5.6 SummaryTilesGrid Component

**File:** `v2/src/components/dashboard/SummaryTilesGrid.tsx`

```tsx
"use client";

import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { SummaryTile } from "./SummaryTile";
import { Skeleton } from "@/components/ui/skeleton";

export function SummaryTilesGrid() {
  const summary = useQuery(api.dashboard.getSummary);

  if (!summary) {
    return <SummaryTilesGridSkeleton />;
  }

  const tiles = [
    ...summary.statusCounts.map((sc) => ({
      status: sc.status,
      count: sc.total,
      subtext: sc.subtexts,
      href: `/cases?status=${sc.status}`,
    })),
    {
      status: "complete" as const,
      count: summary.completedCases,
      subtext: "I-140 Approved",
      href: "/cases?status=complete",
    },
    {
      status: "closed" as const,
      count: summary.closedCases,
      subtext: "Archived cases",
      href: "/cases?status=closed",
    },
  ];

  return (
    <section className="mb-8">
      <h2 className="font-heading text-2xl font-bold mb-4">
        Case Summary
      </h2>
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        {tiles.map((tile) => (
          <SummaryTile
            key={tile.status}
            status={tile.status}
            count={tile.count}
            subtext={tile.subtext}
            href={tile.href}
          />
        ))}
      </div>
    </section>
  );
}

function SummaryTilesGridSkeleton() {
  return (
    <section className="mb-8">
      <Skeleton className="h-8 w-40 mb-4" />
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        {Array.from({ length: 6 }).map((_, i) => (
          <Skeleton key={i} className="h-32 border-4 border-black" />
        ))}
      </div>
    </section>
  );
}
```

---

## Task 6: Implement Remaining Components (Layouts, UI Components, Pages)

### 6.1 Authenticated Layout

**File:** `v2/src/app/(authenticated)/layout.tsx`

```tsx
import { Header } from "@/components/layout/Header";

export default function AuthenticatedLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="min-h-screen bg-background">
      <div className="fixed inset-0 dot-bg opacity-30 pointer-events-none" />
      <Header />
      <main className="container mx-auto px-4 py-8 relative">
        {children}
      </main>
    </div>
  );
}
```

### 6.2 Auth Layout

**File:** `v2/src/app/(auth)/layout.tsx`

```tsx
import { AuthHeader } from "@/components/layout/AuthHeader";
import { AuthFooter } from "@/components/layout/AuthFooter";

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="min-h-screen bg-background flex flex-col">
      <div className="fixed inset-0 dot-bg opacity-30 pointer-events-none" />
      <AuthHeader />
      <main className="flex-1 container mx-auto px-4 py-8 relative flex items-center justify-center">
        {children}
      </main>
      <AuthFooter />
    </div>
  );
}
```

### 6.3 HazardStripes Component

**File:** `v2/src/components/ui/hazard-stripes.tsx`

```tsx
import { cn } from "@/lib/utils";

interface HazardStripesProps {
  className?: string;
  variant?: "footer" | "badge" | "full";
}

export function HazardStripes({ className, variant = "footer" }: HazardStripesProps) {
  const sizes = {
    footer: "h-2",
    badge: "h-1",
    full: "h-full w-full",
  };

  return (
    <div
      className={cn(sizes[variant], "bg-repeat", className)}
      style={{
        backgroundImage: `repeating-linear-gradient(
          -45deg,
          #FACC15,
          #FACC15 10px,
          #000000 10px,
          #000000 20px
        )`,
      }}
    />
  );
}
```

### 6.4 CornerLabel Component

**File:** `v2/src/components/ui/corner-label.tsx`

```tsx
import { cn } from "@/lib/utils";

interface CornerLabelProps {
  value: string | number;
  position?: "top-left" | "top-right" | "bottom-left" | "bottom-right";
  color?: string;
  className?: string;
}

export function CornerLabel({
  value,
  position = "top-left",
  color,
  className,
}: CornerLabelProps) {
  const positionClasses = {
    "top-left": "-top-3 -left-3",
    "top-right": "-top-3 -right-3",
    "bottom-left": "-bottom-3 -left-3",
    "bottom-right": "-bottom-3 -right-3",
  };

  return (
    <div
      className={cn(
        "absolute w-8 h-8 border-4 border-black bg-background",
        "flex items-center justify-center",
        "font-mono text-sm font-bold",
        positionClasses[position],
        className
      )}
      style={{ color }}
    >
      {value}
    </div>
  );
}
```

### 6.5 ProgressRing Component

**File:** `v2/src/components/ui/progress-ring.tsx`

```tsx
"use client";

import { cn } from "@/lib/utils";
import { useEffect, useRef, useState } from "react";

interface ProgressRingProps {
  value: number;
  size?: number;
  strokeWidth?: number;
  color?: string;
  className?: string;
  animateOnScroll?: boolean;
}

export function ProgressRing({
  value,
  size = 48,
  strokeWidth = 4,
  color = "var(--primary)",
  className,
  animateOnScroll = true,
}: ProgressRingProps) {
  const [isVisible, setIsVisible] = useState(!animateOnScroll);
  const [animatedValue, setAnimatedValue] = useState(0);
  const ref = useRef<SVGSVGElement>(null);

  const radius = (size - strokeWidth) / 2;
  const circumference = radius * 2 * Math.PI;
  const offset = circumference - (animatedValue / 100) * circumference;

  useEffect(() => {
    if (!animateOnScroll) {
      setAnimatedValue(value);
      return;
    }

    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          setIsVisible(true);
          observer.disconnect();
        }
      },
      { threshold: 0.5 }
    );

    if (ref.current) {
      observer.observe(ref.current);
    }

    return () => observer.disconnect();
  }, [animateOnScroll, value]);

  useEffect(() => {
    if (isVisible) {
      const duration = 800;
      const startTime = performance.now();

      const animate = (currentTime: number) => {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        setAnimatedValue(value * eased);

        if (progress < 1) {
          requestAnimationFrame(animate);
        }
      };

      requestAnimationFrame(animate);
    }
  }, [isVisible, value]);

  return (
    <svg
      ref={ref}
      width={size}
      height={size}
      className={cn("transform -rotate-90", className)}
    >
      <circle
        cx={size / 2}
        cy={size / 2}
        r={radius}
        fill="none"
        stroke="currentColor"
        strokeWidth={strokeWidth}
        className="text-muted/20"
      />
      <circle
        cx={size / 2}
        cy={size / 2}
        r={radius}
        fill="none"
        stroke={color}
        strokeWidth={strokeWidth}
        strokeDasharray={circumference}
        strokeDashoffset={offset}
        strokeLinecap="square"
        className="transition-all duration-300"
      />
    </svg>
  );
}
```

### 6.6 Placeholder Pages & Exports

Create placeholder pages for demo, privacy, terms, contact (as specified in original plan).

**File:** `v2/src/components/layout/index.ts`

```tsx
export { Header } from "./Header";
export { AuthHeader } from "./AuthHeader";
export { AuthFooter } from "./AuthFooter";
export { ThemeToggle } from "./ThemeToggle";
```

**File:** `v2/src/components/ui/index.ts` (add exports)

```tsx
export { HazardStripes } from "./hazard-stripes";
export { CornerLabel } from "./corner-label";
export { ProgressRing } from "./progress-ring";
```

---

## Verification

### Test Verification

```bash
cd v2 && npm test -- --testPathPattern="layout|SummaryTile"
```

**Expected:** All component tests pass.

### TypeScript Verification

```bash
cd v2 && npx tsc --noEmit
```

**Expected:** No TypeScript errors.

### Visual Verification

1. Run `cd v2 && npm run dev`
2. Navigate to `/dashboard` - verify header, nav links, dark mode toggle
3. Navigate to `/signin` - verify AuthHeader with context-aware buttons
4. Verify Summary Tiles render with correct colors
5. Verify StageProgression hover effect (expanding underline)

---

## Success Criteria

### Tests
- [ ] Header tests pass (logo, nav links, active state, styling)
- [ ] AuthHeader tests pass (context-aware buttons, styling)
- [ ] AuthFooter tests pass (links, copyright)
- [ ] SummaryTile tests pass (rendering, status colors, hover effects)
- [ ] SummaryTilesGrid tests pass (loading, data, responsive)

### UI
- [ ] Header with all nav links (Dashboard, Cases, Calendar, Notifications, Settings)
- [ ] Dark mode toggle works and persists
- [ ] Summary Tiles show all 6 statuses with correct colors
- [ ] StageProgression expanding underline effect works on hover
- [ ] Corner labels show counts
- [ ] Auth pages have header/footer with context-aware buttons
- [ ] Skeleton loading states work
- [ ] Responsive across devices

### General
- [ ] No TypeScript errors
- [ ] All tests pass

---

## Output

**Test files created:**
- `v2/test-utils/ui-fixtures.ts`
- `v2/test-utils/render-utils.tsx`
- `v2/src/components/layout/__tests__/Header.test.tsx`
- `v2/src/components/layout/__tests__/AuthHeader.test.tsx`
- `v2/src/components/layout/__tests__/AuthFooter.test.tsx`
- `v2/src/components/dashboard/__tests__/SummaryTile.test.tsx`
- `v2/src/components/dashboard/__tests__/SummaryTilesGrid.test.tsx`

**Component files created:**
- `v2/src/components/layout/Header.tsx`
- `v2/src/components/layout/AuthHeader.tsx`
- `v2/src/components/layout/AuthFooter.tsx`
- `v2/src/components/layout/ThemeToggle.tsx`
- `v2/src/components/layout/index.ts`
- `v2/src/components/dashboard/SummaryTile.tsx`
- `v2/src/components/dashboard/SummaryTilesGrid.tsx`
- `v2/src/components/ui/hazard-stripes.tsx`
- `v2/src/components/ui/corner-label.tsx`
- `v2/src/components/ui/progress-ring.tsx`
- `v2/src/app/(authenticated)/layout.tsx`
- `v2/src/app/(auth)/layout.tsx`

**Ready for:** 20-03-PLAN.md (Deadline Hero Widget)
