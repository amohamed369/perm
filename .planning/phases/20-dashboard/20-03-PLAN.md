# Phase 20-03: Deadline Hero Widget

## Objective

Build the Deadline Hero Widget - the crown jewel of the dashboard. This component shows deadlines grouped by urgency (overdue, this week, this month, later) with hazard stripes on overdue items, staggered animations, dismissible deadlines, and quick-peek hover cards.

**TDD Approach:** Write component tests FIRST, then implement components to pass tests.

## ⚠️ CRITICAL: Required Reading Before Implementation

**You MUST read these files before starting ANY implementation work:**

1. **Frontend Design Skill** (MANDATORY):
   - `/Users/adammohamed/cc/perm-tracker-test/.planning/FRONTEND_DESIGN_SKILL.md`

2. **PERM Flow Source of Truth** (MANDATORY):
   - `/Users/adammohamed/cc/perm-tracker-test/perm_flow.md`

3. **Design Reference Images** (MANDATORY for UI work):
   - `/Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design4` (Flash UI - primary)

4. **Phase Context**:
   - `/Users/adammohamed/cc/perm-tracker-test/.planning/phases/20-dashboard/20-CONTEXT.md`

5. **Deadline System**:
   - `/Users/adammohamed/cc/perm-tracker-test/.planning/V2_DEADLINE_SYSTEM.md`

### Subagent Instructions

**If you spawn ANY subagents or use the Task tool, you MUST include in their prompt:**

```
REQUIRED READING - Read these files BEFORE any implementation:
1. /Users/adammohamed/cc/perm-tracker-test/.planning/FRONTEND_DESIGN_SKILL.md
2. /Users/adammohamed/cc/perm-tracker-test/perm_flow.md
3. /Users/adammohamed/cc/perm-tracker-test/.planning/phases/20-dashboard/20-CONTEXT.md
4. /Users/adammohamed/cc/perm-tracker-test/.planning/V2_DEADLINE_SYSTEM.md
5. v2/docs/DESIGN_SYSTEM.md
6. /Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design3
7. /Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design4
8. /Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design5
```

## Execution Context

```
@.planning/FRONTEND_DESIGN_SKILL.md
@.planning/phases/20-dashboard/20-CONTEXT.md
@.planning/V2_DEADLINE_SYSTEM.md
@v2/docs/DESIGN_SYSTEM.md
@v2/src/components/ui/
@v2/convex/dashboard.ts
```

## Context

**From 20-CONTEXT.md:**
- 4 urgency groups: overdue, this week, this month, later
- Auto-refresh every 5 minutes
- Click → case detail
- Badge counts per group
- Hazard stripes on overdue items
- Dismissible deadlines synced to DB
- Manual refresh button
- "+N more" overflow (show 5 per group, expand to show all)
- Staggered slide-in animations
- Quick-peek hover cards on deadline items

**Urgency colors:**
- Overdue: `#DC2626` (red)
- This week: `#EA580C` (orange)
- This month: `#FACC15` (yellow)
- Later: `#059669` (green)

---

## Task 1: Create Deadline Widget Test Fixtures

**File:** `v2/test-utils/deadline-fixtures.ts`

```typescript
// v2/test-utils/deadline-fixtures.ts
import { DeadlineItem, DeadlineGroups, Urgency } from "@/convex/lib/dashboard-types";
import { Id } from "@/convex/_generated/dataModel";

/**
 * Factory for creating mock deadline items
 */
export function createMockDeadlineItem(
  overrides: Partial<DeadlineItem> = {}
): DeadlineItem {
  return {
    caseId: "case_123" as Id<"cases">,
    caseNumber: "CASE-2024-001",
    employerName: "Tech Corp Inc",
    beneficiaryName: "John Smith",
    caseStatus: "pwd",
    deadlineType: "pwd_expiration",
    deadlineLabel: "PWD Expires",
    dueDate: "2024-02-15",
    daysUntil: 5,
    urgency: "thisWeek",
    ...overrides,
  };
}

/**
 * Factory for creating overdue deadline
 */
export function createOverdueDeadline(
  overrides: Partial<DeadlineItem> = {}
): DeadlineItem {
  return createMockDeadlineItem({
    daysUntil: -3,
    urgency: "overdue",
    deadlineLabel: "PWD Expired",
    ...overrides,
  });
}

/**
 * Factory for creating this week deadline
 */
export function createThisWeekDeadline(
  overrides: Partial<DeadlineItem> = {}
): DeadlineItem {
  return createMockDeadlineItem({
    daysUntil: 5,
    urgency: "thisWeek",
    ...overrides,
  });
}

/**
 * Factory for creating this month deadline
 */
export function createThisMonthDeadline(
  overrides: Partial<DeadlineItem> = {}
): DeadlineItem {
  return createMockDeadlineItem({
    daysUntil: 20,
    urgency: "thisMonth",
    ...overrides,
  });
}

/**
 * Factory for creating later deadline
 */
export function createLaterDeadline(
  overrides: Partial<DeadlineItem> = {}
): DeadlineItem {
  return createMockDeadlineItem({
    daysUntil: 45,
    urgency: "later",
    ...overrides,
  });
}

/**
 * Factory for creating full deadline groups
 */
export function createMockDeadlineGroups(
  overrides: Partial<DeadlineGroups> = {}
): DeadlineGroups {
  return {
    overdue: [
      createOverdueDeadline({ caseNumber: "CASE-001", daysUntil: -5 }),
      createOverdueDeadline({ caseNumber: "CASE-002", daysUntil: -2 }),
    ],
    thisWeek: [
      createThisWeekDeadline({ caseNumber: "CASE-003", daysUntil: 2 }),
      createThisWeekDeadline({ caseNumber: "CASE-004", daysUntil: 5 }),
      createThisWeekDeadline({ caseNumber: "CASE-005", daysUntil: 7 }),
    ],
    thisMonth: [
      createThisMonthDeadline({ caseNumber: "CASE-006", daysUntil: 15 }),
      createThisMonthDeadline({ caseNumber: "CASE-007", daysUntil: 25 }),
    ],
    later: [
      createLaterDeadline({ caseNumber: "CASE-008", daysUntil: 45 }),
    ],
    totalCount: 8,
    ...overrides,
  };
}

/**
 * Factory for empty deadline groups
 */
export function createEmptyDeadlineGroups(): DeadlineGroups {
  return {
    overdue: [],
    thisWeek: [],
    thisMonth: [],
    later: [],
    totalCount: 0,
  };
}

/**
 * Factory for deadline groups with many items (for overflow testing)
 */
export function createManyDeadlinesGroup(count: number, urgency: Urgency): DeadlineItem[] {
  return Array.from({ length: count }, (_, i) =>
    createMockDeadlineItem({
      caseNumber: `CASE-${String(i + 1).padStart(3, "0")}`,
      urgency,
      daysUntil: urgency === "overdue" ? -(i + 1) : i + 1,
    })
  );
}

/**
 * Urgency styling expectations
 */
export const URGENCY_STYLES = {
  overdue: {
    border: "border-red-600",
    bg: "bg-red-50",
    badge: "bg-red-600",
    text: "text-red-600",
  },
  thisWeek: {
    border: "border-orange-500",
    bg: "bg-orange-50",
    badge: "bg-orange-500",
    text: "text-orange-600",
  },
  thisMonth: {
    border: "border-yellow-500",
    bg: "bg-yellow-50",
    badge: "bg-yellow-500",
    text: "text-yellow-600",
  },
  later: {
    border: "border-green-600",
    bg: "bg-green-50",
    badge: "bg-green-600",
    text: "text-green-600",
  },
} as const;
```

---

## Task 2: Write DeadlineItem Component Tests FIRST

**File:** `v2/src/components/dashboard/__tests__/DeadlineItem.test.tsx`

```typescript
// v2/src/components/dashboard/__tests__/DeadlineItem.test.tsx
import { render, screen, fireEvent } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { DeadlineItem } from "../DeadlineItem";
import {
  createMockDeadlineItem,
  createOverdueDeadline,
  createThisWeekDeadline,
} from "@/test-utils/deadline-fixtures";
import { renderWithProviders } from "@/test-utils/render-utils";

describe("DeadlineItem", () => {
  const defaultDeadline = createMockDeadlineItem();
  const mockOnDismiss = jest.fn();

  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe("rendering", () => {
    it("renders case number", () => {
      renderWithProviders(<DeadlineItem deadline={defaultDeadline} index={0} />);

      expect(screen.getByText(defaultDeadline.caseNumber)).toBeInTheDocument();
    });

    it("renders employer name", () => {
      renderWithProviders(<DeadlineItem deadline={defaultDeadline} index={0} />);

      expect(screen.getByText(defaultDeadline.employerName)).toBeInTheDocument();
    });

    it("renders beneficiary name", () => {
      renderWithProviders(<DeadlineItem deadline={defaultDeadline} index={0} />);

      expect(screen.getByText(defaultDeadline.beneficiaryName)).toBeInTheDocument();
    });

    it("renders deadline label", () => {
      renderWithProviders(<DeadlineItem deadline={defaultDeadline} index={0} />);

      expect(screen.getByText(defaultDeadline.deadlineLabel)).toBeInTheDocument();
    });

    it("renders days until count", () => {
      renderWithProviders(<DeadlineItem deadline={defaultDeadline} index={0} />);

      expect(screen.getByText(String(defaultDeadline.daysUntil))).toBeInTheDocument();
    });

    it("is a link to case detail", () => {
      renderWithProviders(<DeadlineItem deadline={defaultDeadline} index={0} />);

      const link = screen.getByRole("link");
      expect(link).toHaveAttribute("href", `/cases/${defaultDeadline.caseId}`);
    });
  });

  describe("overdue styling", () => {
    it("shows hazard stripes when overdue", () => {
      const overdueDeadline = createOverdueDeadline();
      const { container } = renderWithProviders(
        <DeadlineItem deadline={overdueDeadline} index={0} />
      );

      // Hazard stripes should be present
      const hazardStripes = container.querySelector('[style*="repeating-linear-gradient"]');
      expect(hazardStripes).toBeInTheDocument();
    });

    it("has red border when overdue", () => {
      const overdueDeadline = createOverdueDeadline();
      renderWithProviders(<DeadlineItem deadline={overdueDeadline} index={0} />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("border-red-600");
    });

    it("shows absolute days for overdue (no negative)", () => {
      const overdueDeadline = createOverdueDeadline({ daysUntil: -5 });
      renderWithProviders(<DeadlineItem deadline={overdueDeadline} index={0} />);

      expect(screen.getByText("5")).toBeInTheDocument();
      expect(screen.getByText("days ago")).toBeInTheDocument();
    });

    it("does NOT show hazard stripes when not overdue", () => {
      const thisWeekDeadline = createThisWeekDeadline();
      const { container } = renderWithProviders(
        <DeadlineItem deadline={thisWeekDeadline} index={0} />
      );

      const hazardStripes = container.querySelector('[style*="repeating-linear-gradient"]');
      expect(hazardStripes).not.toBeInTheDocument();
    });
  });

  describe("staggered animation", () => {
    it("has animation delay based on index", () => {
      const { container } = renderWithProviders(
        <DeadlineItem deadline={defaultDeadline} index={2} />
      );

      const wrapper = container.firstChild;
      expect(wrapper).toHaveStyle({ animationDelay: "100ms" }); // 2 * 50ms
    });

    it("has slide-in animation class", () => {
      const { container } = renderWithProviders(
        <DeadlineItem deadline={defaultDeadline} index={0} />
      );

      const wrapper = container.firstChild;
      expect(wrapper).toHaveClass("animate-in", "slide-in-from-right-4");
    });
  });

  describe("dismiss functionality", () => {
    it("shows dismiss button on hover when onDismiss provided", async () => {
      const user = userEvent.setup();
      renderWithProviders(
        <DeadlineItem
          deadline={defaultDeadline}
          index={0}
          onDismiss={mockOnDismiss}
        />
      );

      // Initially hidden
      const dismissButton = screen.getByRole("button", { name: /dismiss/i });
      expect(dismissButton).toHaveClass("opacity-0");

      // Shows on hover via group-hover
      expect(dismissButton).toHaveClass("group-hover:opacity-100");
    });

    it("calls onDismiss with correct args when clicked", async () => {
      const user = userEvent.setup();
      renderWithProviders(
        <DeadlineItem
          deadline={defaultDeadline}
          index={0}
          onDismiss={mockOnDismiss}
        />
      );

      const dismissButton = screen.getByRole("button", { name: /dismiss/i });
      await user.click(dismissButton);

      expect(mockOnDismiss).toHaveBeenCalledWith(
        defaultDeadline.caseId.toString(),
        defaultDeadline.deadlineType
      );
    });

    it("does not render dismiss button when onDismiss not provided", () => {
      renderWithProviders(<DeadlineItem deadline={defaultDeadline} index={0} />);

      expect(screen.queryByRole("button", { name: /dismiss/i })).not.toBeInTheDocument();
    });
  });

  describe("quick-peek hover card", () => {
    it("shows hover card on mouse enter", async () => {
      const user = userEvent.setup();
      const { container } = renderWithProviders(
        <DeadlineItem deadline={defaultDeadline} index={0} />
      );

      const wrapper = container.firstChild as Element;
      fireEvent.mouseEnter(wrapper);

      // Hover card should appear
      expect(screen.getByText("Case #")).toBeInTheDocument();
      expect(screen.getByText("Beneficiary")).toBeInTheDocument();
      expect(screen.getByText("Due")).toBeInTheDocument();
    });

    it("hides hover card on mouse leave", async () => {
      const { container } = renderWithProviders(
        <DeadlineItem deadline={defaultDeadline} index={0} />
      );

      const wrapper = container.firstChild as Element;
      fireEvent.mouseEnter(wrapper);
      fireEvent.mouseLeave(wrapper);

      expect(screen.queryByText("Case #")).not.toBeInTheDocument();
    });

    it("hover card shows case details", () => {
      const { container } = renderWithProviders(
        <DeadlineItem deadline={defaultDeadline} index={0} />
      );

      fireEvent.mouseEnter(container.firstChild as Element);

      expect(screen.getByText(defaultDeadline.caseNumber)).toBeInTheDocument();
      expect(screen.getByText(defaultDeadline.beneficiaryName)).toBeInTheDocument();
      expect(screen.getByText(defaultDeadline.dueDate)).toBeInTheDocument();
    });
  });

  describe("neobrutalist styling", () => {
    it("has 4px black border", () => {
      renderWithProviders(<DeadlineItem deadline={defaultDeadline} index={0} />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("border-4", "border-black");
    });

    it("has hover transform", () => {
      renderWithProviders(<DeadlineItem deadline={defaultDeadline} index={0} />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("hover:-translate-x-0.5", "hover:-translate-y-0.5");
    });
  });
});
```

---

## Task 3: Write UrgencyGroup Component Tests FIRST

**File:** `v2/src/components/dashboard/__tests__/UrgencyGroup.test.tsx`

```typescript
// v2/src/components/dashboard/__tests__/UrgencyGroup.test.tsx
import { render, screen, fireEvent } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { UrgencyGroup } from "../UrgencyGroup";
import {
  createManyDeadlinesGroup,
  createOverdueDeadline,
  URGENCY_STYLES,
} from "@/test-utils/deadline-fixtures";
import { renderWithProviders } from "@/test-utils/render-utils";

describe("UrgencyGroup", () => {
  const overdueItems = [
    createOverdueDeadline({ caseNumber: "CASE-001" }),
    createOverdueDeadline({ caseNumber: "CASE-002" }),
  ];

  const mockOnDismiss = jest.fn();

  beforeEach(() => {
    jest.clearAllMocks();
  });

  describe("rendering", () => {
    it("renders group title", () => {
      renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={overdueItems}
          urgency="overdue"
        />
      );

      expect(screen.getByRole("heading", { name: /overdue/i })).toBeInTheDocument();
    });

    it("renders item count badge", () => {
      renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={overdueItems}
          urgency="overdue"
        />
      );

      expect(screen.getByText("2")).toBeInTheDocument();
    });

    it("renders all items when expanded", () => {
      renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={overdueItems}
          urgency="overdue"
          defaultExpanded={true}
        />
      );

      expect(screen.getByText("CASE-001")).toBeInTheDocument();
      expect(screen.getByText("CASE-002")).toBeInTheDocument();
    });

    it("returns null when no items", () => {
      const { container } = renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={[]}
          urgency="overdue"
        />
      );

      expect(container).toBeEmptyDOMElement();
    });
  });

  describe("expand/collapse", () => {
    it("collapses when header clicked while expanded", async () => {
      const user = userEvent.setup();
      renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={overdueItems}
          urgency="overdue"
          defaultExpanded={true}
        />
      );

      const header = screen.getByRole("button");
      await user.click(header);

      expect(screen.queryByText("CASE-001")).not.toBeInTheDocument();
    });

    it("expands when header clicked while collapsed", async () => {
      const user = userEvent.setup();
      renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={overdueItems}
          urgency="overdue"
          defaultExpanded={false}
        />
      );

      expect(screen.queryByText("CASE-001")).not.toBeInTheDocument();

      const header = screen.getByRole("button");
      await user.click(header);

      expect(screen.getByText("CASE-001")).toBeInTheDocument();
    });

    it("shows chevron up when expanded", () => {
      const { container } = renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={overdueItems}
          urgency="overdue"
          defaultExpanded={true}
        />
      );

      // ChevronUp icon should be visible
      const chevronUp = container.querySelector('[class*="lucide-chevron-up"]');
      expect(chevronUp).toBeInTheDocument();
    });

    it("shows chevron down when collapsed", () => {
      const { container } = renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={overdueItems}
          urgency="overdue"
          defaultExpanded={false}
        />
      );

      const chevronDown = container.querySelector('[class*="lucide-chevron-down"]');
      expect(chevronDown).toBeInTheDocument();
    });
  });

  describe("overflow pattern (+N more)", () => {
    it("shows only maxItems initially", () => {
      const manyItems = createManyDeadlinesGroup(8, "overdue");
      renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={manyItems}
          urgency="overdue"
          maxItems={5}
          defaultExpanded={true}
        />
      );

      // Should show 5 items
      expect(screen.getByText("CASE-001")).toBeInTheDocument();
      expect(screen.getByText("CASE-005")).toBeInTheDocument();

      // Should NOT show items 6-8
      expect(screen.queryByText("CASE-006")).not.toBeInTheDocument();
    });

    it("shows +N more button when items exceed maxItems", () => {
      const manyItems = createManyDeadlinesGroup(8, "overdue");
      renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={manyItems}
          urgency="overdue"
          maxItems={5}
          defaultExpanded={true}
        />
      );

      expect(screen.getByText("+3 more")).toBeInTheDocument();
    });

    it("shows all items when +N more clicked", async () => {
      const user = userEvent.setup();
      const manyItems = createManyDeadlinesGroup(8, "overdue");
      renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={manyItems}
          urgency="overdue"
          maxItems={5}
          defaultExpanded={true}
        />
      );

      await user.click(screen.getByText("+3 more"));

      expect(screen.getByText("CASE-006")).toBeInTheDocument();
      expect(screen.getByText("CASE-008")).toBeInTheDocument();
    });

    it("shows Show less button after expanding", async () => {
      const user = userEvent.setup();
      const manyItems = createManyDeadlinesGroup(8, "overdue");
      renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={manyItems}
          urgency="overdue"
          maxItems={5}
          defaultExpanded={true}
        />
      );

      await user.click(screen.getByText("+3 more"));

      expect(screen.getByText("Show less")).toBeInTheDocument();
    });

    it("does not show +N more when items <= maxItems", () => {
      const fewItems = createManyDeadlinesGroup(3, "overdue");
      renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={fewItems}
          urgency="overdue"
          maxItems={5}
          defaultExpanded={true}
        />
      );

      expect(screen.queryByText(/more/)).not.toBeInTheDocument();
    });
  });

  describe("urgency-specific styling", () => {
    it("overdue group has red styling", () => {
      const { container } = renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={overdueItems}
          urgency="overdue"
        />
      );

      const group = container.firstChild;
      expect(group).toHaveClass("border-4", "border-black");

      const heading = screen.getByRole("heading");
      expect(heading).toHaveClass("text-red-600");
    });

    it("thisWeek group has orange styling", () => {
      renderWithProviders(
        <UrgencyGroup
          title="This Week"
          items={overdueItems}
          urgency="thisWeek"
        />
      );

      const heading = screen.getByRole("heading");
      expect(heading).toHaveClass("text-orange-600");
    });

    it("thisMonth group has yellow styling", () => {
      renderWithProviders(
        <UrgencyGroup
          title="This Month"
          items={overdueItems}
          urgency="thisMonth"
        />
      );

      const heading = screen.getByRole("heading");
      expect(heading).toHaveClass("text-yellow-600");
    });

    it("later group has green styling", () => {
      renderWithProviders(
        <UrgencyGroup
          title="Later"
          items={overdueItems}
          urgency="later"
        />
      );

      const heading = screen.getByRole("heading");
      expect(heading).toHaveClass("text-green-600");
    });
  });

  describe("dismiss propagation", () => {
    it("passes onDismiss to DeadlineItem children", async () => {
      const user = userEvent.setup();
      renderWithProviders(
        <UrgencyGroup
          title="Overdue"
          items={overdueItems}
          urgency="overdue"
          onDismiss={mockOnDismiss}
          defaultExpanded={true}
        />
      );

      const dismissButtons = screen.getAllByRole("button", { name: /dismiss/i });
      await user.click(dismissButtons[0]);

      expect(mockOnDismiss).toHaveBeenCalled();
    });
  });
});
```

---

## Task 4: Write DeadlineHeroWidget Component Tests FIRST

**File:** `v2/src/components/dashboard/__tests__/DeadlineHeroWidget.test.tsx`

```typescript
// v2/src/components/dashboard/__tests__/DeadlineHeroWidget.test.tsx
import { render, screen, act } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { DeadlineHeroWidget } from "../DeadlineHeroWidget";
import {
  createMockDeadlineGroups,
  createEmptyDeadlineGroups,
} from "@/test-utils/deadline-fixtures";
import { renderWithProviders } from "@/test-utils/render-utils";

// Mock convex/react
let mockDeadlinesData: ReturnType<typeof createMockDeadlineGroups> | undefined;
jest.mock("convex/react", () => ({
  useQuery: jest.fn(() => mockDeadlinesData),
  useMutation: jest.fn(() => jest.fn()),
}));

// Mock timers for auto-refresh testing
jest.useFakeTimers();

describe("DeadlineHeroWidget", () => {
  beforeEach(() => {
    jest.clearAllMocks();
    mockDeadlinesData = undefined;
  });

  afterEach(() => {
    jest.runOnlyPendingTimers();
  });

  describe("loading state", () => {
    it("renders skeleton when data is loading", () => {
      mockDeadlinesData = undefined;
      const { container } = renderWithProviders(<DeadlineHeroWidget />);

      // Should show skeleton tiles
      const skeletons = container.querySelectorAll(".h-64");
      expect(skeletons.length).toBe(4);
    });

    it("renders header skeleton", () => {
      mockDeadlinesData = undefined;
      const { container } = renderWithProviders(<DeadlineHeroWidget />);

      const headerSkeleton = container.querySelector(".h-8.w-48");
      expect(headerSkeleton).toBeInTheDocument();
    });
  });

  describe("with data", () => {
    beforeEach(() => {
      mockDeadlinesData = createMockDeadlineGroups();
    });

    it("renders Deadline Hub heading", () => {
      renderWithProviders(<DeadlineHeroWidget />);

      expect(screen.getByRole("heading", { name: /deadline hub/i })).toBeInTheDocument();
    });

    it("renders total count badge", () => {
      renderWithProviders(<DeadlineHeroWidget />);

      expect(screen.getByText("8")).toBeInTheDocument(); // totalCount from mock
    });

    it("renders all 4 urgency groups", () => {
      renderWithProviders(<DeadlineHeroWidget />);

      expect(screen.getByText("Overdue")).toBeInTheDocument();
      expect(screen.getByText("This Week")).toBeInTheDocument();
      expect(screen.getByText("This Month")).toBeInTheDocument();
      expect(screen.getByText("Later")).toBeInTheDocument();
    });

    it("renders refresh button", () => {
      renderWithProviders(<DeadlineHeroWidget />);

      expect(screen.getByRole("button", { name: /refresh/i })).toBeInTheDocument();
    });

    it("shows last updated time", () => {
      renderWithProviders(<DeadlineHeroWidget />);

      expect(screen.getByText(/updated/i)).toBeInTheDocument();
    });
  });

  describe("empty state", () => {
    beforeEach(() => {
      mockDeadlinesData = createEmptyDeadlineGroups();
    });

    it("shows empty state message when no deadlines", () => {
      renderWithProviders(<DeadlineHeroWidget />);

      expect(screen.getByText(/no upcoming deadlines/i)).toBeInTheDocument();
    });

    it("shows call to action for empty state", () => {
      renderWithProviders(<DeadlineHeroWidget />);

      expect(screen.getByText(/create a case/i)).toBeInTheDocument();
    });
  });

  describe("refresh functionality", () => {
    beforeEach(() => {
      mockDeadlinesData = createMockDeadlineGroups();
    });

    it("shows spinner when refresh button clicked", async () => {
      const user = userEvent.setup({ advanceTimers: jest.advanceTimersByTime });
      const { container } = renderWithProviders(<DeadlineHeroWidget />);

      const refreshButton = screen.getByRole("button", { name: /refresh/i });
      await user.click(refreshButton);

      // Refresh icon should have animate-spin class
      const spinner = container.querySelector(".animate-spin");
      expect(spinner).toBeInTheDocument();
    });

    it("updates last refresh time on click", async () => {
      const user = userEvent.setup({ advanceTimers: jest.advanceTimersByTime });
      renderWithProviders(<DeadlineHeroWidget />);

      const refreshButton = screen.getByRole("button", { name: /refresh/i });
      await user.click(refreshButton);

      expect(screen.getByText(/just now/i)).toBeInTheDocument();
    });
  });

  describe("auto-refresh", () => {
    beforeEach(() => {
      mockDeadlinesData = createMockDeadlineGroups();
    });

    it("auto-refreshes every 5 minutes", () => {
      renderWithProviders(<DeadlineHeroWidget />);

      // Initial state
      expect(screen.getByText(/just now/i)).toBeInTheDocument();

      // Advance 5 minutes
      act(() => {
        jest.advanceTimersByTime(5 * 60 * 1000);
      });

      // Should have updated (we can't test the actual time change easily,
      // but the timer callback should have fired)
    });
  });

  describe("urgency group expansion", () => {
    beforeEach(() => {
      mockDeadlinesData = createMockDeadlineGroups();
    });

    it("overdue and thisWeek expanded by default", () => {
      renderWithProviders(<DeadlineHeroWidget />);

      // Overdue items should be visible
      expect(screen.getByText("CASE-001")).toBeInTheDocument();
      // This week items should be visible
      expect(screen.getByText("CASE-003")).toBeInTheDocument();
    });

    it("later collapsed by default", () => {
      renderWithProviders(<DeadlineHeroWidget />);

      // Later items should NOT be visible initially
      // (The group header should be visible but items hidden)
      // We check the actual deadline item text isn't rendered when collapsed
      expect(screen.queryByText("CASE-008")).not.toBeInTheDocument();
    });
  });

  describe("responsive layout", () => {
    beforeEach(() => {
      mockDeadlinesData = createMockDeadlineGroups();
    });

    it("has 2-column grid on desktop", () => {
      const { container } = renderWithProviders(<DeadlineHeroWidget />);

      const grid = container.querySelector(".md\\:grid-cols-2");
      expect(grid).toBeInTheDocument();
    });
  });

  describe("clock icon", () => {
    beforeEach(() => {
      mockDeadlinesData = createMockDeadlineGroups();
    });

    it("renders clock icon in header", () => {
      const { container } = renderWithProviders(<DeadlineHeroWidget />);

      const clockIcon = container.querySelector('[class*="lucide-clock"]');
      expect(clockIcon).toBeInTheDocument();
    });
  });
});
```

---

## Task 5: Implement DeadlineItem Component to Pass Tests

**File:** `v2/src/components/dashboard/DeadlineItem.tsx`

```tsx
"use client";

import Link from "next/link";
import { useState } from "react";
import { cn } from "@/lib/utils";
import { HazardStripes } from "@/components/ui/hazard-stripes";
import { CaseStageBadge } from "@/components/status/CaseStageBadge";
import { DeadlineItem as DeadlineItemType } from "@/convex/lib/dashboard-types";
import { X } from "lucide-react";

interface DeadlineItemProps {
  deadline: DeadlineItemType;
  index: number;
  onDismiss?: (caseId: string, deadlineType: string) => void;
}

export function DeadlineItem({ deadline, index, onDismiss }: DeadlineItemProps) {
  const [isHovered, setIsHovered] = useState(false);
  const isOverdue = deadline.urgency === "overdue";

  return (
    <div
      className={cn(
        "relative group",
        "animate-in slide-in-from-right-4 fade-in duration-300",
      )}
      style={{ animationDelay: `${index * 50}ms` }}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      <Link
        href={`/cases/${deadline.caseId}`}
        className={cn(
          "block p-4 border-4 border-black bg-background",
          "transition-all duration-150 ease-out",
          "hover:-translate-x-0.5 hover:-translate-y-0.5 hover:shadow-hard",
          "active:translate-x-1 active:translate-y-1 active:shadow-none",
          isOverdue && "border-red-600"
        )}
      >
        {/* Hazard stripes footer for overdue */}
        {isOverdue && (
          <HazardStripes variant="footer" className="absolute bottom-0 left-0 right-0" />
        )}

        <div className="flex items-start justify-between gap-4">
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2 mb-1">
              <CaseStageBadge status={deadline.caseStatus} size="sm" />
              <span className="font-mono text-sm text-muted-foreground truncate">
                {deadline.caseNumber}
              </span>
            </div>

            <p className="font-medium truncate">
              {deadline.employerName}
            </p>
            <p className="text-sm text-muted-foreground truncate">
              {deadline.beneficiaryName}
            </p>

            <p className={cn(
              "text-sm font-medium mt-2",
              isOverdue ? "text-red-600" : "text-foreground"
            )}>
              {deadline.deadlineLabel}
            </p>
          </div>

          <div className={cn(
            "flex flex-col items-end",
            isOverdue ? "text-red-600" : deadline.urgency === "thisWeek" ? "text-orange-600" : "text-foreground"
          )}>
            <span className="font-mono text-2xl font-bold">
              {Math.abs(deadline.daysUntil)}
            </span>
            <span className="text-xs uppercase">
              {deadline.daysUntil < 0 ? "days ago" : deadline.daysUntil === 0 ? "today" : "days"}
            </span>
          </div>
        </div>
      </Link>

      {/* Dismiss button */}
      {onDismiss && (
        <button
          onClick={(e) => {
            e.preventDefault();
            onDismiss(deadline.caseId.toString(), deadline.deadlineType);
          }}
          className={cn(
            "absolute -top-2 -right-2 w-6 h-6",
            "flex items-center justify-center",
            "bg-background border-2 border-black",
            "opacity-0 group-hover:opacity-100",
            "transition-opacity duration-150",
            "hover:bg-red-100 hover:border-red-600"
          )}
          aria-label="Dismiss deadline"
        >
          <X className="w-4 h-4" />
        </button>
      )}

      {/* Quick-peek hover card */}
      {isHovered && (
        <div className={cn(
          "absolute z-50 left-full ml-2 top-0",
          "w-64 p-4 bg-background border-4 border-black shadow-hard",
          "animate-in fade-in slide-in-from-left-2 duration-150"
        )}>
          <h4 className="font-heading font-bold mb-2">
            {deadline.employerName}
          </h4>
          <dl className="space-y-1 text-sm">
            <div className="flex justify-between">
              <dt className="text-muted-foreground">Case #</dt>
              <dd className="font-mono">{deadline.caseNumber}</dd>
            </div>
            <div className="flex justify-between">
              <dt className="text-muted-foreground">Beneficiary</dt>
              <dd className="truncate ml-2">{deadline.beneficiaryName}</dd>
            </div>
            <div className="flex justify-between">
              <dt className="text-muted-foreground">Deadline</dt>
              <dd>{deadline.deadlineLabel}</dd>
            </div>
            <div className="flex justify-between">
              <dt className="text-muted-foreground">Due</dt>
              <dd className="font-mono">{deadline.dueDate}</dd>
            </div>
          </dl>
        </div>
      )}
    </div>
  );
}
```

---

## Task 6: Implement UrgencyGroup Component to Pass Tests

**File:** `v2/src/components/dashboard/UrgencyGroup.tsx`

```tsx
"use client";

import { useState } from "react";
import { cn } from "@/lib/utils";
import { DeadlineItem as DeadlineItemComponent } from "./DeadlineItem";
import { DeadlineItem } from "@/convex/lib/dashboard-types";
import { ChevronDown, ChevronUp } from "lucide-react";

interface UrgencyGroupProps {
  title: string;
  items: DeadlineItem[];
  urgency: "overdue" | "thisWeek" | "thisMonth" | "later";
  onDismiss?: (caseId: string, deadlineType: string) => void;
  defaultExpanded?: boolean;
  maxItems?: number;
}

const URGENCY_STYLES = {
  overdue: {
    border: "border-red-600",
    bg: "bg-red-50 dark:bg-red-950/20",
    badge: "bg-red-600 text-white",
    text: "text-red-600",
  },
  thisWeek: {
    border: "border-orange-500",
    bg: "bg-orange-50 dark:bg-orange-950/20",
    badge: "bg-orange-500 text-white",
    text: "text-orange-600",
  },
  thisMonth: {
    border: "border-yellow-500",
    bg: "bg-yellow-50 dark:bg-yellow-950/20",
    badge: "bg-yellow-500 text-black",
    text: "text-yellow-600",
  },
  later: {
    border: "border-green-600",
    bg: "bg-green-50 dark:bg-green-950/20",
    badge: "bg-green-600 text-white",
    text: "text-green-600",
  },
};

export function UrgencyGroup({
  title,
  items,
  urgency,
  onDismiss,
  defaultExpanded = true,
  maxItems = 5,
}: UrgencyGroupProps) {
  const [isExpanded, setIsExpanded] = useState(defaultExpanded);
  const [showAll, setShowAll] = useState(false);

  const styles = URGENCY_STYLES[urgency];
  const displayItems = showAll ? items : items.slice(0, maxItems);
  const hasMore = items.length > maxItems;

  if (items.length === 0) {
    return null;
  }

  return (
    <div className={cn("border-4 border-black", styles.bg, "overflow-hidden")}>
      {/* Header */}
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className={cn(
          "w-full flex items-center justify-between p-4",
          "border-b-4 border-black",
          "hover:bg-black/5 transition-colors duration-150"
        )}
      >
        <div className="flex items-center gap-3">
          <span className={cn(
            "px-3 py-1 font-mono font-bold text-sm border-2 border-black",
            styles.badge
          )}>
            {items.length}
          </span>
          <h3 className={cn("font-heading text-lg font-bold", styles.text)}>
            {title}
          </h3>
        </div>
        {isExpanded ? (
          <ChevronUp className="w-5 h-5" />
        ) : (
          <ChevronDown className="w-5 h-5" />
        )}
      </button>

      {/* Items */}
      {isExpanded && (
        <div className="p-4 space-y-3">
          {displayItems.map((item, index) => (
            <DeadlineItemComponent
              key={`${item.caseId}-${item.deadlineType}`}
              deadline={item}
              index={index}
              onDismiss={onDismiss}
            />
          ))}

          {hasMore && (
            <button
              onClick={() => setShowAll(!showAll)}
              className={cn(
                "w-full py-2 text-sm font-medium",
                "border-2 border-dashed border-current",
                "hover:border-solid transition-all duration-150",
                styles.text
              )}
            >
              {showAll ? "Show less" : `+${items.length - maxItems} more`}
            </button>
          )}
        </div>
      )}
    </div>
  );
}
```

---

## Task 7: Implement DeadlineHeroWidget Component to Pass Tests

**File:** `v2/src/components/dashboard/DeadlineHeroWidget.tsx`

```tsx
"use client";

import { useQuery, useMutation } from "convex/react";
import { api } from "@/convex/_generated/api";
import { useEffect, useState, useCallback } from "react";
import { cn } from "@/lib/utils";
import { UrgencyGroup } from "./UrgencyGroup";
import { Skeleton } from "@/components/ui/skeleton";
import { RefreshCw, Clock } from "lucide-react";
import { Button } from "@/components/ui/button";

const AUTO_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minutes

export function DeadlineHeroWidget() {
  const deadlines = useQuery(api.dashboard.getDeadlines);
  const [lastRefresh, setLastRefresh] = useState<Date>(new Date());
  const [isRefreshing, setIsRefreshing] = useState(false);

  const handleRefresh = useCallback(() => {
    setIsRefreshing(true);
    setLastRefresh(new Date());
    setTimeout(() => setIsRefreshing(false), 500);
  }, []);

  useEffect(() => {
    const interval = setInterval(() => {
      setLastRefresh(new Date());
    }, AUTO_REFRESH_INTERVAL);

    return () => clearInterval(interval);
  }, []);

  const handleDismiss = useCallback((caseId: string, deadlineType: string) => {
    console.log("Dismiss deadline:", caseId, deadlineType);
  }, []);

  if (!deadlines) {
    return <DeadlineHeroWidgetSkeleton />;
  }

  const hasDeadlines = deadlines.totalCount > 0;

  return (
    <section className="mb-8">
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-3">
          <Clock className="w-6 h-6 text-primary" />
          <h2 className="font-heading text-2xl font-bold">
            Deadline Hub
          </h2>
          <span className="px-2 py-1 bg-primary text-primary-foreground font-mono text-sm font-bold border-2 border-black">
            {deadlines.totalCount}
          </span>
        </div>

        <div className="flex items-center gap-4">
          <span className="text-sm text-muted-foreground">
            Updated {formatRelativeTime(lastRefresh)}
          </span>
          <Button
            variant="outline"
            size="sm"
            onClick={handleRefresh}
            disabled={isRefreshing}
            className="border-2 border-black"
          >
            <RefreshCw className={cn("w-4 h-4 mr-2", isRefreshing && "animate-spin")} />
            Refresh
          </Button>
        </div>
      </div>

      {hasDeadlines ? (
        <div className="grid md:grid-cols-2 gap-4">
          <UrgencyGroup
            title="Overdue"
            items={deadlines.overdue}
            urgency="overdue"
            onDismiss={handleDismiss}
            defaultExpanded={true}
          />
          <UrgencyGroup
            title="This Week"
            items={deadlines.thisWeek}
            urgency="thisWeek"
            onDismiss={handleDismiss}
            defaultExpanded={true}
          />
          <UrgencyGroup
            title="This Month"
            items={deadlines.thisMonth}
            urgency="thisMonth"
            onDismiss={handleDismiss}
            defaultExpanded={deadlines.overdue.length === 0 && deadlines.thisWeek.length === 0}
          />
          <UrgencyGroup
            title="Later"
            items={deadlines.later}
            urgency="later"
            onDismiss={handleDismiss}
            defaultExpanded={false}
          />
        </div>
      ) : (
        <div className="p-8 border-4 border-dashed border-muted-foreground/30 text-center">
          <Clock className="w-12 h-12 mx-auto mb-4 text-muted-foreground/50" />
          <p className="text-lg font-medium text-muted-foreground">
            No upcoming deadlines
          </p>
          <p className="text-sm text-muted-foreground/70">
            Create a case to start tracking deadlines
          </p>
        </div>
      )}
    </section>
  );
}

function DeadlineHeroWidgetSkeleton() {
  return (
    <section className="mb-8">
      <div className="flex items-center justify-between mb-4">
        <Skeleton className="h-8 w-48" />
        <Skeleton className="h-8 w-32" />
      </div>
      <div className="grid md:grid-cols-2 gap-4">
        {Array.from({ length: 4 }).map((_, i) => (
          <Skeleton key={i} className="h-64 border-4 border-black" />
        ))}
      </div>
    </section>
  );
}

function formatRelativeTime(date: Date): string {
  const seconds = Math.floor((new Date().getTime() - date.getTime()) / 1000);

  if (seconds < 60) return "just now";
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  return date.toLocaleDateString();
}
```

---

## Task 8: Add CSS Animations & Update Dashboard Page

### 8.1 Add Slide-in Animation

**File:** `v2/src/app/globals.css` (append)

```css
/* Deadline animations */
@keyframes slide-in-from-right {
  from {
    opacity: 0;
    transform: translateX(1rem);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.animate-slide-in-right {
  animation: slide-in-from-right 0.3s ease-out forwards;
}
```

### 8.2 Update Dashboard Page

**File:** `v2/src/app/(authenticated)/dashboard/page.tsx`

Replace placeholder with actual widget:

```tsx
"use client";

import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { redirect } from "next/navigation";
import { SummaryTilesGrid } from "@/components/dashboard/SummaryTilesGrid";
import { DeadlineHeroWidget } from "@/components/dashboard/DeadlineHeroWidget";
import { Spinner } from "@/components/ui/spinner";

export default function DashboardPage() {
  const user = useQuery(api.users.currentUser);

  if (user === undefined) {
    return (
      <div className="flex items-center justify-center min-h-[50vh]">
        <Spinner size="lg" />
      </div>
    );
  }

  if (user === null) {
    redirect("/signin");
  }

  return (
    <div className="space-y-8">
      <div>
        <h1 className="font-heading text-3xl font-bold mb-2">
          Welcome back, {user.name?.split(" ")[0] || "there"}
        </h1>
        <p className="text-muted-foreground">
          Here's your case overview for today.
        </p>
      </div>

      {/* Deadline Hero Widget - THE crown jewel */}
      <DeadlineHeroWidget />

      {/* Summary Tiles */}
      <SummaryTilesGrid />

      {/* Placeholder for 20-04 */}
      <div className="grid md:grid-cols-2 gap-8">
        <div className="p-8 border-4 border-dashed border-muted-foreground/30 text-center text-muted-foreground">
          Recent Activity (Phase 20-04)
        </div>
        <div className="p-8 border-4 border-dashed border-muted-foreground/30 text-center text-muted-foreground">
          Upcoming Deadlines (Phase 20-04)
        </div>
      </div>
    </div>
  );
}
```

### 8.3 Update Component Exports

**File:** `v2/src/components/dashboard/index.ts`

```tsx
export { DeadlineItem } from "./DeadlineItem";
export { UrgencyGroup } from "./UrgencyGroup";
export { DeadlineHeroWidget } from "./DeadlineHeroWidget";
export { SummaryTile } from "./SummaryTile";
export { SummaryTilesGrid } from "./SummaryTilesGrid";
```

---

## Verification

### Test Verification

```bash
cd v2 && npm test -- --testPathPattern="DeadlineItem|UrgencyGroup|DeadlineHeroWidget"
```

**Expected:** All component tests pass.

### TypeScript Verification

```bash
cd v2 && npx tsc --noEmit
```

**Expected:** No TypeScript errors.

### Visual Verification

1. Run `cd v2 && npm run dev`
2. Navigate to `/dashboard`
3. Verify Deadline Hero Widget appears at top
4. Verify 4 urgency groups with correct colors
5. Verify hazard stripes on overdue items
6. Verify staggered slide-in animation
7. Hover deadline item → quick-peek card appears
8. Click refresh button → spinner animation
9. Click "+N more" → expands to show all

---

## Success Criteria

### Tests
- [ ] DeadlineItem tests pass (rendering, overdue styling, animations, dismiss, hover card)
- [ ] UrgencyGroup tests pass (expand/collapse, overflow pattern, styling)
- [ ] DeadlineHeroWidget tests pass (loading, data, empty state, refresh)

### UI
- [ ] Deadline Hero Widget prominently displayed at top
- [ ] 4 urgency groups (overdue, thisWeek, thisMonth, later)
- [ ] Hazard stripes on overdue items
- [ ] Staggered slide-in animations (50ms delay per item)
- [ ] Badge counts per group
- [ ] Auto-refresh every 5 minutes
- [ ] Manual refresh button with spinner
- [ ] "+N more" overflow pattern
- [ ] Quick-peek hover cards
- [ ] Click deadline → case detail
- [ ] Dismiss button on hover
- [ ] Empty state when no deadlines
- [ ] Skeleton loading
- [ ] Dark mode compatible

### General
- [ ] No TypeScript errors
- [ ] All tests pass

---

## Output

**Test files created:**
- `v2/test-utils/deadline-fixtures.ts`
- `v2/src/components/dashboard/__tests__/DeadlineItem.test.tsx`
- `v2/src/components/dashboard/__tests__/UrgencyGroup.test.tsx`
- `v2/src/components/dashboard/__tests__/DeadlineHeroWidget.test.tsx`

**Component files created:**
- `v2/src/components/dashboard/DeadlineItem.tsx`
- `v2/src/components/dashboard/UrgencyGroup.tsx`
- `v2/src/components/dashboard/DeadlineHeroWidget.tsx`

**Files modified:**
- `v2/src/app/(authenticated)/dashboard/page.tsx`
- `v2/src/app/globals.css`
- `v2/src/components/dashboard/index.ts`

**Ready for:** 20-04-PLAN.md (Recent Activity, Upcoming Deadlines, Add Case Button)
