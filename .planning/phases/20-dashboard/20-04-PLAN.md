# Phase 20-04: Recent Activity, Upcoming Deadlines & Add Case Button

## Objective

Complete the dashboard with Recent Activity (last 5 updated cases), Upcoming Deadlines list (next 30 days), and an Add Case button. This finalizes Phase 20 and prepares for the Human Checkpoint UI review.

**TDD Approach:** Write component tests FIRST, then implement components to pass tests.

## ⚠️ CRITICAL: Required Reading Before Implementation

**You MUST read these files before starting ANY implementation work:**

1. **Frontend Design Skill** (MANDATORY):
   - `/Users/adammohamed/cc/perm-tracker-test/.planning/FRONTEND_DESIGN_SKILL.md`

2. **PERM Flow Source of Truth** (MANDATORY):
   - `/Users/adammohamed/cc/perm-tracker-test/perm_flow.md`

3. **Phase Context**:
   - `/Users/adammohamed/cc/perm-tracker-test/.planning/phases/20-dashboard/20-CONTEXT.md`

### Subagent Instructions

**If you spawn ANY subagents or use the Task tool, you MUST include in their prompt:**

```
REQUIRED READING - Read these files BEFORE any implementation:
1. /Users/adammohamed/cc/perm-tracker-test/.planning/FRONTEND_DESIGN_SKILL.md
2. /Users/adammohamed/cc/perm-tracker-test/perm_flow.md
3. /Users/adammohamed/cc/perm-tracker-test/.planning/phases/20-dashboard/20-CONTEXT.md
4. v2/docs/DESIGN_SYSTEM.md
6. /Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design3
7. /Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design4
8. /Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design5
```

## Execution Context

```
@.planning/FRONTEND_DESIGN_SKILL.md
@.planning/phases/20-dashboard/20-CONTEXT.md
@v2/docs/DESIGN_SYSTEM.md
@v2/convex/dashboard.ts
@v2/src/components/dashboard/
```

## Context

**From 20-CONTEXT.md:**
- Recent Activity shows last 5 updated cases
- Upcoming Deadlines shows next 30 days grouped
- Add Case button at the bottom

**Design consistency:**
- Cards with neobrutalist style (hard shadows, black borders)
- Same hover effects as other dashboard components
- Consistent with SummaryTiles and DeadlineHeroWidget

---

## Task 1: Create Test Fixtures for Activity & Upcoming Deadlines

**File:** `v2/test-utils/activity-fixtures.ts`

```typescript
// v2/test-utils/activity-fixtures.ts
import { RecentActivityItem, DeadlineItem } from "@/convex/lib/dashboard-types";
import { Id } from "@/convex/_generated/dataModel";

/**
 * Factory for creating mock recent activity items
 */
export function createMockActivityItem(
  overrides: Partial<RecentActivityItem> = {}
): RecentActivityItem {
  return {
    caseId: "case_123" as Id<"cases">,
    caseNumber: "CASE-2024-001",
    employerName: "Tech Corp Inc",
    beneficiaryName: "John Smith",
    caseStatus: "pwd",
    progressStatus: "waiting",
    action: "updated",
    updatedAt: new Date().toISOString(),
    ...overrides,
  };
}

/**
 * Factory for creating list of recent activity items
 */
export function createMockActivityList(count: number = 5): RecentActivityItem[] {
  const actions = ["created", "updated", "status_changed"] as const;
  const statuses = ["pwd", "recruitment", "eta9089", "i140"] as const;

  return Array.from({ length: count }, (_, i) => {
    const hoursAgo = i * 2; // Stagger by 2 hours
    const date = new Date();
    date.setHours(date.getHours() - hoursAgo);

    return createMockActivityItem({
      caseId: `case_${i + 1}` as Id<"cases">,
      caseNumber: `CASE-2024-${String(i + 1).padStart(3, "0")}`,
      employerName: `Company ${i + 1}`,
      beneficiaryName: `Person ${i + 1}`,
      caseStatus: statuses[i % statuses.length],
      action: actions[i % actions.length],
      updatedAt: date.toISOString(),
    });
  });
}

/**
 * Factory for creating upcoming deadlines (next 30 days)
 */
export function createMockUpcomingDeadlines(count: number = 10): DeadlineItem[] {
  return Array.from({ length: count }, (_, i) => ({
    caseId: `case_${i + 1}` as Id<"cases">,
    caseNumber: `CASE-2024-${String(i + 1).padStart(3, "0")}`,
    employerName: `Company ${i + 1}`,
    beneficiaryName: `Person ${i + 1}`,
    caseStatus: "pwd",
    deadlineType: "pwd_expiration",
    deadlineLabel: "PWD Expires",
    dueDate: formatFutureDate(i * 3), // Every 3 days
    daysUntil: i * 3,
    urgency: i * 3 <= 7 ? "thisWeek" : i * 3 <= 30 ? "thisMonth" : "later",
  }));
}

/**
 * Factory for empty activity list
 */
export function createEmptyActivityList(): RecentActivityItem[] {
  return [];
}

/**
 * Format a date N days in the future
 */
function formatFutureDate(daysFromNow: number): string {
  const date = new Date();
  date.setDate(date.getDate() + daysFromNow);
  return date.toISOString().split("T")[0];
}
```

---

## Task 2: Write RecentActivityCard Component Tests FIRST

**File:** `v2/src/components/dashboard/__tests__/RecentActivityCard.test.tsx`

```typescript
// v2/src/components/dashboard/__tests__/RecentActivityCard.test.tsx
import { render, screen } from "@testing-library/react";
import { RecentActivityCard } from "../RecentActivityCard";
import { createMockActivityItem } from "@/test-utils/activity-fixtures";
import { renderWithProviders } from "@/test-utils/render-utils";

describe("RecentActivityCard", () => {
  const defaultActivity = createMockActivityItem();

  describe("rendering", () => {
    it("renders employer name", () => {
      renderWithProviders(<RecentActivityCard activity={defaultActivity} />);

      expect(screen.getByText(defaultActivity.employerName)).toBeInTheDocument();
    });

    it("renders beneficiary name", () => {
      renderWithProviders(<RecentActivityCard activity={defaultActivity} />);

      expect(screen.getByText(defaultActivity.beneficiaryName)).toBeInTheDocument();
    });

    it("renders case status badge", () => {
      renderWithProviders(<RecentActivityCard activity={defaultActivity} />);

      // CaseStageBadge should be present (visual component)
      const badges = screen.getAllByRole("status");
      expect(badges.length).toBeGreaterThan(0);
    });

    it("renders action label", () => {
      renderWithProviders(<RecentActivityCard activity={defaultActivity} />);

      expect(screen.getByText(defaultActivity.action)).toBeInTheDocument();
    });

    it("is a link to case detail", () => {
      renderWithProviders(<RecentActivityCard activity={defaultActivity} />);

      const link = screen.getByRole("link");
      expect(link).toHaveAttribute("href", `/cases/${defaultActivity.caseId}`);
    });
  });

  describe("time formatting", () => {
    it("shows relative time for recent activity", () => {
      const recentActivity = createMockActivityItem({
        updatedAt: new Date().toISOString(),
      });
      renderWithProviders(<RecentActivityCard activity={recentActivity} />);

      // Should show something like "just now" or "Xm ago"
      expect(screen.getByText(/just now|ago/i)).toBeInTheDocument();
    });
  });

  describe("neobrutalist styling", () => {
    it("has 4px black border", () => {
      renderWithProviders(<RecentActivityCard activity={defaultActivity} />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("border-4", "border-black");
    });

    it("has hover transform", () => {
      renderWithProviders(<RecentActivityCard activity={defaultActivity} />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("hover:-translate-x-0.5", "hover:-translate-y-0.5");
    });

    it("has hover shadow", () => {
      renderWithProviders(<RecentActivityCard activity={defaultActivity} />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("hover:shadow-hard");
    });
  });
});
```

---

## Task 3: Write RecentActivityWidget Component Tests FIRST

**File:** `v2/src/components/dashboard/__tests__/RecentActivityWidget.test.tsx`

```typescript
// v2/src/components/dashboard/__tests__/RecentActivityWidget.test.tsx
import { render, screen } from "@testing-library/react";
import { RecentActivityWidget } from "../RecentActivityWidget";
import { createMockActivityList, createEmptyActivityList } from "@/test-utils/activity-fixtures";
import { renderWithProviders } from "@/test-utils/render-utils";

// Mock convex/react
let mockActivityData: ReturnType<typeof createMockActivityList> | undefined;
jest.mock("convex/react", () => ({
  useQuery: jest.fn(() => mockActivityData),
}));

describe("RecentActivityWidget", () => {
  beforeEach(() => {
    jest.clearAllMocks();
    mockActivityData = undefined;
  });

  describe("loading state", () => {
    it("renders skeleton when data is loading", () => {
      mockActivityData = undefined;
      const { container } = renderWithProviders(<RecentActivityWidget />);

      // Should show 5 skeleton items
      const skeletons = container.querySelectorAll(".p-4");
      expect(skeletons.length).toBeGreaterThan(0);
    });

    it("renders header skeleton", () => {
      mockActivityData = undefined;
      const { container } = renderWithProviders(<RecentActivityWidget />);

      const headerSkeleton = container.querySelector(".h-6.w-36");
      expect(headerSkeleton).toBeInTheDocument();
    });
  });

  describe("with data", () => {
    beforeEach(() => {
      mockActivityData = createMockActivityList(5);
    });

    it("renders Recent Activity heading", () => {
      renderWithProviders(<RecentActivityWidget />);

      expect(screen.getByRole("heading", { name: /recent activity/i })).toBeInTheDocument();
    });

    it("renders all activity items", () => {
      renderWithProviders(<RecentActivityWidget />);

      expect(screen.getByText("Company 1")).toBeInTheDocument();
      expect(screen.getByText("Company 5")).toBeInTheDocument();
    });

    it("renders View all link", () => {
      renderWithProviders(<RecentActivityWidget />);

      const viewAllLink = screen.getByRole("link", { name: /view all/i });
      expect(viewAllLink).toBeInTheDocument();
      expect(viewAllLink).toHaveAttribute("href", "/cases?sort=updated");
    });

    it("renders History icon", () => {
      const { container } = renderWithProviders(<RecentActivityWidget />);

      const historyIcon = container.querySelector('[class*="lucide-history"]');
      expect(historyIcon).toBeInTheDocument();
    });
  });

  describe("empty state", () => {
    beforeEach(() => {
      mockActivityData = createEmptyActivityList();
    });

    it("shows empty state message", () => {
      renderWithProviders(<RecentActivityWidget />);

      expect(screen.getByText(/no recent activity/i)).toBeInTheDocument();
    });

    it("shows call to action", () => {
      renderWithProviders(<RecentActivityWidget />);

      expect(screen.getByText(/create your first case/i)).toBeInTheDocument();
    });
  });

  describe("styling", () => {
    beforeEach(() => {
      mockActivityData = createMockActivityList(5);
    });

    it("has neobrutalist border", () => {
      const { container } = renderWithProviders(<RecentActivityWidget />);

      const widget = container.firstChild;
      expect(widget).toHaveClass("border-4", "border-black");
    });

    it("has dividers between items", () => {
      const { container } = renderWithProviders(<RecentActivityWidget />);

      const dividers = container.querySelector(".divide-y-4");
      expect(dividers).toBeInTheDocument();
    });
  });
});
```

---

## Task 4: Write UpcomingDeadlinesWidget Component Tests FIRST

**File:** `v2/src/components/dashboard/__tests__/UpcomingDeadlinesWidget.test.tsx`

```typescript
// v2/src/components/dashboard/__tests__/UpcomingDeadlinesWidget.test.tsx
import { render, screen } from "@testing-library/react";
import { UpcomingDeadlinesWidget } from "../UpcomingDeadlinesWidget";
import { createMockUpcomingDeadlines } from "@/test-utils/activity-fixtures";
import { renderWithProviders } from "@/test-utils/render-utils";

// Mock convex/react
let mockDeadlinesData: ReturnType<typeof createMockUpcomingDeadlines> | undefined;
jest.mock("convex/react", () => ({
  useQuery: jest.fn(() => mockDeadlinesData),
}));

describe("UpcomingDeadlinesWidget", () => {
  beforeEach(() => {
    jest.clearAllMocks();
    mockDeadlinesData = undefined;
  });

  describe("loading state", () => {
    it("renders skeleton when data is loading", () => {
      mockDeadlinesData = undefined;
      const { container } = renderWithProviders(<UpcomingDeadlinesWidget />);

      const skeletons = container.querySelectorAll(".p-3");
      expect(skeletons.length).toBeGreaterThan(0);
    });
  });

  describe("with data", () => {
    beforeEach(() => {
      mockDeadlinesData = createMockUpcomingDeadlines(10);
    });

    it("renders Next 30 Days heading", () => {
      renderWithProviders(<UpcomingDeadlinesWidget />);

      expect(screen.getByRole("heading", { name: /next 30 days/i })).toBeInTheDocument();
    });

    it("renders deadline count badge", () => {
      renderWithProviders(<UpcomingDeadlinesWidget />);

      expect(screen.getByText("10")).toBeInTheDocument();
    });

    it("renders deadline items", () => {
      renderWithProviders(<UpcomingDeadlinesWidget />);

      expect(screen.getByText("Company 1")).toBeInTheDocument();
    });

    it("renders Calendar link", () => {
      renderWithProviders(<UpcomingDeadlinesWidget />);

      const calendarLink = screen.getByRole("link", { name: /calendar/i });
      expect(calendarLink).toBeInTheDocument();
      expect(calendarLink).toHaveAttribute("href", "/calendar");
    });

    it("renders Calendar icon", () => {
      const { container } = renderWithProviders(<UpcomingDeadlinesWidget />);

      const calendarIcon = container.querySelector('[class*="lucide-calendar"]');
      expect(calendarIcon).toBeInTheDocument();
    });
  });

  describe("empty state", () => {
    beforeEach(() => {
      mockDeadlinesData = [];
    });

    it("shows empty state message", () => {
      renderWithProviders(<UpcomingDeadlinesWidget />);

      expect(screen.getByText(/no deadlines in next 30 days/i)).toBeInTheDocument();
    });

    it("shows encouragement message", () => {
      renderWithProviders(<UpcomingDeadlinesWidget />);

      expect(screen.getByText(/you're all caught up/i)).toBeInTheDocument();
    });
  });

  describe("scrollable list", () => {
    beforeEach(() => {
      mockDeadlinesData = createMockUpcomingDeadlines(10);
    });

    it("has max height and overflow scroll", () => {
      const { container } = renderWithProviders(<UpcomingDeadlinesWidget />);

      const scrollContainer = container.querySelector(".max-h-80.overflow-y-auto");
      expect(scrollContainer).toBeInTheDocument();
    });
  });
});
```

---

## Task 5: Write AddCaseButton Component Tests FIRST

**File:** `v2/src/components/dashboard/__tests__/AddCaseButton.test.tsx`

```typescript
// v2/src/components/dashboard/__tests__/AddCaseButton.test.tsx
import { render, screen } from "@testing-library/react";
import { AddCaseButton } from "../AddCaseButton";
import { renderWithProviders } from "@/test-utils/render-utils";

describe("AddCaseButton", () => {
  describe("rendering", () => {
    it("renders button text", () => {
      renderWithProviders(<AddCaseButton />);

      expect(screen.getByText(/add new case/i)).toBeInTheDocument();
    });

    it("is a link to new case page", () => {
      renderWithProviders(<AddCaseButton />);

      const link = screen.getByRole("link");
      expect(link).toHaveAttribute("href", "/cases/new");
    });

    it("renders Plus icon", () => {
      const { container } = renderWithProviders(<AddCaseButton />);

      const plusIcon = container.querySelector('[class*="lucide-plus"]');
      expect(plusIcon).toBeInTheDocument();
    });
  });

  describe("neobrutalist styling", () => {
    it("has 4px black border", () => {
      renderWithProviders(<AddCaseButton />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("border-4", "border-black");
    });

    it("has primary background", () => {
      renderWithProviders(<AddCaseButton />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("bg-primary");
    });

    it("has hard shadow", () => {
      renderWithProviders(<AddCaseButton />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("shadow-hard");
    });

    it("has hover lift effect", () => {
      renderWithProviders(<AddCaseButton />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("hover:-translate-x-1", "hover:-translate-y-1");
    });

    it("has active press effect", () => {
      renderWithProviders(<AddCaseButton />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("active:translate-x-1", "active:translate-y-1");
    });
  });

  describe("typography", () => {
    it("uses heading font", () => {
      renderWithProviders(<AddCaseButton />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("font-heading");
    });

    it("has bold font weight", () => {
      renderWithProviders(<AddCaseButton />);

      const link = screen.getByRole("link");
      expect(link).toHaveClass("font-bold");
    });
  });
});
```

---

## Task 6: Write Date Utility Tests FIRST

**File:** `v2/src/lib/utils/__tests__/date.test.ts`

```typescript
// v2/src/lib/utils/__tests__/date.test.ts
import { formatDistanceToNow, formatDate, formatISODate } from "../date";

describe("formatDistanceToNow", () => {
  it('returns "just now" for dates within 60 seconds', () => {
    const now = new Date();
    expect(formatDistanceToNow(now)).toBe("just now");
  });

  it("returns minutes for dates within an hour", () => {
    const fiveMinutesAgo = new Date();
    fiveMinutesAgo.setMinutes(fiveMinutesAgo.getMinutes() - 5);
    expect(formatDistanceToNow(fiveMinutesAgo)).toBe("5m ago");
  });

  it("returns hours for dates within a day", () => {
    const threeHoursAgo = new Date();
    threeHoursAgo.setHours(threeHoursAgo.getHours() - 3);
    expect(formatDistanceToNow(threeHoursAgo)).toBe("3h ago");
  });

  it("returns days for dates within a week", () => {
    const twoDaysAgo = new Date();
    twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
    expect(formatDistanceToNow(twoDaysAgo)).toBe("2d ago");
  });

  it("returns formatted date for older dates", () => {
    const twoWeeksAgo = new Date();
    twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
    const result = formatDistanceToNow(twoWeeksAgo);
    // Should be like "Dec 9" format
    expect(result).toMatch(/\w{3} \d{1,2}/);
  });
});

describe("formatDate", () => {
  it("formats Date object correctly", () => {
    const date = new Date(2024, 0, 15); // Jan 15, 2024
    expect(formatDate(date)).toBe("Jan 15, 2024");
  });

  it("formats ISO string correctly", () => {
    expect(formatDate("2024-01-15")).toBe("Jan 15, 2024");
  });
});

describe("formatISODate", () => {
  it("formats YYYY-MM-DD to readable format", () => {
    expect(formatISODate("2024-01-15")).toBe("Jan 15, 2024");
  });

  it("handles different months correctly", () => {
    expect(formatISODate("2024-06-01")).toBe("Jun 1, 2024");
    expect(formatISODate("2024-12-25")).toBe("Dec 25, 2024");
  });
});
```

---

## Task 7: Implement Date Utilities to Pass Tests

**File:** `v2/src/lib/utils/date.ts`

```typescript
// v2/src/lib/utils/date.ts

/**
 * Format a date as relative time (e.g., "2 hours ago")
 */
export function formatDistanceToNow(date: Date): string {
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffSec = Math.floor(diffMs / 1000);
  const diffMin = Math.floor(diffSec / 60);
  const diffHour = Math.floor(diffMin / 60);
  const diffDay = Math.floor(diffHour / 24);

  if (diffSec < 60) return "just now";
  if (diffMin < 60) return `${diffMin}m ago`;
  if (diffHour < 24) return `${diffHour}h ago`;
  if (diffDay < 7) return `${diffDay}d ago`;

  return date.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
  });
}

/**
 * Format a date for display
 */
export function formatDate(date: Date | string): string {
  const d = typeof date === "string" ? new Date(date) : date;
  return d.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
}

/**
 * Format an ISO date string for display (YYYY-MM-DD)
 */
export function formatISODate(isoDate: string): string {
  const [year, month, day] = isoDate.split("-");
  const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
  return date.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
}
```

---

## Task 8: Implement RecentActivityCard Component to Pass Tests

**File:** `v2/src/components/dashboard/RecentActivityCard.tsx`

```tsx
"use client";

import Link from "next/link";
import { cn } from "@/lib/utils";
import { CaseStageBadge } from "@/components/status/CaseStageBadge";
import { ProgressStatusBadge } from "@/components/status/ProgressStatusBadge";
import { RecentActivityItem } from "@/convex/lib/dashboard-types";
import { formatDistanceToNow } from "@/lib/utils/date";

interface RecentActivityCardProps {
  activity: RecentActivityItem;
}

export function RecentActivityCard({ activity }: RecentActivityCardProps) {
  return (
    <Link
      href={`/cases/${activity.caseId}`}
      className={cn(
        "block p-4 border-4 border-black bg-background",
        "transition-all duration-150 ease-out",
        "hover:-translate-x-0.5 hover:-translate-y-0.5 hover:shadow-hard",
        "active:translate-x-1 active:translate-y-1 active:shadow-none"
      )}
    >
      <div className="flex items-start justify-between gap-4">
        <div className="flex-1 min-w-0">
          {/* Status badges */}
          <div className="flex items-center gap-2 mb-1">
            <CaseStageBadge status={activity.caseStatus} size="sm" />
            <ProgressStatusBadge status={activity.progressStatus} size="sm" />
          </div>

          {/* Employer + Beneficiary */}
          <p className="font-medium truncate">
            {activity.employerName}
          </p>
          <p className="text-sm text-muted-foreground truncate">
            {activity.beneficiaryName}
          </p>
        </div>

        {/* Time and action */}
        <div className="flex flex-col items-end text-right">
          <span className="text-xs text-muted-foreground uppercase">
            {activity.action}
          </span>
          <span className="text-sm text-muted-foreground">
            {formatDistanceToNow(new Date(activity.updatedAt))}
          </span>
        </div>
      </div>
    </Link>
  );
}
```

---

## Task 9: Implement RecentActivityWidget Component to Pass Tests

**File:** `v2/src/components/dashboard/RecentActivityWidget.tsx`

```tsx
"use client";

import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { cn } from "@/lib/utils";
import { RecentActivityCard } from "./RecentActivityCard";
import { Skeleton } from "@/components/ui/skeleton";
import { History, ArrowRight } from "lucide-react";
import Link from "next/link";

export function RecentActivityWidget() {
  const recentActivity = useQuery(api.dashboard.getRecentActivity);

  if (!recentActivity) {
    return <RecentActivityWidgetSkeleton />;
  }

  const hasActivity = recentActivity.length > 0;

  return (
    <div className="border-4 border-black bg-background">
      {/* Header */}
      <div className="flex items-center justify-between p-4 border-b-4 border-black">
        <div className="flex items-center gap-2">
          <History className="w-5 h-5" />
          <h3 className="font-heading text-lg font-bold">
            Recent Activity
          </h3>
        </div>
        <Link
          href="/cases?sort=updated"
          className={cn(
            "flex items-center gap-1 text-sm text-muted-foreground",
            "hover:text-foreground transition-colors duration-150"
          )}
        >
          View all
          <ArrowRight className="w-4 h-4" />
        </Link>
      </div>

      {/* Content */}
      {hasActivity ? (
        <div className="divide-y-4 divide-black">
          {recentActivity.map((activity) => (
            <RecentActivityCard
              key={activity.caseId.toString()}
              activity={activity}
            />
          ))}
        </div>
      ) : (
        <div className="p-8 text-center">
          <History className="w-12 h-12 mx-auto mb-4 text-muted-foreground/50" />
          <p className="text-muted-foreground">
            No recent activity
          </p>
          <p className="text-sm text-muted-foreground/70">
            Create your first case to get started
          </p>
        </div>
      )}
    </div>
  );
}

function RecentActivityWidgetSkeleton() {
  return (
    <div className="border-4 border-black bg-background">
      <div className="flex items-center justify-between p-4 border-b-4 border-black">
        <Skeleton className="h-6 w-36" />
        <Skeleton className="h-4 w-16" />
      </div>
      <div className="divide-y-4 divide-black">
        {Array.from({ length: 5 }).map((_, i) => (
          <div key={i} className="p-4">
            <Skeleton className="h-4 w-24 mb-2" />
            <Skeleton className="h-5 w-48 mb-1" />
            <Skeleton className="h-4 w-32" />
          </div>
        ))}
      </div>
    </div>
  );
}
```

---

## Task 10: Implement UpcomingDeadlinesWidget Component to Pass Tests

**File:** `v2/src/components/dashboard/UpcomingDeadlineItem.tsx`

```tsx
"use client";

import Link from "next/link";
import { cn } from "@/lib/utils";
import { DeadlineItem } from "@/convex/lib/dashboard-types";
import { DeadlineIndicator } from "@/components/status/DeadlineIndicator";

interface UpcomingDeadlineItemProps {
  deadline: DeadlineItem;
}

export function UpcomingDeadlineItem({ deadline }: UpcomingDeadlineItemProps) {
  return (
    <Link
      href={`/cases/${deadline.caseId}`}
      className={cn(
        "flex items-center justify-between p-3",
        "hover:bg-muted/50 transition-colors duration-150"
      )}
    >
      <div className="flex-1 min-w-0">
        <p className="font-medium truncate text-sm">
          {deadline.deadlineLabel}
        </p>
        <p className="text-xs text-muted-foreground truncate">
          {deadline.employerName} • {deadline.caseNumber}
        </p>
      </div>

      <DeadlineIndicator
        daysUntil={deadline.daysUntil}
        showLabel={true}
      />
    </Link>
  );
}
```

**File:** `v2/src/components/dashboard/UpcomingDeadlinesWidget.tsx`

```tsx
"use client";

import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { cn } from "@/lib/utils";
import { UpcomingDeadlineItem } from "./UpcomingDeadlineItem";
import { Skeleton } from "@/components/ui/skeleton";
import { Calendar, ArrowRight } from "lucide-react";
import Link from "next/link";

export function UpcomingDeadlinesWidget() {
  const deadlines = useQuery(api.dashboard.getUpcomingDeadlines, { days: 30 });

  if (!deadlines) {
    return <UpcomingDeadlinesWidgetSkeleton />;
  }

  const hasDeadlines = deadlines.length > 0;

  return (
    <div className="border-4 border-black bg-background">
      {/* Header */}
      <div className="flex items-center justify-between p-4 border-b-4 border-black">
        <div className="flex items-center gap-2">
          <Calendar className="w-5 h-5" />
          <h3 className="font-heading text-lg font-bold">
            Next 30 Days
          </h3>
          {hasDeadlines && (
            <span className="px-2 py-0.5 bg-muted text-muted-foreground font-mono text-xs border-2 border-black">
              {deadlines.length}
            </span>
          )}
        </div>
        <Link
          href="/calendar"
          className={cn(
            "flex items-center gap-1 text-sm text-muted-foreground",
            "hover:text-foreground transition-colors duration-150"
          )}
        >
          Calendar
          <ArrowRight className="w-4 h-4" />
        </Link>
      </div>

      {/* Content */}
      {hasDeadlines ? (
        <div className="divide-y divide-border max-h-80 overflow-y-auto">
          {deadlines.map((deadline) => (
            <UpcomingDeadlineItem
              key={`${deadline.caseId}-${deadline.deadlineType}`}
              deadline={deadline}
            />
          ))}
        </div>
      ) : (
        <div className="p-8 text-center">
          <Calendar className="w-12 h-12 mx-auto mb-4 text-muted-foreground/50" />
          <p className="text-muted-foreground">
            No deadlines in next 30 days
          </p>
          <p className="text-sm text-muted-foreground/70">
            You're all caught up!
          </p>
        </div>
      )}
    </div>
  );
}

function UpcomingDeadlinesWidgetSkeleton() {
  return (
    <div className="border-4 border-black bg-background">
      <div className="flex items-center justify-between p-4 border-b-4 border-black">
        <Skeleton className="h-6 w-32" />
        <Skeleton className="h-4 w-20" />
      </div>
      <div className="divide-y divide-border">
        {Array.from({ length: 5 }).map((_, i) => (
          <div key={i} className="flex items-center justify-between p-3">
            <div>
              <Skeleton className="h-4 w-32 mb-1" />
              <Skeleton className="h-3 w-24" />
            </div>
            <Skeleton className="h-6 w-12" />
          </div>
        ))}
      </div>
    </div>
  );
}
```

---

## Task 11: Implement AddCaseButton Component to Pass Tests

**File:** `v2/src/components/dashboard/AddCaseButton.tsx`

```tsx
"use client";

import Link from "next/link";
import { cn } from "@/lib/utils";
import { Plus } from "lucide-react";

export function AddCaseButton() {
  return (
    <Link
      href="/cases/new"
      className={cn(
        "flex items-center justify-center gap-3 p-6",
        "border-4 border-black bg-primary text-primary-foreground",
        "font-heading text-xl font-bold",
        "shadow-hard transition-all duration-150 ease-out",
        "hover:-translate-x-1 hover:-translate-y-1 hover:shadow-hard-lg",
        "active:translate-x-1 active:translate-y-1 active:shadow-none"
      )}
    >
      <Plus className="w-6 h-6" />
      Add New Case
    </Link>
  );
}
```

---

## Task 12: Update Dashboard Page - Final Version

**File:** `v2/src/app/(authenticated)/dashboard/page.tsx`

```tsx
"use client";

import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { redirect } from "next/navigation";
import { SummaryTilesGrid } from "@/components/dashboard/SummaryTilesGrid";
import { DeadlineHeroWidget } from "@/components/dashboard/DeadlineHeroWidget";
import { RecentActivityWidget } from "@/components/dashboard/RecentActivityWidget";
import { UpcomingDeadlinesWidget } from "@/components/dashboard/UpcomingDeadlinesWidget";
import { AddCaseButton } from "@/components/dashboard/AddCaseButton";
import { Spinner } from "@/components/ui/spinner";

export default function DashboardPage() {
  const user = useQuery(api.users.currentUser);

  if (user === undefined) {
    return (
      <div className="flex items-center justify-center min-h-[50vh]">
        <Spinner size="lg" />
      </div>
    );
  }

  if (user === null) {
    redirect("/signin");
  }

  return (
    <div className="space-y-8">
      {/* Welcome */}
      <div>
        <h1 className="font-heading text-3xl font-bold mb-2">
          Welcome back, {user.name?.split(" ")[0] || "there"}
        </h1>
        <p className="text-muted-foreground">
          Here's your case overview for today.
        </p>
      </div>

      {/* Deadline Hero Widget - THE crown jewel */}
      <DeadlineHeroWidget />

      {/* Summary Tiles */}
      <SummaryTilesGrid />

      {/* Two-column layout: Recent Activity + Upcoming Deadlines */}
      <div className="grid md:grid-cols-2 gap-8">
        <RecentActivityWidget />
        <UpcomingDeadlinesWidget />
      </div>

      {/* Add Case Button */}
      <AddCaseButton />
    </div>
  );
}
```

---

## Task 13: Update Component Exports & Create Placeholder Pages

### 13.1 Update Component Exports

**File:** `v2/src/components/dashboard/index.ts`

```tsx
export { DeadlineItem } from "./DeadlineItem";
export { UrgencyGroup } from "./UrgencyGroup";
export { DeadlineHeroWidget } from "./DeadlineHeroWidget";
export { SummaryTile } from "./SummaryTile";
export { SummaryTilesGrid } from "./SummaryTilesGrid";
export { RecentActivityCard } from "./RecentActivityCard";
export { RecentActivityWidget } from "./RecentActivityWidget";
export { UpcomingDeadlineItem } from "./UpcomingDeadlineItem";
export { UpcomingDeadlinesWidget } from "./UpcomingDeadlinesWidget";
export { AddCaseButton } from "./AddCaseButton";
```

### 13.2 Create Placeholder Pages

**File:** `v2/src/app/(authenticated)/cases/page.tsx`

```tsx
export default function CasesPage() {
  return (
    <div className="p-8 border-4 border-dashed border-muted-foreground/30 text-center">
      <h1 className="font-heading text-2xl font-bold mb-2">Cases</h1>
      <p className="text-muted-foreground">Coming in Phase 21</p>
    </div>
  );
}
```

**File:** `v2/src/app/(authenticated)/cases/new/page.tsx`

```tsx
export default function NewCasePage() {
  return (
    <div className="p-8 border-4 border-dashed border-muted-foreground/30 text-center">
      <h1 className="font-heading text-2xl font-bold mb-2">Add New Case</h1>
      <p className="text-muted-foreground">Coming in Phase 22</p>
    </div>
  );
}
```

**File:** `v2/src/app/(authenticated)/cases/[id]/page.tsx`

```tsx
export default function CaseDetailPage({ params }: { params: { id: string } }) {
  return (
    <div className="p-8 border-4 border-dashed border-muted-foreground/30 text-center">
      <h1 className="font-heading text-2xl font-bold mb-2">Case Detail</h1>
      <p className="text-muted-foreground">Case ID: {params.id}</p>
      <p className="text-muted-foreground">Coming in Phase 23</p>
    </div>
  );
}
```

**File:** `v2/src/app/(authenticated)/calendar/page.tsx`

```tsx
export default function CalendarPage() {
  return (
    <div className="p-8 border-4 border-dashed border-muted-foreground/30 text-center">
      <h1 className="font-heading text-2xl font-bold mb-2">Calendar</h1>
      <p className="text-muted-foreground">Coming in Phase 23.1</p>
    </div>
  );
}
```

**File:** `v2/src/app/(authenticated)/notifications/page.tsx`

```tsx
export default function NotificationsPage() {
  return (
    <div className="p-8 border-4 border-dashed border-muted-foreground/30 text-center">
      <h1 className="font-heading text-2xl font-bold mb-2">Notifications</h1>
      <p className="text-muted-foreground">Coming in Phase 24</p>
    </div>
  );
}
```

**File:** `v2/src/app/(authenticated)/settings/page.tsx`

```tsx
export default function SettingsPage() {
  return (
    <div className="p-8 border-4 border-dashed border-muted-foreground/30 text-center">
      <h1 className="font-heading text-2xl font-bold mb-2">Settings</h1>
      <p className="text-muted-foreground">Coming in Phase 25</p>
    </div>
  );
}
```

---

## Verification

### Test Verification

```bash
cd v2 && npm test -- --testPathPattern="RecentActivity|UpcomingDeadlines|AddCaseButton|date"
```

**Expected:** All component tests pass.

### TypeScript Verification

```bash
cd v2 && npx tsc --noEmit
```

**Expected:** No TypeScript errors.

### Visual Verification

1. Run `cd v2 && npm run dev`
2. Navigate to `/dashboard`
3. Verify Recent Activity shows last 5 cases
4. Verify Upcoming Deadlines shows next 30 days
5. Verify Add Case button at bottom
6. Click Recent Activity item → case detail
7. Click Upcoming Deadline → case detail
8. Click "View all" → cases list
9. Click "Calendar" → calendar page
10. Click Add Case → new case form

---

## Success Criteria

### Tests
- [ ] RecentActivityCard tests pass
- [ ] RecentActivityWidget tests pass
- [ ] UpcomingDeadlinesWidget tests pass
- [ ] AddCaseButton tests pass
- [ ] Date utility tests pass

### UI
- [ ] Recent Activity shows last 5 updated cases
- [ ] Clicking activity item navigates to case detail
- [ ] "View all" link goes to cases list
- [ ] Upcoming Deadlines shows next 30 days
- [ ] Deadline items show correct urgency colors
- [ ] Clicking deadline navigates to case detail
- [ ] "Calendar" link goes to calendar page
- [ ] Add Case button at bottom of dashboard
- [ ] Add Case button has premium hover effect
- [ ] All nav links work (placeholder pages ready)
- [ ] Empty states for all widgets
- [ ] Skeleton loading states
- [ ] Dark mode compatible
- [ ] Responsive layout

### General
- [ ] No TypeScript errors
- [ ] All tests pass

---

## Output

**Test files created:**
- `v2/test-utils/activity-fixtures.ts`
- `v2/src/components/dashboard/__tests__/RecentActivityCard.test.tsx`
- `v2/src/components/dashboard/__tests__/RecentActivityWidget.test.tsx`
- `v2/src/components/dashboard/__tests__/UpcomingDeadlinesWidget.test.tsx`
- `v2/src/components/dashboard/__tests__/AddCaseButton.test.tsx`
- `v2/src/lib/utils/__tests__/date.test.ts`

**Component files created:**
- `v2/src/components/dashboard/RecentActivityCard.tsx`
- `v2/src/components/dashboard/RecentActivityWidget.tsx`
- `v2/src/components/dashboard/UpcomingDeadlineItem.tsx`
- `v2/src/components/dashboard/UpcomingDeadlinesWidget.tsx`
- `v2/src/components/dashboard/AddCaseButton.tsx`
- `v2/src/lib/utils/date.ts`

**Placeholder pages created:**
- `v2/src/app/(authenticated)/cases/page.tsx`
- `v2/src/app/(authenticated)/cases/new/page.tsx`
- `v2/src/app/(authenticated)/cases/[id]/page.tsx`
- `v2/src/app/(authenticated)/calendar/page.tsx`
- `v2/src/app/(authenticated)/notifications/page.tsx`
- `v2/src/app/(authenticated)/settings/page.tsx`

**Files modified:**
- `v2/src/app/(authenticated)/dashboard/page.tsx`
- `v2/src/components/dashboard/index.ts`

**Ready for:** Human Checkpoint UI Review

---

## Human Checkpoint: Phase 20 UI Review

After completing all 4 plans, the user must review the dashboard before moving to Phase 21.

**Review Checklist:**

1. **Deadline Hero Widget**
   - [ ] Prominently displayed at top
   - [ ] 4 urgency groups with correct colors
   - [ ] Hazard stripes on overdue items
   - [ ] Staggered animations look smooth
   - [ ] Hover cards show case details
   - [ ] Refresh button works

2. **Summary Tiles**
   - [ ] All 6 tiles visible (PWD, Recruitment, ETA 9089, I-140, Complete, Closed)
   - [ ] StageProgression hover effect (expanding underline)
   - [ ] Correct colors per status
   - [ ] Subtexts show counts
   - [ ] Corner labels with numbers

3. **Recent Activity**
   - [ ] Shows last 5 updated cases
   - [ ] Clear action labels (created/updated)
   - [ ] Time formatting readable

4. **Upcoming Deadlines**
   - [ ] Shows next 30 days
   - [ ] Urgency colors correct
   - [ ] Scrollable if many items

5. **General Polish**
   - [ ] Dark mode works everywhere
   - [ ] Header nav links all work
   - [ ] No broken layouts
   - [ ] No console errors
   - [ ] Mobile responsive
   - [ ] Loading states work

**If issues found:** Create Phase 20.1 for fixes before proceeding to Phase 21.
