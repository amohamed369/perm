---
phase: 21-case-list
plan: 04
type: execute
---

<objective>
Implement selection mode with bulk actions and import/export functionality.

Purpose: Enable users to select multiple cases for bulk operations and manage data portability.
Output: Selection mode UI, bulk delete/archive, CSV/JSON export, JSON import with preview.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-case-list/21-CONTEXT.md
@perm_flow.md

**Prior Plan Summaries:**
@.planning/phases/21-case-list/21-01-SUMMARY.md
@.planning/phases/21-case-list/21-02-SUMMARY.md
@.planning/phases/21-case-list/21-03-SUMMARY.md

**Design References (MUST READ):**
@.planning/FRONTEND_DESIGN_SKILL.md
@v2/docs/DESIGN_SYSTEM.md

**Component Dependencies:**
@v2/src/components/cases/CaseCard.tsx
@v2/src/app/(authenticated)/cases/page.tsx

**CRITICAL INSTRUCTIONS:**
All agents/subagents MUST read before implementation:
1. .planning/FRONTEND_DESIGN_SKILL.md
2. perm_flow.md (source of truth for statuses)
3. v2/docs/DESIGN_SYSTEM.md

Code must be: clean, organized, minimal, abstractable, scalable, maintainable, readable.
Fixes must be GLOBAL — no repeated code, abstract patterns into reusable utilities.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement selection mode and bulk action bar</name>
  <files>v2/src/components/cases/SelectionBar.tsx, v2/src/components/cases/__tests__/SelectionBar.test.tsx, v2/src/app/(authenticated)/cases/page.tsx</files>
  <exploration>
    Use Explore agent to understand:
    - Existing modal/dialog patterns
    - Button component variants
    - State management patterns in case list page
  </exploration>
  <action>
TDD: Write tests FIRST, then implement.

Create SelectionBar component:

**Toggle Selection Mode:**
- "Select Cases" button in page header
- Clicking toggles selectionMode state
- When active, button changes to "Cancel Selection"

**Selection Bar (appears when selectionMode=true):**
- Fixed bar at top (or floating at bottom)
- Left: "X cases selected" count
- Middle: Select All | Deselect All buttons
- Right: Export CSV | Export JSON | Delete | Archive buttons

**Props Interface:**
```typescript
interface SelectionBarProps {
  selectedCount: number;
  totalCount: number;
  onSelectAll: () => void;
  onDeselectAll: () => void;
  onExportCSV: () => void;
  onExportJSON: () => void;
  onBulkDelete: () => void;
  onBulkArchive: () => void;
}
```

**Styling:**
- Neobrutalist bar (black border, white bg)
- Sticky position at top below filter bar
- Export buttons: secondary style
- Delete/Archive: destructive style with confirmation

**Integration with Case List Page:**
- Add selectionMode state to page
- Pass selectionMode and onSelect to CaseCard
- Track selectedCaseIds in state
- Wire up SelectionBar callbacks

Add tests for:
- Selection bar hidden when not in selection mode
- Selection bar shows correct count
- Select all selects all visible cases
- Deselect all clears selection
- Export buttons trigger callbacks
- Delete/Archive buttons trigger callbacks
  </action>
  <verify>pnpm test v2/src/components/cases/__tests__/SelectionBar.test.tsx passes</verify>
  <done>Selection mode toggles correctly, bulk actions wired up</done>
</task>

<task type="auto">
  <name>Task 2: Implement export functionality (CSV/JSON)</name>
  <files>v2/src/lib/export/caseExport.ts, v2/src/lib/export/__tests__/caseExport.test.ts, v2/convex/cases.ts</files>
  <action>
TDD: Write tests FIRST, then implement.

Create export utilities:

**Export CSV:**
```typescript
export function exportCasesCSV(cases: CaseCardData[]): void {
  // 1. Build CSV header row (all fields)
  // 2. Build data rows (escape commas, quotes)
  // 3. Create Blob with CSV content
  // 4. Trigger download with filename: perm-cases-YYYY-MM-DD.csv
}
```

**Export JSON:**
```typescript
export function exportCasesJSON(cases: CaseCardData[]): void {
  // 1. Serialize cases to JSON (pretty printed)
  // 2. Create Blob with JSON content
  // 3. Trigger download with filename: perm-cases-YYYY-MM-DD.json
}
```

**CSV Fields (comprehensive):**
- id, employerName, beneficiaryIdentifier, positionTitle
- caseStatus, progressStatus
- All dates: pwdFiled, pwdDetermined, pwdExpires, recruitmentStarted, recruitmentExpires, eta9089WindowOpens, eta9089Filed, eta9089Certified, eta9089Expires, i140Filed, i140Approved
- Flags: isProfessional, isFavorite, calendarSyncEnabled
- createdAt, updatedAt

**Convex Query (for full export):**
Add `exportCases` query that returns all user cases without pagination (for export).

**Behavior:**
- If selection mode with selected cases: export only selected
- If no selection: export all (respect current filters)

Add tests for:
- CSV format is valid
- JSON format is valid
- Dates formatted correctly (YYYY-MM-DD)
- Special characters escaped in CSV
- Filename includes current date
- Respects selection/filter state
  </action>
  <verify>pnpm test v2/src/lib/export/__tests__/caseExport.test.ts passes</verify>
  <done>CSV and JSON export work correctly with proper formatting</done>
</task>

<task type="auto">
  <name>Task 3: Implement import functionality with preview</name>
  <files>v2/src/components/cases/ImportModal.tsx, v2/src/components/cases/__tests__/ImportModal.test.tsx, v2/src/lib/import/caseImport.ts, v2/convex/cases.ts</files>
  <action>
TDD: Write tests FIRST, then implement.

Create ImportModal component:

**Modal UI:**
- Trigger: "Import Cases" button in page header (or filter bar)
- Modal content:
  1. File dropzone (drag & drop or click to browse)
  2. Accepted formats: .json only
  3. Preview table showing parsed cases
  4. Validation errors displayed inline
  5. Import button (disabled if errors)
  6. Cancel button

**Import Logic (caseImport.ts):**
```typescript
export function parseCaseImportFile(file: File): Promise<ImportResult> {
  // 1. Read file contents
  // 2. Parse JSON
  // 3. Detect format (v2 export or legacy Firebase format)
  // 4. Validate each case:
  //    - Required fields present
  //    - Dates are valid
  //    - Status values are valid
  // 5. Return { valid: Case[], errors: ImportError[] }
}
```

**Legacy Format Detection:**
- Check for Firebase-style IDs or field names
- Auto-map legacy fields to v2 schema
- Show warning: "Legacy format detected, X fields will be migrated"

**Convex Mutation:**
Add `importCases` mutation that:
- Accepts array of case data
- Creates cases with owner set to current user
- Returns count of imported cases

**Preview Table:**
- Show first 10 cases in scrollable table
- Columns: Employer, Beneficiary, Status, Dates count
- Error rows highlighted in red
- Total count: "X cases ready to import, Y errors"

Add tests for:
- File upload triggers parsing
- Valid JSON parsed correctly
- Invalid JSON shows error
- Legacy format auto-detected
- Validation errors displayed
- Import button disabled with errors
- Successful import closes modal
  </action>
  <verify>pnpm test v2/src/components/cases/__tests__/ImportModal.test.tsx passes</verify>
  <done>Import modal works with preview, validation, and legacy format support</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete case list with selection mode, bulk actions, export/import</what-built>
  <how-to-verify>
    1. Run: cd v2 && pnpm dev
    2. Visit: http://localhost:3000/cases
    3. Test selection mode:
       - Click "Select Cases" button
       - Checkboxes appear on cards
       - Select a few cases
       - Selection bar shows correct count
       - Select All/Deselect All work
    4. Test export:
       - With cases selected, click Export CSV
       - File downloads with correct filename
       - Open CSV — verify format is correct
       - Test Export JSON similarly
    5. Test import:
       - Click Import Cases
       - Drag/drop a JSON file
       - Preview shows parsed cases
       - Validation errors display for bad data
       - Import creates cases in database
    6. Test bulk actions:
       - Select cases, click Delete
       - Confirmation modal appears
       - Confirm — cases are soft-deleted
       - Test Archive similarly
    7. Check responsive layout on mobile
    8. Check dark mode compatibility
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm test` passes all new tests
- [ ] `pnpm build` succeeds without errors
- [ ] No TypeScript errors
- [ ] Selection mode toggles correctly
- [ ] Export produces valid CSV/JSON files
- [ ] Import parses and validates correctly
- [ ] Bulk delete/archive work with confirmation
- [ ] Human verification checkpoint passed
</verification>

<success_criteria>
- All 4 tasks completed (including human checkpoint)
- All verification checks pass
- Selection mode is intuitive
- Export includes all fields
- Import handles legacy formats
- Bulk actions have proper confirmations
- Visual design approved by user
- Phase 21 complete
</success_criteria>

<output>
After completion, create `.planning/phases/21-case-list/21-04-SUMMARY.md`:

# Phase 21-04: Selection Mode + Export/Import Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Phase 21 complete. Ready for Phase 22 (Case Forms).
</output>
