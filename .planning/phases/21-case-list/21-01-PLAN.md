---
phase: 21-case-list
plan: 01
type: execute
---

<objective>
Extend Convex data layer with case list queries supporting filtering, sorting, search, and pagination.

Purpose: Provide the backend foundation for the case list page with efficient querying patterns.
Output: Enhanced cases.ts with list query, search index, and helper types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-case-list/21-CONTEXT.md
@perm_flow.md

**Prior Phase Summary:**
@.planning/phases/20-dashboard/20-04-SUMMARY.md

**Existing Data Layer:**
@v2/convex/cases.ts
@v2/convex/lib/dashboardTypes.ts
@v2/convex/lib/dashboardHelpers.ts

**Codebase Constraints:**
- TDD throughout (tests before code)
- Real-time via Convex subscriptions
- TypeScript strict mode, no `any` types
- Build on Phase 20 dashboard patterns

**CRITICAL INSTRUCTIONS:**
All agents/subagents MUST read before implementation:
1. .planning/FRONTEND_DESIGN_SKILL.md
2. perm_flow.md (source of truth for statuses)
3. v2/docs/DESIGN_SYSTEM.md

Code must be: clean, organized, minimal, abstractable, scalable, maintainable, readable.
Fixes must be GLOBAL â€” no repeated code, abstract patterns into reusable utilities.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create case list query types and interfaces</name>
  <files>v2/convex/lib/caseListTypes.ts, v2/convex/lib/caseListTypes.test.ts</files>
  <exploration>
    Use Explore agent to understand existing dashboardTypes.ts patterns.
    Check how CaseStatus and ProgressStatus are currently defined.
  </exploration>
  <action>
TDD: Write tests FIRST, then implement.

Create types for case list functionality:
- `CaseListFilters` - status, progressStatus, searchQuery, favoritesOnly
- `CaseListSort` - sortBy (deadline, updated, employer, status, pwdFiled, etaFiled, i140Filed), sortOrder (asc/desc)
- `CaseListPagination` - page, pageSize, totalCount, totalPages
- `CaseListResponse` - cases array + pagination metadata
- `CaseCardData` - Minimal projection for card display (id, employer, beneficiary, status, progressStatus, nextDeadline, badges, dates)

Follow existing dashboardTypes.ts patterns. Use const arrays for literal types.
Export all types from convex/lib/index.ts.
  </action>
  <verify>pnpm test v2/convex/lib/caseListTypes.test.ts passes</verify>
  <done>All case list types defined with full type coverage, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Implement filtered case list query</name>
  <files>v2/convex/cases.ts, v2/convex/cases.test.ts</files>
  <exploration>
    Use Explore agent to understand existing cases.list() query.
    Check how dashboard queries filter by status.
  </exploration>
  <action>
TDD: Write tests FIRST, then implement.

Add new query `listFiltered` to cases.ts:
```typescript
export const listFiltered = query({
  args: {
    status: v.optional(v.string()),        // CaseStatus filter
    progressStatus: v.optional(v.string()), // ProgressStatus filter
    searchQuery: v.optional(v.string()),    // Employer/beneficiary search
    favoritesOnly: v.optional(v.boolean()), // Favorites filter
    sortBy: v.optional(v.string()),         // Sort field
    sortOrder: v.optional(v.string()),      // asc/desc
    page: v.optional(v.number()),           // Page number (1-indexed)
    pageSize: v.optional(v.number()),       // Items per page
  },
  handler: async (ctx, args) => {
    // 1. Get authenticated user
    // 2. Query cases with ownership filter
    // 3. Apply status/progressStatus filters
    // 4. Apply search filter (case-insensitive employer/beneficiary match)
    // 5. Apply favorites filter
    // 6. Sort results
    // 7. Apply pagination (calculate offset, slice)
    // 8. Return CaseListResponse with cases + pagination
  }
});
```

Handle defaults: page=1, pageSize=12, sortBy="nextDeadline", sortOrder="asc".
Exclude soft-deleted cases (deletedAt != null).
Calculate nextDeadline from case dates using dashboardHelpers.
  </action>
  <verify>pnpm test v2/convex/cases.test.ts passes, all filter combinations work</verify>
  <done>listFiltered query works with all filter/sort/pagination options</done>
</task>

<task type="auto">
  <name>Task 3: Create case list helpers and projections</name>
  <files>v2/convex/lib/caseListHelpers.ts, v2/convex/lib/caseListHelpers.test.ts</files>
  <action>
TDD: Write tests FIRST, then implement.

Create helper functions for case list:

1. `projectCaseForCard(case)` - Convert full case to CaseCardData:
   - Extract: id, employerName, beneficiaryIdentifier, caseStatus, progressStatus
   - Calculate: nextDeadline (type, date, daysUntil, urgency)
   - Derive: badges (isProfessional, hasActiveRfi, hasActiveRfe, calendarSyncEnabled)
   - Include: key dates (pwdFiled, pwdDetermined, pwdExpires, etc.)
   - Include: isFavorite, updatedAt

2. `calculateNextDeadline(case)` - Find most urgent upcoming deadline:
   - Check all deadline types in order of urgency
   - Return { type, date, daysUntil, urgency } or null if no deadlines

3. `sortCases(cases, sortBy, sortOrder)` - Sort case array:
   - Support all sort options from 21-CONTEXT.md
   - Handle null dates (sort to end)

4. `filterBySearch(cases, query)` - Case-insensitive search:
   - Match against employerName, beneficiaryIdentifier, positionTitle
   - Return filtered array

Export from convex/lib/index.ts.
  </action>
  <verify>pnpm test v2/convex/lib/caseListHelpers.test.ts passes</verify>
  <done>All helpers implemented with full test coverage, edge cases handled</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm test` passes all new tests
- [ ] `pnpm build` succeeds without errors
- [ ] TypeScript strict mode satisfied (no `any` types)
- [ ] listFiltered query accessible in Convex dashboard
- [ ] All exports added to convex/lib/index.ts
</verification>

<success_criteria>
- All 3 tasks completed
- All verification checks pass
- Case list query returns correct data shape
- Filtering/sorting/pagination work correctly
- Search matches employer, beneficiary, position
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-case-list/21-01-SUMMARY.md`:

# Phase 21-01: Data Layer & Case Queries Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 21-02-PLAN.md (Case Card Component)
</output>
