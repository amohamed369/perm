---
phase: 25.1-calendar-sync
plan: 04
type: execute
domain: react-ui
---

<objective>
Update CalendarSyncSection UI with Connect/Disconnect buttons, real-time connection status, and Sync All Cases action.

Purpose: Replace "Coming Soon" with functional Google Calendar integration UI.
Output: CalendarSyncSection with working OAuth flow, disconnect button, and bulk sync capability.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25.1-calendar-sync/25.1-CONTEXT.md
@.planning/phases/25.1-calendar-sync/25.1-01-SUMMARY.md
@.planning/phases/25.1-calendar-sync/25.1-02-SUMMARY.md
@.planning/phases/25.1-calendar-sync/25.1-03-SUMMARY.md
@.planning/FRONTEND_DESIGN_SKILL.md

**Depends on:** Plans 01-03 (OAuth, CRUD, Hooks)

**Current UI:**
- CalendarSyncSection.tsx exists with "Coming Soon" banner
- Connection status badge (reads googleCalendarConnected)
- Master toggle + 7 deadline type toggles
- Neobrutalist styling matching ProfileSection

**Required UI Updates:**
- Remove "Coming Soon" banner
- Add "Connect Calendar" button (OAuth flow)
- Add "Disconnect" button when connected
- Add "Sync All Cases" button when connected
- Show progress indicator during bulk sync
- Handle OAuth popup blocked/timeout

**v1 Reference:**
- Settings UI: `frontend/src/js/pages/settings.js`

## Required Reading (MANDATORY)
| Doc | Path | Purpose |
|-----|------|---------|
| FRONTEND_DESIGN_SKILL.md | `.planning/FRONTEND_DESIGN_SKILL.md` | Design system |
| CalendarSyncSection.tsx | Current component | Existing patterns |
| CONTEXT.md | `.planning/phases/25.1-calendar-sync/25.1-CONTEXT.md` | Edge cases |

## Quality Standards
- Match existing neobrutalist design patterns
- Motion animations for state changes
- Toast notifications for success/error
- Proper loading states
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Connect Calendar button with OAuth flow</name>
  <files>
    v2/src/components/settings/CalendarSyncSection.tsx
  </files>
  <exploration>
    Read @.planning/FRONTEND_DESIGN_SKILL.md before starting.

    Use Explore agent to understand:
    - Current CalendarSyncSection structure
    - Button patterns in other settings sections
    - How OAuth redirects are handled in Next.js
  </exploration>
  <action>
    Update CalendarSyncSection to add Connect button:

    1. **Remove "Coming Soon" banner** at the top

    2. **Replace connection status section** with interactive UI:
       ```tsx
       {/* Google Calendar Connection */}
       <div className="flex items-center justify-between p-4 bg-muted/50 border border-border mb-5">
         <div className="flex items-center gap-3">
           <div className="p-2 bg-background border border-border">
             <Cloud className="w-5 h-5 text-muted-foreground" />
           </div>
           <div>
             <p className="text-sm font-medium text-foreground">Google Calendar</p>
             <p className="text-xs text-muted-foreground">
               {isConnected
                 ? `Connected as ${profile.googleEmail || 'your Google account'}`
                 : "Connect to sync deadlines automatically"}
             </p>
           </div>
         </div>

         {isConnected ? (
           <button
             onClick={handleDisconnect}
             disabled={isDisconnecting}
             className="px-3 py-1.5 text-sm font-medium bg-destructive text-destructive-foreground
                        border-2 border-black dark:border-white/20
                        hover:brightness-95 active:translate-x-0.5 active:translate-y-0.5
                        disabled:opacity-50 disabled:cursor-not-allowed"
             style={{ boxShadow: "2px 2px 0px #000" }}
           >
             {isDisconnecting ? "Disconnecting..." : "Disconnect"}
           </button>
         ) : (
           <button
             onClick={handleConnect}
             disabled={isConnecting}
             className="px-3 py-1.5 text-sm font-medium bg-primary text-primary-foreground
                        border-2 border-black dark:border-white/20
                        hover:brightness-95 active:translate-x-0.5 active:translate-y-0.5
                        disabled:opacity-50 disabled:cursor-not-allowed"
             style={{ boxShadow: "2px 2px 0px #000" }}
           >
             {isConnecting ? "Connecting..." : "Connect Calendar"}
           </button>
         )}
       </div>
       ```

    3. **Add connect handler**:
       ```typescript
       const [isConnecting, setIsConnecting] = useState(false);

       const handleConnect = async () => {
         setIsConnecting(true);
         try {
           // Open OAuth flow in same tab (redirect)
           window.location.href = '/api/google/connect';
         } catch (error) {
           console.error('Failed to start OAuth:', error);
           toast.error('Failed to connect. Please try again.');
           setIsConnecting(false);
         }
       };
       ```

    4. **Add disconnect handler**:
       ```typescript
       const [isDisconnecting, setIsDisconnecting] = useState(false);

       const handleDisconnect = async () => {
         setIsDisconnecting(true);
         try {
           const response = await fetch('/api/google/disconnect', {
             method: 'POST',
           });

           if (!response.ok) throw new Error('Disconnect failed');

           toast.success('Google Calendar disconnected');
           // Profile will update via Convex subscription
         } catch (error) {
           console.error('Failed to disconnect:', error);
           toast.error('Failed to disconnect. Please try again.');
         } finally {
           setIsDisconnecting(false);
         }
       };
       ```

    5. **Handle OAuth callback query params** (connected=true, error=...):
       ```typescript
       // At component mount, check for callback params
       useEffect(() => {
         const params = new URLSearchParams(window.location.search);
         if (params.get('connected') === 'true') {
           toast.success('Google Calendar connected!');
           // Clean up URL
           window.history.replaceState({}, '', '/settings?tab=calendar');
         }
         if (params.get('error')) {
           const error = params.get('error');
           toast.error(`Connection failed: ${error}`);
           window.history.replaceState({}, '', '/settings?tab=calendar');
         }
       }, []);
       ```
  </action>
  <verify>
    - Connect button visible when not connected
    - Disconnect button visible when connected
    - OAuth redirect works
    - Toast notifications show
  </verify>
  <done>
    Connect/Disconnect buttons working with proper state handling
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Sync All Cases button with progress</name>
  <files>
    v2/src/components/settings/CalendarSyncSection.tsx
    v2/convex/googleCalendarActions.ts (add syncAllCases action)
  </files>
  <exploration>
    Use Explore agent to understand:
    - How to get all user cases from Convex
    - Progress indicator patterns in existing components
    - How to handle long-running operations in UI
  </exploration>
  <action>
    1. **Add syncAllCases action in v2/convex/googleCalendarActions.ts**:
       ```typescript
       // Sync all cases for a user (manual trigger)
       export const syncAllCases = action({
         args: {},
         handler: async (ctx) => {
           const identity = await ctx.auth.getUserIdentity();
           if (!identity) throw new Error("Not authenticated");

           const userId = identity.subject as Id<"users">;

           // Check if connected
           const syncCheck = await ctx.runQuery(internal.googleAuth.shouldSyncCalendar, { userId });
           if (!syncCheck.shouldSync) {
             return { success: false, error: syncCheck.reason };
           }

           // Get all user cases
           const cases = await ctx.runQuery(internal.cases.listForSync, { userId });

           // Sync each case
           let synced = 0;
           let failed = 0;

           for (const caseData of cases) {
             if (caseData.calendarSyncEnabled !== false) {
               try {
                 await ctx.runAction(internal.googleCalendarActions.syncCaseCalendarEvents, {
                   userId,
                   caseId: caseData._id,
                 });
                 synced++;
               } catch (error) {
                 failed++;
                 console.error(`Failed to sync case ${caseData._id}:`, error);
               }
             }
           }

           return { success: true, synced, failed, total: cases.length };
         },
       });
       ```

    2. **Add listForSync query in cases.ts**:
       ```typescript
       export const listForSync = internalQuery({
         args: { userId: v.id("users") },
         handler: async (ctx, args) => {
           return await ctx.db
             .query("cases")
             .withIndex("by_user_id", (q) => q.eq("userId", args.userId))
             .filter((q) => q.eq(q.field("deletedAt"), undefined))
             .collect();
         },
       });
       ```

    3. **Add Sync All button to CalendarSyncSection.tsx**:
       ```tsx
       const [isSyncing, setIsSyncing] = useState(false);
       const [syncProgress, setSyncProgress] = useState<{ synced: number; total: number } | null>(null);
       const syncAllCases = useAction(api.googleCalendarActions.syncAllCases);

       const handleSyncAll = async () => {
         setIsSyncing(true);
         setSyncProgress(null);

         try {
           const result = await syncAllCases();

           if (!result.success) {
             toast.error(result.error || 'Sync failed');
             return;
           }

           setSyncProgress({ synced: result.synced, total: result.total });
           toast.success(`Synced ${result.synced} of ${result.total} cases`);
         } catch (error) {
           console.error('Failed to sync:', error);
           toast.error('Failed to sync cases');
         } finally {
           setIsSyncing(false);
         }
       };

       // Render button (only when connected)
       {isConnected && (
         <div className="flex items-center justify-between p-4 bg-background border border-border">
           <div>
             <p className="text-sm font-medium text-foreground">Sync All Cases</p>
             <p className="text-xs text-muted-foreground">
               {syncProgress
                 ? `Last sync: ${syncProgress.synced} of ${syncProgress.total} cases`
                 : "Manually sync all case deadlines to Google Calendar"}
             </p>
           </div>
           <button
             onClick={handleSyncAll}
             disabled={isSyncing}
             className="px-3 py-1.5 text-sm font-medium bg-secondary text-secondary-foreground
                        border-2 border-black dark:border-white/20
                        hover:brightness-95 active:translate-x-0.5 active:translate-y-0.5
                        disabled:opacity-50 disabled:cursor-not-allowed"
             style={{ boxShadow: "2px 2px 0px #000" }}
           >
             {isSyncing ? (
               <span className="flex items-center gap-2">
                 <Loader2 className="w-4 h-4 animate-spin" />
                 Syncing...
               </span>
             ) : (
               "Sync All"
             )}
           </button>
         </div>
       )}
       ```
  </action>
  <verify>
    - Sync All button appears when connected
    - Button shows loading state during sync
    - Progress shows synced/total count
    - Toast notifications work
  </verify>
  <done>
    Sync All Cases button with progress indicator working
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Calendar Sync Settings UI with:
    - Connect Calendar button (initiates OAuth)
    - Disconnect button (when connected)
    - Connection status with Google email
    - Sync All Cases button with progress
    - All 7 deadline type toggles (existing)
    - Neobrutalist styling
  </what-built>
  <how-to-verify>
    1. Run: `cd v2 && pnpm dev` (frontend) and `npx convex dev` (backend)
    2. Visit: http://localhost:3000/settings?tab=calendar
    3. Verify UI when NOT connected:
       - "Connect Calendar" button visible
       - Deadline toggles visible but functional
       - No "Coming Soon" banner
    4. (Optional) Click Connect Calendar:
       - Should redirect to Google OAuth
       - After auth, redirect back with ?connected=true
       - Toast shows "Connected!"
    5. Verify UI when connected:
       - "Disconnect" button visible
       - Google email shown
       - "Sync All" button visible
    6. Click Sync All:
       - Loading spinner shows
       - Toast shows result
       - Progress count updates
    7. Check neobrutalist styling:
       - 4px box shadows
       - 2px borders
       - Active state translate
  </how-to-verify>
  <resume-signal>Type "approved" if UI looks correct, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Connect button initiates OAuth flow
- [ ] Disconnect button clears tokens
- [ ] Connection status shows email when connected
- [ ] Sync All button syncs all cases with progress
- [ ] Toast notifications for all actions
- [ ] Neobrutalist styling maintained
- [ ] Human verification approved
</verification>

<success_criteria>
- All 3 tasks completed (2 auto + 1 human-verify)
- CalendarSyncSection fully functional
- OAuth flow works end-to-end
- Sync All with progress works
- Ready for Plan 05 (Edge Cases + Tests)
</success_criteria>

<output>
After completion, create `.planning/phases/25.1-calendar-sync/25.1-04-SUMMARY.md`:

# Phase 25.1 Plan 04: Settings UI Update Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 25.1-05-PLAN.md (Edge Cases + Tests)
</output>
