# Phase 25.1 Plan 01: OAuth Infrastructure Summary

**Created Google OAuth infrastructure for calendar integration with Next.js API routes, Convex token storage, and automatic refresh capabilities.**

## Accomplishments

- Created 3 Next.js API routes for Google OAuth flow (connect, callback, disconnect)
- Implemented secure token storage with AES-256-GCM encryption in Convex
- Built token refresh action with auto-disconnect on revocation
- Added CSRF protection via state parameter in httpOnly cookies
- Separated calendar OAuth from Convex Auth (different client credentials)

## Files Created/Modified

### Created
- `v2/src/lib/google/oauth.ts` - Shared OAuth utilities (encodeState, decodeState, getOAuthClient, getAuthUrl, exchangeCodeForTokens, refreshAccessToken)
- `v2/src/app/api/google/connect/route.ts` - Initiates OAuth flow, redirects to Google consent screen
- `v2/src/app/api/google/callback/route.ts` - Handles OAuth callback, validates state, exchanges code for tokens
- `v2/src/app/api/google/disconnect/route.ts` - Clears tokens to disconnect calendar sync
- `v2/convex/googleAuth.ts` - Token storage mutations/queries (storeGoogleTokens, clearGoogleTokens, getGoogleConnectionStatus, getGoogleTokens, isGoogleCalendarConnected, internal mutations)
- `v2/convex/lib/googleHelpers.ts` - Helper utilities (isTokenExpired, calculateTokenExpiry, hasRequiredScopes)
- `v2/convex/googleCalendarActions.ts` - Token refresh action with auto-disconnect on revocation

### Modified
- `v2/convex/schema.ts` - Added privacyModeEnabled field (legacy data compatibility)
- `v2/convex/lib/crypto.ts` - Already had encryptToken/decryptToken (reused)

## Dependencies Added

- `google-auth-library@^10.5.0` - Official Google OAuth client library

## Environment Variables Required

| Variable | Purpose |
|----------|---------|
| `GOOGLE_CALENDAR_CLIENT_ID` | Calendar OAuth client ID (separate from AUTH_GOOGLE_CLIENT_ID) |
| `GOOGLE_CALENDAR_CLIENT_SECRET` | Calendar OAuth client secret |
| `NEXT_PUBLIC_APP_URL` | Base URL for redirect URI |
| `OAUTH_ENCRYPTION_KEY` | 64-character hex string for token encryption |

## Architecture Decisions

| Decision | Rationale |
|----------|-----------|
| Separate OAuth credentials for calendar | Allows different scopes/permissions from app login |
| Store tokens encrypted in userProfiles | Security - tokens encrypted at rest with AES-256-GCM |
| Internal queries for token retrieval | Tokens never exposed to client - only server-side actions |
| Auto-disconnect on token revocation | Clean handling when user revokes in Google settings |
| 5-minute token expiry buffer | Prevents mid-request token expiration |

## Security Features

- **State parameter validation** - Prevents CSRF attacks
- **httpOnly cookies** - State not accessible to JavaScript
- **User ID verification** - State userId must match current authenticated user
- **Token encryption** - AES-256-GCM encryption before storage
- **Internal functions for tokens** - Tokens only accessible from server-side Convex actions

## Issues Encountered

- **Schema mismatch** - Existing userProfiles data had `privacyModeEnabled` field not in schema. Added it back as optional field for data compatibility.

## Next Step

Ready for 25.1-02-PLAN.md (Calendar Event CRUD) - creating/updating/deleting Google Calendar events for case deadlines.
