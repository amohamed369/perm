# Phase 25.1: Calendar Sync (One-Way) - Context

**Gathered:** 2025-12-31
**Status:** Ready for planning

---

<vision>
## How This Should Work

One-way sync from App to Google Calendar, matching v1 behavior with v2 polish. When a user connects their Google Calendar:

1. **Connect once, forget about it** - OAuth flow is seamless, one click
2. **Automatic sync on every case change** - Create/update/delete cases automatically syncs events
3. **Visible but unobtrusive indicators** - Case cards show sync status, settings show connection
4. **Manual control when needed** - "Sync All Cases" button, per-case sync option
5. **Graceful edge case handling** - Not connected? Show hint. Token expired? Auto-refresh or prompt reconnect.

**The experience should feel professional and production-grade.** Users don't think about syncing - it just works. But when something's wrong (not connected, error), they get clear guidance on how to fix it.

**Key behaviors matching v1:**
- Delete case = delete calendar events
- Disconnect = clear tokens, leave events in Google (user can delete manually)
- Only sync future deadlines (skip past dates)
- Delete-and-recreate on update (simple, reliable)

</vision>

<essential>
## What Must Be Nailed

**All three are equally critical - can't ship without all being solid:**

1. **Seamless OAuth Flow**
   - "Connect Calendar" button just works
   - No friction, no confusing errors
   - Handle popup blocked, timeout, partial scope grant

2. **Reliable Sync Triggers**
   - Every case create syncs relevant events
   - Every case update updates/deletes relevant events
   - Every case delete removes all events
   - toggleCalendarSync ON/OFF syncs or removes all

3. **Proper Edge Case Handling**
   - Not connected: Show hint + redirect to settings
   - Token expired: Auto-refresh or prompt reconnect
   - Token revoked: Auto-disconnect + clear message
   - API errors: Log, don't block case operations
   - Rate limits: Exponential backoff

</essential>

<boundaries>
## What's Out of Scope

**Explicitly NOT building in this phase:**

- **Two-way sync (webhooks)** - No Google → App sync, one-way only
- **Multiple calendar providers** - Google only, no Outlook/Apple/iCal
- **Shared/team calendars** - Only user's primary calendar
- **Gmail OAuth** - Separate integration, not this phase
- **Offline sync** - Requires service worker, that's Phase 31
- **Calendar invites/attendees** - Just deadline events, no meetings
- **Recurring events** - Each deadline is a single all-day event
- **Historical event sync** - Only future deadlines

</boundaries>

<specifics>
## Specific Requirements

### Event Format (Match v1)
```
Title: "{Type}: {Employer}"
Examples:
- "PWD Expiration: Acme Corp"
- "I-140 Deadline: Tech Solutions Inc"
- "RFI Response Due: Global Services - RFI #1"

Type: All-day events (no time component)
Timezone: UTC
Description: Multi-line with case details and case ID
```

### 8 Event Types
| Event Type | Preference Field | What It Syncs |
|------------|------------------|---------------|
| PWD Expiration | `calendarSyncPwd` | PWD expiration date |
| ETA 9089 Filing | `calendarSyncEta9089` | Filing date |
| ETA 9089 Expiration | `calendarSyncEta9089` | 180 days after certification |
| Ready to File | `calendarSyncFilingWindow` | 30 days after recruitment ends |
| Recruitment Expires | `calendarSyncRecruitment` | 180 days after recruitment ends |
| I-140 Deadline | `calendarSyncI140` | 180 days after ETA certification |
| RFI Response Due | `calendarSyncRfi` | Per RFI entry |
| RFE Response Due | `calendarSyncRfe` | Per RFE entry |

### UI Patterns
- Settings: "Connect Calendar" button replaces "Coming Soon"
- Settings: Connection status badge (green connected, gray not)
- Settings: "Disconnect" button when connected
- Settings: "Sync All Cases" button when connected
- Case Card: Calendar icon with "Sync" label when enabled
- Case Detail: Toggle in header + dropdown option
- Calendar Page: Hint if Google not connected

</specifics>

---

## Current v2 State

| Component | Status | Notes |
|-----------|--------|-------|
| Schema fields | ✅ Complete | 7 toggles, tokens, event IDs in schema.ts |
| Settings UI | ✅ Complete | CalendarSyncSection.tsx with "Coming Soon" |
| In-app calendar | ✅ Complete | Phase 23.1 |
| Case card indicator | ✅ Complete | Shows when calendarSyncEnabled=true |
| Case detail toggle | ✅ Complete | toggleCalendarSync mutation exists |
| Google OAuth | ❌ Not built | Need Next.js API routes |
| Event CRUD | ❌ Not built | Need Convex actions |
| Sync hooks | ❌ Not built | Need to hook into case mutations |
| "Not connected" handling | ❌ Not built | Need validation + hints |

---

## Complete Edge Case Inventory

### Category 1: "Not Connected" State Handling (10 cases)

| # | Location | Edge Case | Required Handling |
|---|----------|-----------|-------------------|
| 1 | Case Detail - Sync Toggle | User clicks sync but Google not connected | Check first, show toast + redirect hint |
| 2 | Case Card - Sync Indicator | Shows "Sync" but not actually connected | Show warning indicator or hide |
| 3 | Settings - Deadline Toggles | Toggles enabled but Google not connected | Disable toggles + show warning banner |
| 4 | Calendar Page | User expects Google sync but not connected | Show connection hint/CTA |
| 5 | Backend Mutation | toggleCalendarSync allows toggle without connection | Add validation in mutation |
| 6 | Bulk Sync Button | User clicks "Sync All" but not connected | Check first, redirect to settings |
| 7 | Per-case Dropdown | "Sync to Calendar" when not connected | Check first, show helpful message |
| 8 | Token Expired | Token valid on check but expires during sync | Auto-refresh before operations |
| 9 | Token Revoked | User revoked in Google settings | Auto-disconnect, show clear error |
| 10 | Partial Scope Grant | User unchecks calendar in Google OAuth | Validate scopes after OAuth |

### Category 2: Sync Operation Edge Cases (13 cases)

| # | Edge Case | Handling |
|---|-----------|----------|
| 11 | Rate limit (429) from Google | Exponential backoff, log, don't block |
| 12 | Token expires mid-sync | Auto-refresh before each batch |
| 13 | Event already deleted in Google (404) | Log warning, remove stale ID from DB |
| 14 | Multiple RFIs same due date | Creates duplicate events (acceptable) |
| 15 | Case has no deadlines | Skip gracefully, return empty |
| 16 | Very long employer name | Truncate before sending to Google |
| 17 | Special chars in name (XSS) | Sanitize before sending |
| 18 | Emoji in employer name | Test UTF-8 handling |
| 19 | Dates in far past | Skip past deadlines |
| 20 | Dates in far future (2099) | Allow (acceptable) |
| 21 | Network timeout | Configurable timeout, log failure |
| 22 | Partial sync failure | Best-effort + log failures |
| 23 | Concurrent syncs (race) | Consider user-level lock |

### Category 3: Case Lifecycle Events (10 cases)

| # | Event | Calendar Action |
|---|-------|-----------------|
| 24 | Case created | Create events if sync enabled |
| 25 | Case updated | Update/delete changed events |
| 26 | Case soft-deleted | Delete all calendar events |
| 27 | Case restored | Recreate calendar events |
| 28 | Case duplicated | New case = new events |
| 29 | Case imported (CSV/JSON) | Prompt manual sync after import |
| 30 | Case archived (terminal status) | Delete future events |
| 31 | toggleCalendarSync ON | Create all events |
| 32 | toggleCalendarSync OFF | Delete all events |
| 33 | Deadline type preference OFF | Consider immediate cleanup |

### Category 4: Settings UI Edge Cases (10 cases)

| # | Edge Case | Handling |
|---|-----------|----------|
| 34 | Rapid toggle clicks | Add debounce (300ms) |
| 35 | All deadline types disabled | Show warning |
| 36 | Network fail during save | Error toast + retry option |
| 37 | OAuth popup blocked | Detection + helpful message |
| 38 | OAuth timeout | 90s timeout, show error |
| 39 | Browser close during OAuth | Verify on next load |
| 40 | Navigate away during OAuth | Cleanup on unmount |
| 41 | Long bulk sync (many cases) | Progress indicator |
| 42 | Concurrent setting changes | Last-write-wins (acceptable) |
| 43 | Settings load failure | Show error state |

### Category 5: Disconnect/Reconnect Flow (5 cases)

| # | Edge Case | Handling |
|---|-----------|----------|
| 44 | Disconnect - delete events? | No, leave in Google |
| 45 | Disconnect - clear tokens | Yes, clear all |
| 46 | Reconnect - recreate events? | Prompt "Sync All" |
| 47 | Different Google account | Overwrites tokens, clear old event IDs |
| 48 | Reconnect with stale event IDs | Clear IDs on disconnect |

### Category 6: v2 Convex-Specific Edge Cases (8 cases)

| # | Edge Case | Handling |
|---|-----------|----------|
| 49 | Optimistic update fails after navigation | Consider persistent notification |
| 50 | Query cache stale after mutation | Invalidate cache on mutation |
| 51 | Concurrent edits from multiple devices | Last-write-wins (acceptable) |
| 52 | Subscription race with mutation | Use mutation return value |
| 53 | Partial bulk import failure | Best-effort, log failures |
| 54 | Email rate limiting on bulk ops | Already limited to 10 |
| 55 | Auth token expiry during operation | Check before, not during |
| 56 | Service worker caching | Don't cache query responses |

### Category 7: Data Edge Cases (6 cases)

| # | Edge Case | Handling |
|---|-----------|----------|
| 57 | RFI resolved but event exists | Delete event on resolution |
| 58 | RFI array empty vs null | Handle both |
| 59 | calendarEventIds has stale IDs | Cleanup on 404 |
| 60 | Case-level sync OFF but has events | Delete on toggle OFF |
| 61 | User-level sync OFF mid-operation | Check before each event |
| 62 | Timezone handling | UTC all-day events |

---

## Complete Issue List (37 items)

### Core OAuth & Tokens
| # | Issue | Priority | Complexity |
|---|-------|----------|------------|
| 1 | Google OAuth flow (Next.js API routes) | High | Medium |
| 2 | Token storage in userProfiles | High | Low |
| 3 | Token refresh mechanism | High | Medium |
| 4 | Scope validation after OAuth | Medium | Low |
| 5 | Disconnect flow (clear tokens, keep events) | Medium | Low |

### Calendar Event CRUD
| # | Issue | Priority | Complexity |
|---|-------|----------|------------|
| 6 | Create event action (single deadline) | High | Medium |
| 7 | Update event action | High | Low |
| 8 | Delete event action | High | Low |
| 9 | Handle 404 (event deleted in Google) | Medium | Low |
| 10 | Rate limit handling (429 + backoff) | Medium | Medium |

### Case Mutation Hooks
| # | Issue | Priority | Complexity |
|---|-------|----------|------------|
| 11 | Hook into case create | High | Medium |
| 12 | Hook into case update | High | Medium |
| 13 | Hook into case delete (soft) | High | Low |
| 14 | Hook into case restore | Medium | Low |
| 15 | Hook into toggleCalendarSync | High | Medium |

### "Not Connected" Handling
| # | Issue | Priority | Complexity |
|---|-------|----------|------------|
| 16 | Case detail toggle - check connection first | High | Low |
| 17 | Backend mutation - validate connection | High | Low |
| 18 | CaseCard indicator - show warning if disconnected | Medium | Low |
| 19 | Calendar page - show connection hint | Low | Low |
| 20 | Error messages + redirect to settings | High | Low |

### Settings UI
| # | Issue | Priority | Complexity |
|---|-------|----------|------------|
| 21 | "Connect Calendar" OAuth button | High | Medium |
| 22 | "Disconnect" button | Medium | Low |
| 23 | Connection status badge (real) | Medium | Low |
| 24 | "Sync All Cases" button | Medium | Medium |
| 25 | Progress indicator for bulk sync | Low | Medium |
| 26 | Debounce rapid toggles | Medium | Low |
| 27 | Warn if all deadline types disabled | Low | Low |

### Manual Sync
| # | Issue | Priority | Complexity |
|---|-------|----------|------------|
| 28 | Per-case sync from dropdown | Medium | Low |
| 29 | Sync after CSV import (prompt) | Low | Low |

### Edge Case Hardening
| # | Issue | Priority | Complexity |
|---|-------|----------|------------|
| 30 | Token expiry check before operations | Medium | Low |
| 31 | Revoked token auto-disconnect | Medium | Medium |
| 32 | Stale event ID cleanup | Low | Medium |
| 33 | Skip past deadlines (only future) | Medium | Low |
| 34 | Sanitize names before sending | Medium | Low |

### Tests
| # | Issue | Priority | Complexity |
|---|-------|----------|------------|
| 35 | Unit tests for OAuth, CRUD, hooks | High | Medium |
| 36 | Integration tests with mocked Google | Medium | High |
| 37 | E2E tests (production only) | Low | High |

---

## v1 Reference Files

| Purpose | File Path |
|---------|-----------|
| Core sync logic | `backend/app/services/calendar_integration.py` (674 lines) |
| Google API calls | `backend/app/services/calendar_service.py` |
| OAuth flow | `backend/app/api/google_services.py` |
| Token management | `backend/app/utils/google_oauth.py` |
| Frontend sync | `frontend/src/js/utils/calendarSync.js` |
| Settings UI | `frontend/src/js/pages/settings.js` |
| "Not connected" patterns | `frontend/public/js/chatbot-confirmation.js` |

---

<meta_instructions>
## META: Instructions for Plan Phase & Subagents

**CRITICAL: These instructions MUST cascade through all phases of execution.**

### For Plan Phase (when creating PLAN.md files)

Every PLAN.md MUST include these sections verbatim:

```markdown
## Required Reading (MANDATORY for all subagents)

Before ANY implementation, subagents MUST read:

| Doc | Path | Purpose |
|-----|------|---------|
| perm_flow.md | `/Users/adammohamed/cc/perm-tracker-test/perm_flow.md` | SOURCE OF TRUTH for deadlines, statuses |
| v2/CLAUDE.md | `/Users/adammohamed/cc/perm-tracker-test/v2/CLAUDE.md` | API patterns, imports, anti-patterns |
| frontend-design skill (its a plug-in) | `/Users/adammohamed/cc/perm-tracker-test/.planning/FRONTEND_DESIGN_SKILL.md` | UI work guidelines |
| Design docs | `/Users/adammohamed/cc/perm-tracker-test/.planning/phases/17-design-system/design*` | Visual references |
| This CONTEXT.md | `.planning/phases/25.1-calendar-two-way-sync/25.1-CONTEXT.md` | Edge cases, requirements |

## Quality Standards (MANDATORY for all subagents)

- **DRY** - Don't Repeat Yourself, abstract common patterns
- **KISS** - Keep It Simple, minimal complexity
- **Clean** - Organized, readable, maintainable code
- **No clashing** - No duplicate or conflicting implementations
- **Work within existing** - Use existing patterns, don't reinvent
- **Refactor as needed** - Improve code you touch for consistency
- **Global fixes** - Fix issues globally, not per-file hacks
- **Abstract where sensible** - Scalable, reusable patterns

## Edge Cases to Handle

[Include relevant edge cases from the inventory above]

## v1 Reference

[Include relevant v1 file paths for reference]
```

### For Execution Phase (Orchestrator Pattern)

```markdown
## Workflow

1. **Create JSON tracker** for all issues at start
2. **For each issue:**
   a. Spawn **Explore agent** to fully understand current state
   b. Review findings, adjust approach if needed
   c. Spawn **Task agent** with FULL context to implement
   d. **Verify** implementation (tests pass, no regressions)
   e. **Follow up** if issues found
3. **Update JSON tracker** throughout
4. **Clean up thoroughly** after completion
```

### Subagent Prompt Template

When spawning Task agents, include:

```
## Context
[Brief description of what this task accomplishes]

## Required Reading (READ BEFORE IMPLEMENTING)
- `/Users/adammohamed/cc/perm-tracker-test/perm_flow.md` - SOURCE OF TRUTH
- `/Users/adammohamed/cc/perm-tracker-test/v2/CLAUDE.md` - API patterns
- [Other relevant docs]

## Quality Standards
- DRY, KISS, clean, organized, minimal
- No clashing/duplicate implementations
- Work within existing code patterns
- Refactor as needed for consistency
- Global fixes, not repeated workarounds

## Edge Cases to Handle
[List specific edge cases relevant to this task]

## v1 Reference
[Relevant v1 files to check for patterns]

## Implementation
[Specific implementation instructions]

## Verification
[How to verify the implementation is correct]
```

</meta_instructions>

---

<notes>
## Additional Context

### Decisions Made During Discussion

| Decision | Rationale |
|----------|-----------|
| One-way sync only | Simpler, matches v1, webhooks need production HTTPS |
| Delete events on soft-delete | Match v1 behavior, clean calendar |
| Leave events on disconnect | User can delete manually in Google |
| Only future deadlines | Past deadlines not useful in calendar |
| UTC all-day events | Consistent, no timezone complexity |
| Delete-and-recreate on update | Simple, reliable, matches v1 |
| Best-effort sync | Don't block case operations on sync failure |
| Manual "Sync All" for reconnect | User explicitly triggers after reconnect |

### Technical Recommendations

| Topic | Recommendation |
|-------|----------------|
| Incremental sync (syncToken) | Not needed for one-way |
| Rate limiting | Exponential backoff, log failures |
| Retry logic | Manual "Sync All", no auto-retry |
| Event format | Match v1 exactly for consistency |
| Token refresh | Auto-refresh before operations |

### Quality Bar

This phase should result in:
- **Zero** cases where sync silently fails without user awareness
- **Zero** cases where "not connected" state is confusing
- **100%** feature parity with v1 calendar sync
- **Clean** integration with existing v2 patterns
- **Comprehensive** test coverage

</notes>

---

*Phase: 25.1-calendar-sync*
*Context gathered: 2025-12-31*
*Scope: One-way sync (App → Google Calendar)*
