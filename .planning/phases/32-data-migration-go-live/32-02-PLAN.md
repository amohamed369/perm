---
phase: 32-data-migration-go-live
plan: 02
type: execute
---

<objective>
Fix v2 calendar sync gaps before go-live to prevent orphaned Google Calendar events.

Purpose: Ensure v2 properly cleans up calendar events when users change preferences.
Output: Auto-cleanup on preference toggles, "Clear All Events" button in settings.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-data-migration-go-live/32-RESEARCH.md
@.planning/phases/32-data-migration-go-live/32-CONTEXT.md
@v2/convex/googleCalendarActions.ts
@v2/convex/calendar.ts
@v2/src/app/(authenticated)/settings/page.tsx

**Prior decisions affecting this plan:**
- Phase 25.1: Calendar OAuth infrastructure implemented
- v1 bug: unsync clears DB but not Google Calendar (orphaned events)
- v2 gaps identified: no auto-cleanup on preference toggle, no "clear all" button

**Calendar sync preferences (7 toggles):**
- calendarSyncPwd
- calendarSyncEta9089
- calendarSyncI140
- calendarSyncRfe
- calendarSyncRfi
- calendarSyncRecruitment
- calendarSyncFilingWindow

**Calendar sync architecture:**
- Events stored per-case in `calendarEventIds` object
- Google Calendar API calls via Next.js API routes (not Convex HTTP actions)
- OAuth tokens stored in userProfiles (encrypted)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-cleanup when user toggles off deadline type</name>
  <files>v2/convex/calendar.ts, v2/convex/googleCalendarActions.ts</files>
  <exploration>
    Use Explore agent to understand current updateCalendarPreferences mutation.
    Find where calendar sync toggles are updated in userProfiles.
  </exploration>
  <action>
Implement auto-cleanup when a calendar sync preference is toggled OFF:

1. In `calendar.ts`, modify or create mutation `updateCalendarSyncPreference`:
   - Accept: userId, preferenceName (e.g., "calendarSyncPwd"), newValue (boolean)
   - If newValue is FALSE:
     - Query all cases for this user where calendarSyncEnabled is true
     - For each case, delete the corresponding event type from Google Calendar
     - Clear the event ID from case's calendarEventIds
   - Update the preference in userProfiles
   - Use scheduler.runAfter for async Google Calendar API calls

2. Create internal action `bulkDeleteEventsByType`:
   - Accept: userId, eventType (e.g., "pwd_expiration")
   - Fetch user's OAuth tokens
   - Query all cases with that event type stored
   - Delete each event from Google Calendar
   - Clear event IDs from cases
   - Handle errors gracefully (some events may already be deleted)

3. Map preference names to event types:
   - calendarSyncPwd → pwd_expiration
   - calendarSyncEta9089 → eta9089_filing_window, eta9089_expiration
   - calendarSyncI140 → i140_filing_deadline
   - calendarSyncRfe → rfe_due
   - calendarSyncRfi → rfi_due
   - calendarSyncRecruitment → recruitment_end
   - calendarSyncFilingWindow → eta9089_filing_window

Use existing deleteCalendarEvent patterns from googleCalendarActions.ts.
  </action>
  <verify>Toggle off a calendar sync preference and verify corresponding events deleted from Google Calendar</verify>
  <done>Toggling off a sync preference auto-deletes all events of that type</done>
</task>

<task type="auto">
  <name>Task 2: Add "Clear All Calendar Events" action</name>
  <files>v2/convex/googleCalendarActions.ts, v2/convex/calendar.ts</files>
  <action>
Create "Clear All Events" functionality for the disconnect flow:

1. In `googleCalendarActions.ts`, create internal action `clearAllCalendarEvents`:
   - Accept: userId
   - Fetch user's OAuth tokens
   - Query ALL cases for this user
   - For each case with any calendarEventIds:
     - Delete all events from Google Calendar
     - Clear calendarEventIds object to {}
   - Return stats: { eventsDeleted: number, casesCleaned: number, errors: number }
   - Handle errors gracefully (log but continue)

2. In `calendar.ts`, create mutation `disconnectGoogleCalendarWithCleanup`:
   - Runs clearAllCalendarEvents action
   - Then clears OAuth tokens from userProfiles
   - Sets googleCalendarConnected to false
   - Returns cleanup stats

3. Handle edge cases:
   - Expired OAuth tokens (attempt refresh first)
   - Already-deleted events (404 from Google API → skip, don't error)
   - Rate limiting (add small delay between deletes if needed)
   </action>
  <verify>Call disconnectGoogleCalendarWithCleanup and verify all events removed from Google Calendar</verify>
  <done>Disconnect action removes all synced events before clearing tokens</done>
</task>

<task type="auto">
  <name>Task 3: Add "Clear All Events" button to Settings UI</name>
  <files>v2/src/app/(authenticated)/settings/page.tsx, v2/src/components/settings/CalendarSyncSection.tsx</files>
  <exploration>
    Read current Settings page structure and CalendarSyncSection component.
    Check how other destructive actions (like account deletion) are styled.
  </exploration>
  <action>
Add "Clear All Events" button to the Calendar settings section:

1. In CalendarSyncSection or equivalent component:
   - Add a "Clear All Calendar Events" button below the disconnect button
   - Style as destructive action (red variant, confirmation required)
   - Only show when calendar is connected

2. Implement confirmation flow:
   - Use existing AlertDialog pattern
   - Title: "Clear All Calendar Events?"
   - Message: "This will delete all PERM Tracker events from your Google Calendar. This cannot be undone."
   - Confirm button: "Clear All Events"
   - Cancel button: "Cancel"

3. On confirm:
   - Call new clearAllCalendarEvents mutation
   - Show loading state during deletion
   - Show toast with stats: "Cleared X events from Y cases"
   - Handle errors gracefully with error toast

4. Update the Disconnect button flow:
   - When user clicks Disconnect, first offer to clear events
   - "Clear events and disconnect" vs "Disconnect only"
   - If clearing, call disconnectGoogleCalendarWithCleanup
   - If not clearing, call existing disconnect mutation

Follow existing UI patterns from settings page. No new dependencies.
  </action>
  <verify>UI shows buttons, confirmation works, events are cleared</verify>
  <done>Users can clear all calendar events before disconnecting</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Calendar sync auto-cleanup and "Clear All Events" button</what-built>
  <how-to-verify>
    1. Run: pnpm dev (Terminal 2) + npx convex dev (Terminal 1)
    2. Go to Settings → Calendar section
    3. Ensure Google Calendar is connected (if not, connect it)
    4. Create a test case with dates that trigger calendar sync
    5. Verify events appear in Google Calendar
    6. Toggle OFF one calendar sync preference (e.g., PWD reminders)
    7. Verify those specific events are deleted from Google Calendar
    8. Click "Clear All Calendar Events" button
    9. Confirm in dialog
    10. Verify all PERM Tracker events are removed from Google Calendar
    11. Try the Disconnect flow - verify it offers to clear events first
  </how-to-verify>
  <resume-signal>Type "approved" if calendar cleanup works correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pnpm build succeeds without errors
- [ ] pnpm test passes (no regressions)
- [ ] Toggle off preference → events of that type deleted
- [ ] Clear All Events button works with confirmation
- [ ] Disconnect flow offers cleanup option
</verification>

<success_criteria>
- Toggling off a sync preference auto-deletes corresponding calendar events
- "Clear All Events" button deletes all synced events with confirmation
- Disconnect flow offers to clear events before disconnecting
- All operations handle errors gracefully (no crashes on already-deleted events)
- Human verification passes
</success_criteria>

<output>
After completion, create `.planning/phases/32-data-migration-go-live/32-02-SUMMARY.md`
</output>
