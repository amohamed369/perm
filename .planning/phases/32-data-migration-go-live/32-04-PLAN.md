---
phase: 32-data-migration-go-live
plan: 04
type: execute
---

<objective>
Execute production migration, go live, clean up v1 calendar events, and decommission v1 services.

Purpose: Complete the v1 → v2 migration with zero data loss and clean decommission.
Output: v2 live at permtracker.app, v1 decommissioned, clean codebase.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-data-migration-go-live/32-RESEARCH.md
@.planning/phases/32-data-migration-go-live/32-CONTEXT.md
@.planning/phases/32-data-migration-go-live/32-01-SUMMARY.md
@.planning/phases/32-data-migration-go-live/32-02-SUMMARY.md
@.planning/phases/32-data-migration-go-live/32-03-SUMMARY.md

**Prior decisions affecting this plan:**
- Maintenance window: 30 min max
- DNS cutover to Vercel v2 deployment
- v1 calendar cleanup: T+24hr after go-live
- v1 decommission: T+7 days (Render), T+30 days (Supabase)
- Remove v1 code from repo after verification

**Production URLs:**
- Frontend: https://permtracker.app (Vercel)
- v1 Backend: https://perm-tracker-api.onrender.com (to decommission)
- v1 Database: Supabase production (to decommission)

**Rollback criteria:**
- Any data loss → immediate rollback
- Critical features broken → immediate rollback
- Authentication failing → immediate rollback
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create v1 calendar cleanup script</name>
  <files>backend/scripts/cleanup_v1_calendar.py, v2/scripts/migration/05_cleanup_v1_calendar.sh</files>
  <exploration>
    Check existing backend/scripts/ for patterns.
    Review v1 calendar sync implementation for event identification.
  </exploration>
  <action>
Create v1 calendar cleanup script to run T+24hr after go-live:

1. `backend/scripts/cleanup_v1_calendar.py`:
   - Connect to v1 Supabase to get user calendar tokens
   - For each user with Google Calendar connected:
     - Refresh OAuth token if expired
     - Search for all PERM Tracker events (search query: "PERM Tracker")
     - Delete each event
     - Log: user email, events found, events deleted, errors
   - Summary: total users processed, total events deleted, errors

2. `v2/scripts/migration/05_cleanup_v1_calendar.sh`:
   - Wrapper script to run the Python cleanup
   - Requires SUPABASE_URL and SUPABASE_KEY env vars
   - Logs to migration/logs/

3. Safety features:
   - Dry-run mode (--dry-run shows what would be deleted)
   - Rate limiting (1 second delay between users)
   - Continue on error (don't stop if one user fails)
   - Detailed logging for debugging

The cleanup MUST run from v1 environment because it needs v1's OAuth tokens.
v2 users will re-authorize Google Calendar with fresh tokens.
  </action>
  <verify>python cleanup_v1_calendar.py --dry-run shows events that would be deleted</verify>
  <done>v1 calendar cleanup script ready to run T+24hr after go-live</done>
</task>

<task type="auto">
  <name>Task 2: Create decommission checklist and scripts</name>
  <files>v2/scripts/migration/decommission.md, v2/scripts/migration/06_decommission.sh</files>
  <action>
Create decommission documentation and automation:

1. `decommission.md` - Complete decommission checklist:

   **T+0: Go-Live Complete**
   - [ ] v2 verified working for 24 hours
   - [ ] No critical bug reports
   - [ ] User feedback collected

   **T+24hr: Calendar Cleanup**
   - [ ] Run 05_cleanup_v1_calendar.sh
   - [ ] Verify events deleted (spot check 3 users)
   - [ ] Log cleanup results

   **T+7 days: Render Decommission**
   - [ ] Confirm v2 stable for 7 days
   - [ ] Scale Render service to 0 instances
   - [ ] Verify no traffic to old API
   - [ ] Delete Render service

   **T+14 days: Code Cleanup**
   - [ ] Merge test branch to main
   - [ ] Move v2/ contents to repo root
   - [ ] Remove legacy v1 code (backend/, frontend/)
   - [ ] Update CLAUDE.md, README.md
   - [ ] Remove .planning/ docs (archive separately)

   **T+30 days: Supabase Decommission**
   - [ ] Export final Supabase backup
   - [ ] Store backup in secure location
   - [ ] Pause Supabase project
   - [ ] (Optional) Delete Supabase project after 90 days

2. `06_decommission.sh` - Automation for code cleanup:
   ```bash
   # Move v2 to root
   # Remove old directories
   # Update imports
   # Run tests
   ```

This script will be run MANUALLY after all checkpoints pass.
  </action>
  <verify>Checklist is complete and actionable</verify>
  <done>Decommission documentation and scripts ready</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Production migration and go-live preparation complete</what-built>
  <how-to-verify>
    **This is the FINAL verification before production go-live.**

    **Pre-Go-Live Checklist:**
    1. [ ] 32-01 migration scripts verified on test environment
    2. [ ] 32-02 calendar sync fixes verified (auto-cleanup, clear all button)
    3. [ ] 32-03 test migration verified
    4. [ ] User notification emails sent (T-7 days, T-1 day)
    5. [ ] Rollback procedure documented and understood
    6. [ ] Team available for migration window

    **Ready to Execute Production Migration?**

    If all checks pass, the production migration sequence is:
    1. Announce maintenance (set v1 to read-only)
    2. Run: `./run_migration.sh --production`
    3. Verify: `./04_verify_migration.ts --production`
    4. Deploy v2: `npx convex deploy` (if not already)
    5. DNS cutover: Point permtracker.app to Vercel v2
    6. Smoke test: Log in, verify cases, test key flows
    7. Announce: "Migration complete, v2 is live"

    **Timeline:**
    - T+0: Go-live
    - T+24hr: Run v1 calendar cleanup
    - T+7 days: Decommission Render
    - T+30 days: Decommission Supabase
  </how-to-verify>
  <resume-signal>Type "ready for production" when all pre-go-live checks pass, or describe blockers</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Production migration executed and v2 live</what-built>
  <how-to-verify>
    **Post Go-Live Verification:**

    1. Visit https://permtracker.app
    2. Log in with production Google account
    3. Verify:
       - [ ] Dashboard loads with correct case count
       - [ ] Case list shows all cases
       - [ ] Case detail shows correct data
       - [ ] Date calculations are accurate
       - [ ] Add new case works
       - [ ] Edit case works
       - [ ] Notifications appear
       - [ ] Chatbot responds
       - [ ] Settings page works
       - [ ] Export CSV works

    4. Check browser console for errors
    5. Check Convex dashboard for function errors
    6. Monitor for 1 hour for any issues

    **If any critical issues:**
    - Execute rollback procedure
    - Point DNS back to v1
    - Debug and fix before retrying
  </how-to-verify>
  <resume-signal>Type "go-live successful" when v2 is verified live, or "rollback needed" with reason</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] v2 live at permtracker.app
- [ ] All user data migrated correctly
- [ ] No critical issues reported
- [ ] v1 calendar cleanup script ready (run at T+24hr)
- [ ] Decommission checklist ready
</verification>

<success_criteria>
- v2 successfully deployed and serving production traffic
- All 229 features working with migrated data
- Users can log in and see their cases
- No data loss
- Decommission plan in place for v1 services
- Phase 32 complete - v2.0 migration shipped!
</success_criteria>

<output>
After completion, create `.planning/phases/32-data-migration-go-live/32-04-SUMMARY.md`

This completes the v2.0 Complete Migration milestone!
</output>
