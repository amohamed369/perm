---
phase: 14-schema-design-extraction
plan: 01
type: execute
---

<objective>
Extract database schema and create CONVEX_SCHEMA.md with complete type mappings.

Purpose: Provide a ready-to-implement schema reference for Phase 19 (Schema + Security)
Output: `.planning/V2_CONVEX_SCHEMA.md` - All tables, types, relationships, RLS → Convex security mappings
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/V2_MIGRATION_BRIEF.md
@.planning/phases/14-schema-design-extraction/14-CONTEXT.md

**Phase 13 outputs (business logic references):**
@.planning/V2_BUSINESS_RULES.md
@.planning/V2_DEADLINE_FLOWS.md
@.planning/V2_VALIDATION_RULES.md

**Prior phase summary:**
Phase 13 extracted all business rules, deadline calculation logic, and validation rules into reference documents.

**Codebase constraints from exploration:**
- Migration files are in `backend/database/migrations/` (27 files)
- CRITICAL: Table naming inconsistency - `users` vs `perm_users` across migrations
- RLS uses helper functions with SECURITY DEFINER pattern
- All fields use snake_case naming

**Key source files:**
@backend/database/migrations/001_initial_schema.sql
@backend/database/migrations/002_fix_rls_policies.sql
@backend/app/schemas/case.py
@backend/app/schemas/notification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract canonical schema from all migration files</name>
  <files>.planning/V2_CONVEX_SCHEMA.md</files>
  <exploration>
    Use Explore agent to: Read ALL 27 migration files and build a complete picture of the final schema state. Identify which migrations modify existing tables vs create new ones. Note the users/perm_users naming issue.
  </exploration>
  <action>
Create `.planning/V2_CONVEX_SCHEMA.md` with comprehensive schema documentation:

**Structure:**
```markdown
# v2 Convex Schema Reference

## Overview
- Total tables: [count]
- Core tables: users, cases
- Supporting tables: notifications, user_settings, etc.

## Table Definitions

### users (v1: perm_users/users)
| Field | v1 SQL Type | Convex Type | Required | Notes |
|-------|-------------|-------------|----------|-------|
| id | UUID | Id<"users"> | Yes | Primary key |
| auth_user_id | UUID | string | Yes | External auth ref |
| email | VARCHAR(255) | string | Yes | Unique |
...

### cases
[Same format with all 50+ fields organized by stage: PWD, Recruitment, ETA 9089, I-140, RFI/RFE]

[Continue for all tables...]

## Relationships
- cases.user_id → users._id
- notifications.case_id → cases._id
...

## Indexes
[List all indexes from migrations]

## Schema Issues Found
- users vs perm_users naming mismatch
- Duplicate table definitions in migrations 004/005
[Document all inconsistencies]
```

**Type mapping rules:**
- UUID → Id<"tableName"> for PKs, string for external refs
- VARCHAR(N) → string
- TEXT → string
- INTEGER → number (v.int64() for large values)
- BIGINT → number (v.int64())
- BOOLEAN → boolean
- TIMESTAMP WITH TIME ZONE → number (Unix timestamp)
- DATE → string (ISO format) or number (Unix)
- JSONB → v.any() or specific object type
- DECIMAL → number (stored as cents for currency)

**Important:** Document the actual final state of each table after all migrations are applied, not just the initial creation.
  </action>
  <verify>
- File exists at .planning/V2_CONVEX_SCHEMA.md
- All tables from migrations are documented (users, cases, notifications, user_settings, refresh_tokens, user_preferences, permission_states, conversations, conversation_messages)
- Each table has field-by-field mapping with Convex types
- Relationships section lists all foreign key relationships
  </verify>
  <done>Complete schema extraction with Convex type mappings for all tables and fields</done>
</task>

<task type="auto">
  <name>Task 2: Map RLS policies to Convex security rules</name>
  <files>.planning/V2_CONVEX_SCHEMA.md</files>
  <exploration>
    Use Explore agent to: Find all RLS policy definitions across migration files, especially the helper functions (get_current_user_id, is_firm_admin, etc.). Understand the security patterns.
  </exploration>
  <action>
Add a comprehensive Security Rules section to V2_CONVEX_SCHEMA.md:

```markdown
## Security Rules (RLS → Convex)

### v1 RLS Patterns

**Helper Functions:**
- `get_current_user_id()` - Gets internal user ID from auth.uid()
- `get_current_user_firm_id()` - Gets user's firm_id
- `is_firm_admin()` - Checks admin role

**Policy Patterns:**
| Table | Operation | v1 RLS Policy | Convex Equivalent |
|-------|-----------|---------------|-------------------|
| cases | SELECT | `user_id = get_current_user_id()` | `ctx.auth.getUserIdentity()` + query filter |
| cases | INSERT | `user_id = get_current_user_id()` | Mutation validation |
...

### Convex Security Implementation

**Pattern 1: User Ownership**
```typescript
// v1: USING (user_id = get_current_user_id())
// v2: Convex query with auth check
export const get = query({
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");
    return ctx.db
      .query("cases")
      .filter((q) => q.eq(q.field("userId"), identity.subject))
      .collect();
  },
});
```

**Pattern 2: Firm Access (Future)**
[Document how firm-level access will translate]

### Security Checklist for v2
- [ ] All queries check auth
- [ ] User can only access own data
- [ ] Soft delete respected (deleted_at IS NULL)
- [ ] Firm access rules (if implemented)
```

Document ALL RLS policies found and their Convex translation patterns.
  </action>
  <verify>
- Security Rules section exists in V2_CONVEX_SCHEMA.md
- All RLS policies from migrations are documented
- Convex equivalent patterns are provided for each
- Helper function behaviors are documented
  </verify>
  <done>Complete RLS → Convex security rule mapping with implementation patterns</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] V2_CONVEX_SCHEMA.md exists in .planning/
- [ ] All 9+ tables documented with field mappings
- [ ] Convex type mappings specified for each field
- [ ] RLS → Convex security patterns documented
- [ ] Schema inconsistencies documented (users vs perm_users)
- [ ] Document is ready to copy-paste for Phase 19
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- V2_CONVEX_SCHEMA.md provides complete schema reference
- Security rules are clearly documented with Convex patterns
- Schema issues/inconsistencies are documented for resolution
</success_criteria>

<output>
After completion, create `.planning/phases/14-schema-design-extraction/14-01-SUMMARY.md`:

# Phase 14 Plan 01: Schema Extraction Summary

**[One-liner: e.g., "Extracted 9 tables with 100+ fields and complete RLS → Convex mapping"]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `.planning/V2_CONVEX_SCHEMA.md` - Complete schema reference

## Decisions Made
- [Type mapping decisions, naming decisions]

## Issues Encountered
- [Any schema inconsistencies found]

## Next Step
Ready for 14-02-PLAN.md (Design Tokens + Field Mappings)
</output>
