---
phase: 23.1-calendar-ui
plan: 01
type: execute
domain: react-calendar
---

<objective>
Set up react-big-calendar with date-fns localizer and create Convex query for calendar event data.

Purpose: Establish the calendar infrastructure and data layer that all UI components will consume.
Output: Working react-big-calendar integration, Convex query returning calendar events from cases, event type definitions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23.1-calendar-ui/23.1-CONTEXT.md
@.planning/phases/23.1-calendar-ui/23.1-RESEARCH.md

**Codebase constraints:**
- Next.js 16.1.0 + React 19.2.3
- Convex for all data queries
- Tailwind v4 CSS-first config
- date-fns v4.1.0 already installed
- TypeScript strict mode - no `any` types

**Prior phase context:**
@.planning/phases/23-case-detail-timeline/23-01-SUMMARY.md

**Design guidance:**
@.planning/FRONTEND_DESIGN_SKILL.md
@v2/docs/DESIGN_SYSTEM.md

**Relevant source files:**
@v2/convex/timeline.ts
@v2/src/lib/timeline/types.ts
@v2/src/lib/timeline/milestones.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-big-calendar and set up date-fns localizer</name>
  <files>v2/package.json, v2/src/lib/calendar/localizer.ts</files>
  <action>
1. Install dependencies: `pnpm add react-big-calendar @types/react-big-calendar`
2. Create v2/src/lib/calendar/localizer.ts with date-fns localizer setup:
   - Import from 'react-big-calendar' and date-fns functions
   - Use specific imports (not entire date-fns) for tree-shaking
   - Configure en-US locale
   - Export configured localizer

Reference from RESEARCH.md:
```typescript
import { dateFnsLocalizer } from 'react-big-calendar'
import format from 'date-fns/format'
import parse from 'date-fns/parse'
import startOfWeek from 'date-fns/startOfWeek'
import getDay from 'date-fns/getDay'
import enUS from 'date-fns/locale/en-US'
```

Note: We're using date-fns v4 which uses default exports - adjust imports accordingly.
  </action>
  <verify>
- `pnpm ls react-big-calendar` shows package installed
- TypeScript compiles: `pnpm tsc --noEmit` passes
- Localizer can be imported and instantiated without error
  </verify>
  <done>react-big-calendar installed, date-fns localizer configured and exportable</done>
</task>

<task type="auto">
  <name>Task 2: Define calendar event types and create event mapper utility</name>
  <files>v2/src/lib/calendar/types.ts, v2/src/lib/calendar/event-mapper.ts, v2/src/lib/calendar/event-mapper.test.ts</files>
  <exploration>
    Use Explore agent to find:
    - How MILESTONE_CONFIG defines deadline types in timeline/types.ts
    - How extractMilestones works in timeline/milestones.ts
    - The STAGE_COLORS mapping for stage-based coloring
    Read @.planning/FRONTEND_DESIGN_SKILL.md for stage/urgency colors
  </exploration>
  <action>
1. Create v2/src/lib/calendar/types.ts:
   - Define CalendarEvent interface with: id, title, start, end, allDay, caseId, deadlineType, stage, urgency, isFilingWindow
   - Define DeadlineType enum matching MILESTONE_CONFIG
   - Re-export STAGE_COLORS from timeline/types.ts for consistency
   - Define urgency thresholds: urgent (â‰¤7 days), soon (8-30 days), normal (30+ days)

2. Create v2/src/lib/calendar/event-mapper.ts:
   - Function `caseToCalendarEvents(case)` that extracts all milestones as CalendarEvent[]
   - Reuse extractMilestones() from timeline/milestones.ts for consistency
   - Handle filing windows specially: "ETA Window Opens" and "ETA Window Closes" as separate events
   - Calculate urgency based on daysUntil each deadline
   - Format titles: "PWD Exp: Smith J." pattern

3. Create v2/src/lib/calendar/event-mapper.test.ts:
   - Test with TDD: write tests first
   - Test case with all deadline types
   - Test case with missing dates (no events for missing)
   - Test urgency calculation (7 days, 30 days boundaries)
   - Test filing window split into open/close events
   - Test title formatting
  </action>
  <verify>
- `pnpm test event-mapper` passes all tests
- TypeScript strict mode passes
- Event mapper correctly extracts all deadline types from a case
  </verify>
  <done>CalendarEvent type defined, caseToCalendarEvents mapper tested with 10+ test cases</done>
</task>

<task type="auto">
  <name>Task 3: Create Convex query for calendar events</name>
  <files>v2/convex/calendar.ts, v2/convex/calendar.test.ts</files>
  <exploration>
    Use Explore agent to find:
    - How getCasesForTimeline queries case data in timeline.ts
    - Schema for cases table (all deadline fields)
    - Pattern for authenticated Convex queries
  </exploration>
  <action>
1. Create v2/convex/calendar.ts:
   - Query `getCalendarEvents({ showCompleted?: boolean })`:
     - Get authenticated user ID
     - Query all user's cases (or filter out "closed" if !showCompleted)
     - Return case data with all deadline fields
   - Query `getCalendarPreferences()`:
     - Return calendarHiddenCases, calendarHiddenDeadlineTypes from userProfiles
     - Return empty arrays if not set
   - Mutation `updateCalendarPreferences({ hiddenCases?, hiddenDeadlineTypes? })`:
     - Update userProfiles with new visibility settings

2. Update v2/convex/schema.ts if needed:
   - Add calendarHiddenCases, calendarHiddenDeadlineTypes to userProfiles table
   - Use v.optional(v.array(...)) pattern

3. Create v2/convex/calendar.test.ts:
   - Test getCalendarEvents returns cases with deadline fields
   - Test showCompleted filter works
   - Test preferences CRUD
  </action>
  <verify>
- `pnpm test calendar` passes all Convex tests
- `npx convex dev --run calendar:getCalendarEvents` returns valid data structure
  </verify>
  <done>Convex calendar queries working, preferences stored in userProfiles, tests passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm tsc --noEmit` passes
- [ ] `pnpm test` passes (all calendar tests + no regressions)
- [ ] react-big-calendar installed and importable
- [ ] Localizer exports correctly
- [ ] Event mapper converts cases to CalendarEvent[] correctly
- [ ] Convex queries return expected data structure
</verification>

<success_criteria>
- react-big-calendar and types installed
- date-fns localizer configured
- CalendarEvent type defined with stage/urgency fields
- caseToCalendarEvents mapper tested with 10+ tests
- Convex getCalendarEvents query works
- Calendar preferences persist to userProfiles
- No TypeScript errors, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/23.1-calendar-ui/23.1-01-SUMMARY.md`:

# Phase 23.1 Plan 01: Calendar Data Layer Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 23.1-02-PLAN.md (Calendar View Component)
</output>
