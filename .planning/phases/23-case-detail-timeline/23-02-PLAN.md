---
phase: 23-case-detail-timeline
plan: 02
type: execute
---

<objective>
Build Case Detail page with all case information sections and inline timeline visualization.

Purpose: Create the command center for each case where users see full case details and progress.
Output: Complete `/cases/[id]` page with sections, inline timeline, quick actions.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-case-detail-timeline/23-CONTEXT.md
@.planning/phases/23-case-detail-timeline/23-01-SUMMARY.md
@.planning/FRONTEND_DESIGN_SKILL.md
@perm_flow.md
@v2/src/components/forms/CaseForm.tsx
@v2/src/components/status/StatusBadge.tsx

**REQUIRED READING (for all subagents):**
- .planning/FRONTEND_DESIGN_SKILL.md
- .planning/phases/17-design-system/design3.md
- .planning/phases/17-design-system/design4.md
- perm_flow.md (source of truth for business logic)

**CODE QUALITY STANDARDS:**
- Clean, organized, minimal, abstract-able, scalable
- Maintainable, readable, DRY (global fixes, no repetition)
- Follow existing v2 patterns

**COMPLIANCE:**
- All v1 features must be preserved
- Follow perm_flow.md for all business logic

**Prior decisions:**
- Two-tier status: caseStatus + progressStatus
- Stage colors: PWD blue, Recruitment purple, ETA orange, I-140 green
- Neobrutalist: hard shadows, thick borders, Forest Green accents

**From 23-01:**
- Timeline data layer complete
- Milestone extraction utilities available
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CaseDetailSection components</name>
  <files>
    v2/src/components/cases/detail/CaseDetailSection.tsx,
    v2/src/components/cases/detail/BasicInfoSection.tsx,
    v2/src/components/cases/detail/PWDSection.tsx,
    v2/src/components/cases/detail/RecruitmentSection.tsx,
    v2/src/components/cases/detail/ETA9089Section.tsx,
    v2/src/components/cases/detail/I140Section.tsx,
    v2/src/components/cases/detail/RFIRFESection.tsx,
    v2/src/components/cases/detail/index.ts
  </files>
  <exploration>
    Use Explore agent to:
    - Find existing v2 form section components (v2/src/components/forms/sections/)
    - Understand how data is displayed vs. edited
    - Look at StatusBadge patterns for consistent status display
  </exploration>
  <action>
Create read-only display sections for case detail:

**CaseDetailSection.tsx** - Base wrapper component:
```typescript
interface CaseDetailSectionProps {
  title: string;
  icon?: React.ReactNode;
  children: React.ReactNode;
  className?: string;
}
```
- Neobrutalist card with hard shadow
- Collapsible with animation (default open)
- Section title with icon

**BasicInfoSection.tsx:**
- Case number, internal reference
- Employer name, FEIN
- Beneficiary identifier
- Position title, job title
- SOC code/title
- Status badges (caseStatus + progressStatus)
- Professional occupation indicator

**PWDSection.tsx:**
- Filing date, determination date, expiration date
- Case number
- Wage amount (formatted as currency), wage level
- Visual timeline bar showing PWD period

**RecruitmentSection.tsx:**
- Job order dates with duration
- Sunday ad dates
- Additional recruitment methods (list)
- Applicants count
- Notice of filing dates
- Notes

**ETA9089Section.tsx:**
- Filing date, audit date, certification date, expiration date
- Case number
- Filing window indicator (if not yet filed)

**I140Section.tsx:**
- Filing date, approval date
- Deadline indicator (180 days from cert if not yet filed)

**RFIRFESection.tsx:**
- List of RFI entries with status (pending/submitted)
- List of RFE entries with status
- Due dates with urgency colors
- Response dates if submitted

Use NavigableCard from ui/ if available, otherwise create consistent card styling.
Date displays should be formatted consistently using existing formatDate utility.
  </action>
  <verify>pnpm tsc --noEmit, visual inspection of section layout</verify>
  <done>All 6 case detail sections created with consistent styling</done>
</task>

<task type="auto">
  <name>Task 2: Create inline case timeline component</name>
  <files>
    v2/src/components/cases/detail/InlineCaseTimeline.tsx,
    v2/src/components/cases/detail/TimelineMilestone.tsx,
    v2/src/components/cases/detail/TimelineRangeBar.tsx
  </files>
  <exploration>
    Use Explore agent to understand:
    - v1 inline timeline rendering (frontend/case-detail.html lines 406-443)
    - Tooltip patterns using tippy.js or radix
    - Existing animation patterns in v2
  </exploration>
  <action>
Create compact inline timeline for case detail page:

**InlineCaseTimeline.tsx:**
- Fixed 6-month window centered on today
- Horizontal layout with month headers
- Case milestones as colored dots
- Job order range bar
- Legend below (4 stage colors)
- Only renders if case has at least one date

Props:
```typescript
interface InlineCaseTimelineProps {
  caseData: CaseWithDates;
}
```

Uses extractMilestones and extractRangeBars from lib/timeline.

**TimelineMilestone.tsx:**
- 12px colored circle with 3px black border
- Positioned absolutely based on date percentage
- Hover: scale 1.5x with tooltip showing label + formatted date
- Use Radix Tooltip or custom neobrutalist tooltip

**TimelineRangeBar.tsx:**
- Semi-transparent bar between two dates
- 8px height, stage color with 0.3 opacity
- Rounded ends

Styling:
- Timeline bar min-height 80px
- Month headers as flex items
- Responsive: horizontal scroll on mobile
- Current month highlighted
  </action>
  <verify>pnpm tsc --noEmit, timeline renders with test data</verify>
  <done>Inline timeline component with milestones and range bars</done>
</task>

<task type="auto">
  <name>Task 3: Build Case Detail page</name>
  <files>
    v2/src/app/(authenticated)/cases/[id]/page.tsx,
    v2/src/app/(authenticated)/cases/[id]/loading.tsx
  </files>
  <exploration>
    Use Explore agent to:
    - Find existing page patterns (dashboard, cases list)
    - Understand Convex useQuery patterns
    - Find navigation utilities (back button, breadcrumbs)
  </exploration>
  <action>
Replace placeholder page with full implementation:

**page.tsx:**
1. Fetch case data with useQuery(api.cases.get, { id })
2. Handle loading state (skeleton)
3. Handle not found (redirect to /cases or show error)
4. Layout:
   - Header: Back button, case title (employer + position), quick actions dropdown
   - Status bar: caseStatus badge, progressStatus badge, deadline summary
   - Inline timeline (6-month centered view)
   - Sections grid: BasicInfo, PWD, Recruitment, ETA9089, I140, RFIRFE
   - Add/Remove from Timeline button

Quick actions dropdown:
- Edit Case → /cases/[id]/edit
- Delete Case → confirmation modal, soft delete
- Archive Case → if not closed, set to closed
- Reopen Case → if closed, set back to appropriate status

**loading.tsx:**
- Skeleton matching page layout
- Use existing skeleton components

Use existing patterns from dashboard/case list pages.
  </action>
  <verify>
    Navigate to /cases/[id] shows full case detail
    All sections render with real data
  </verify>
  <done>Case detail page fully functional</done>
</task>

<task type="auto">
  <name>Task 4: Add case detail tests</name>
  <files>
    v2/src/components/cases/detail/__tests__/InlineCaseTimeline.test.tsx,
    v2/src/app/(authenticated)/cases/[id]/__tests__/page.test.tsx
  </files>
  <action>
Write tests:

**InlineCaseTimeline.test.tsx:**
- Renders nothing when case has no dates
- Renders milestones for each populated date field
- Positions milestones correctly within 6-month window
- Renders job order range bar when dates exist
- Shows tooltip on milestone hover
- Displays correct stage colors
- Renders legend

**page.test.tsx:**
- Renders loading state initially
- Renders case details when data loads
- Shows all section headers
- Quick actions dropdown opens
- Edit navigates to edit page
- Delete shows confirmation modal
- Delete calls mutation on confirm
- Archive sets status to closed
- Reopen changes status appropriately

Use vitest + testing-library patterns from existing tests.
  </action>
  <verify>pnpm test -- cases/detail passes</verify>
  <done>Case detail page and components tested</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm tsc --noEmit` passes
- [ ] `pnpm test -- cases/detail` passes
- [ ] Case detail page renders with real data
- [ ] All 6 sections display correctly
- [ ] Inline timeline shows milestones and range bars
- [ ] Quick actions (edit, delete, archive) work
</verification>

<success_criteria>
- Case detail page at /cases/[id] fully functional
- All case data displayed in organized sections
- Inline 6-month timeline with milestones
- Quick actions dropdown with edit/delete/archive/reopen
- Loading and error states handled
- Tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/23-case-detail-timeline/23-02-SUMMARY.md`

Include:
- Accomplishments
- Files Created/Modified
- Decisions Made
- Issues Encountered
- Next Step: Ready for 23-03-PLAN.md (Timeline Page Core)
</output>
