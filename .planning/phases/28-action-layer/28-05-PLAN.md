---
phase: 28-action-layer
plan: 05
type: execute
---

<objective>
Add bulk operation tools and multi-step execution visualization.

Purpose: Enable chatbot to perform bulk operations (update multiple cases, bulk sync) and show progress for chained actions.
Output: 4 bulk tools, multi-step execution UI, human-verified action system.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-action-layer/28-CONTEXT.md
@.planning/phases/28-action-layer/28-01-SUMMARY.md
@.planning/phases/28-action-layer/28-02-SUMMARY.md
@.planning/phases/28-action-layer/28-03-SUMMARY.md
@.planning/phases/28-action-layer/28-04-SUMMARY.md

**Existing bulk mutations:**
@v2/convex/cases.ts - bulkRemove, bulkUpdateStatus, bulkUpdateCalendarSync

**UI components:**
@v2/src/components/chat/InChatConfirmationCard.tsx
@v2/src/components/chat/ToolCallCard.tsx

**Chaining UX from 28-CONTEXT.md:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” Finding PWD cases...             â”‚ âœ“ Done (234ms)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“ Found 5 cases matching criteria  â”‚
â”‚    [Approve All] [Review Each]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**All bulk operations are DESTRUCTIVE - always require confirmation.**

**CRITICAL: Human checkpoint at end for visual review of entire action system.**
Read `.planning/FRONTEND_DESIGN_SKILL.md` for UI work.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define bulk operation tool schemas</name>
  <files>v2/src/lib/ai/tools.ts, v2/src/lib/ai/tool-permissions.ts</files>
  <exploration>
    Use Explore agent to find: existing bulk mutation arguments, case status enums, how bulkRemove/bulkUpdateStatus work.
  </exploration>
  <action>
    1. Add bulk operation tools to tools.ts:

    ```typescript
    // Bulk Operation Tools - ALL DESTRUCTIVE

    const BulkUpdateStatusInputSchema = z.object({
      caseIds: z.array(z.string()).describe("Array of case IDs to update"),
      status: z.enum(["pwd", "recruitment", "eta_9089", "i_140", "complete", "closed"])
        .describe("New status for all cases"),
      reason: z.string().optional().describe("Reason for bulk update"),
    });

    export const bulkUpdateStatusTool = tool({
      description: `Update status for multiple cases at once.

âš ï¸ DESTRUCTIVE ACTION - Always requires confirmation

WHEN TO USE:
- User asks to update status for multiple cases
- User says "change all PWD cases to recruitment"
- After querying cases, user wants to bulk update results

WHEN NOT TO USE:
- Single case update (use updateCase)
- User hasn't confirmed which cases

REQUIRES: User confirmation (DESTRUCTIVE tier)`,
      inputSchema: BulkUpdateStatusInputSchema,
    });

    const BulkArchiveCasesInputSchema = z.object({
      caseIds: z.array(z.string()).describe("Array of case IDs to archive"),
      reason: z.string().optional().describe("Reason for bulk archive"),
    });

    export const bulkArchiveCasesTool = tool({
      description: `Archive multiple cases at once.

âš ï¸ DESTRUCTIVE ACTION - Always requires confirmation

WHEN TO USE:
- User asks to archive multiple cases
- User says "close all completed cases"
- After querying cases, user wants to archive results

WHEN NOT TO USE:
- Single case (use archiveCase)
- User wants to delete (use bulkDeleteCases)

REQUIRES: User confirmation (DESTRUCTIVE tier)`,
      inputSchema: BulkArchiveCasesInputSchema,
    });

    const BulkDeleteCasesInputSchema = z.object({
      caseIds: z.array(z.string()).describe("Array of case IDs to delete"),
      confirmPhrase: z.string().optional().describe("Confirmation phrase for safety"),
    });

    export const bulkDeleteCasesTool = tool({
      description: `PERMANENTLY delete multiple cases at once.

âš ï¸ HIGHLY DESTRUCTIVE - Requires explicit confirmation with warning

WHEN TO USE:
- User explicitly asks to permanently delete multiple cases
- User is certain about bulk deletion

WHEN NOT TO USE:
- User wants to archive (use bulkArchiveCases)
- User is unsure

REQUIRES: User confirmation (DESTRUCTIVE tier with extra warning)`,
      inputSchema: BulkDeleteCasesInputSchema,
    });

    const BulkCalendarSyncInputSchema = z.object({
      caseIds: z.array(z.string()).describe("Array of case IDs to sync/unsync"),
      enabled: z.boolean().describe("true to sync, false to unsync"),
    });

    export const bulkCalendarSyncTool = tool({
      description: `Sync or unsync multiple cases to/from Google Calendar.

âš ï¸ DESTRUCTIVE ACTION - Always requires confirmation

WHEN TO USE:
- User asks to sync multiple cases to calendar
- User says "sync all recruitment cases"
- User wants to unsync multiple cases

REQUIRES: User confirmation (DESTRUCTIVE tier)`,
      inputSchema: BulkCalendarSyncInputSchema,
    });
    ```

    2. Update tool-permissions.ts:
    ```typescript
    bulkUpdateStatus: 'destructive',
    bulkArchiveCases: 'destructive',
    bulkDeleteCases: 'destructive',
    bulkCalendarSync: 'destructive',
    ```

    3. Add to chatTools export and update types.
  </action>
  <verify>TypeScript compiles, 4 bulk tools export correctly</verify>
  <done>4 bulk operation tools defined with destructive permission level</done>
</task>

<task type="auto">
  <name>Task 2: Create multi-step execution UI</name>
  <files>v2/src/components/chat/ActionChainProgress.tsx, v2/src/components/chat/index.ts</files>
  <exploration>
    Use Explore agent to find: existing ToolCallCard animation patterns, how messages render in chat, Motion animation patterns.
    Read `.planning/FRONTEND_DESIGN_SKILL.md` for design guidance.
  </exploration>
  <action>
    1. Create ActionChainProgress.tsx for visualizing chained actions:

    ```typescript
    interface ActionStep {
      id: string;
      toolName: string;
      status: 'pending' | 'executing' | 'done' | 'error' | 'waiting_approval';
      arguments?: Record<string, unknown>;
      result?: unknown;
      duration?: number;
      error?: string;
    }

    interface ActionChainProgressProps {
      steps: ActionStep[];
      onApprove?: (stepId: string) => void;
      onDeny?: (stepId: string) => void;
      onApproveAll?: () => void;
    }
    ```

    2. Visual design (from 28-CONTEXT.md):
    ```
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸ” Finding PWD cases...             â”‚ âœ“ Done (234ms)
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ (connector line)
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸ“ Found 5 cases                    â”‚
    â”‚    Acme Corp, TechStart, ...        â”‚
    â”‚                                     â”‚
    â”‚ [Approve All] [Review Each] [Deny]  â”‚ â† Waiting approval
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸ—„ï¸ Archiving 5 cases...             â”‚ â³ Executing...
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ```

    3. Component features:
       - Vertical connector lines between steps (dashed when pending, solid when complete)
       - Each step is a mini ToolCallCard
       - Status icons: â³ pending, ğŸ”„ executing, âœ“ done, âŒ error, ğŸ”’ waiting approval
       - Duration badges on completed steps
       - Stagger animation for new steps (spring physics)
       - Collapse completed steps after 3+ (show summary)

    4. Approve All / Review Each / Deny buttons for bulk approvals:
       - Approve All: green button, proceeds with all pending actions
       - Review Each: shows individual confirmation for each
       - Deny: red button, cancels all pending actions

    5. Motion animations:
       - Steps slide in from left with spring
       - Connector lines draw with animation
       - Status changes trigger pulse animation
       - Error state shakes

    6. Export from index.ts.
  </action>
  <verify>Component renders chain of steps, animations work, buttons functional</verify>
  <done>ActionChainProgress component complete with visual chain display</done>
</task>

<task type="auto">
  <name>Task 3: Integrate bulk tools with API and chain visualization</name>
  <files>v2/src/app/api/chat/route.ts, v2/src/components/chat/ChatMessages.tsx</files>
  <exploration>
    Use Explore agent to find: how chat messages render tool calls, existing message handling, bulk mutation patterns.
  </exploration>
  <action>
    1. Add execute functions for bulk tools in API route:

    ```typescript
    bulkUpdateStatus: {
      execute: async (params) => {
        // Always requires confirmation (destructive)
        if (!isApproved) {
          return {
            requiresPermission: true,
            permissionType: 'destructive',
            toolName: 'bulkUpdateStatus',
            arguments: params,
            description: `Update ${params.caseIds.length} cases to ${params.status}`,
            preview: {
              count: params.caseIds.length,
              status: params.status,
            },
          };
        }

        try {
          await fetchAction(api.cases.bulkUpdateStatus, {
            ids: params.caseIds.map(id => id as Id<'cases'>),
            status: params.status,
          }, { token });

          return {
            success: true,
            count: params.caseIds.length,
            status: params.status,
            message: `Updated ${params.caseIds.length} cases to ${params.status}`,
          };
        } catch (error) {
          return {
            error: 'Failed to bulk update',
            suggestion: error instanceof Error ? error.message : 'Please try again',
          };
        }
      },
    },

    bulkArchiveCases: {
      execute: async (params) => {
        if (!isApproved) {
          return {
            requiresPermission: true,
            permissionType: 'destructive',
            toolName: 'bulkArchiveCases',
            arguments: params,
            description: `Archive ${params.caseIds.length} cases`,
          };
        }

        await fetchAction(api.cases.bulkRemove, {
          ids: params.caseIds.map(id => id as Id<'cases'>),
        }, { token });

        return {
          success: true,
          count: params.caseIds.length,
          message: `Archived ${params.caseIds.length} cases`,
        };
      },
    },

    // Similar for bulkDeleteCases, bulkCalendarSync
    ```

    2. Update ChatMessages to detect multi-step tool sequences:
       - When multiple tool calls in sequence, group into ActionChainProgress
       - Single tool calls use regular ToolCallCard or InChatConfirmationCard
       - Track chain state for approval flow

    3. Add chain state management:
       - Track pending approvals
       - Handle "Approve All" button
       - Handle "Review Each" flow
       - Handle "Deny" to cancel chain

    4. Update tool icons and result summaries for bulk tools:
    ```typescript
    TOOL_ICONS: {
      bulkUpdateStatus: RefreshCw,
      bulkArchiveCases: Archive,
      bulkDeleteCases: Trash2,
      bulkCalendarSync: Calendar,
    }

    TOOL_COLORS: {
      bulkUpdateStatus: 'text-amber-600',
      bulkArchiveCases: 'text-slate-600',
      bulkDeleteCases: 'text-red-600',
      bulkCalendarSync: 'text-teal-600',
    }
    ```

    5. Invalidate tool cache after bulk mutations.
  </action>
  <verify>Bulk tools execute, chain visualization works, approval flow complete</verify>
  <done>Bulk tools integrated, chain visualization working, approval flow complete</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Action Layer with permission system, 20+ action tools, confirmation cards, and chain visualization</what-built>
  <how-to-verify>
    1. Run: `cd v2 && pnpm dev`
    2. Visit: http://localhost:3000/dashboard
    3. Open chat widget

    **Test Permission Toggle:**
    - Look for OFF | CONFIRM | AUTO toggle in chat header
    - Click each mode, verify it persists
    - Check visual feedback on mode switch

    **Test Confirmation Cards (in CONFIRM mode):**
    - Say "Create a case for Test Corp"
    - Verify inline confirmation card appears with:
      - Tool icon and name
      - Arguments displayed
      - Approve/Deny buttons
      - Neobrutalist styling (2px borders, hard shadows)
    - Click Approve, verify case creates
    - Say "Delete case X" and verify red destructive styling

    **Test AUTO mode:**
    - Switch to AUTO mode
    - Say "Create a case for Auto Test"
    - Verify it creates immediately (no card)
    - Say "Delete case X" - should STILL show confirmation (destructive always asks)

    **Test Navigation Tools:**
    - Say "Go to calendar" - should navigate
    - Say "Show me the dashboard" - should navigate
    - Verify smooth client-side navigation

    **Test Chain Visualization:**
    - Say "Find all PWD cases and archive them"
    - Verify steps appear:
      1. Query step (executes)
      2. Results shown
      3. Archive step (waiting approval)
    - Verify connector lines between steps
    - Verify Approve All / Deny buttons

    **Visual Quality:**
    - All animations smooth (spring physics)
    - Neobrutalist styling consistent
    - Mobile responsive (test at 375px)
    - No layout shift or flicker
    - Status transitions animated (pulse on change)

    **Error States:**
    - Force an error (invalid case ID)
    - Verify error styling (red, shake animation)
    - Verify helpful error message
  </how-to-verify>
  <resume-signal>Type "approved" if action system works correctly, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds in v2/
- [ ] 4 bulk tools appear in chatTools export
- [ ] Bulk tools always show confirmation (destructive tier)
- [ ] ActionChainProgress renders multi-step flows
- [ ] Approve All / Review Each / Deny buttons work
- [ ] Human checkpoint PASSED - visual review approved
- [ ] All animations smooth and polished
- [ ] No TypeScript errors
</verification>

<success_criteria>
- 4 bulk operation tools defined and working
- Chain visualization shows step-by-step progress
- Bulk approval flow (Approve All, Review Each, Deny)
- Human verification of complete action system passed
- All 20+ tools working end-to-end
- Permission system works correctly in all modes
</success_criteria>

<output>
After completion, create `.planning/phases/28-action-layer/28-05-SUMMARY.md`:

# Phase 28 Plan 05: Bulk Operations & Polish Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Human Checkpoint

- Status: [PASSED/FAILED]
- Reviewer notes: [notes]
- Issues fixed: [list if any]

## Next Step

Phase 28 complete, ready for Phase 29 (Advanced Automation)
</output>
