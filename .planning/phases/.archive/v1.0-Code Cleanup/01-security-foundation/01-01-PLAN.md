---
phase: 01-security-foundation
plan: 01
type: execute
---

<objective>
Eliminate critical security vulnerabilities by adding LLM provider startup validation and preparing for credential rotation.

Purpose: Address H1 (Missing LLM Validation) immediately and prepare infrastructure for C1 (Hardcoded Secrets) rotation.
Output: Validated startup that fails fast on misconfiguration, .env.example template, and documented rotation procedure.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/COMPREHENSIVE_CONCERNS_SPEC.md

**Concerns being addressed:**
- H1: Missing LLM Provider Startup Validation (HIGH severity)
- C1: Hardcoded Production Secrets (CRITICAL - preparation only, rotation is checkpoint)

**Key files:**
@backend/app/config.py
@backend/app/main.py
@backend/.env

**Current state:**
- All LLM API keys default to empty strings with no validation
- Application starts successfully even when ALL LLM keys are empty
- Users encounter cryptic errors when using chatbot feature
- Test .env contains real Supabase credentials, JWT secret, encryption key
- No .env.example exists to guide developers
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LLM provider startup validation</name>
  <files>backend/app/main.py, backend/app/config.py</files>
  <action>
Add startup validation in main.py that:
1. Checks if at least one LLM API key is configured (gemini, openrouter, groq, cerebras, mistral)
2. Logs which LLM providers are available at startup
3. Raises RuntimeError with clear message if NO LLM keys are set AND environment is production
4. In development mode, only warn (don't fail) so devs can run without LLM keys

Add helper method to config.py Settings class:
- `has_any_llm_key` property that returns True if any LLM key is non-empty
- `available_llm_providers` property that returns list of configured provider names

Implementation notes:
- Use existing logging pattern from main.py (logger = logging.getLogger(__name__))
- Check after app creation but before routers are included
- Use environment setting from config to determine production vs development
  </action>
  <verify>
1. Backend starts successfully with at least one LLM key set
2. Backend logs available providers on startup
3. With no LLM keys in production mode: `ENVIRONMENT=production python -c "from app.main import app"` raises RuntimeError
4. With no LLM keys in development mode: Backend starts with warning
  </verify>
  <done>
- Settings class has `has_any_llm_key` and `available_llm_providers` properties
- Startup validates LLM configuration
- Clear error message if misconfigured in production
- Warning only in development mode
  </done>
</task>

<task type="auto">
  <name>Task 2: Create .env.example with placeholder values</name>
  <files>backend/.env.example</files>
  <action>
Create `.env.example` that:
1. Contains ALL environment variables from current .env
2. Uses ONLY placeholder values (no real credentials)
3. Documents each variable's purpose with comments
4. Groups variables by category (API, Database, Auth, LLM, etc.)
5. Marks required vs optional variables

Use format:
```
# ==================================================================
# PERM Tracker - Environment Variables
# ==================================================================
# Copy this file to .env and fill in your values
# ==================================================================

# ==================== ENVIRONMENT ====================
ENVIRONMENT=development  # development | production

# ==================== REQUIRED: Supabase ====================
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-key
SUPABASE_SERVICE_KEY=your-service-role-key  # CRITICAL: Keep secret

# etc...
```

Do NOT copy any real values from .env - use descriptive placeholders only.
  </action>
  <verify>
1. `backend/.env.example` exists
2. Contains no real credentials (grep for actual API keys returns nothing)
3. All variables from current .env are documented
4. Comments explain each variable
  </verify>
  <done>
- .env.example created with all variables
- No real credentials in file
- Clear documentation for each variable
- Marked required vs optional
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Rotate production credentials (C1 remediation)</action>
  <instructions>
I've prepared the infrastructure for secure credential management. Now you must rotate the actual production credentials.

**CRITICAL: These credentials are exposed and must be rotated:**

1. **Supabase (production database):**
   - Go to: https://supabase.com/dashboard → Your Project → Settings → API
   - Regenerate: API anon key, Service role key
   - Update in: Render dashboard environment variables

2. **JWT Secret Key:**
   - Generate new: `openssl rand -base64 64`
   - Update in: Render dashboard
   - Impact: All users will need to re-login

3. **Encryption Key (Fernet):**
   - Generate new: `python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"`
   - Update in: Render dashboard
   - Impact: Existing stored OAuth tokens will be invalidated

4. **LLM API Keys (if exposed):**
   - Regenerate each key from provider dashboards
   - Update in: Render dashboard

5. **Resend API Key:**
   - Regenerate at: https://resend.com/api-keys
   - Update in: Render dashboard

6. **Google OAuth (if exposed):**
   - Regenerate at: Google Cloud Console → Credentials
   - Update in: Render dashboard

**After rotation:**
- Test production deployment
- Verify users can still log in (they may need to re-authenticate)
- Verify chatbot works
- Verify email notifications work
  </instructions>
  <verification>
After you confirm rotation is complete, I can verify:
- Backend health check returns 200: `curl https://perm-tracker-api.onrender.com/health`
- Frontend loads without errors
  </verification>
  <resume-signal>Type "rotated" when all credentials have been rotated and deployed to Render</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd backend && python -c "from app.config import settings; print(settings.has_any_llm_key, settings.available_llm_providers)"` works
- [ ] Backend starts successfully with current .env (development mode)
- [ ] `.env.example` exists and contains no real credentials
- [ ] All production credentials rotated (confirmed by human)
- [ ] Production deployment verified working
</verification>

<success_criteria>
- LLM provider validation added to startup
- Settings class has helper properties for LLM key checking
- .env.example created with placeholder values
- All production credentials rotated (C1 resolved)
- No real credentials committed to repository
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-foundation/01-01-SUMMARY.md`:

# Phase 1 Plan 1: Security Foundation Summary

**[Substantive one-liner about what was accomplished]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale, or "None"]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Phase 1 complete, ready for Phase 2: Logging Infrastructure
</output>
