---
phase: 06-frontend-monolith-decomposition
plan: 02
type: execute
---

<objective>
Extract ChatbotAPI and ClientActionExecutor classes into separate modules.

Purpose: Begin modularizing chatbot-v2.js by extracting the API communication and action execution layers into dedicated files.
Output: Two new modules (chatbot-api.js, chatbot-actions.js) with chatbot-v2.js importing them.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-frontend-monolith-decomposition/06-01-SUMMARY.md

**chatbot-v2.js structure (lines):**
- Configuration (27-53): ~27 lines - getAuthHeader, isAuthenticated, sanitizeText
- ChatbotAPI (54-266): ~212 lines - API communication class
- ClientActionExecutor (267-494): ~228 lines - Action execution class
- ConfirmationModal (495-639): ~145 lines
- InChatConfirmationCard (640-1062): ~423 lines
- StructuredResultCard (1063-1189): ~127 lines
- QuickActions (1190-1303): ~114 lines
- PersonalizedGreeting (1304-1435): ~132 lines
- StopGenerationButton (1436-1497): ~62 lines
- ChatbotUI (1498-2734): ~1237 lines
- Initialization (2735-2772): ~38 lines

**Module design principle:**
- Keep IIFE pattern (service worker compatibility)
- Use window.* exports for cross-module communication
- Maintain same loading order in HTML files
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chatbot-api.js module</name>
  <files>frontend/public/js/chatbot-api.js</files>
  <action>
    Create new file frontend/public/js/chatbot-api.js containing:

    1. IIFE wrapper (function() { 'use strict'; ... })()
    2. Configuration section:
       - API_BASE_URL constant
       - getAuthHeader() function
       - isAuthenticated() function
       - sanitizeText() function (used by API responses)
    3. ChatbotAPI class (lines 58-265 from chatbot-v2.js):
       - constructor with baseUrl
       - sendMessage() method
       - sendPublicMessage() method
       - sendStreamingMessage() method (if exists)
       - continueWithPermission() method
       - abort() method
    4. Export to window:
       ```javascript
       window.ChatbotAPI = ChatbotAPI;
       window.ChatbotConfig = {
         API_BASE_URL,
         getAuthHeader,
         isAuthenticated,
         sanitizeText,
       };
       ```

    Remove all console.log/console.error statements from this module.
  </action>
  <verify>
    - File exists: ls frontend/public/js/chatbot-api.js
    - No console statements: grep -c "console\." frontend/public/js/chatbot-api.js returns 0
    - Exports defined: grep "window.ChatbotAPI" frontend/public/js/chatbot-api.js
  </verify>
  <done>chatbot-api.js module created with ChatbotAPI class and config exports, no console.log statements</done>
</task>

<task type="auto">
  <name>Task 2: Create chatbot-actions.js module</name>
  <files>frontend/public/js/chatbot-actions.js</files>
  <action>
    Create new file frontend/public/js/chatbot-actions.js containing:

    1. IIFE wrapper
    2. ClientActionExecutor class (lines 271-493 from chatbot-v2.js):
       - execute() method - executes array of actions
       - executeOne() method - executes single action
       - All action handlers: navigateTo, jumpToDate, etc.
    3. Export to window:
       ```javascript
       window.ClientActionExecutor = ClientActionExecutor;
       ```

    Remove all console.log/console.error statements from this module.
    Replace console.error in catch blocks with proper error objects (throw or return error).
  </action>
  <verify>
    - File exists: ls frontend/public/js/chatbot-actions.js
    - No console statements: grep -c "console\." frontend/public/js/chatbot-actions.js returns 0
    - Export defined: grep "window.ClientActionExecutor" frontend/public/js/chatbot-actions.js
  </verify>
  <done>chatbot-actions.js module created with ClientActionExecutor class, no console.log statements</done>
</task>

<task type="auto">
  <name>Task 3: Update chatbot-v2.js to use extracted modules</name>
  <files>frontend/public/js/chatbot-v2.js</files>
  <action>
    Modify chatbot-v2.js:

    1. Remove ChatbotAPI class definition (lines ~54-266)
    2. Remove ClientActionExecutor class definition (lines ~267-494)
    3. Remove configuration functions that are now in chatbot-api.js:
       - API_BASE_URL
       - getAuthHeader()
       - isAuthenticated()
       - sanitizeText()
    4. At the top of the IIFE, add comments documenting dependencies:
       ```javascript
       /**
        * Dependencies (must be loaded before this file):
        * - chatbot-utils.js (window.ChatbotUtils)
        * - chatbot-history.js (window.ChatHistoryManager)
        * - chatbot-sidebar.js (window.ChatHistorySidebar)
        * - chatbot-api.js (window.ChatbotAPI, window.ChatbotConfig)
        * - chatbot-actions.js (window.ClientActionExecutor)
        */
       ```
    5. Update code to use window.* imports:
       - Replace `new ChatbotAPI()` with `new window.ChatbotAPI()`
       - Replace `new ClientActionExecutor()` with `new window.ClientActionExecutor()`
       - Replace `getAuthHeader()` with `window.ChatbotConfig.getAuthHeader()`
       - Replace `isAuthenticated()` with `window.ChatbotConfig.isAuthenticated()`
       - Replace `sanitizeText()` with `window.ChatbotConfig.sanitizeText()`
       - Replace `API_BASE_URL` with `window.ChatbotConfig.API_BASE_URL`

    This should reduce chatbot-v2.js by ~450 lines.
  </action>
  <verify>
    - ChatbotAPI class not in file: grep "class ChatbotAPI" frontend/public/js/chatbot-v2.js returns nothing
    - ClientActionExecutor class not in file: grep "class ClientActionExecutor" frontend/public/js/chatbot-v2.js returns nothing
    - Uses window imports: grep "window.ChatbotAPI" frontend/public/js/chatbot-v2.js
    - File is smaller: wc -l frontend/public/js/chatbot-v2.js shows ~2300 lines (down from 2772)
  </verify>
  <done>chatbot-v2.js uses extracted modules via window.* imports, reduced by ~450 lines</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] chatbot-api.js exists with ChatbotAPI class
- [ ] chatbot-actions.js exists with ClientActionExecutor class
- [ ] Both new files have 0 console.log statements
- [ ] chatbot-v2.js no longer contains extracted classes
- [ ] chatbot-v2.js uses window.ChatbotAPI and window.ClientActionExecutor
- [ ] No syntax errors (npm run build or manual check)
</verification>

<success_criteria>
- Two new modules created: chatbot-api.js (~210 lines), chatbot-actions.js (~230 lines)
- chatbot-v2.js reduced from 2,772 to ~2,300 lines
- All console.log statements removed from extracted modules
- Code still functions (verified by manual testing or build)
</success_criteria>

<output>
After completion, create `.planning/phases/06-frontend-monolith-decomposition/06-02-SUMMARY.md`:

# Phase 6 Plan 02: API and Actions Module Extraction Summary

**Extracted ChatbotAPI and ClientActionExecutor into dedicated modules, reducing chatbot-v2.js by ~450 lines.**

## Accomplishments
- Created chatbot-api.js (~210 lines) with ChatbotAPI class
- Created chatbot-actions.js (~230 lines) with ClientActionExecutor class
- Removed all console.log statements from extracted modules
- Updated chatbot-v2.js to use window.* imports

## Files Created/Modified
- `frontend/public/js/chatbot-api.js` - NEW (ChatbotAPI + config)
- `frontend/public/js/chatbot-actions.js` - NEW (ClientActionExecutor)
- `frontend/public/js/chatbot-v2.js` - Removed extracted code, added window.* imports

## Decisions Made
- Used IIFE pattern with window.* exports (not ES modules) for service worker compatibility
- Moved config functions (getAuthHeader, etc.) to chatbot-api.js as ChatbotConfig

## Issues Encountered
None

## Next Step
Ready for 06-03-PLAN.md: Extract Confirmation and Components modules
</output>
