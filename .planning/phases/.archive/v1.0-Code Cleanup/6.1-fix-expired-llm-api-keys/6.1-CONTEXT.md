# Phase 6.1: Fix Expired LLM API Keys - Context

**Gathered:** 2025-12-19
**Status:** RESOLVED (was misdiagnosed)

## Original Assumption (WRONG)

Phase 6.1 was inserted because chatbot testing failed with errors suggesting LLM API keys were expired/invalid. All 5 providers (Gemini, Groq, OpenRouter, Cerebras, Mistral) appeared to return auth errors.

## Actual Root Cause (FOUND)

**The API keys were never expired.** The issue was a **configuration loading bug**.

### The Bug

1. `LLMService.__init__` used `os.getenv("GEMINI_API_KEY")` to load keys
2. Pydantic's `env_file=".env"` in `config.py` loads `.env` into the Settings object
3. **But Pydantic doesn't set actual environment variables** — it only reads them internally
4. So `os.getenv()` returned `None` for all keys even though `settings.gemini_api_key` had the correct values
5. Result: `llm_service.is_configured()` returned `False`, causing 503 errors

### Evidence

```bash
# Keys tested directly - ALL VALID:
curl "https://generativelanguage.googleapis.com/v1beta/models?key=..." → HTTP 200
curl -H "Authorization: Bearer ..." "https://api.groq.com/..." → HTTP 200
# ... all 5 providers returned 200

# Chat health before fix:
curl http://localhost:8000/api/chat/health
→ {"status": "unconfigured", "configured": false}

# Chat health after fix:
→ {"status": "ok", "configured": true}
```

## The Fix (Applied 2025-12-19)

### Fix 1: LLMService uses settings instead of os.getenv

**File:** `backend/app/services/llm_service.py`

```python
# BEFORE (broken):
def __init__(self):
    self.gemini_api_key = os.getenv("GEMINI_API_KEY")
    self.openrouter_api_key = os.getenv("OPENROUTER_API_KEY")
    # ... etc

# AFTER (fixed):
from app.config import settings

def __init__(self):
    self.gemini_api_key = settings.gemini_api_key
    self.openrouter_api_key = settings.openrouter_api_key
    # ... etc
```

### Fix 2: start_test.sh exports env vars

**File:** `backend/start_test.sh`

```bash
# Added after cp .env.test .env:
set -a  # Auto-export all variables
source .env.test
set +a
```

This ensures any remaining `os.getenv()` calls elsewhere also work.

## Key Learnings

1. **Pydantic env_file != environment variables**: Pydantic reads `.env` into the Settings model but doesn't set `os.environ`
2. **Use settings, not os.getenv**: Code should use `settings.some_key` for consistent configuration access
3. **Test vs Production parity**: The same keys work in both — only the Supabase database differs

## Outcome

- Phase 6.1 plan (regenerate keys) is **no longer needed**
- The fix was applied as part of debugging
- Chatbot now works correctly in test environment
- Phase 6 verification can proceed

---

*Phase: 6.1-fix-expired-llm-api-keys*
*Context gathered: 2025-12-19*
*Resolution: Configuration bug fixed, not key expiration*
