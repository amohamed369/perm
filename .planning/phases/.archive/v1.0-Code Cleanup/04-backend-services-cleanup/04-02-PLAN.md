---
phase: 04-backend-services-cleanup
plan: 02
type: execute
---

<objective>
Clean llm_service.py - the largest service file (1,990 lines) - by extracting utilities and ensuring consistent patterns.

Purpose: llm_service.py contains utility functions (sanitize_*, normalize_*) that should be in utils/, and has the most complexity to audit.
Output: Cleaner llm_service.py with utilities extracted, consistent with Phase 2-3 patterns.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-backend-services-cleanup/04-01-SUMMARY.md

**Prior decisions affecting this phase:**
- Phase 2: Standard logging format, no prefixes
- Phase 3: Extract constants (like USER_SELECT_COLUMNS) for maintainability

**Files to clean:**
@backend/app/services/llm_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit llm_service.py for cleanup opportunities</name>
  <files>backend/app/services/llm_service.py</files>
  <exploration>
    Use Explore agent to:
    - Find all utility functions (sanitize_*, normalize_*, etc.)
    - Check for emoji in log statements
    - Identify any print() statements
    - Look for dead code or unused functions
    - Check if logger pattern matches Phase 2 standard
  </exploration>
  <action>
    Create a list of specific cleanup items found:
    1. Emoji in log statements (if any)
    2. print() statements (if any)
    3. Utility functions that could be extracted
    4. Dead/unused code
    5. Pattern inconsistencies

    Do NOT make changes yet - this is audit only.
  </action>
  <verify>List of cleanup items documented</verify>
  <done>Clear understanding of what needs cleaning in llm_service.py</done>
</task>

<task type="auto">
  <name>Task 2: Clean llm_service.py logging and remove dead code</name>
  <files>backend/app/services/llm_service.py</files>
  <action>
    Based on audit findings:
    1. Remove any emoji from log statements
    2. Remove any print() statements (convert to logger if needed)
    3. Remove dead/unused code (functions never called)
    4. Ensure logger = logging.getLogger(__name__) pattern

    Do NOT:
    - Change function signatures or behavior
    - Extract utilities yet (that's Task 3 if needed)
    - Remove comments that are actually useful
  </action>
  <verify>
    - grep for emoji returns empty
    - grep for "print(" returns empty (except in prompts/strings meant for LLM)
    - pytest backend/tests/ -v passes
  </verify>
  <done>llm_service.py cleaned of logging inconsistencies and dead code</done>
</task>

<task type="auto">
  <name>Task 3: Verify llm_service.py consistency and run tests</name>
  <files>backend/app/services/llm_service.py</files>
  <action>
    1. Run full test suite: pytest backend/tests/ -v
    2. Verify LLM providers still work (check test coverage)
    3. Document any patterns that should be applied to other services

    Note: Utility extraction (sanitize_*, normalize_*) is a larger refactor.
    If these functions are only used in llm_service.py, leave them.
    Only extract if used across multiple services.
  </action>
  <verify>pytest backend/tests/ -v passes (227 tests expected)</verify>
  <done>llm_service.py is clean, tested, and follows Phase 2-3 patterns</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] No emoji in llm_service.py log statements
- [ ] No print() statements (except in LLM prompts)
- [ ] Logger pattern matches Phase 2 standard
- [ ] All tests pass
- [ ] No functional changes to LLM providers
</verification>

<success_criteria>
- llm_service.py follows Phase 2-3 logging and code patterns
- No dead code or inconsistencies
- All 227 tests pass
- LLM functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/04-backend-services-cleanup/04-02-SUMMARY.md`
</output>
