---
phase: 03-backend-core-cleanup
plan: 01
type: execute
---

<objective>
Polish backend core files (config.py, main.py, dependencies.py) - fix type hints, remove duplicate imports, clean dead code.

Purpose: Ensure core files meet quality standards before cleaning services (Phase 4) and tools (Phase 5).
Output: Clean, fully-typed core files with no dead code or duplicate patterns.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior phase reference:**
@.planning/phases/02-logging-infrastructure/02-01-SUMMARY.md

**Files to clean:**
@backend/app/config.py
@backend/app/main.py
@backend/app/dependencies.py

**Phase 2 logging infrastructure (for reference):**
@backend/app/utils/logger.py

**Concerns addressed:**
- M2 (Direct env var access): Verify core files use centralized config (already compliant)
- H3 (Debug logging): Verify no print() statements (already clean)
- M1 (Type safety): Fix missing type hints

**TEST WORKTREE CONTEXT:**
- All testing is local: `localhost:8000`
- Database: Test Supabase (isolated)
- Run pytest for verification
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean up main.py</name>
  <files>backend/app/main.py</files>
  <exploration>
    Use Explore agent to verify current state of main.py:
    - Confirm duplicate import logging locations (expected: lines ~176, ~197)
    - Find CacheControlMiddleware.dispatch() method location
    - Locate "Future routers" comments
  </exploration>
  <action>
    1. Remove duplicate `import logging` statements inside startup_event() and shutdown_event() functions - use the module-level logger instead

    2. Add return type hint to CacheControlMiddleware.dispatch():
       ```python
       async def dispatch(self, request: Request, call_next) -> Response:
       ```
       Import Response from starlette.responses if not already imported

    3. Remove dead "Future routers" comments (lines mentioning calendar, settings_api routers that are commented out)

    4. Ensure all functions have complete type hints (parameters and returns)

    DO NOT change any functional behavior - this is purely cleanup.
  </action>
  <verify>
    cd backend && python -c "from app.main import app; print('Import OK')"
    cd backend && python -m py_compile app/main.py
  </verify>
  <done>
    - No duplicate logging imports inside functions
    - CacheControlMiddleware.dispatch() has return type Response
    - No dead "Future routers" comments
    - File compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Polish dependencies.py and run regression tests</name>
  <files>backend/app/dependencies.py</files>
  <exploration>
    Use Explore agent to understand dependencies.py patterns:
    - Find get_optional_current_user and get_current_user_optional functions
    - Check if they're actually duplicates or have semantic differences
    - Find repeated Supabase field selection strings
  </exploration>
  <action>
    1. Review get_optional_current_user vs get_current_user_optional:
       - If truly identical: remove one and update any imports
       - If semantically different: add clarifying docstrings explaining the difference

    2. If there's a repeated Supabase column selection string (like "id, email, ..."), extract to a constant at module level:
       ```python
       USER_SELECT_COLUMNS = "id, email, created_at, ..."
       ```

    3. Ensure all functions have complete type hints

    4. Run full regression test suite to verify nothing broke

    DO NOT change authentication behavior - only consolidate duplicate code.
  </action>
  <verify>
    cd backend && pytest -v
    cd backend && python -c "from app.dependencies import get_current_user, get_optional_current_user; print('Import OK')"
  </verify>
  <done>
    - Duplicate functions either consolidated or documented with clear distinction
    - Repeated strings extracted to constants (if applicable)
    - All 23+ tests pass
    - No import errors
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd backend && python -m py_compile app/config.py app/main.py app/dependencies.py` - all compile
- [ ] `cd backend && pytest` - all tests pass (23+)
- [ ] No print() statements in core files: `grep -r "print(" backend/app/{config,main,dependencies}.py` returns empty
- [ ] No `Any` type hints in core files
- [ ] No duplicate imports or dead code
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No functional changes to authentication or app startup
- Core files are clean, typed, and free of dead code
- Ready for Phase 4 (Backend Services Cleanup)
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-core-cleanup/03-01-SUMMARY.md`:

# Phase 3 Plan 01: Backend Core Cleanup Summary

**[One-liner describing what was cleaned]**

## Accomplishments

- [List specific cleanups made]

## Files Modified

- `backend/app/main.py` - [changes]
- `backend/app/dependencies.py` - [changes]

## Decisions Made

[Any decisions about duplicate functions, etc.]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 3 complete, ready for Phase 4 (Backend Services Cleanup)
</output>
