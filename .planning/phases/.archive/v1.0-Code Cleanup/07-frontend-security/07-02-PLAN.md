---
phase: 07-frontend-security
plan: 02
type: execute
domain: security
depends_on: 07-01-PLAN.md
---

<objective>
Fix remaining HIGH/MEDIUM risk innerHTML patterns and add CSP security headers.

Purpose: Complete XSS remediation across all frontend files and add defense-in-depth via CSP.
Output: All unsafe DOM assignments fixed, CSP headers configured in vercel.json.
</objective>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/07-frontend-security/07-RESEARCH.md
@frontend/src/js/utils/sanitize.js (created in 07-01)
@frontend/vercel.json (CSP headers to add)
</context>

<background>
Remaining files from Explore agent audit:
- settings.js (lines 533, 542) - HIGH risk anti-pattern
- dateValidation.js (lines 471, 506) - HIGH risk (error messages)
- loaders.js (lines 19, 64, 204) - MEDIUM risk (message parameter)
- profileMenu.js (lines 176, 186) - MEDIUM risk (SVG injection pattern)
- darkMode.js (lines 90, 93) - MEDIUM risk (SVG injection pattern)

CSP headers needed for defense-in-depth (Report-Only mode first).
</background>

<tasks>
<task type="auto">
  <name>Task 1: Fix HIGH risk innerHTML in settings.js and dateValidation.js</name>
  <files>
    frontend/src/js/pages/settings.js
    frontend/src/js/utils/form/dateValidation.js
  </files>
  <action>
    **settings.js (lines 533, 542):**
    Current: Calendar status text inserted via property assignment with inline HTML spans.

    FIX: Replace with DOM construction:
    1. Create span element programmatically
    2. Set textContent for text portions
    3. Apply styles via classList or style property
    4. Use appendChild instead of string assignment

    Example pattern:
    - Create span, set className for color styling
    - Set textContent = "Connected" or "Not Connected"
    - Append to container

    **dateValidation.js (lines 471, 506):**
    Current: displayValidationErrors() and displayValidationWarnings() use template literals
    with fieldLabel and error.message/warning.message.

    Risk analysis:
    - fieldLabel comes from getFieldLabel() which returns hardcoded strings (SAFE)
    - error.message/warning.message come from validation logic (SAFE - internal)

    FIX: Even though currently safe, apply defense-in-depth:
    1. Wrap fieldLabel with Sanitizer.text()
    2. Wrap error.message/warning.message with Sanitizer.text()
    3. This protects against future changes that might introduce external data
  </action>
  <verify>
    - grep -n "calendarText" frontend/src/js/pages/settings.js - no raw string assignment
    - grep -n "fieldLabel" frontend/src/js/utils/form/dateValidation.js - shows Sanitizer.text
    - grep -n "error.message" frontend/src/js/utils/form/dateValidation.js - shows Sanitizer.text
    - Settings page calendar status displays correctly
    - Form validation errors display correctly
  </verify>
  <done>
    - settings.js uses DOM methods for calendar status (no template strings)
    - dateValidation.js wraps all dynamic content in Sanitizer.text()
    - Both files follow secure DOM manipulation patterns
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix MEDIUM risk innerHTML in loaders.js, profileMenu.js, darkMode.js</name>
  <files>
    frontend/src/js/utils/ui/loaders.js
    frontend/src/js/utils/ui/profileMenu.js
    frontend/src/js/utils/ui/darkMode.js
  </files>
  <action>
    **loaders.js (lines 19, 64, 204):**
    Current: showLoader(), showButtonLoader(), showOverlayLoader() accept message parameter
    and insert via template literal.

    Risk: Message is user-provided parameter - callers might pass unsanitized data.

    FIX:
    1. Sanitize message parameter: Sanitizer.text(message || '')
    2. Apply at function entry before any DOM insertion
    3. Check all three functions: showLoader, showButtonLoader, showOverlayLoader

    **profileMenu.js (lines 176, 186):**
    Current: SVG icon strings assigned via property.

    Risk: SVG comes from hardcoded constants (getSvgIcon function likely returns static strings).

    FIX:
    1. Verify getSvgIcon returns static hardcoded SVGs (check source)
    2. If static, add comment documenting safety: // SVG from static source - safe
    3. If dynamic, wrap with Sanitizer.html() (SVG needs HTML parsing)

    **darkMode.js (lines 90, 93):**
    Current: Same pattern as profileMenu - SVG icon insertion.

    FIX: Same approach as profileMenu.js
  </action>
  <verify>
    - grep -n "message" frontend/src/js/utils/ui/loaders.js - shows Sanitizer.text
    - Loader displays work correctly (test showLoader with various messages)
    - Dark mode toggle works
    - Profile menu renders correctly
    - No console errors
  </verify>
  <done>
    - loaders.js sanitizes message parameter in all loader functions
    - profileMenu.js SVG insertion documented or sanitized
    - darkMode.js SVG insertion documented or sanitized
    - All MEDIUM risk patterns addressed
  </done>
</task>

<task type="auto">
  <name>Task 3: Add CSP headers to vercel.json (Report-Only mode)</name>
  <files>frontend/vercel.json</files>
  <action>
    Add Content-Security-Policy-Report-Only header to test CSP before enforcing.

    CSP POLICY (from 07-RESEARCH.md):
    - default-src 'self'
    - script-src 'self' https://cdn.jsdelivr.net https://cdn.tailwindcss.com
    - style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://fonts.googleapis.com
    - img-src 'self' data: https:
    - font-src 'self' https://fonts.gstatic.com
    - connect-src 'self' http://localhost:8000 (for test environment)
    - object-src 'none'
    - base-uri 'none'
    - form-action 'self'
    - frame-ancestors 'none'

    ALSO ADD additional security headers:
    - X-Content-Type-Options: nosniff
    - X-Frame-Options: DENY
    - Referrer-Policy: strict-origin-when-cross-origin

    FORMAT: Add to existing headers array in vercel.json

    Use Report-Only first (not enforcing) so we can:
    1. Deploy and check browser console for violations
    2. Fix any violations found
    3. Switch to enforcing CSP in Phase 10 or later

    NOTE: This is TEST WORKTREE - localhost:8000 in connect-src.
    Production would use https://perm-tracker-api.onrender.com
  </action>
  <verify>
    - vercel.json has Content-Security-Policy-Report-Only header
    - vercel.json has X-Content-Type-Options, X-Frame-Options, Referrer-Policy headers
    - JSON is valid (no syntax errors)
    - npm run build succeeds
    - Local dev: headers may not appear (Vite dev server) - verify in Vercel preview if deploying
  </verify>
  <done>
    - CSP Report-Only header configured for test environment
    - Additional security headers (X-Content-Type-Options, X-Frame-Options, Referrer-Policy) added
    - Headers applied to all routes via source pattern
    - Valid JSON syntax maintained
  </done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] settings.js calendar status uses safe DOM methods
- [ ] dateValidation.js errors/warnings sanitized
- [ ] loaders.js message parameter sanitized
- [ ] profileMenu.js and darkMode.js SVG patterns reviewed/documented
- [ ] vercel.json has CSP-Report-Only and security headers
- [ ] vercel.json is valid JSON (no parse errors)
- [ ] Frontend functionality preserved (all UI elements work)
- [ ] No console errors
</verification>

<success_criteria>
- 0 HIGH risk innerHTML patterns remaining
- 0 MEDIUM risk patterns without sanitization or documentation
- CSP headers configured in Report-Only mode
- Security headers (X-Content-Type-Options, X-Frame-Options, Referrer-Policy) configured
- All frontend functionality preserved
- H2 (DOM-Based XSS) concern from COMPREHENSIVE_CONCERNS_SPEC.md resolved
</success_criteria>

<output>
After completion:
1. Update STATE.md - mark Phase 7 complete
2. Update ROADMAP.md - check off Phase 7, update concerns coverage table
3. Create phase summary documenting:
   - All files modified
   - Sanitization approach taken
   - CSP policy configured
   - Any violations found during testing
</output>
