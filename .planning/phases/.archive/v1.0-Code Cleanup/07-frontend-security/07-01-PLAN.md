---
phase: 07-frontend-security
plan: 01
type: execute
domain: security
---

<objective>
Add DOMPurify library, create centralized Sanitizer utility, and fix the 2 CRITICAL XSS vulnerabilities in notification rendering.

Purpose: Eliminate the highest-risk XSS attack vectors where API response data is directly inserted into DOM.
Output: DOMPurify integrated, Sanitizer utility created, notifications.js and notifications-page.js secured.
</objective>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/07-frontend-security/07-RESEARCH.md
@frontend/public/js/chatbot-api.js (existing sanitizeText function reference)
@frontend/src/js/components/notifications.js (CRITICAL - line 703)
@frontend/src/js/pages/notifications-page.js (CRITICAL - line 164)
</context>

<background>
Research and Explore agent findings:
- DOMPurify CDN: https://cdn.jsdelivr.net/npm/dompurify@3.2.2/dist/purify.min.js
- Existing sanitizeText() in chatbot-api.js uses textContent to innerHTML pattern
- Notifications render API data (title, message, case_id) directly in template literals
- 2 CRITICAL files: notifications.js (line 703), notifications-page.js (line 164)
</background>

<tasks>
<task type="auto">
  <name>Task 1: Add DOMPurify and create Sanitizer utility</name>
  <files>
    frontend/src/js/utils/sanitize.js (CREATE)
    frontend/public/index.html
    frontend/public/dashboard.html
    frontend/public/cases.html
    frontend/public/case-detail.html
    frontend/public/add-case.html
    frontend/public/edit-case.html
    frontend/public/calendar.html
    frontend/public/timeline.html
    frontend/public/notifications.html
    frontend/public/settings.html
  </files>
  <action>
    1. Create frontend/src/js/utils/sanitize.js with centralized Sanitizer:
       - Use IIFE pattern (like chatbot modules) for service worker compatibility
       - Sanitizer.html(dirty) - sanitize HTML preserving safe tags (b, i, em, strong, a, p, br, ul, ol, li, span, div)
       - Sanitizer.text(dirty) - strip ALL HTML (safest, for user content display)
       - Sanitizer.richContent(dirty) - more permissive for chatbot responses
       - Add DOMPurify hook for target="_blank" + rel="noopener noreferrer" on links
       - Export as window.Sanitizer

    2. Reference 07-RESEARCH.md for exact DOMPurify configuration patterns

    3. Add DOMPurify CDN script tag to ALL HTML pages that render user/API content:
       - Place BEFORE closing body tag but BEFORE application scripts
       - CDN URL: https://cdn.jsdelivr.net/npm/dompurify@3.2.2/dist/purify.min.js

    4. Add sanitize.js script to same pages AFTER DOMPurify

    Note: Do NOT delete existing chatbot-api.js sanitizeText() - chatbot modules depend on it.
  </action>
  <verify>
    - frontend/src/js/utils/sanitize.js exists
    - DOMPurify script tag present in dashboard.html, notifications.html
    - Browser console: typeof DOMPurify !== 'undefined'
    - Browser console: typeof window.Sanitizer !== 'undefined'
    - Browser console: Sanitizer.text('&lt;script&gt;alert(1)&lt;/script&gt;') returns empty string
  </verify>
  <done>
    - Sanitizer utility created with html(), text(), richContent() methods
    - DOMPurify CDN added to all HTML pages needing sanitization
    - sanitize.js loaded after DOMPurify
    - window.Sanitizer accessible globally
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix CRITICAL XSS in notifications.js</name>
  <files>frontend/src/js/components/notifications.js</files>
  <action>
    Fix renderNotifications() function around line 703.

    VULNERABILITY: API fields (notif.title, notif.message, notif.id, notif.case_id)
    are interpolated directly into template literal without sanitization.

    FIX APPROACH:
    1. Wrap notif.title with Sanitizer.text() - strips ALL HTML
    2. Wrap notif.message with Sanitizer.text() - strips ALL HTML
    3. Wrap notif.id in data-id attribute with Sanitizer.text(String(...))
    4. Wrap notif.id in onclick handler with Sanitizer.text(String(...))
    5. Wrap notif.case_id in data-case-id with Sanitizer.text(String(...))

    Why Sanitizer.text() not Sanitizer.html():
    - Notification titles/messages should be PLAIN TEXT display
    - This is the SAFEST approach - prevents all XSS vectors
    - If rich formatting needed later, switch to Sanitizer.html()

    Leave static HTML structure unchanged - only wrap dynamic API data.
  </action>
  <verify>
    - grep -n "notif.title" frontend/src/js/components/notifications.js shows Sanitizer.text wrapping
    - grep -n "notif.message" frontend/src/js/components/notifications.js shows Sanitizer.text wrapping
    - Run frontend locally, notifications render correctly with proper text
    - No console errors
  </verify>
  <done>
    - All API-sourced notification data sanitized before DOM insertion
    - notif.title, notif.message wrapped in Sanitizer.text()
    - notif.id, notif.case_id in attributes wrapped in Sanitizer.text()
    - No raw template literal interpolation of API data
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix CRITICAL XSS in notifications-page.js</name>
  <files>frontend/src/js/pages/notifications-page.js</files>
  <action>
    Fix createNotificationCard() function around line 164.

    VULNERABILITY: API fields interpolated directly:
    - notification.title (in h3 content and title attribute)
    - notification.message (in p content and title attribute)
    - notification.days_until_deadline (in p content)
    - notification.case_id (passed to buildCaseDetailUrl)

    FIX APPROACH:
    1. Pre-sanitize fields at start of function:
       - const safeTitle = Sanitizer.text(notification.title || '');
       - const safeMessage = Sanitizer.text(notification.message || '');

    2. Type-check days_until_deadline (must be number):
       - const safeDays = typeof notification.days_until_deadline === 'number' ? notification.days_until_deadline : null;

    3. Use buildCaseDetailUrl() as-is (trusted internal function) but verify case_id handling

    4. Replace all notification.title/message references with safeTitle/safeMessage

    ALSO REVIEW other usages in this file (lines 321, 436, 364, 372, 378, 387, 500, 510):
    - These are static HTML templates (button loading states, restore text)
    - Lower priority - static strings don't have XSS risk
    - Focus on line 164 createNotificationCard which has API data
  </action>
  <verify>
    - grep -n "notification.title" frontend/src/js/pages/notifications-page.js - verify sanitization
    - grep -n "notification.message" frontend/src/js/pages/notifications-page.js - verify sanitization
    - Run frontend locally, notifications page renders correctly
    - Cards display notification content as expected
    - No console errors
  </verify>
  <done>
    - createNotificationCard() sanitizes all API fields before DOM insertion
    - notification.title, notification.message use Sanitizer.text()
    - days_until_deadline type-checked before use
    - No raw template interpolation of API data in card creation
  </done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] DOMPurify loaded in browser (Network tab or console: typeof DOMPurify !== 'undefined')
- [ ] Sanitizer utility accessible: window.Sanitizer.text, window.Sanitizer.html defined
- [ ] Sanitizer.text with script tag input returns empty string
- [ ] Notifications dropdown renders correctly (test on dashboard)
- [ ] Notifications page (/notifications) renders correctly
- [ ] No console errors on either page
- [ ] npm run build succeeds (if applicable)
</verification>

<success_criteria>
- DOMPurify 3.2.2 integrated via CDN in all relevant HTML pages
- Sanitizer utility at frontend/src/js/utils/sanitize.js with html(), text(), richContent() methods
- notifications.js renderNotifications() - all API data sanitized
- notifications-page.js createNotificationCard() - all API data sanitized
- 0 CRITICAL XSS vulnerabilities remaining (the 2 notification files fixed)
- Frontend still functions correctly
</success_criteria>

<output>
After completion, update:
1. STATE.md - mark plan 07-01 in progress/complete
2. Note any decisions made during implementation
3. List exact files modified for commit message
</output>
