---
phase: 10-final-validation
plan: 01
type: execute
---

<objective>
Add Sentry error tracking to backend and frontend for production visibility.

Purpose: Enable real-time error monitoring, stack traces with source context, and alerting for production issues. Currently errors only appear in Render dashboard logs or browser console.
Output: Sentry SDK integrated in both backend (FastAPI middleware) and frontend (browser SDK), configured for test environment with proper DSN handling.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Concern addressed:** M5 (Missing Error Tracking Integration) from COMPREHENSIVE_CONCERNS_SPEC.md

**Current state:**
- No Sentry SDK in requirements.txt or package.json
- Backend has global exception handler in main.py (lines 134-170) with traceback logging
- Frontend errors go to console only, shown via showToast() utility
- 22% test coverage means many error paths are untested and unknown

**Integration points identified:**
- Backend: app/main.py global exception handler
- Backend: All service files with try/except blocks
- Frontend: API client error handling in orchestratedChat.js, cases.js
- Frontend: showToast() for user-visible errors

**Test worktree context:**
- Use test/development DSN (not production)
- Environment-aware configuration (only send in non-local environments)
- Local development should not send to Sentry
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Sentry to backend with FastAPI integration</name>
  <files>backend/requirements.txt, backend/app/config.py, backend/app/main.py</files>
  <action>
1. Add sentry-sdk[fastapi] to requirements.txt

2. Add Sentry DSN to config.py Settings class:
   ```python
   sentry_dsn: str = ""  # Empty = disabled
   ```

3. Initialize Sentry in main.py BEFORE app creation:
   ```python
   import sentry_sdk
   from sentry_sdk.integrations.fastapi import FastApiIntegration
   from sentry_sdk.integrations.starlette import StarletteIntegration

   if settings.sentry_dsn and not settings.debug:
       sentry_sdk.init(
           dsn=settings.sentry_dsn,
           integrations=[
               FastApiIntegration(transaction_style="endpoint"),
               StarletteIntegration(transaction_style="endpoint"),
           ],
           traces_sample_rate=0.1,  # 10% of requests for performance
           environment="development" if settings.debug else "production",
           send_default_pii=False,  # Don't send user emails/IPs
       )

4. Update global exception handler to capture to Sentry:
   ```python
   @app.exception_handler(Exception)
   async def global_exception_handler(request: Request, exc: Exception) -> JSONResponse:
       # Capture to Sentry first
       sentry_sdk.capture_exception(exc)
       # Then existing error handling...
   ```

5. Add test endpoint to verify Sentry works:
   ```python
   @app.get("/api/debug/sentry-test")
   async def sentry_test():
       if settings.debug:
           raise ValueError("Sentry test error - ignore this")
       raise HTTPException(status_code=404, detail="Not available in production")
   ```
  </action>
  <verify>
- pip install -r requirements.txt succeeds
- Backend starts without errors: uvicorn app.main:app --reload
- With SENTRY_DSN unset: app starts normally, no Sentry initialization
- Settings class includes sentry_dsn field
  </verify>
  <done>Sentry SDK installed and configured in backend with FastAPI integration, disabled by default when DSN not set</done>
</task>

<task type="auto">
  <name>Task 2: Add Sentry to frontend with environment-aware initialization</name>
  <files>frontend/package.json, frontend/src/js/utils/sentry.js, frontend/src/js/app.js, frontend/public/index.html</files>
  <action>
1. Add @sentry/browser to package.json dependencies:
   ```json
   "@sentry/browser": "^8.0.0"
   ```

2. Create frontend/src/js/utils/sentry.js:
   ```javascript
   import * as Sentry from '@sentry/browser';

   const SENTRY_DSN = ''; // Set via build config or leave empty to disable
   const isLocalhost = window.location.hostname === 'localhost' ||
                       window.location.hostname === '127.0.0.1';

   export function initSentry() {
     // Don't initialize on localhost or if no DSN
     if (isLocalhost || !SENTRY_DSN) {
       console.log('[Sentry] Disabled - localhost or no DSN configured');
       return;
     }

     Sentry.init({
       dsn: SENTRY_DSN,
       environment: isLocalhost ? 'development' : 'production',
       tracesSampleRate: 0.1,
       // Don't send user data
       beforeSend(event) {
         // Strip any PII from event
         if (event.user) {
           delete event.user.email;
           delete event.user.ip_address;
         }
         return event;
       },
     });

     console.log('[Sentry] Initialized for', window.location.hostname);
   }

   export function captureException(error, context = {}) {
     if (isLocalhost || !SENTRY_DSN) {
       console.error('[Sentry] Would capture:', error, context);
       return;
     }
     Sentry.captureException(error, { extra: context });
   }

   export function captureMessage(message, level = 'info') {
     if (isLocalhost || !SENTRY_DSN) {
       console.log('[Sentry] Would capture message:', message);
       return;
     }
     Sentry.captureMessage(message, level);
   }
   ```

3. Initialize Sentry early in app.js (or main entry point):
   ```javascript
   import { initSentry } from './utils/sentry.js';
   initSentry();
   ```

4. Update showToast or error handling to capture exceptions:
   - Find the main error handler pattern used across API calls
   - Add captureException() call for error responses

Note: Since this is test worktree and DSN will be empty, Sentry will be disabled but the infrastructure is in place. The placeholder allows easy activation by setting the DSN.
  </action>
  <verify>
- npm install succeeds
- Frontend builds without errors: npm run build
- No console errors on page load
- sentry.js module exports initSentry, captureException, captureMessage
  </verify>
  <done>Sentry SDK infrastructure added to frontend, disabled by default, ready for DSN configuration</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Backend: pip install -r requirements.txt succeeds
- [ ] Backend: uvicorn app.main:app starts without errors
- [ ] Backend: Settings class has sentry_dsn field
- [ ] Frontend: npm install succeeds
- [ ] Frontend: npm run build succeeds
- [ ] Frontend: sentry.js utility exists with proper exports
- [ ] No regressions: existing functionality works
</verification>

<success_criteria>
- Sentry SDK installed in both backend and frontend
- Environment-aware initialization (disabled on localhost, disabled when no DSN)
- Privacy-conscious configuration (no PII sent)
- Infrastructure ready for production DSN activation
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-final-validation/10-01-SUMMARY.md`
</output>
