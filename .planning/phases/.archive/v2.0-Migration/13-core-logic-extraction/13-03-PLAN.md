---
phase: 13-core-logic-extraction
plan: 03
type: execute
---

<objective>
Create VALIDATION_RULES.md - complete catalog of all validation rules, error vs warning distinction, and edge cases.

Purpose: Provide complete validation reference for v2.0 central validation module with TDD test cases.
Output: `.planning/V2_VALIDATION_RULES.md` - standalone migration-ready reference document.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/V2_MIGRATION_BRIEF.md
@.planning/V2_DEADLINE_SYSTEM.md
@.planning/phases/13-core-logic-extraction/13-RESEARCH.md
@.planning/phases/13-core-logic-extraction/13-CONTEXT.md
@.planning/phases/13-core-logic-extraction/13-01-SUMMARY.md (if exists)
@.planning/phases/13-core-logic-extraction/13-02-SUMMARY.md (if exists)

**Source files to extract from:**
@backend/app/utils/date_validation.py (all validate_* functions)
@backend/app/schemas/case.py (Pydantic validators)
@frontend/src/js/utils/form/dateValidation.js (client-side mirror)
@backend/tests/ (test files for edge case coverage)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Complete Validation Rule Catalog</name>
  <files>.planning/V2_VALIDATION_RULES.md (create)</files>
  <exploration>
    Read backend/app/utils/date_validation.py for all validate_* functions.
    Read 13-RESEARCH.md validation_rules section for the rule catalog.
    Identify all validation rules by category (PWD, Recruitment, ETA 9089, I-140, RFI/RFE).
    Note error vs warning distinction for each rule.
  </exploration>
  <action>
Create .planning/V2_VALIDATION_RULES.md with the following structure:

```markdown
# v2.0 Validation Rules Reference

> Purpose: Complete validation rule catalog for migration
> Created: [date]
> Source: Extracted from backend/app/utils/date_validation.py, schemas/case.py
> Test Coverage: 377+ behaviors from test suite

## 1. Validation System Overview

### 1.1 Validation Result Types

```typescript
type ValidationSeverity = 'error' | 'warning';

interface ValidationResult {
  isValid: boolean;
  severity: ValidationSeverity;
  ruleId: string;
  field: string;
  message: string;
}
```

### 1.2 Error vs Warning Distinction

| Severity | Meaning | Block Save? |
|----------|---------|-------------|
| Error | Regulation violation, must fix | Yes |
| Warning | Non-blocking issue, review recommended | No |

### 1.3 Validation Triggers

- On field blur (immediate feedback)
- On form submit (full validation)
- On API request (server-side)
- Cross-field (when related fields change)

## 2. PWD Validation Rules

| Rule ID | Field | Severity | Condition | Message |
|---------|-------|----------|-----------|---------|
| V-PWD-01 | pwd_determination_date | Error | determination <= filing | "Determination date must be after filing date" |
| V-PWD-02 | pwd_expiration_date | Error | expiration <= determination | "Expiration date must be after determination date" |
| V-PWD-03 | pwd_expiration_date | Warning | expiration != calculated | "Expiration date doesn't match calculated value" |
| V-PWD-04 | pwd_expiration_date | Warning | expiration < today | "PWD has expired" |

### 2.1 PWD Cross-Field Validations

```typescript
function validatePwdDates(case: Case): ValidationResult[] {
  const results: ValidationResult[] = [];

  if (case.pwdDeterminationDate && case.pwdFilingDate) {
    if (case.pwdDeterminationDate <= case.pwdFilingDate) {
      results.push({
        isValid: false,
        severity: 'error',
        ruleId: 'V-PWD-01',
        field: 'pwd_determination_date',
        message: 'Determination date must be after filing date'
      });
    }
  }

  // ... additional validations
  return results;
}
```

## 3. Recruitment Validation Rules

| Rule ID | Field | Severity | Condition | Message |
|---------|-------|----------|-----------|---------|
| V-REC-01 | sunday_ad_first_date | Error | dayOfWeek != 0 | "First Sunday ad must be on a Sunday" |
| V-REC-02 | sunday_ad_second_date | Error | dayOfWeek != 0 | "Second Sunday ad must be on a Sunday" |
| V-REC-03 | sunday_ad_second_date | Error | second <= first | "Second Sunday ad must be after first" |
| V-REC-04 | job_order_end_date | Error | end <= start | "Job order end must be after start" |
| V-REC-05 | job_order_end_date | Error | duration < 30 days | "Job order must be at least 30 days" |
| V-REC-06 | notice_of_filing_end_date | Error | businessDays < 10 | "Notice of Filing must be at least 10 business days" |

### 3.1 Sunday Validation

```typescript
function validateSundayAd(date: Date, fieldName: string): ValidationResult | null {
  if (date.getDay() !== 0) { // 0 = Sunday
    return {
      isValid: false,
      severity: 'error',
      ruleId: fieldName === 'sunday_ad_first_date' ? 'V-REC-01' : 'V-REC-02',
      field: fieldName,
      message: `${fieldName === 'sunday_ad_first_date' ? 'First' : 'Second'} Sunday ad must be on a Sunday`
    };
  }
  return null;
}
```

## 4. ETA 9089 Validation Rules

| Rule ID | Field | Severity | Condition | Message |
|---------|-------|----------|-----------|---------|
| V-ETA-01 | eta9089_filing_date | Error | filing < recruitment_end + 30 | "Must wait 30 days after recruitment ends" |
| V-ETA-02 | eta9089_filing_date | Error | filing > recruitment_end + 180 | "Must file within 180 days of recruitment end" |
| V-ETA-03 | eta9089_filing_date | Error | filing > pwd_expiration (when applicable) | "Must file before PWD expiration" |
| V-ETA-04 | eta9089_certification_date | Error | certification <= filing | "Certification must be after filing date" |
| V-ETA-05 | eta9089_expiration_date | Warning | expiration != certification + 180 | "Expiration doesn't match calculated value" |

### 4.1 Either/Or Rule Implementation

```typescript
function validateEta9089Filing(case: Case): ValidationResult[] {
  const results: ValidationResult[] = [];

  if (case.eta9089FilingDate && case.pwdExpirationDate) {
    // Check if PWD expiration applies
    if (shouldEnforcePwdExpiration(case)) {
      if (case.eta9089FilingDate > case.pwdExpirationDate) {
        results.push({
          isValid: false,
          severity: 'error',
          ruleId: 'V-ETA-03',
          field: 'eta9089_filing_date',
          message: 'ETA 9089 must be filed before PWD expiration'
        });
      }
    }
  }

  return results;
}

function shouldEnforcePwdExpiration(case: Case): boolean {
  // PWD expiration only matters if recruitment started BEFORE PWD issued
  const recruitmentStart = getRecruitmentStartDate(case);
  return recruitmentStart && recruitmentStart < case.pwdDeterminationDate;
}
```

## 5. I-140 Validation Rules

| Rule ID | Field | Severity | Condition | Message |
|---------|-------|----------|-----------|---------|
| V-I140-01 | i140_filing_date | Error | filing <= certification | "I-140 must be filed after ETA 9089 certification" |
| V-I140-02 | i140_filing_date | Error | filing > certification + 180 | "I-140 must be filed within 180 days of certification" |
| V-I140-03 | i140_approval_date | Error | approval <= filing | "Approval must be after filing date" |

## 6. RFI/RFE Validation Rules

| Rule ID | Field | Severity | Condition | Message |
|---------|-------|----------|-----------|---------|
| V-RFI-01 | rfi_response_due_date | Error | due <= received | "Due date must be after received date" |
| V-RFI-02 | rfi_response_submitted_date | Error | submitted < received | "Cannot submit before receiving" |
| V-RFI-03 | rfi_response_submitted_date | Warning | submitted > due | "Response was submitted late" |
| V-RFE-01 | rfe_response_due_date | Error | due <= received | "Due date must be after received date" |
| V-RFE-02 | rfe_response_submitted_date | Error | submitted < received | "Cannot submit before receiving" |
| V-RFE-03 | rfe_response_submitted_date | Warning | submitted > due | "Response was submitted late" |
```

Document all 20+ validation rules with:
- Unique rule ID (V-XXX-NN format)
- Field affected
- Severity (error/warning)
- Condition that triggers
- User-facing message
- TypeScript pseudocode for complex rules
  </action>
  <verify>
File exists at .planning/V2_VALIDATION_RULES.md.
Grep for "V-PWD" shows PWD rules.
Grep for "V-REC" shows recruitment rules.
Grep for "V-ETA" shows ETA 9089 rules.
Grep for "V-I140" shows I-140 rules.
Document has at least 6 major sections.
  </verify>
  <done>
V2_VALIDATION_RULES.md exists with:
- Validation system overview
- Error vs warning distinction
- PWD validation rules (4 rules)
- Recruitment validation rules (6 rules)
- ETA 9089 validation rules (5 rules)
- I-140 validation rules (3 rules)
- RFI/RFE validation rules (6 rules)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Edge Cases, Test Coverage Map, and Professional Rules</name>
  <files>.planning/V2_VALIDATION_RULES.md (edit)</files>
  <exploration>
    Read backend/tests/ for edge case test scenarios.
    Read backend/app/utils/date_validation.py for professional occupation validation.
    Map test behaviors to validation rules for coverage verification.
  </exploration>
  <action>
Append to V2_VALIDATION_RULES.md:

```markdown
## 7. Professional Occupation Validation

| Rule ID | Field | Severity | Condition | Message |
|---------|-------|----------|-----------|---------|
| V-PRO-01 | additional_recruitment_methods | Error | count < 3 when professional | "Professional positions require 3 additional recruitment methods" |
| V-PRO-02 | additional_recruitment_methods | Error | >1 step in final 30 days | "Only one additional step may occur within 30 days of filing" |

### 7.1 Professional Position Validation

```typescript
function validateProfessionalRecruitment(case: Case): ValidationResult[] {
  if (!case.isProfessionalOccupation) {
    return []; // Not applicable
  }

  const results: ValidationResult[] = [];
  const methods = case.additionalRecruitmentMethods || [];

  // Must have at least 3 methods
  if (methods.length < 3) {
    results.push({
      isValid: false,
      severity: 'error',
      ruleId: 'V-PRO-01',
      field: 'additional_recruitment_methods',
      message: 'Professional positions require 3 additional recruitment methods'
    });
  }

  // Only one method can end within 30 days of filing
  if (case.eta9089FilingDate) {
    const thirtyDaysBefore = addDays(case.eta9089FilingDate, -30);
    const methodsInFinal30 = methods.filter(m =>
      m.endDate && m.endDate >= thirtyDaysBefore
    );

    if (methodsInFinal30.length > 1) {
      results.push({
        isValid: false,
        severity: 'error',
        ruleId: 'V-PRO-02',
        field: 'additional_recruitment_methods',
        message: 'Only one additional step may occur within 30 days of filing'
      });
    }
  }

  return results;
}
```

## 8. Edge Cases

### 8.1 PWD Edge Cases

| Scenario | Expected Behavior |
|----------|------------------|
| PWD determination on Apr 1 | Uses June 30 same year (not 90-day) |
| PWD determination on Apr 2 | Uses 90-day rule |
| PWD determination on Jun 30 | Uses 90-day rule (expires Sep 28) |
| PWD determination on Jul 1 | Uses June 30 following year |
| PWD expires during recruitment | Warning only if recruitment started during validity |

### 8.2 Recruitment Edge Cases

| Scenario | Expected Behavior |
|----------|------------------|
| Sunday ad on Saturday | Error: "Must be on a Sunday" |
| Second ad same day as first | Error: "Second must be after first" |
| Job order 29 days | Error: "Must be at least 30 days" |
| Job order exactly 30 days | Valid |
| Notice of Filing on holiday week | Excludes holidays from count |

### 8.3 ETA 9089 Edge Cases

| Scenario | Expected Behavior |
|----------|------------------|
| Filing on day 30 | Valid (30-day wait satisfied) |
| Filing on day 29 | Error: "Must wait 30 days" |
| Filing on day 180 | Valid (within window) |
| Filing on day 181 | Error: "Must file within 180 days" |
| Filing after PWD expires, recruitment started before | Error |
| Filing after PWD expires, recruitment started after | Valid (Either/Or rule) |

### 8.4 I-140 Edge Cases

| Scenario | Expected Behavior |
|----------|------------------|
| Filing on certification + 180 day | Valid |
| Filing on certification + 181 day | Error |
| Deadline falls on Saturday | Extends to Monday |
| Deadline falls on federal holiday | Extends to next business day |

## 9. Test Coverage Map

### 9.1 Validation Rules â†’ Test Files

| Rule Category | Test File | Approx Test Count |
|--------------|-----------|-------------------|
| PWD validation | test_cases.py | 12 |
| Recruitment validation | test_recruitment.py | 31 |
| ETA 9089 validation | test_cases.py | 15 |
| I-140 validation | test_case_lifecycle.py | 8 |
| Cross-field | test_cases.py | 10 |
| Professional | test_recruitment.py | 6 |

### 9.2 Target: 377+ Behaviors

The v2.0 validation module must replicate all test behaviors from:
- `backend/tests/test_cases.py` (24 tests)
- `backend/tests/test_case_lifecycle.py` (21 tests)
- `backend/tests/test_recruitment.py` (31 tests)
- Plus related validation in other test files

## 10. Validation Execution Pattern

### 10.1 Client-Side (Immediate Feedback)

```typescript
// On field blur
function onFieldBlur(fieldName: string, value: any, case: Case): ValidationResult[] {
  const updatedCase = { ...case, [fieldName]: value };
  return validateField(fieldName, updatedCase);
}

// On form submit
function onFormSubmit(case: Case): ValidationResult[] {
  return validateAllFields(case);
}
```

### 10.2 Server-Side (Final Authority)

```typescript
// On API mutation
function validateCaseMutation(case: Case): ValidationResult[] {
  const results = validateAllFields(case);

  // Block on errors, allow warnings
  if (results.some(r => r.severity === 'error')) {
    throw new ValidationError(results);
  }

  return results; // Return warnings for display
}
```

## 11. Feature Cross-Reference

### 11.1 Features Covered
Maps to V2_FEATURE_INVENTORY.md:
- Date Validation (20 features) - all validation aspects
- Case Management - validation component

### 11.2 Related Documents
- V2_BUSINESS_RULES.md - Stage progression, process flow
- V2_DEADLINE_FLOWS.md - Deadline calculations
- V2_DEADLINE_SYSTEM.md - Original ecosystem reference

---

*Extracted: [date]*
*Sources: backend/app/utils/date_validation.py, backend/tests/, frontend/src/js/utils/form/dateValidation.js*
*Test Coverage: 377+ behaviors mapped*
```

Ensure all edge cases from test files are documented.
Map tests to validation rules for coverage verification.
Include client-side and server-side validation patterns.
  </action>
  <verify>
Grep for "V-PRO" shows professional rules.
Grep for "Edge Cases" shows section 8 exists.
Grep for "Test Coverage" shows section 9 exists.
All 20+ validation rules from feature inventory are documented.
Document is self-contained for v2.0 implementation.
  </verify>
  <done>
V2_VALIDATION_RULES.md is complete with:
- Professional occupation validation
- Edge cases for all rule categories
- Test coverage map
- Client/server validation patterns
- Feature cross-references
- Ready for v2.0 TDD implementation
  </done>
</task>

<task type="auto">
  <name>Task 3: Update STATE.md and verify all three documents</name>
  <files>.planning/STATE.md (edit)</files>
  <action>
1. Verify all three V2_ documents exist:
   - .planning/V2_BUSINESS_RULES.md
   - .planning/V2_DEADLINE_FLOWS.md
   - .planning/V2_VALIDATION_RULES.md

2. Update STATE.md:
   - Current Position: Phase 13 complete
   - Add to Context Documents table:
     | V2_BUSINESS_RULES.md | PERM process, stage progression |
     | V2_DEADLINE_FLOWS.md | Deadline calculations, supersession |
     | V2_VALIDATION_RULES.md | All validation rules, edge cases |
   - Update Next action to Phase 14

3. Verify cross-references between documents are accurate.
  </action>
  <verify>
ls .planning/V2_*.md shows all expected documents.
STATE.md updated with Phase 13 complete status.
All documents reference each other correctly.
  </verify>
  <done>
Phase 13 complete:
- 3 comprehensive migration documents created
- STATE.md updated
- Ready for Phase 14 (Schema + Design Extraction)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] V2_VALIDATION_RULES.md exists in .planning/
- [ ] All 20+ validation rules documented with IDs
- [ ] Error vs warning distinction clear
- [ ] Professional occupation rules included
- [ ] Edge cases documented for all categories
- [ ] Test coverage map present
- [ ] Client/server validation patterns documented
- [ ] Cross-references to other V2_ docs
- [ ] STATE.md updated for Phase 13 complete
- [ ] All three V2_ docs reference each other
</verification>

<success_criteria>
- V2_VALIDATION_RULES.md is comprehensive enough to implement validation module
- Never need to read legacy date_validation.py for validation logic
- All 20 validation features from V2_FEATURE_INVENTORY.md are documented
- Edge cases from 377+ tests are captured
- TDD-ready with clear test scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/13-core-logic-extraction/13-03-SUMMARY.md`:

# Phase 13 Plan 03: VALIDATION_RULES.md Extraction Summary

**[One-liner: what shipped]**

## Accomplishments

- Created V2_VALIDATION_RULES.md
- Updated STATE.md for Phase 13 complete

## Files Created/Modified

- `.planning/V2_VALIDATION_RULES.md` - Created
- `.planning/STATE.md` - Updated

## Decisions Made

[Any choices about structure/organization]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 13 complete. Ready for Phase 14 (Schema + Design Extraction)
</output>
