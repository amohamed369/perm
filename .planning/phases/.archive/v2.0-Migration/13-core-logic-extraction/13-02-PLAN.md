---
phase: 13-core-logic-extraction
plan: 02
type: execute
---

<objective>
Create DEADLINE_FLOWS.md - comprehensive documentation of all deadline types, calculation formulas, and supersession rules.

Purpose: Provide complete deadline system reference for v2.0 central validation module implementation.
Output: `.planning/V2_DEADLINE_FLOWS.md` - standalone migration-ready reference document.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/V2_MIGRATION_BRIEF.md
@.planning/V2_DEADLINE_SYSTEM.md
@.planning/phases/13-core-logic-extraction/13-RESEARCH.md
@.planning/phases/13-core-logic-extraction/13-CONTEXT.md
@.planning/phases/13-core-logic-extraction/13-01-SUMMARY.md (if exists)

**Source files to extract from:**
@backend/app/utils/date_validation.py (all calculate_* functions)
@backend/app/utils/deadline_relevance.py (supersession logic, isRelevant functions)
@backend/app/utils/business_days.py (federal holiday handling)
@docs/research.md (section 1.6 - Critical Deadlines Summary)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract All Deadline Types and Calculation Formulas</name>
  <files>.planning/V2_DEADLINE_FLOWS.md (create)</files>
  <exploration>
    Read backend/app/utils/date_validation.py for all calculate_* functions.
    Read docs/research.md section 1.6 for Critical Deadlines Summary.
    Read V2_DEADLINE_SYSTEM.md for the deadline ecosystem overview.
    Identify every deadline type that exists in the system.
  </exploration>
  <action>
Create .planning/V2_DEADLINE_FLOWS.md with the following structure:

```markdown
# v2.0 Deadline Flows Reference

> Purpose: Complete deadline calculation and flow logic for migration
> Created: [date]
> Source: Extracted from backend/app/utils/date_validation.py, deadline_relevance.py

## 1. Deadline Types Overview

### 1.1 Complete Deadline Type Catalog
| Deadline Type | Calculation | Superseded By |
|--------------|-------------|---------------|
| pwd_expiration | [formula] | eta9089_filing_date |
| recruitment_end | [formula] | eta9089_filing_date |
| recruitment_expiration | [formula] | eta9089_filing_date |
| eta9089_filing_window_open | [formula] | eta9089_filing_date |
| eta9089_filing_window_close | [formula] | eta9089_filing_date |
| eta9089_expiration | [formula] | i140_filing_date |
| i140_filing_deadline | [formula] | i140_filing_date |
| rfi_response_due | [user input] | rfi_response_submitted |
| rfe_response_due | [user input] | rfe_response_submitted |

## 2. PWD Expiration Calculation

### 2.1 The April 2 - June 30 Rule (20 CFR § 656.40(c))

```typescript
function calculatePwdExpiration(determinationDate: Date): Date {
  const month = determinationDate.getMonth(); // 0-indexed
  const day = determinationDate.getDate();
  const year = determinationDate.getFullYear();

  // Rule 1: April 2 - June 30 → +90 days
  if ((month === 3 && day >= 2) || month === 4 || (month === 5 && day <= 30)) {
    return addDays(determinationDate, 90);
  }

  // Rule 2: July 1 - December 31 → June 30 of FOLLOWING year
  if (month >= 6) {
    return new Date(year + 1, 5, 30);
  }

  // Rule 3: January 1 - April 1 → June 30 of SAME year
  return new Date(year, 5, 30);
}
```

### 2.2 Edge Case Examples
| Determination Date | Rule Applied | Expiration Date |
|-------------------|--------------|-----------------|
| 2025-04-02 | 90-day rule | 2025-07-01 |
| 2025-06-30 | 90-day rule | 2025-09-28 |
| 2025-07-01 | Next Jun 30 | 2026-06-30 |
| 2025-01-15 | Same Jun 30 | 2025-06-30 |
| 2025-04-01 | Same Jun 30 | 2025-06-30 |

## 3. Recruitment Calculations

### 3.1 Recruitment End Date

```typescript
function calculateRecruitmentEnd(case: Case): Date | null {
  const dates = [
    case.sundayAdSecondDate,
    case.jobOrderEndDate
  ].filter(Boolean);

  return dates.length > 0 ? max(dates) : null;
}
```

### 3.2 Recruitment Expiration (180-Day Limit)

```typescript
function calculateRecruitmentExpiration(recruitmentEnd: Date): Date {
  return addDays(recruitmentEnd, 180);
}
```

## 4. ETA 9089 Filing Window

### 4.1 Window Calculation (20 CFR § 656.17(e))

```typescript
function calculateEta9089Window(recruitmentEnd: Date): { open: Date; close: Date } {
  return {
    open: addDays(recruitmentEnd, 30),   // Minimum 30 days
    close: addDays(recruitmentEnd, 180)  // Maximum 180 days
  };
}
```

### 4.2 PWD Constraint Check

```typescript
function shouldEnforcePwdExpiration(case: Case): boolean {
  // If recruitment started BEFORE PWD was issued, PWD matters
  const recruitmentStart = min([
    case.sundayAdFirstDate,
    case.jobOrderStartDate
  ].filter(Boolean));

  return recruitmentStart < case.pwdDeterminationDate;
}
```

## 5. ETA 9089 Expiration

### 5.1 Calculation (8 CFR § 204.5(n)(3))

```typescript
function calculateEta9089Expiration(certificationDate: Date): Date {
  return addDays(certificationDate, 180);
}
```

## 6. I-140 Filing Deadline

### 6.1 Calculation with Weekend/Holiday Extension

```typescript
function calculateI140Deadline(eta9089Expiration: Date): Date {
  let deadline = eta9089Expiration;

  // Extend to next business day if falls on weekend/holiday
  while (isWeekend(deadline) || isFederalHoliday(deadline)) {
    deadline = addDays(deadline, 1);
  }

  return deadline;
}
```
```

Include all deadline types with formulas.
Use TypeScript pseudocode matching v2.0 target.
Include worked examples for edge cases.
  </action>
  <verify>
File exists at .planning/V2_DEADLINE_FLOWS.md.
Grep for "calculate" shows all calculation functions.
Document has at least 6 major sections.
  </verify>
  <done>
V2_DEADLINE_FLOWS.md exists with:
- Complete deadline type catalog
- PWD expiration calculation with edge cases
- Recruitment calculations
- ETA 9089 window calculation
- I-140 deadline with extensions
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract Supersession Rules and Business Day Logic</name>
  <files>.planning/V2_DEADLINE_FLOWS.md (edit)</files>
  <exploration>
    Read backend/app/utils/deadline_relevance.py for all supersession rules.
    Read backend/app/utils/business_days.py for federal holiday list and calculation.
    Identify terminal statuses that hide all deadlines.
  </exploration>
  <action>
Append to V2_DEADLINE_FLOWS.md:

```markdown
## 7. Deadline Relevance (Supersession)

### 7.1 Core Principle
Deadlines become irrelevant when their associated stage completes.
The system should HIDE superseded deadlines, not show them as "complete".

### 7.2 Supersession Rules Table

| Deadline Type | Becomes Irrelevant When |
|--------------|------------------------|
| pwd_expiration | eta9089_filing_date is set |
| recruitment_end | eta9089_filing_date is set |
| recruitment_expiration | eta9089_filing_date is set |
| eta9089_filing_window | eta9089_filing_date is set |
| ready_to_file | eta9089_filing_date is set |
| eta9089_expiration | i140_filing_date is set |
| i140_filing_deadline | i140_filing_date is set |
| rfi_response_due | rfi_response_submitted_date is set |
| rfe_response_due | rfe_response_submitted_date is set |

### 7.3 Terminal Statuses (All Deadlines Hidden)

```typescript
const TERMINAL_STATUSES = ['Complete', 'Closed', 'Withdrawn', 'Denied'];

function isDeadlineRelevant(deadline: Deadline, case: Case): boolean {
  if (TERMINAL_STATUSES.includes(case.status)) {
    return false;
  }

  return !isSuperseded(deadline.type, case);
}
```

### 7.4 Cascade on Stage Progress

When a case progresses to a new stage:
1. Identify newly superseded deadlines
2. Delete notifications for superseded deadlines
3. Delete calendar events for superseded deadlines
4. Create notifications for newly relevant deadlines
5. Create calendar events for newly relevant deadlines

## 8. Business Day Calculator

### 8.1 Federal Holidays (OPM Schedule)

```typescript
// Notice of Filing requires 10 BUSINESS days
// Weekends and federal holidays excluded

const FEDERAL_HOLIDAYS_2025 = [
  '2025-01-01', // New Year's Day
  '2025-01-20', // MLK Day
  '2025-02-17', // Presidents' Day
  '2025-05-26', // Memorial Day
  '2025-06-19', // Juneteenth
  '2025-07-04', // Independence Day
  '2025-09-01', // Labor Day
  '2025-10-13', // Columbus Day
  '2025-11-11', // Veterans Day
  '2025-11-27', // Thanksgiving
  '2025-12-25', // Christmas
];
```

### 8.2 Holiday Observation Rules

```typescript
function getObservedDate(holiday: Date): Date {
  const dayOfWeek = holiday.getDay();

  if (dayOfWeek === 0) { // Sunday
    return addDays(holiday, 1); // Monday observed
  }
  if (dayOfWeek === 6) { // Saturday
    return addDays(holiday, -1); // Friday observed
  }

  return holiday;
}
```

### 8.3 Business Day Count

```typescript
function countBusinessDays(start: Date, end: Date): number {
  let count = 0;
  let current = new Date(start);

  while (current <= end) {
    if (!isWeekend(current) && !isFederalHoliday(current)) {
      count++;
    }
    current = addDays(current, 1);
  }

  return count;
}
```

## 9. Urgency Levels

### 9.1 Dashboard Grouping

| Urgency | Condition | Color |
|---------|-----------|-------|
| Overdue | deadline < today | Red |
| Critical | deadline <= today + 3 days | Orange |
| High | deadline <= today + 7 days | Yellow |
| Normal | deadline > today + 7 days | Green |

## 10. Feature Cross-Reference

### 10.1 Features Covered
Maps to V2_FEATURE_INVENTORY.md:
- Deadline Tracking (15 features)
- Date Validation (20 features) - calculation aspects

### 10.2 Related Documents
- V2_BUSINESS_RULES.md - Stage progression, process flow
- V2_VALIDATION_RULES.md - All validation rules
- V2_DEADLINE_SYSTEM.md - Original ecosystem reference

---

*Extracted: [date]*
*Sources: backend/app/utils/date_validation.py, deadline_relevance.py, business_days.py*
```

Ensure every supersession rule from deadline_relevance.py is captured.
Include the 2025-2027 federal holiday lists.
Document urgency levels for dashboard display.
  </action>
  <verify>
Grep for "Supersession" shows section 7 exists.
Grep for "FEDERAL_HOLIDAYS" shows holiday list.
Document has at least 10 sections.
All deadline types from Task 1 have supersession rules.
  </verify>
  <done>
V2_DEADLINE_FLOWS.md is complete with:
- Supersession rules for all deadline types
- Terminal status handling
- Business day calculator with federal holidays
- Urgency levels for dashboard
- Feature cross-references
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] V2_DEADLINE_FLOWS.md exists in .planning/
- [ ] All deadline types cataloged with formulas
- [ ] PWD expiration edge cases documented
- [ ] ETA 9089 window calculation complete
- [ ] I-140 deadline with weekend/holiday extension
- [ ] Supersession rules for all deadline types
- [ ] Federal holiday list included
- [ ] Business day calculation documented
- [ ] Urgency levels defined
- [ ] Cross-references to other V2_ docs
</verification>

<success_criteria>
- V2_DEADLINE_FLOWS.md is comprehensive enough to rebuild deadline module
- Never need to read legacy date_validation.py for deadline calculations
- All features from V2_FEATURE_INVENTORY.md sections 3, 5 are documented
- Every calculation has TypeScript pseudocode and examples
</success_criteria>

<output>
After completion, create `.planning/phases/13-core-logic-extraction/13-02-SUMMARY.md`:

# Phase 13 Plan 02: DEADLINE_FLOWS.md Extraction Summary

**[One-liner: what shipped]**

## Accomplishments

- Created V2_DEADLINE_FLOWS.md

## Files Created/Modified

- `.planning/V2_DEADLINE_FLOWS.md` - Created

## Decisions Made

[Any choices about structure/organization]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 13-03-PLAN.md (VALIDATION_RULES.md extraction)
</output>
