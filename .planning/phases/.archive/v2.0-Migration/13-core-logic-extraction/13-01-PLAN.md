---
phase: 13-core-logic-extraction
plan: 01
type: execute
---

<objective>
Create BUSINESS_RULES.md - comprehensive documentation of PERM process flow, case stages, and deadline calculation formulas.

Purpose: Provide complete business logic reference so v2.0 migration never needs to read legacy FastAPI code.
Output: `.planning/V2_BUSINESS_RULES.md` - standalone migration-ready reference document.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/V2_MIGRATION_BRIEF.md
@.planning/V2_DEADLINE_SYSTEM.md
@.planning/phases/13-core-logic-extraction/13-RESEARCH.md
@.planning/phases/13-core-logic-extraction/13-CONTEXT.md

**Source files to extract from:**
@docs/research.md (sections 1.1-1.6 - PERM process, deadlines)
@backend/app/utils/date_validation.py (calculation functions)
@backend/app/utils/deadline_relevance.py (supersession rules)
@backend/app/services/case_service.py (stage logic, auto-calculations)
@backend/app/schemas/case.py (stage enum, field definitions)

**Vision from CONTEXT.md:**
These documents should be a complete rule reference - so comprehensive that during migration,
the legacy FastAPI code never needs to be read again.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract PERM Process Flow and Stage Progression</name>
  <files>.planning/V2_BUSINESS_RULES.md (create)</files>
  <exploration>
    Read docs/research.md sections 1.1-1.4 for PERM 4-step process.
    Read backend/app/schemas/case.py for CaseStatus enum (11 stages).
    Read backend/app/services/case_service.py for auto_determine_case_status logic.
    Understand how stage transitions are triggered by date fields.
  </exploration>
  <action>
Create .planning/V2_BUSINESS_RULES.md with the following structure:

```markdown
# v2.0 Business Rules Reference

> Purpose: Complete PERM business logic for migration
> Created: [date]
> Source: Extracted from backend/app/utils/, docs/research.md

## 1. PERM Process Overview

### 1.1 Four-Step Process
[Extract from docs/research.md 1.3 - Job ID, PWD, Recruitment, ETA 9089]

### 1.2 Timeline Overview
[Current processing times, typical durations]

## 2. Case Stage Progression

### 2.1 Stage Enum (11 values)
[From CaseStatus - PWD through Complete/Withdrawn/Denied]

### 2.2 Stage Transition Rules
[From auto_determine_case_status - which fields trigger which transitions]

### 2.3 Stage-Specific Behavior
[What happens at each stage, what deadlines become relevant]

## 3. Auto-Calculated Fields

### 3.1 PWD Expiration
[The April 2-June 30 rule with code examples]

### 3.2 Recruitment End Date
[max(second_sunday_ad, job_order_end)]

### 3.3 ETA 9089 Expiration
[certification + 180 days]

### 3.4 I-140 Filing Deadline
[certification + 180 days, weekend/holiday extension]

## 4. The Either/Or Rule (20 CFR § 656.40(c))

### 4.1 Explanation
[Two valid paths for PWD validity]

### 4.2 Implementation
[How the system validates this rule]

## 5. Case Field Reference

### 5.1 All 50+ Fields
[Field name, type, constraints, auto-calculation if any]

## 6. Terminal States

### 6.1 Complete
### 6.2 Closed
### 6.3 Withdrawn
### 6.4 Denied
[What happens to deadlines, notifications, calendar events]
```

Document every business rule with regulatory citations (20 CFR § 656.xx) where applicable.
Use TypeScript-style pseudocode for calculations (matches v2.0 target stack).
Cross-reference V2_DEADLINE_SYSTEM.md for calculation details.
  </action>
  <verify>
File exists at .planning/V2_BUSINESS_RULES.md.
Grep for "Stage" shows all 11 stages documented.
Grep for "Either/Or" confirms the critical rule is explained.
  </verify>
  <done>
BUSINESS_RULES.md exists with:
- PERM 4-step process documented
- All 11 case stages with transition rules
- Auto-calculation formulas
- Either/Or rule explained
- 50+ case fields cataloged
- Terminal states documented
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Professional Occupation Rules and Cross-References</name>
  <files>.planning/V2_BUSINESS_RULES.md (edit)</files>
  <exploration>
    Read backend/app/utils/date_validation.py for professional occupation validation.
    Read docs/research.md for the 10 additional recruitment methods.
    Check V2_FEATURE_INVENTORY.md for any business rules features to ensure coverage.
  </exploration>
  <action>
Append to V2_BUSINESS_RULES.md:

```markdown
## 7. Professional Occupation Rules

### 7.1 Definition
[is_professional_occupation = true when Bachelor's degree required]

### 7.2 Additional Recruitment Requirements
[3 of 10 methods required - list all 10]

### 7.3 30-Day Final Step Rule
[Only ONE additional step may end within 30 days of filing]

### 7.4 Validation
[How the system validates professional occupation requirements]

## 8. Feature Cross-Reference

### 8.1 Features Covered by This Document
[Map to V2_FEATURE_INVENTORY.md sections:
- Case Management (15 features)
- Case Stages (11 features)
- Recruitment (8 features)]

### 8.2 Related Documents
- V2_DEADLINE_FLOWS.md - Deadline calculations in depth
- V2_VALIDATION_RULES.md - All validation rules
- V2_DEADLINE_SYSTEM.md - Deadline ecosystem reference

---

*Extracted: [date]*
*Sources: backend/app/utils/date_validation.py, backend/app/services/case_service.py, docs/research.md*
```

Ensure regulatory citations include:
- 20 CFR § 656.40(c) - PWD validity
- 20 CFR § 656.17 - Basic labor certification
- 20 CFR § 656.18 - College/university teachers
- 8 CFR § 204.5(n)(3) - I-140 validity
  </action>
  <verify>
Grep for "Professional" shows section 7 exists.
Grep for "656.40" shows regulatory citations.
Document is complete and self-contained.
  </verify>
  <done>
V2_BUSINESS_RULES.md is complete with:
- Professional occupation rules
- Feature cross-references
- All regulatory citations
- Ready for v2.0 migration use
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] V2_BUSINESS_RULES.md exists in .planning/
- [ ] Document covers PERM 4-step process
- [ ] All 11 case stages documented with transitions
- [ ] Auto-calculation formulas included
- [ ] Either/Or rule explained with both paths
- [ ] Professional occupation rules included
- [ ] 50+ case fields cataloged
- [ ] Regulatory citations present (20 CFR § 656.xx)
- [ ] Cross-references to other V2_ docs
</verification>

<success_criteria>
- V2_BUSINESS_RULES.md is comprehensive enough to rebuild case stage logic
- Never need to read legacy case_service.py or date_validation.py for business rules
- All features from V2_FEATURE_INVENTORY.md sections 2-4 are documented
- Regulatory accuracy verified against docs/research.md
</success_criteria>

<output>
After completion, create `.planning/phases/13-core-logic-extraction/13-01-SUMMARY.md`:

# Phase 13 Plan 01: BUSINESS_RULES.md Extraction Summary

**[One-liner: what shipped]**

## Accomplishments

- Created V2_BUSINESS_RULES.md

## Files Created/Modified

- `.planning/V2_BUSINESS_RULES.md` - Created

## Decisions Made

[Any choices about structure/organization]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 13-02-PLAN.md (DEADLINE_FLOWS.md extraction)
</output>
