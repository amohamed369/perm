---
phase: 18-auth
plan: 02
type: execute
domain: convex-auth
---

<objective>
Integrate Convex Auth with Next.js - update providers, create middleware, and set up environment variables.

Purpose: Connect the Convex Auth backend to the Next.js frontend with proper SSR support and route protection.
Output: Working auth flow between Next.js and Convex with route protection middleware.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-auth/18-RESEARCH.md
@.planning/phases/18-auth/18-CONTEXT.md
@.planning/phases/18-auth/18-01-SUMMARY.md

**Prior decisions affecting this phase:**
- Use ConvexAuthNextjsProvider (not plain ConvexProvider)
- Add ConvexAuthNextjsServerProvider wrapper for SSR
- 7-day session duration to match v1 behavior

**Relevant source files:**
@v2/src/app/providers.tsx
@v2/src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update providers for Convex Auth</name>
  <files>v2/src/app/providers.tsx, v2/src/app/layout.tsx</files>
  <action>
    **Update v2/src/app/providers.tsx:**
    Replace ConvexProvider with ConvexAuthNextjsProvider:

    ```typescript
    "use client";

    import { ConvexAuthNextjsProvider } from "@convex-dev/auth/nextjs";
    import { ConvexReactClient } from "convex/react";
    import { ReactNode } from "react";
    import { ThemeProvider } from "@/components/providers/theme-provider";
    import { Toaster } from "@/components/ui/sonner";

    const convex = new ConvexReactClient(process.env.NEXT_PUBLIC_CONVEX_URL!);

    export function ConvexClientProvider({ children }: { children: ReactNode }) {
      return (
        <ConvexAuthNextjsProvider client={convex}>
          <ThemeProvider>
            {children}
            <Toaster />
          </ThemeProvider>
        </ConvexAuthNextjsProvider>
      );
    }
    ```

    **Update v2/src/app/layout.tsx:**
    Wrap the entire app with ConvexAuthNextjsServerProvider for SSR auth:

    - Import ConvexAuthNextjsServerProvider from "@convex-dev/auth/nextjs/server"
    - Wrap the html element with ConvexAuthNextjsServerProvider

    WHY server provider: Enables server-side auth checks and cookie-based sessions that work with Next.js SSR.
  </action>
  <verify>
    `cd v2 && npm run build` succeeds - no TypeScript errors in providers or layout
  </verify>
  <done>Providers updated to use ConvexAuth; both client and server providers in place</done>
</task>

<task type="auto">
  <name>Task 2: Create route protection middleware</name>
  <files>v2/src/middleware.ts</files>
  <action>
    Create v2/src/middleware.ts with Convex Auth middleware:

    ```typescript
    import {
      convexAuthNextjsMiddleware,
      createRouteMatcher,
      nextjsMiddlewareRedirect,
    } from "@convex-dev/auth/nextjs/server";

    // Public routes (no auth required)
    const isPublicRoute = createRouteMatcher([
      "/",
      "/login",
      "/signup",
      "/reset-password",
    ]);

    // Auth routes (should redirect to dashboard if already logged in)
    const isAuthRoute = createRouteMatcher(["/login", "/signup"]);

    export default convexAuthNextjsMiddleware(async (request, { convexAuth }) => {
      const isAuthenticated = await convexAuth.isAuthenticated();

      // Redirect authenticated users away from login/signup pages
      if (isAuthRoute(request) && isAuthenticated) {
        return nextjsMiddlewareRedirect(request, "/dashboard");
      }

      // Redirect unauthenticated users to login (for protected routes)
      if (!isPublicRoute(request) && !isAuthenticated) {
        return nextjsMiddlewareRedirect(request, "/login");
      }
    });

    export const config = {
      // Match all routes except static files and Next.js internals
      matcher: ["/((?!.*\\..*|_next).*)", "/", "/(api|trpc)(.*)"],
    };
    ```

    This middleware:
    - Protects all routes except public ones
    - Redirects authenticated users away from login/signup to /dashboard
    - Redirects unauthenticated users to /login
    - Matches all routes except static files
  </action>
  <verify>
    `cd v2 && npm run build` succeeds with middleware in place
  </verify>
  <done>Middleware created with route protection logic</done>
</task>

<task type="auto">
  <name>Task 3: Configure environment variables for Convex Auth</name>
  <files>v2/.env.local</files>
  <action>
    **Update v2/.env.local with auth-related variables:**

    Add placeholders for auth environment variables:
    ```
    # Existing
    NEXT_PUBLIC_CONVEX_URL=...

    # Auth (values will be set in Convex dashboard)
    # AUTH_GOOGLE_ID and AUTH_GOOGLE_SECRET go in Convex env vars, not here
    # RESEND_API_KEY goes in Convex env vars, not here

    # Site URL for OAuth redirects (used by auth.config.ts)
    SITE_URL=http://localhost:3000
    ```

    **Set Convex environment variables via CLI:**
    Document the commands needed (to be run manually by developer):
    ```bash
    # Set in Convex dashboard or via CLI:
    npx convex env set AUTH_GOOGLE_ID <reuse-from-v1>
    npx convex env set AUTH_GOOGLE_SECRET <reuse-from-v1>
    npx convex env set AUTH_RESEND_KEY <reuse-from-v1>
    npx convex env set SITE_URL http://localhost:3000
    ```

    **IMPORTANT:** The actual credential values must be reused from v1:
    - Google OAuth: Same GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET from v1
    - Resend: Same RESEND_API_KEY from v1

    Also need to add redirect URI in Google Cloud Console:
    `https://<convex-deployment>.convex.site/api/auth/callback/google`
  </action>
  <verify>
    .env.local has SITE_URL set to localhost:3000
  </verify>
  <done>Environment configuration documented; SITE_URL set in .env.local</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd v2 && npm run build` succeeds
- [ ] `cd v2 && npm run dev` starts without errors
- [ ] providers.tsx uses ConvexAuthNextjsProvider
- [ ] layout.tsx has ConvexAuthNextjsServerProvider wrapper
- [ ] middleware.ts exists with route protection logic
- [ ] .env.local has SITE_URL configured
</verification>

<success_criteria>
- ConvexAuthNextjsProvider replaces ConvexProvider
- ConvexAuthNextjsServerProvider wraps the entire app for SSR
- Route protection middleware created
- Public routes (/login, /signup, /reset-password, /) accessible without auth
- Protected routes redirect to /login when not authenticated
- Auth routes redirect to /dashboard when authenticated
- Environment variables documented for developer setup
</success_criteria>

<output>
After completion, create `.planning/phases/18-auth/18-02-SUMMARY.md`:

# Phase 18 Plan 02: Next.js Integration Summary

**[One-liner: what was accomplished]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `v2/src/app/providers.tsx` - ConvexAuthNextjsProvider
- `v2/src/app/layout.tsx` - ConvexAuthNextjsServerProvider wrapper
- `v2/src/middleware.ts` - Route protection
- `v2/.env.local` - Environment configuration

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 18-03-PLAN.md (Auth UI pages and user queries)
</output>
