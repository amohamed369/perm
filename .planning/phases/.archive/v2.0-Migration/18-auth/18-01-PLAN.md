---
phase: 18-auth
plan: 01
type: execute
domain: convex-auth
---

<objective>
Set up Convex Auth backend with Password + Google OAuth providers, email templates, and Clerk-ready schema.

Purpose: Establish the auth infrastructure that all other auth features depend on.
Output: Configured Convex Auth with working Password/OAuth providers, email OTP system, and userProfiles table for app-specific data.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-auth/18-RESEARCH.md
@.planning/phases/18-auth/18-CONTEXT.md

**Prior decisions affecting this phase:**
- Use separate `userProfiles` table for app-specific data (Clerk migration readiness)
- Reuse existing Google OAuth credentials from v1 (AUTH_GOOGLE_ID, AUTH_GOOGLE_SECRET)
- Email verification before account is active
- Match v1 login experience as closely as possible

**Relevant source files:**
@v2/convex/schema.ts
@v2/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Convex Auth dependencies</name>
  <files>v2/package.json</files>
  <action>
    Install the required Convex Auth packages:
    ```bash
    cd v2 && pnpm add @convex-dev/auth @auth/core resend @oslojs/crypto zod
    ```

    These packages provide:
    - @convex-dev/auth: Core Convex Auth framework
    - @auth/core: OAuth provider definitions (Google)
    - resend: Email delivery for OTP verification
    - @oslojs/crypto: Secure random token generation
    - zod: Input validation for email/password
  </action>
  <verify>Check package.json includes all 5 new dependencies; `pnpm install` succeeds</verify>
  <done>All auth dependencies installed and lockfile updated</done>
</task>

<task type="auto">
  <name>Task 2: Configure Convex Auth with Password + Google providers</name>
  <files>v2/convex/auth.ts, v2/convex/auth.config.ts, v2/convex/ResendOTP.ts, v2/convex/ResendPasswordReset.ts, v2/convex/http.ts</files>
  <exploration>
    Use researcher agent to verify latest Convex Auth patterns from Context7:
    - Password provider configuration with verify/reset options
    - Google OAuth provider setup
    - HTTP routes for OAuth callbacks
  </exploration>
  <action>
    **Create v2/convex/auth.config.ts:**
    Export site URL for auth redirects. Use environment variable for flexibility.

    **Create v2/convex/ResendOTP.ts:**
    Resend-based OTP provider for email verification. Use @oslojs/crypto for 8-digit numeric codes.
    Template: "Your verification code is: {code}. This code expires in 10 minutes."
    From address: "PERM Tracker <noreply@permtracker.app>"

    **Create v2/convex/ResendPasswordReset.ts:**
    Resend-based OTP provider for password reset. Similar structure to ResendOTP.
    Template: "Your password reset code is: {code}. This code expires in 10 minutes."

    **Create v2/convex/auth.ts:**
    Configure convexAuth with:
    - Google provider (from @auth/core/providers/google)
    - Password provider with verify=ResendOTP, reset=ResendPasswordReset
    - Password validation: minimum 8 characters
    - Export: auth, signIn, signOut, store, isAuthenticated

    **Create v2/convex/http.ts:**
    HTTP router with auth.addHttpRoutes(http) for OAuth callbacks.

    IMPORTANT: Use patterns from 18-RESEARCH.md code examples. Don't hand-roll JWT validation or session management.
  </action>
  <verify>TypeScript compiles without errors: `cd v2 && npx tsc --noEmit`</verify>
  <done>All auth files created: auth.config.ts, auth.ts, ResendOTP.ts, ResendPasswordReset.ts, http.ts</done>
</task>

<task type="auto">
  <name>Task 3: Update Convex schema with authTables + userProfiles</name>
  <files>v2/convex/schema.ts</files>
  <action>
    Update schema.ts to:

    1. Import authTables from @convex-dev/auth/server

    2. Spread authTables into schema (includes users, authSessions, authAccounts, etc.)

    3. Extend the users table with minimal fields:
       - name: v.optional(v.string())
       - image: v.optional(v.string())
       - email: v.optional(v.string())
       - emailVerificationTime: v.optional(v.number())
       - isAnonymous: v.optional(v.boolean())
       - Add index: "email" on ["email"]

    4. Create userProfiles table (1:1 with users, stores app-specific data):
       - userId: v.id("users") - Reference to auth user
       - calendarSyncEnabled: v.boolean() - Default true (from v1)
       - notificationPreferences: v.optional(v.object({
           emailNotifications: v.boolean(),
           deadlineReminders: v.boolean(),
         }))
       - Add index: "userId" on ["userId"]

    5. Keep testItems table for now (will be removed in Phase 19)

    WHY separate userProfiles: Clerk migration only touches users table; all app preferences survive unchanged.
  </action>
  <verify>
    Run `cd v2 && npx convex dev` - schema should validate and deploy.
    Check Convex dashboard shows new tables: users, authSessions, authAccounts, authRefreshTokens, authVerificationCodes, userProfiles
  </verify>
  <done>Schema updated with auth tables and userProfiles table; Convex dev runs successfully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd v2 && pnpm install` succeeds with all dependencies
- [ ] `cd v2 && npx tsc --noEmit` compiles without TypeScript errors
- [ ] `cd v2 && npx convex dev` deploys schema successfully
- [ ] Convex dashboard shows auth tables created
</verification>

<success_criteria>
- All Convex Auth packages installed
- auth.ts exports signIn, signOut, store, isAuthenticated
- Password provider configured with email verification and password reset
- Google OAuth provider configured
- HTTP routes created for OAuth callbacks
- Schema includes authTables spread + userProfiles table
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-auth/18-01-SUMMARY.md`:

# Phase 18 Plan 01: Convex Auth Backend Setup Summary

**[One-liner: what was accomplished]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `v2/convex/auth.config.ts` - Site URL configuration
- `v2/convex/auth.ts` - Main auth configuration
- `v2/convex/ResendOTP.ts` - Email verification provider
- `v2/convex/ResendPasswordReset.ts` - Password reset provider
- `v2/convex/http.ts` - HTTP routes for OAuth
- `v2/convex/schema.ts` - Updated with auth tables

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 18-02-PLAN.md (Next.js integration - providers and middleware)
</output>
