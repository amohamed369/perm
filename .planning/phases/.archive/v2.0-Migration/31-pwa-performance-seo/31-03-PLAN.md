---
phase: 31-pwa-performance-seo
plan: 03
type: execute
---

<objective>
Optimize performance with bundle analysis, image optimization, and Lighthouse verification. Achieve 90+ scores across all categories.

Purpose: Ensure production-ready performance with sub-second loads and best-in-class Core Web Vitals.
Output: Optimized bundle, images with proper sizing, Lighthouse 90+ scores, Speed Insights integration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-pwa-performance-seo/31-RESEARCH.md
@.planning/phases/31-pwa-performance-seo/31-CONTEXT.md
@.planning/phases/31-pwa-performance-seo/31-01-SUMMARY.md
@.planning/phases/31-pwa-performance-seo/31-02-SUMMARY.md

**Prior decisions affecting this phase:**
- Lighthouse 90+ across all categories is the target
- Sub-second loads, instant-feeling interactions
- Focus on Core Web Vitals (LCP, INP, CLS)

**Codebase constraints:**
- Next.js 16.1.0 with App Router
- Uses next/font (already optimized)
- Framer Motion for animations
- Tailwind CSS v4
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bundle analyzer and identify optimization opportunities</name>
  <files>v2/package.json, v2/next.config.ts, v2/scripts/analyze-bundle.sh</files>
  <action>
    1. Install bundle analyzer:
       ```bash
       cd v2 && pnpm add -D @next/bundle-analyzer
       ```

    2. Update `next.config.ts` to include bundle analyzer:
       ```typescript
       import bundleAnalyzer from '@next/bundle-analyzer'

       const withBundleAnalyzer = bundleAnalyzer({
         enabled: process.env.ANALYZE === 'true',
       })

       // Wrap existing config
       export default withBundleAnalyzer(withSerwist({
         // existing config
       }))
       ```

    3. Add npm script to package.json:
       ```json
       "scripts": {
         "analyze": "ANALYZE=true pnpm build"
       }
       ```

    4. Run analysis and document findings:
       ```bash
       pnpm analyze
       ```

    5. Identify and fix common issues:
       - Large dependencies that could be code-split
       - Unused imports
       - Heavy libraries loaded on every page
       - Client components that could be server components

    6. Document bundle size baseline and any optimizations made
  </action>
  <verify>
    pnpm analyze generates bundle analysis report
    Bundle size documented in summary
    Any immediate optimizations applied
  </verify>
  <done>Bundle analyzer configured, initial analysis complete, optimizations documented</done>
</task>

<task type="auto">
  <name>Task 2: Optimize images and add priority loading hints</name>
  <files>v2/src/components/home/HeroSection.tsx, v2/src/app/(public)/page.tsx, v2/public/images/*</files>
  <exploration>
    Use Explore agent to find all Image components and identify which need priority loading.
    Find images that may be causing CLS (missing dimensions).
  </exploration>
  <action>
    1. Audit all `next/image` usage in the codebase:
       - Ensure all images have explicit width/height OR use fill with sized container
       - Add `priority` prop to above-the-fold images (hero, logo)
       - Verify proper alt text for accessibility

    2. Optimize hero image (`public/images/hero-showcase.png`):
       - Compress if over 200KB
       - Ensure proper dimensions set
       - Add priority loading

    3. Update HeroSection and other above-the-fold components:
       ```typescript
       <Image
         src="/images/hero-showcase.png"
         alt="PERM Tracker dashboard preview"
         width={1200}
         height={800}
         priority
         quality={85}
       />
       ```

    4. Check for and fix CLS issues:
       - Images without dimensions
       - Dynamic content that shifts layout
       - Font loading (already using next/font, should be fine)

    5. Optimize OG image if over 100KB:
       - Use JPEG at 80% quality
       - Resize to exactly 1200x630
  </action>
  <verify>
    All Image components have width/height or fill with sized container
    Above-the-fold images have priority prop
    No Lighthouse CLS warnings
    Hero image loads quickly
  </verify>
  <done>All images optimized with proper dimensions, priority loading for ATF images</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    PWA infrastructure, SEO optimization, and performance improvements for PERM Tracker v2.

    Completed:
    - Serwist service worker with strict NetworkOnly for HTML/JS
    - PWA manifest with app icons
    - Push notifications verified working
    - robots.txt and sitemap.xml
    - OpenGraph and Twitter card metadata
    - Page-level SEO for all routes
    - Bundle analyzer integration
    - Image optimization with priority loading
  </what-built>
  <how-to-verify>
    1. **PWA Installation Test:**
       - Run: `cd v2 && pnpm build && pnpm start`
       - Visit: http://localhost:3000
       - Check: Browser shows install prompt or "Add to Home Screen" option
       - Install the app and verify it opens in standalone mode

    2. **Push Notification Test:**
       - Go to Settings > Notifications
       - Enable push notifications
       - Verify browser permission prompt appears
       - After enabling, trigger a test notification from Convex dashboard

    3. **Lighthouse Audit:**
       - Open Chrome DevTools > Lighthouse
       - Run audit on http://localhost:3000 (home page)
       - Run audit on http://localhost:3000/dashboard (authenticated)
       - Verify scores:
         - Performance: 90+
         - Accessibility: 90+
         - Best Practices: 90+
         - SEO: 90+

    4. **SEO Verification:**
       - Check /robots.txt blocks authenticated routes
       - Check /sitemap.xml lists public pages
       - View page source for OpenGraph tags
       - Use Facebook/Twitter debugger for social preview

    5. **Offline Test:**
       - Install PWA
       - Go offline (DevTools > Network > Offline)
       - Verify offline page appears gracefully

    6. **Mobile Responsiveness:**
       - Test on mobile device or emulator
       - Verify app installs correctly on mobile
       - Check touch interactions are smooth
  </how-to-verify>
  <resume-signal>
    Type "approved" if all checks pass with Lighthouse 90+ scores.
    If any scores are below 90, describe which categories and what issues were found.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 4: Add Speed Insights and final polish</name>
  <files>v2/package.json, v2/src/app/layout.tsx</files>
  <action>
    1. Install Vercel Speed Insights (optional but recommended for production):
       ```bash
       pnpm add @vercel/speed-insights
       ```

    2. Add Speed Insights to root layout:
       ```typescript
       import { SpeedInsights } from '@vercel/speed-insights/next'

       export default function RootLayout({ children }) {
         return (
           <html>
             <body>
               {children}
               <SpeedInsights />
             </body>
           </html>
         )
       }
       ```

    3. Address any issues found during Lighthouse verification:
       - Performance: Optimize largest contentful paint elements
       - Accessibility: Fix any a11y issues found
       - Best Practices: Address security or deprecation warnings
       - SEO: Fix any missing meta tags or structured data issues

    4. Document final Lighthouse scores in summary

    5. Create performance baseline document for future reference
  </action>
  <verify>
    Speed Insights component added to layout
    Final Lighthouse scores documented
    All categories at 90+
  </verify>
  <done>Speed Insights integrated, all Lighthouse scores 90+, phase complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Bundle analyzer configured and initial analysis done
- [ ] All images have explicit dimensions
- [ ] Above-the-fold images have priority loading
- [ ] Human verification passed with Lighthouse 90+ scores
- [ ] Speed Insights added for production monitoring
- [ ] No CLS issues (CLS < 0.1)
- [ ] PWA installs correctly on mobile and desktop
- [ ] Push notifications work end-to-end
</verification>

<success_criteria>
- Lighthouse Performance: 90+
- Lighthouse Accessibility: 90+
- Lighthouse Best Practices: 90+
- Lighthouse SEO: 90+
- Bundle analyzer available for ongoing optimization
- Speed Insights integrated for real-user metrics
- Phase 31 complete and production-ready
</success_criteria>

<output>
After completion, create `.planning/phases/31-pwa-performance-seo/31-03-SUMMARY.md`:

# Phase 31 Plan 03: Performance & Polish Summary

**[Summary of optimizations and final scores]**

## Accomplishments
- Bundle analysis completed
- Images optimized with priority loading
- Lighthouse 90+ achieved across all categories
- Speed Insights integrated

## Performance Metrics
- Performance: [score]
- Accessibility: [score]
- Best Practices: [score]
- SEO: [score]

## Files Created/Modified
- [list files]

## Optimizations Made
- [list optimizations]

## Next Step
Phase 31 complete, ready for Phase 32 (Data Migration + Go-Live)
</output>
