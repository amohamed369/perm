---
phase: 31-pwa-performance-seo
plan: 01
type: execute
---

<objective>
Set up PWA infrastructure with Serwist service worker, manifest, and icons. Verify push notifications work end-to-end.

Purpose: Make the app installable as a PWA with proper offline shell and working push notifications.
Output: Installable PWA with service worker, manifest, PWA icons, and verified push notification flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-pwa-performance-seo/31-RESEARCH.md
@.planning/phases/31-pwa-performance-seo/31-CONTEXT.md

**Prior decisions affecting this phase:**
- NEVER cache HTML/JS in service worker (v1 Nov 2025 bug lesson)
- Keep push SW (`sw-push.js`) separate from main SW
- Convex has NO offline data persistence - offline shell only is feasible

**Existing push notification infrastructure (Phase 24):**
- `public/sw-push.js` - Push event handler (exists)
- `src/lib/pushSubscription.ts` - Client-side utilities (exists)
- `convex/pushNotifications.ts` and `convex/pushSubscriptions.ts` - Backend (exists)

**Icons referenced but missing:**
- `sw-push.js` references `/icon-192.png` and `/badge-72.png` (don't exist yet)

**Codebase constraints:**
- Next.js 16.1.0 App Router
- pnpm package manager
- Serwist 9.x for service worker (not next-pwa)
- Tailwind CSS v4 (CSS-first config)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Serwist and create PWA manifest with icons</name>
  <files>v2/package.json, v2/src/app/manifest.ts, v2/public/icon-192.png, v2/public/icon-512.png, v2/public/badge-72.png, v2/public/apple-touch-icon.png</files>
  <exploration>
    Use Explore agent to find the existing design token colors (especially lime green #a3e635 or #2ECC40) for icon generation.
    Check v2/public/ for any existing icon assets that could be used as base.
  </exploration>
  <action>
    1. Install dependencies:
       ```bash
       cd v2 && pnpm add @serwist/next && pnpm add -D serwist
       ```

    2. Create `src/app/manifest.ts` using Next.js built-in pattern:
       ```typescript
       import type { MetadataRoute } from 'next'

       export default function manifest(): MetadataRoute.Manifest {
         return {
           name: 'PERM Tracker',
           short_name: 'PERM Tracker',
           description: 'Free PERM case tracking software for immigration attorneys',
           start_url: '/dashboard',
           display: 'standalone',
           background_color: '#ffffff',
           theme_color: '#a3e635', // Lime green from design tokens
           icons: [
             { src: '/icon-192.png', sizes: '192x192', type: 'image/png', purpose: 'any maskable' },
             { src: '/icon-512.png', sizes: '512x512', type: 'image/png', purpose: 'any maskable' },
           ],
         }
       }
       ```

    3. Create PWA icons (192x192, 512x512, badge-72, apple-touch-icon):
       - Use lime green background (#a3e635) with white "PT" text or simple geometric design
       - Create as PNG files in v2/public/
       - Badge icon (72x72) for push notifications
       - Apple touch icon (180x180) for iOS

    4. Verify manifest is accessible at /manifest.webmanifest
  </action>
  <verify>
    curl http://localhost:3000/manifest.webmanifest returns valid JSON manifest
    ls v2/public/icon-*.png shows all icon files exist
  </verify>
  <done>manifest.ts created, all PWA icons (192, 512, 72 badge, apple-touch) exist in public/</done>
</task>

<task type="auto">
  <name>Task 2: Create main service worker with Serwist (strict NetworkOnly for HTML/JS)</name>
  <files>v2/src/app/sw.ts, v2/next.config.ts, v2/src/app/~offline/page.tsx</files>
  <action>
    1. Create `src/app/sw.ts` with strict caching rules per project requirements:
       ```typescript
       import { CacheFirst, NetworkOnly, Serwist } from 'serwist'

       declare const self: ServiceWorkerGlobalScope

       const serwist = new Serwist({
         precacheEntries: self.__SW_MANIFEST,
         skipWaiting: true,
         clientsClaim: true,
         navigationPreload: true,
         runtimeCaching: [
           // CRITICAL: Never cache HTML documents
           {
             matcher: ({ request }) => request.destination === 'document',
             handler: new NetworkOnly(),
           },
           // CRITICAL: Never cache JavaScript
           {
             matcher: ({ request }) => request.destination === 'script',
             handler: new NetworkOnly(),
           },
           // CRITICAL: Never cache stylesheets (avoid stale CSS)
           {
             matcher: ({ request }) => request.destination === 'style',
             handler: new NetworkOnly(),
           },
           // Safe: Cache images
           {
             matcher: ({ request }) => request.destination === 'image',
             handler: new CacheFirst({
               cacheName: 'images',
               plugins: [{ maxEntries: 100, maxAgeSeconds: 30 * 24 * 60 * 60 }],
             }),
           },
           // Safe: Cache fonts
           {
             matcher: ({ request }) => request.destination === 'font',
             handler: new CacheFirst({
               cacheName: 'fonts',
               plugins: [{ maxEntries: 20, maxAgeSeconds: 365 * 24 * 60 * 60 }],
             }),
           },
         ],
       })

       serwist.addEventListeners()
       ```

    2. Update `next.config.ts` to integrate Serwist:
       - Import and wrap config with `withSerwist` from `@serwist/next`
       - Disable in development: `disable: process.env.NODE_ENV === 'development'`
       - Set swSrc: 'src/app/sw.ts', swDest: 'public/sw.js'

    3. Create offline fallback page at `src/app/~offline/page.tsx`:
       - Simple page showing "You're offline" message
       - Instructions that data will load when back online
       - Match app styling (neobrutalist design)

    4. Add type declarations for Serwist if needed (serwist.d.ts)
  </action>
  <verify>
    pnpm build succeeds
    ls v2/public/sw.js confirms service worker is generated
    Service worker source uses NetworkOnly for documents and scripts
  </verify>
  <done>Main service worker created with strict NetworkOnly for HTML/JS/CSS, offline page exists</done>
</task>

<task type="auto">
  <name>Task 3: Add SW registration and verify push notifications end-to-end</name>
  <files>v2/src/components/pwa/ServiceWorkerRegistration.tsx, v2/src/components/pwa/InstallPrompt.tsx, v2/src/app/(authenticated)/layout.tsx</files>
  <exploration>
    Use Explore agent to find where push notification subscription is triggered (NotificationPreferencesSection).
    Verify VAPID keys are configured in .env.local and Convex environment.
  </exploration>
  <action>
    1. Create `src/components/pwa/ServiceWorkerRegistration.tsx`:
       ```typescript
       'use client'
       import { useEffect } from 'react'

       export function ServiceWorkerRegistration() {
         useEffect(() => {
           if (typeof window !== 'undefined' && 'serviceWorker' in navigator) {
             // Register main service worker for caching
             navigator.serviceWorker
               .register('/sw.js')
               .then((reg) => console.log('SW registered:', reg.scope))
               .catch((err) => console.error('SW registration failed:', err))
           }
         }, [])

         return null
       }
       ```

    2. Create `src/components/pwa/InstallPrompt.tsx` (non-intrusive):
       - Hook to capture `beforeinstallprompt` event
       - Small banner or button in settings to trigger install
       - Don't show if already installed (display-mode: standalone)

    3. Add SW registration to authenticated layout:
       - Import and render `<ServiceWorkerRegistration />` in `(authenticated)/layout.tsx`

    4. Verify push notification flow works end-to-end:
       a. Check VAPID keys exist in environment
       b. Ensure icons referenced in sw-push.js exist (created in Task 1)
       c. Test subscription flow in NotificationPreferencesSection
       d. Verify push notification delivery from Convex backend

    5. Create `src/components/pwa/index.ts` barrel export
  </action>
  <verify>
    Build succeeds
    In browser DevTools > Application > Service Workers, both sw.js and sw-push.js are registered
    Push subscription can be created via NotificationPreferencesSection toggle
    Test push notification can be sent and received (manual test or Convex dashboard)
  </verify>
  <done>SW registration component added, push notifications verified working end-to-end, install prompt available</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds without errors
- [ ] manifest.webmanifest accessible and valid JSON
- [ ] All PWA icons exist (192, 512, 72 badge, apple-touch-icon)
- [ ] Main service worker uses NetworkOnly for HTML/JS/CSS
- [ ] sw.js generated in public/ during build
- [ ] Push notifications work: subscribe â†’ receive test notification
- [ ] Offline page displays when network unavailable
</verification>

<success_criteria>
- Serwist installed and configured
- manifest.ts with proper app metadata
- All required PWA icons created
- Main service worker with strict caching policy (NetworkOnly for HTML/JS/CSS)
- SW registration in authenticated layout
- Push notifications verified working end-to-end
- Offline fallback page exists
</success_criteria>

<output>
After completion, create `.planning/phases/31-pwa-performance-seo/31-01-SUMMARY.md`
</output>
