---
phase: 23-case-detail-timeline
plan: 03
type: execute
---

<objective>
Build Timeline page core with full timeline visualization, milestones, and range bars.

Purpose: Create the portfolio overview showing all selected cases on a horizontal timeline.
Output: `/timeline` page with time range selector, milestone rendering, and responsive layout.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-case-detail-timeline/23-CONTEXT.md
@.planning/phases/23-case-detail-timeline/23-01-SUMMARY.md
@.planning/phases/23-case-detail-timeline/23-02-SUMMARY.md
@.planning/FRONTEND_DESIGN_SKILL.md
@perm_flow.md
@v2/src/lib/timeline/milestones.ts
@v2/src/lib/timeline/types.ts

**REQUIRED READING (for all subagents):**
- .planning/FRONTEND_DESIGN_SKILL.md
- .planning/phases/17-design-system/design3.md
- perm_flow.md (source of truth for business logic)

**CODE QUALITY STANDARDS:**
- Clean, organized, minimal, abstract-able, scalable
- Maintainable, readable, DRY (global fixes, no repetition)
- Follow existing v2 patterns

**COMPLIANCE:**
- All v1 features must be preserved
- Follow perm_flow.md for all business logic

**From v1 timeline to preserve:**
- Horizontal layout with sticky left sidebar (250px desktop, 180px tablet, 140px mobile)
- Month headers across top
- Case rows with employer name + position title in sidebar
- 16 milestone types as colored dots
- Job order range bars
- Current month highlighted
- Legend with 4 stage colors

**Prior plan completions:**
- 23-01: Data layer, Convex functions, milestone utilities
- 23-02: Case detail page with inline timeline
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create timeline page route and layout</name>
  <files>
    v2/src/app/(authenticated)/timeline/page.tsx,
    v2/src/app/(authenticated)/timeline/loading.tsx
  </files>
  <exploration>
    Use Explore agent to:
    - Understand v1 timeline layout (frontend/timeline.html lines 313-374)
    - Find existing page layout patterns in v2
    - Check for Select component from ui/
  </exploration>
  <action>
Create timeline page with core layout:

**page.tsx:**
```typescript
"use client";

import { useQuery } from "convex/react";
import { api } from "@/convex/_generated/api";
import { useState } from "react";
import { TimelineGrid } from "@/components/timeline/TimelineGrid";
import { TimelineControls } from "@/components/timeline/TimelineControls";
import { TimelineLegend } from "@/components/timeline/TimelineLegend";

export default function TimelinePage() {
  const preferences = useQuery(api.timeline.getPreferences);
  const timeRange = preferences?.timeRange ?? 6;
  const cases = useQuery(api.timeline.getCasesForTimeline, { timeRange });

  // ... loading/empty states

  return (
    <div className="flex flex-col h-full">
      {/* Header with controls */}
      <TimelineControls
        timeRange={timeRange}
        onTimeRangeChange={handleTimeRangeChange}
        onOpenCaseSelector={openCaseSelector}
        caseCount={cases.length}
      />

      {/* Main timeline grid */}
      <div className="flex-1 overflow-auto">
        <TimelineGrid
          cases={cases}
          timeRange={timeRange}
        />
      </div>

      {/* Legend */}
      <TimelineLegend />
    </div>
  );
}
```

Layout considerations:
- Full viewport height (flex h-full)
- Fixed header with controls
- Scrollable timeline grid
- Fixed footer legend

**loading.tsx:**
- Skeleton header with controls
- Skeleton grid rows
- Skeleton legend
  </action>
  <verify>pnpm tsc --noEmit, page renders structure</verify>
  <done>Timeline page route created with layout structure</done>
</task>

<task type="auto">
  <name>Task 2: Create TimelineGrid component</name>
  <files>
    v2/src/components/timeline/TimelineGrid.tsx,
    v2/src/components/timeline/TimelineRow.tsx,
    v2/src/components/timeline/TimelineHeader.tsx,
    v2/src/components/timeline/index.ts
  </files>
  <action>
Create the core timeline visualization:

**TimelineGrid.tsx:**
- Container with overflow handling
- Fixed sticky left sidebar (case labels)
- Scrollable right section (timeline bars)
- Month headers row at top

Props:
```typescript
interface TimelineGridProps {
  cases: CaseForTimeline[];
  timeRange: 3 | 6 | 12 | 24;
}
```

Date range calculation:
```typescript
const today = new Date();
const startDate = subMonths(startOfMonth(today), timeRange / 2);
const endDate = addMonths(startDate, timeRange);
const months = eachMonthOfInterval({ start: startDate, end: endDate });
```

**TimelineHeader.tsx:**
- Row of month labels
- Current month highlighted with subtle background
- Format: "Jan", "Feb", etc.

**TimelineRow.tsx:**
- Left: Sticky sidebar with employer name + position title (truncated)
- Right: Timeline bar with milestones and range bars
- Hover effect on row

Positioning logic:
```typescript
function calculatePosition(date: Date, startDate: Date, endDate: Date): number | null {
  if (date < startDate || date > endDate) return null;
  const totalMs = endDate.getTime() - startDate.getTime();
  const dateMs = date.getTime() - startDate.getTime();
  return (dateMs / totalMs) * 100;
}
```

Styling (from v1 to preserve):
- Sidebar widths: 250px (desktop), 180px (tablet ≤768px), 140px (mobile ≤480px)
- Row hover: subtle Forest Green tint
- 3px border on sidebar
  </action>
  <verify>pnpm tsc --noEmit, grid renders with test cases</verify>
  <done>TimelineGrid with rows and header rendering</done>
</task>

<task type="auto">
  <name>Task 3: Create timeline milestones and range bars</name>
  <files>
    v2/src/components/timeline/TimelineMilestoneMarker.tsx,
    v2/src/components/timeline/TimelineRangeBar.tsx,
    v2/src/components/timeline/TimelineTooltip.tsx
  </files>
  <exploration>
    Use Explore agent to:
    - Check for existing Tooltip component in ui/
    - Find Radix Tooltip usage patterns
    - Review v1 tippy.js implementation for styling
  </exploration>
  <action>
Create milestone and range bar visualizations:

**TimelineMilestoneMarker.tsx:**
```typescript
interface TimelineMilestoneMarkerProps {
  milestone: Milestone;
  position: number; // 0-100 percentage
  caseId: string;
  onNavigate?: (caseId: string) => void;
}
```
- 12px circle with 3px black border
- Background color from milestone.color
- Absolute positioned at percentage
- Hover: scale(1.5) transform with transition
- Click: navigate to case detail page
- Tooltip on hover (label + date)

**TimelineRangeBar.tsx:**
```typescript
interface TimelineRangeBarProps {
  rangeBar: RangeBar;
  startPosition: number;
  endPosition: number;
}
```
- Semi-transparent bar (opacity 0.3)
- Height: 8px, vertically centered
- Color from rangeBar.color
- Rounded ends (2px border-radius)

**TimelineTooltip.tsx:**
- Neobrutalist styled tooltip
- Background: var(--bg-primary)
- Border: 3px solid black
- Box shadow: 4px 4px 0 rgba(0,0,0,0.2)
- Content: Label on first line, formatted date on second
- Use Radix Tooltip or custom implementation

If Radix Tooltip available, style it to match neobrutalist aesthetic.
If not, create custom positioned tooltip with portal.
  </action>
  <verify>Milestones render with correct colors and positions, tooltips appear on hover</verify>
  <done>Milestone markers and range bars with tooltips</done>
</task>

<task type="auto">
  <name>Task 4: Create TimelineControls and TimelineLegend</name>
  <files>
    v2/src/components/timeline/TimelineControls.tsx,
    v2/src/components/timeline/TimelineLegend.tsx
  </files>
  <action>
Create control bar and legend:

**TimelineControls.tsx:**
```typescript
interface TimelineControlsProps {
  timeRange: 3 | 6 | 12 | 24;
  onTimeRangeChange: (range: 3 | 6 | 12 | 24) => void;
  onOpenCaseSelector: () => void;
  caseCount: number;
}
```
- Title "Timeline" on left
- Time range select dropdown (3, 6, 12, 24 months)
- "Select Cases" button with count badge
- Neobrutalist styling (hard shadow on controls)

Use existing Select component from ui/ if available.
Otherwise, create styled native select.

**TimelineLegend.tsx:**
- Horizontal flex layout
- 4 colored bars with labels:
  - PWD (blue #0066FF)
  - Recruitment (purple #9333ea)
  - ETA 9089 (orange #ea580c)
  - I-140 (green #16a34a)
- Each bar: 24px wide, 8px tall, 3px border, slight gradient
- Mobile: wrap to 2x2 grid

From v1 styling:
```css
.timeline-legend-bar--pwd {
  background: linear-gradient(135deg, #0066FF, #3b82f6);
}
```

Fixed position at bottom or sticky footer.
  </action>
  <verify>Controls change time range, legend displays correctly</verify>
  <done>Timeline controls and legend complete</done>
</task>

<task type="auto">
  <name>Task 5: Add timeline page tests</name>
  <files>
    v2/src/components/timeline/__tests__/TimelineGrid.test.tsx,
    v2/src/components/timeline/__tests__/TimelineMilestoneMarker.test.tsx,
    v2/src/app/(authenticated)/timeline/__tests__/page.test.tsx
  </files>
  <action>
Write tests:

**TimelineGrid.test.tsx:**
- Renders correct number of rows for cases
- Shows month headers for time range
- Highlights current month
- Positions milestones correctly
- Handles empty cases array

**TimelineMilestoneMarker.test.tsx:**
- Renders at correct position percentage
- Uses correct color for stage
- Shows tooltip on hover
- Calls onNavigate on click
- Scales on hover

**page.test.tsx:**
- Renders loading state
- Renders empty state when no cases
- Renders timeline with cases
- Time range dropdown changes view
- "Select Cases" button opens modal (placeholder)

Use vitest + testing-library patterns.
  </action>
  <verify>pnpm test -- timeline passes</verify>
  <done>Timeline core components tested</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm tsc --noEmit` passes
- [ ] `pnpm test -- timeline` passes
- [ ] Timeline page renders at /timeline
- [ ] Cases display in horizontal rows
- [ ] Milestones appear at correct positions with colors
- [ ] Range bars display for job order periods
- [ ] Time range selector changes view
- [ ] Legend shows 4 stage colors
</verification>

<success_criteria>
- Timeline page fully functional at /timeline
- Horizontal layout with sticky sidebar
- 16 milestone types rendering with correct colors
- Calculated milestones (Ready to File, Recruitment Expires)
- Range bars for job order periods
- Time range selector (3/6/12/24 months)
- Legend with stage colors
- Responsive breakpoints for sidebar widths
</success_criteria>

<output>
After completion, create `.planning/phases/23-case-detail-timeline/23-03-SUMMARY.md`

Include:
- Accomplishments
- Files Created/Modified
- Decisions Made
- Issues Encountered
- Next Step: Ready for 23-04-PLAN.md (Case Selection Modal)
</output>
