---
phase: 23-case-detail-timeline
plan: 01
type: execute
---

<objective>
Create timeline data layer with Convex schema and queries for case detail and timeline pages.

Purpose: Establish data foundation for case detail and timeline features with real-time subscriptions.
Output: timelinePreferences table, timeline queries, milestone calculation utilities.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-case-detail-timeline/23-CONTEXT.md
@v2/convex/schema.ts
@v2/convex/cases.ts
@perm_flow.md

**Prior decisions affecting this phase:**
- Convex for real-time subscriptions (Phase 15)
- Two-tier status system: caseStatus + progressStatus (Phase 19)
- Stage colors from v1: PWD blue, Recruitment purple, ETA orange, I-140 green

**From v1 timeline (must preserve):**
- 16 milestone types with specific colors
- Calculated milestones: "Ready to File" (30 days after recruitment), "Recruitment Expires" (180 days from first step)
- Active RFI/RFE deadline filtering
- localStorage â†’ Convex for persistence (real-time sync)

**Codebase constraints:**
- TypeScript strict mode
- All dates as ISO strings (YYYY-MM-DD)
- BigInt for numeric values in Convex
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add timelinePreferences table to Convex schema</name>
  <files>v2/convex/schema.ts</files>
  <action>
Add timelinePreferences table after userCaseOrder:

```typescript
// Timeline display preferences
timelinePreferences: defineTable({
  userId: v.id("users"),
  // Selected case IDs (null = all active cases, empty array = none)
  selectedCaseIds: v.optional(v.array(v.id("cases"))),
  // Time range in months (3, 6, 12, or 24)
  timeRange: v.union(
    v.literal(3),
    v.literal(6),
    v.literal(12),
    v.literal(24)
  ),
  // Timestamps
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_user_id", ["userId"]),
```

Default timeRange should be 6 months. selectedCaseIds undefined means "all active cases".
  </action>
  <verify>npx convex dev --once completes without schema errors</verify>
  <done>timelinePreferences table defined with userId index</done>
</task>

<task type="auto">
  <name>Task 2: Create timeline Convex functions</name>
  <files>v2/convex/timeline.ts</files>
  <action>
Create new file with:

1. **getPreferences** query - Get user's timeline preferences (or defaults)
2. **updatePreferences** mutation - Update selectedCaseIds and/or timeRange
3. **addCaseToTimeline** mutation - Add single case to selected list
4. **removeCaseFromTimeline** mutation - Remove single case from selected list
5. **getCasesForTimeline** query - Get cases with all timeline-relevant data

For getCasesForTimeline:
- Accept timeRange argument (3/6/12/24)
- Return cases with: id, employerName, positionTitle, caseStatus, all date fields, rfiEntries, rfeEntries
- Filter to only non-deleted cases
- If selectedCaseIds is set, filter to those; if null/undefined, return all active (non-closed status)

Include proper auth checks using getCurrentUserId from ./lib/auth.
  </action>
  <verify>npx convex dev --once deploys functions, TypeScript compiles</verify>
  <done>Timeline functions created and deployed</done>
</task>

<task type="auto">
  <name>Task 3: Create milestone calculation utilities</name>
  <files>v2/src/lib/timeline/milestones.ts, v2/src/lib/timeline/types.ts</files>
  <action>
Create timeline utilities:

**types.ts:**
```typescript
export interface Milestone {
  field: string;           // e.g., "pwdFilingDate", "readyToFile"
  label: string;           // e.g., "PWD Filed", "Ready to File"
  date: string;            // ISO date
  stage: "pwd" | "recruitment" | "eta9089" | "i140" | "calculated" | "rfi" | "rfe";
  color: string;           // Hex color
  isCalculated: boolean;   // true for Ready to File, Recruitment Expires
  order?: number;          // For RFI/RFE numbering
}

export interface RangeBar {
  field: string;           // e.g., "jobOrder"
  label: string;
  startDate: string;
  endDate: string;
  stage: "recruitment";
  color: string;
}

export const STAGE_COLORS = {
  pwd: "#0066FF",
  recruitment: "#9333ea",
  eta9089: "#ea580c",
  i140: "#16a34a",
  calculated: "#22c55e",
  rfi: "#dc2626",
  rfe: "#dc2626",
} as const;

export const MILESTONE_CONFIG = [
  { field: "pwdFilingDate", label: "PWD Filed", stage: "pwd" },
  { field: "pwdDeterminationDate", label: "PWD Determined", stage: "pwd" },
  { field: "pwdExpirationDate", label: "PWD Expires", stage: "pwd" },
  { field: "sundayAdFirstDate", label: "1st Sunday Ad", stage: "recruitment" },
  { field: "sundayAdSecondDate", label: "2nd Sunday Ad", stage: "recruitment" },
  { field: "jobOrderStartDate", label: "Job Order Start", stage: "recruitment" },
  { field: "jobOrderEndDate", label: "Job Order End", stage: "recruitment" },
  { field: "eta9089FilingDate", label: "ETA 9089 Filed", stage: "eta9089" },
  { field: "eta9089CertificationDate", label: "ETA 9089 Certified", stage: "eta9089" },
  { field: "eta9089ExpirationDate", label: "ETA 9089 Expires", stage: "eta9089" },
  { field: "i140FilingDate", label: "I-140 Filed", stage: "i140" },
  { field: "i140ApprovalDate", label: "I-140 Approved", stage: "i140" },
] as const;
```

**milestones.ts:**
```typescript
import { addDays, parseISO, differenceInDays } from "date-fns";
import { MILESTONE_CONFIG, STAGE_COLORS, type Milestone, type RangeBar } from "./types";

export function extractMilestones(caseData: CaseWithDates): Milestone[] {
  const milestones: Milestone[] = [];

  // Static milestones from case data
  for (const config of MILESTONE_CONFIG) {
    const date = caseData[config.field as keyof CaseWithDates];
    if (date) {
      milestones.push({
        field: config.field,
        label: config.label,
        date: date as string,
        stage: config.stage,
        color: STAGE_COLORS[config.stage],
        isCalculated: false,
      });
    }
  }

  // Calculated: Ready to File (30 days after recruitment ends)
  // Only if ETA 9089 NOT yet filed
  if (!caseData.eta9089FilingDate) {
    const readyToFileDate = calculateReadyToFileDate(caseData);
    if (readyToFileDate) {
      milestones.push({
        field: "readyToFile",
        label: "Ready to File",
        date: readyToFileDate,
        stage: "calculated",
        color: STAGE_COLORS.calculated,
        isCalculated: true,
      });
    }
  }

  // Calculated: Recruitment Expires (180 days from first recruitment step)
  // Only if ETA 9089 NOT yet filed
  if (!caseData.eta9089FilingDate) {
    const recruitmentExpiresDate = calculateRecruitmentExpiresDate(caseData);
    if (recruitmentExpiresDate) {
      milestones.push({
        field: "recruitmentExpires",
        label: "Recruitment Expires",
        date: recruitmentExpiresDate,
        stage: "rfi", // Red color for urgency
        color: "#dc2626",
        isCalculated: true,
      });
    }
  }

  // RFI deadlines (active only)
  const rfiDeadlines = extractRfiDeadlines(caseData.rfiEntries ?? []);
  milestones.push(...rfiDeadlines);

  // RFE deadlines (active only)
  const rfeDeadlines = extractRfeDeadlines(caseData.rfeEntries ?? []);
  milestones.push(...rfeDeadlines);

  return milestones;
}

export function extractRangeBars(caseData: CaseWithDates): RangeBar[] {
  const ranges: RangeBar[] = [];

  if (caseData.jobOrderStartDate && caseData.jobOrderEndDate) {
    ranges.push({
      field: "jobOrder",
      label: "Job Order Period",
      startDate: caseData.jobOrderStartDate,
      endDate: caseData.jobOrderEndDate,
      stage: "recruitment",
      color: STAGE_COLORS.recruitment,
    });
  }

  return ranges;
}

function calculateReadyToFileDate(caseData: CaseWithDates): string | null {
  // Ready to file = 30 days after recruitment ends
  // Recruitment ends = latest of: 2nd Sunday ad OR job order end
  const dates: Date[] = [];
  if (caseData.sundayAdSecondDate) dates.push(parseISO(caseData.sundayAdSecondDate));
  if (caseData.jobOrderEndDate) dates.push(parseISO(caseData.jobOrderEndDate));

  if (dates.length === 0) return null;

  const latestRecruitmentEnd = dates.reduce((a, b) => a > b ? a : b);
  const readyToFile = addDays(latestRecruitmentEnd, 30);
  return readyToFile.toISOString().split("T")[0];
}

function calculateRecruitmentExpiresDate(caseData: CaseWithDates): string | null {
  // Recruitment expires = 180 days from FIRST recruitment step
  // First step = earliest of: 1st Sunday ad OR job order start
  const dates: Date[] = [];
  if (caseData.sundayAdFirstDate) dates.push(parseISO(caseData.sundayAdFirstDate));
  if (caseData.jobOrderStartDate) dates.push(parseISO(caseData.jobOrderStartDate));

  if (dates.length === 0) return null;

  const earliestRecruitmentStart = dates.reduce((a, b) => a < b ? a : b);
  const recruitmentExpires = addDays(earliestRecruitmentStart, 180);
  return recruitmentExpires.toISOString().split("T")[0];
}

function extractRfiDeadlines(entries: RfiEntry[]): Milestone[] {
  const active = entries.filter(e => !e.responseSubmittedDate && e.responseDueDate);
  return active.map((entry, index) => ({
    field: `rfi-${entry.id}`,
    label: active.length > 1 ? `RFI Due #${index + 1}` : "RFI Due",
    date: entry.responseDueDate,
    stage: "rfi" as const,
    color: STAGE_COLORS.rfi,
    isCalculated: false,
    order: index + 1,
  }));
}

function extractRfeDeadlines(entries: RfeEntry[]): Milestone[] {
  const active = entries.filter(e => !e.responseSubmittedDate && e.responseDueDate);
  return active.map((entry, index) => ({
    field: `rfe-${entry.id}`,
    label: active.length > 1 ? `RFE Due #${index + 1}` : "RFE Due",
    date: entry.responseDueDate,
    stage: "rfe" as const,
    color: STAGE_COLORS.rfe,
    isCalculated: false,
    order: index + 1,
  }));
}
```

Add proper TypeScript types for CaseWithDates, RfiEntry, RfeEntry based on schema.
  </action>
  <verify>npx tsc --noEmit passes, no type errors</verify>
  <done>Milestone extraction with all 16 types + calculated milestones working</done>
</task>

<task type="auto">
  <name>Task 4: Add tests for timeline functions</name>
  <files>v2/convex/timeline.test.ts, v2/src/lib/timeline/__tests__/milestones.test.ts</files>
  <action>
Write comprehensive tests:

**timeline.test.ts** (Convex function tests):
- getPreferences returns defaults for new user
- updatePreferences saves timeRange
- updatePreferences saves selectedCaseIds
- addCaseToTimeline adds case to empty list
- addCaseToTimeline converts undefined to array with case
- removeCaseFromTimeline removes case from list
- getCasesForTimeline returns all active cases when no selection
- getCasesForTimeline filters to selected cases
- getCasesForTimeline excludes deleted cases

**milestones.test.ts** (Utility tests):
- extractMilestones returns static milestones from case data
- extractMilestones calculates Ready to File date correctly
- extractMilestones calculates Recruitment Expires date correctly
- extractMilestones skips calculated milestones when ETA 9089 filed
- extractMilestones extracts active RFI deadlines
- extractMilestones extracts active RFE deadlines
- extractMilestones numbers multiple RFIs/RFEs
- extractRangeBars returns job order period
- calculateReadyToFileDate returns null with no recruitment data

Use vitest patterns established in project.
  </action>
  <verify>pnpm test -- timeline passes all tests</verify>
  <done>Timeline data layer fully tested</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` deploys schema and functions
- [ ] `pnpm test -- timeline` passes all tests
- [ ] `pnpm tsc --noEmit` has no type errors
- [ ] Timeline preferences can be saved and retrieved
</verification>

<success_criteria>
- timelinePreferences table created in Convex schema
- Timeline Convex functions (getPreferences, updatePreferences, addCase, removeCase, getCases)
- Milestone extraction utilities with all 16 types + 2 calculated
- RFI/RFE deadline extraction
- All tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/23-case-detail-timeline/23-01-SUMMARY.md`

Include:
- Accomplishments
- Files Created/Modified
- Decisions Made
- Issues Encountered
- Next Step: Ready for 23-02-PLAN.md (Case Detail Page)
</output>
