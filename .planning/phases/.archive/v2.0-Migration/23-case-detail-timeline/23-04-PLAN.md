---
phase: 23-case-detail-timeline
plan: 04
type: execute
---

<objective>
Build case selection modal for timeline with search, filter, sort, and bulk actions.

Purpose: Allow users to customize which cases appear on their timeline.
Output: Full-featured case selection modal with real-time persistence to Convex.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-case-detail-timeline/23-CONTEXT.md
@.planning/phases/23-case-detail-timeline/23-01-SUMMARY.md
@.planning/phases/23-case-detail-timeline/23-02-SUMMARY.md
@.planning/phases/23-case-detail-timeline/23-03-SUMMARY.md
@.planning/FRONTEND_DESIGN_SKILL.md
@perm_flow.md
@v2/convex/timeline.ts

**REQUIRED READING (for all subagents):**
- .planning/FRONTEND_DESIGN_SKILL.md
- perm_flow.md (source of truth for business logic)

**From v1 timeline modal (must preserve):**
- Search by employer name and position title
- Sort: Name / Status / Date
- Filter: All / Active / PWD / Recruitment / ETA 9089 / I-140 / Complete
- Bulk actions: Select All, Deselect All, Active Only
- Individual checkbox selection
- "Showing X of Y cases" count
- Debounced search (200ms)
- Completed statuses: Complete, Closed, Withdrawn, Denied

**Prior plan completions:**
- 23-01: Data layer with updatePreferences mutation
- 23-02: Case detail page
- 23-03: Timeline page core with grid and controls
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CaseSelectionModal component</name>
  <files>
    v2/src/components/timeline/CaseSelectionModal.tsx,
    v2/src/components/timeline/CaseSelectionItem.tsx
  </files>
  <exploration>
    Use Explore agent to:
    - Find existing Modal/Dialog component in ui/
    - Check v1 modal implementation (frontend/timeline.html lines 380-433)
    - Find existing Input/Select components
  </exploration>
  <action>
Create case selection modal:

**CaseSelectionModal.tsx:**
```typescript
interface CaseSelectionModalProps {
  isOpen: boolean;
  onClose: () => void;
  allCases: CaseForSelection[];
  selectedIds: Set<string>;
  onSelectionChange: (ids: string[]) => void;
}

interface CaseForSelection {
  _id: string;
  employerName: string;
  positionTitle: string;
  caseStatus: CaseStatus;
  createdAt: number;
}
```

Layout:
1. **Header:**
   - Title: "Select Cases for Timeline"
   - Subtitle: "Choose which cases to display on your timeline"
   - Close button (X)

2. **Controls row:**
   - Search input (debounced 200ms)
   - Sort dropdown: Name (A-Z) / Status / Date (newest first)
   - Filter dropdown: All / Active / PWD / Recruitment / ETA 9089 / I-140 / Complete

3. **Bulk actions row:**
   - Select All button
   - Deselect All button
   - Active Only button
   - "Showing X of Y cases" text

4. **Case list:**
   - Scrollable container (max-height with overflow)
   - Each item: checkbox + employer name + position + status badge
   - Empty state if no matches

5. **Footer:**
   - Cancel button
   - Save Changes button (primary)

Use existing Dialog from ui/ if available (Radix Dialog).
Apply neobrutalist styling: hard shadows, thick borders.

**CaseSelectionItem.tsx:**
```typescript
interface CaseSelectionItemProps {
  case: CaseForSelection;
  isSelected: boolean;
  onToggle: (id: string) => void;
}
```
- Checkbox on left
- Employer name + position title (truncated if long)
- Status badge on right
- Hover effect: background lightening
  </action>
  <verify>Modal opens and displays cases correctly</verify>
  <done>Case selection modal with all controls</done>
</task>

<task type="auto">
  <name>Task 2: Implement search, filter, and sort logic</name>
  <files>v2/src/components/timeline/useCaseSelection.ts</files>
  <action>
Create custom hook for case selection logic:

```typescript
interface UseCaseSelectionOptions {
  cases: CaseForSelection[];
  initialSelectedIds: string[];
}

interface UseCaseSelectionReturn {
  // Filtered/sorted cases
  displayedCases: CaseForSelection[];
  filteredCount: number;
  totalCount: number;

  // Search
  searchQuery: string;
  setSearchQuery: (query: string) => void;

  // Sort
  sortBy: "name" | "status" | "date";
  setSortBy: (sort: "name" | "status" | "date") => void;

  // Filter
  filterStatus: "all" | "active" | CaseStatus;
  setFilterStatus: (filter: "all" | "active" | CaseStatus) => void;

  // Selection
  selectedIds: Set<string>;
  toggleCase: (id: string) => void;
  selectAll: () => void;
  deselectAll: () => void;
  selectActiveOnly: () => void;

  // Dirty state
  hasChanges: boolean;
  getSelectedArray: () => string[];
}
```

Implementation details:
- **Search:** Case-insensitive match on employerName OR positionTitle
- **Debounce:** 200ms delay on search (use useDeferredValue or custom debounce)
- **Sort:**
  - Name: alphabetical by employerName
  - Status: order by caseStatus progression (pwd < recruitment < eta9089 < i140 < closed)
  - Date: by createdAt descending
- **Filter:**
  - All: no filter
  - Active: exclude ['closed'] (includes all other statuses)
  - PWD/Recruitment/ETA9089/I140: match specific caseStatus
  - Complete: only 'closed' status

- **Active Only:** Select all cases where caseStatus !== 'closed'
- **hasChanges:** Compare current selection to initial
  </action>
  <verify>Hook correctly filters, sorts, and tracks selection</verify>
  <done>Case selection logic implemented and tested</done>
</task>

<task type="auto">
  <name>Task 3: Integrate modal with timeline page</name>
  <files>
    v2/src/app/(authenticated)/timeline/page.tsx,
    v2/src/components/timeline/TimelineControls.tsx
  </files>
  <action>
Connect modal to timeline page:

**timeline/page.tsx updates:**
1. Add state for modal open/close
2. Fetch all cases for selection (separate query)
3. Pass selected IDs from preferences
4. Handle save: call updatePreferences mutation
5. Refresh timeline on selection change

```typescript
const [isModalOpen, setIsModalOpen] = useState(false);
const allCases = useQuery(api.cases.list, {});
const updatePrefs = useMutation(api.timeline.updatePreferences);

const handleSaveSelection = async (selectedIds: string[]) => {
  await updatePrefs({
    selectedCaseIds: selectedIds.length === 0 ? undefined : selectedIds,
  });
  setIsModalOpen(false);
};
```

**TimelineControls updates:**
- "Select Cases" button opens modal
- Show badge with selected count vs total

Behavior:
- Saving empty selection = show all active (selectedCaseIds becomes undefined)
- Saving specific selection = show only those cases
- Changes persist in Convex (real-time sync across devices)
  </action>
  <verify>Selection persists after page refresh, syncs to Convex</verify>
  <done>Modal integrated with timeline page and persistence</done>
</task>

<task type="auto">
  <name>Task 4: Add Add/Remove from Timeline buttons to case detail</name>
  <files>v2/src/app/(authenticated)/cases/[id]/page.tsx</files>
  <exploration>
    Use Explore agent to:
    - Find existing button patterns in case detail
    - Check how v1 implemented Add/Remove (frontend/case-detail.html lines 153-161)
  </exploration>
  <action>
Add timeline toggle button to case detail header:

Logic (matching v1):
```typescript
const preferences = useQuery(api.timeline.getPreferences);
const addToTimeline = useMutation(api.timeline.addCaseToTimeline);
const removeFromTimeline = useMutation(api.timeline.removeCaseFromTimeline);

// If no custom selection (selectedCaseIds undefined), show based on status
// Active cases are "on" timeline by default, closed are "off"
const isOnTimeline = useMemo(() => {
  if (preferences?.selectedCaseIds === undefined) {
    return caseData.caseStatus !== 'closed';
  }
  return preferences.selectedCaseIds.includes(caseId);
}, [preferences, caseData.caseStatus, caseId]);
```

Button display:
- If on timeline: "Remove from Timeline" button (orange/warning color)
- If not on timeline: "Add to Timeline" button (blue/primary color)

Actions:
- Add: Call addCaseToTimeline mutation
- Remove: Show confirmation toast, call removeCaseFromTimeline mutation

Confirmation for remove:
- Simple toast: "Case removed from timeline"
- Or: "Remove this case from your timeline?" confirm dialog

Position: In header actions area, next to Edit/Delete/Archive
  </action>
  <verify>Button state reflects timeline inclusion, mutations work</verify>
  <done>Add/Remove timeline buttons on case detail</done>
</task>

<task type="auto">
  <name>Task 5: Add tests for case selection</name>
  <files>
    v2/src/components/timeline/__tests__/CaseSelectionModal.test.tsx,
    v2/src/components/timeline/__tests__/useCaseSelection.test.ts
  </files>
  <action>
Write tests:

**useCaseSelection.test.ts:**
- Filters cases by search query
- Debounces search input
- Sorts by name alphabetically
- Sorts by status progression order
- Sorts by date newest first
- Filters by specific status
- Filters active (excludes closed)
- selectAll selects all filtered cases
- deselectAll clears selection
- selectActiveOnly selects non-closed cases
- toggleCase adds/removes from selection
- hasChanges detects changes from initial

**CaseSelectionModal.test.tsx:**
- Renders search input and dropdowns
- Displays correct case count
- Individual checkbox toggles selection
- Select All button works
- Deselect All button works
- Save Changes calls onSelectionChange
- Cancel closes without saving
- Empty state shows when no matches

Use vitest + testing-library.
  </action>
  <verify>pnpm test -- CaseSelection passes</verify>
  <done>Case selection fully tested</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm tsc --noEmit` passes
- [ ] `pnpm test -- CaseSelection` passes
- [ ] Modal opens from timeline page
- [ ] Search filters cases correctly
- [ ] Sort and filter dropdowns work
- [ ] Bulk actions (Select All, Deselect All, Active Only) work
- [ ] Save persists selection to Convex
- [ ] Add/Remove buttons on case detail work
- [ ] Selection syncs in real-time
</verification>

<success_criteria>
- Case selection modal fully functional
- Search with debounce
- Sort by name/status/date
- Filter by status
- Bulk actions (select all, deselect all, active only)
- Selection persists to Convex (real-time sync)
- Add/Remove buttons on case detail page
- All tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/23-case-detail-timeline/23-04-SUMMARY.md`

Include:
- Accomplishments
- Files Created/Modified
- Decisions Made
- Issues Encountered
- Next Step: Ready for 23-05-PLAN.md (Polish + Human Verification)
</output>
