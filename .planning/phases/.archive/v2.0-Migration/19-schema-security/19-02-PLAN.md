---
phase: 19-schema-security
plan: 02
type: execute
---

<objective>
Define supporting Convex schema tables: notifications, conversations, conversationMessages, refreshTokens, and auditLogs.

Purpose: Complete the data layer with notification tracking, chatbot persistence, token management, and audit logging.
Output: Updated schema.ts with 5 additional tables and proper indexes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/V2_CONVEX_SCHEMA.md
@.planning/phases/19-schema-security/19-CONTEXT.md
@.planning/phases/19-schema-security/19-01-SUMMARY.md

**Prior plan context:**
- 19-01: Core tables (users, userProfiles, cases) defined

**Codebase constraints:**
- Dates stored as ISO strings (YYYY-MM-DD)
- Timestamps stored as Unix milliseconds (v.number())
- Soft deletes via deletedAt timestamp
- auditLogs is NEW table (not in v1) for detailed change tracking
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define notifications table</name>
  <files>v2/convex/schema.ts</files>
  <action>
Add the notifications table for deadline alerts and system messages:

**Relationships:**
- userId: v.id("users")
- caseId: v.optional(v.id("cases")) // Optional - system notifications don't have case

**Notification content:**
- type: v.union(
    v.literal("deadline_reminder"),
    v.literal("status_change"),
    v.literal("rfe_alert"),
    v.literal("rfi_alert"),
    v.literal("system")
  )
- title: v.string()
- message: v.string()

**Priority:**
- priority: v.union(v.literal("low"), v.literal("normal"), v.literal("high"), v.literal("urgent"))

**Deadline information:**
- deadlineDate: v.optional(v.string()) // ISO date
- deadlineType: v.optional(v.string()) // e.g., "pwd_expiration", "rfi_due"
- daysUntilDeadline: v.optional(v.int64())

**Read status:**
- isRead: v.boolean()
- readAt: v.optional(v.number())

**Email status:**
- emailSent: v.boolean()
- emailSentAt: v.optional(v.number())

**Timestamps:**
- createdAt: v.number()
- updatedAt: v.number()

**Indexes:**
- by_user_id: ["userId"]
- by_user_and_unread: ["userId", "isRead"]
- by_case_id: ["caseId"]
- by_deadline_date: ["deadlineDate"]
  </action>
  <verify>npx convex dev --once succeeds, notifications table visible in schema</verify>
  <done>Notifications table defined with all alert fields and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Define conversations and conversationMessages tables</name>
  <files>v2/convex/schema.ts</files>
  <action>
Add chatbot persistence tables:

**conversations table:**
- userId: v.id("users")
- title: v.string()
- isArchived: v.boolean()
- metadata: v.optional(v.any()) // Flexible metadata storage
- createdAt: v.number()
- updatedAt: v.number()

Indexes:
- by_user_id: ["userId"]
- by_user_and_archived: ["userId", "isArchived"]

**conversationMessages table:**
- conversationId: v.id("conversations")
- role: v.union(v.literal("user"), v.literal("assistant"), v.literal("system"))
- content: v.string()
- toolCalls: v.optional(v.array(v.object({
    tool: v.string(),
    arguments: v.any(),
    result: v.optional(v.any()),
    executedAt: v.optional(v.number())
  })))
- metadata: v.optional(v.any())
- createdAt: v.number()

Indexes:
- by_conversation_id: ["conversationId"]
- by_created_at: ["createdAt"]
  </action>
  <verify>npx convex dev --once succeeds, both conversation tables visible</verify>
  <done>Chatbot persistence tables defined with proper relationships</done>
</task>

<task type="auto">
  <name>Task 3: Define refreshTokens and auditLogs tables</name>
  <files>v2/convex/schema.ts</files>
  <action>
Add token management and audit logging tables:

**refreshTokens table:**
- userId: v.id("users")
- token: v.string() // Hashed token
- expiresAt: v.number() // Unix timestamp
- revokedAt: v.optional(v.number())
- revokedReason: v.optional(v.union(
    v.literal("rotation"),
    v.literal("logout"),
    v.literal("security"),
    v.literal("expired")
  ))
- ipAddress: v.optional(v.string())
- userAgent: v.optional(v.string())
- createdAt: v.number()
- updatedAt: v.number()

Indexes:
- by_user_id: ["userId"]
- by_token: ["token"]
- by_expires_at: ["expiresAt"]

**auditLogs table (NEW - detailed change tracking):**
- userId: v.id("users") // Who made the change
- tableName: v.string() // Which table was affected
- documentId: v.string() // ID of affected document (stored as string for flexibility)
- action: v.union(v.literal("create"), v.literal("update"), v.literal("delete"))
- changes: v.optional(v.array(v.object({
    field: v.string(),
    oldValue: v.optional(v.any()),
    newValue: v.optional(v.any())
  })))
- metadata: v.optional(v.object({
    ipAddress: v.optional(v.string()),
    userAgent: v.optional(v.string()),
    source: v.optional(v.string()) // "web", "api", "chatbot"
  }))
- timestamp: v.number()

Indexes:
- by_user_id: ["userId"]
- by_table_name: ["tableName"]
- by_document_id: ["documentId"]
- by_timestamp: ["timestamp"]
- by_user_and_table: ["userId", "tableName"]

Note: auditLogs should be append-only (no updates or deletes on audit entries).
  </action>
  <verify>npx convex dev --once succeeds, both tables visible with correct indexes</verify>
  <done>Token management and audit logging tables defined</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` succeeds without errors
- [ ] notifications table has 4 indexes
- [ ] conversations table has 2 indexes
- [ ] conversationMessages table has 2 indexes
- [ ] refreshTokens table has 3 indexes
- [ ] auditLogs table has 5 indexes
- [ ] Total: 9 tables defined in schema (users + 8 new)
</verification>

<success_criteria>
- All 5 supporting tables defined with complete field lists
- Field types match V2_CONVEX_SCHEMA.md specifications
- Indexes support expected query patterns
- auditLogs supports field-level change tracking
- Schema deploys successfully to Convex
</success_criteria>

<output>
After completion, create `.planning/phases/19-schema-security/19-02-SUMMARY.md`:

# Phase 19 Plan 02: Supporting Schema Summary

**[One-liner describing what shipped]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- `v2/convex/schema.ts` - Added 5 supporting tables

## Decisions Made
- [Any schema decisions]

## Issues Encountered
- [Problems and resolutions, or "None"]

## Next Step
Ready for 19-03-PLAN.md (Auth helpers and security patterns)
</output>
