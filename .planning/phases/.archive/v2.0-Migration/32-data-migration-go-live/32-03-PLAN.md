---
phase: 32-data-migration-go-live
plan: 03
type: execute
---

<objective>
Execute data migration from Supabase to Convex production and verify all 229 features work correctly.

Purpose: Migrate production data with zero data loss and verify the app works correctly.
Output: Production Convex deployment with all user data migrated and verified.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/V2_FEATURE_INVENTORY.md
@.planning/phases/32-data-migration-go-live/32-RESEARCH.md
@.planning/phases/32-data-migration-go-live/32-CONTEXT.md
@.planning/phases/32-data-migration-go-live/32-01-SUMMARY.md

**Prior decisions affecting this plan:**
- Maintenance window approach (15-30 min)
- Email-based user matching
- Chat/notifications start fresh (not migrated)
- Calendar needs re-connection (OAuth tokens not migrated)
- Users log in with Google and see their cases

**Migration sequence (from research):**
1. Set v1 to read-only mode
2. Export from Supabase
3. Transform data
4. Import to Convex production
5. Run ID migrations
6. Verify 229 features
7. DNS cutover

**CRITICAL:** This plan executes the actual production migration. Test thoroughly before executing.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create verification scripts and pre-migration checklist</name>
  <files>v2/scripts/migration/04_verify_migration.ts, v2/scripts/migration/pre_migration_checklist.md</files>
  <action>
Create verification infrastructure:

1. `pre_migration_checklist.md` - Pre-migration checklist:
   - [ ] Backup Supabase database (automatic, verify exists)
   - [ ] Announce maintenance window (T-7 days, T-1 day)
   - [ ] Convex production deployment working (npx convex deploy)
   - [ ] Environment variables set in Convex production
   - [ ] Test migration scripts on test Supabase instance
   - [ ] Rollback procedure documented and tested
   - [ ] Team available during migration window

2. `04_verify_migration.ts` - Automated verification script:
   - Compare record counts: Supabase vs Convex
   - Sample data verification (10% random sample):
     - Fetch case by legacyId from Convex
     - Compare all fields to source data
     - Log mismatches
   - Foreign key verification:
     - All cases have valid userId
     - userId references exist in userProfiles
   - Calculation verification:
     - Pick 10 cases with PWD dates
     - Verify pwdExpirationDate is correctly calculated
     - Verify filing window dates are correct
   - Return: { success: boolean, stats: {...}, errors: [...] }

3. Add `--production` flag to verify against production Convex:
   - Read from CONVEX_DEPLOY_KEY env var
   - Query production deployment
   </action>
  <verify>npx tsx 04_verify_migration.ts --dry-run shows verification plan</verify>
  <done>Verification scripts ready for production validation</done>
</task>

<task type="auto">
  <name>Task 2: Create migration execution script with rollback</name>
  <files>v2/scripts/migration/run_migration.sh</files>
  <action>
Create master migration script that orchestrates the full process:

1. `run_migration.sh` - Master script:
   ```bash
   #!/bin/bash
   set -e  # Exit on error

   # Configuration
   MIGRATION_DIR="$(dirname "$0")"
   DATA_DIR="$MIGRATION_DIR/data"
   TIMESTAMP=$(date +%Y%m%d_%H%M%S)
   LOG_FILE="$MIGRATION_DIR/logs/migration_$TIMESTAMP.log"

   # Check prerequisites
   check_prerequisites() {
     # Verify env vars, CLI tools, connectivity
   }

   # Step 1: Export from Supabase
   step_export() {
     echo "Step 1: Exporting from Supabase..."
     bash "$MIGRATION_DIR/01_export_supabase.sh"
   }

   # Step 2: Transform data
   step_transform() {
     echo "Step 2: Transforming data..."
     npx tsx "$MIGRATION_DIR/02_transform_data.ts"
   }

   # Step 3: Import to Convex
   step_import() {
     echo "Step 3: Importing to Convex..."
     bash "$MIGRATION_DIR/03_import_convex.sh"
   }

   # Step 4: Run ID migrations
   step_migrate_ids() {
     echo "Step 4: Running ID migrations..."
     npx convex run migrations:migrateCaseUserIds
   }

   # Step 5: Verify
   step_verify() {
     echo "Step 5: Verifying migration..."
     npx tsx "$MIGRATION_DIR/04_verify_migration.ts" --production
   }

   # Main execution
   main() {
     echo "=== PERM Tracker Migration ==="
     echo "Started: $(date)"
     check_prerequisites
     step_export
     step_transform
     step_import
     step_migrate_ids
     step_verify
     echo "=== Migration Complete ==="
     echo "Finished: $(date)"
   }

   main "$@" 2>&1 | tee "$LOG_FILE"
   ```

2. Add rollback capability:
   - Before import, create Convex backup: `npx convex export backup_$TIMESTAMP.zip`
   - If any step fails, option to restore from backup
   - Document rollback steps in README.md

3. Add dry-run mode:
   - `--dry-run` flag that validates each step without executing
   - Shows what would be done
   </action>
  <verify>./run_migration.sh --dry-run completes without errors</verify>
  <done>Master migration script with rollback capability ready</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete migration infrastructure ready for production execution</what-built>
  <how-to-verify>
    **Test migration on TEST environment first:**

    1. Connect to test Supabase (lkbhdshknusfrvxgtahz)
    2. Run full migration on test deployment:
       ```bash
       cd v2/scripts/migration
       ./run_migration.sh
       ```
    3. Verify in test Convex dashboard:
       - Cases table has records
       - userProfiles table has records
       - Record counts match source
    4. Start test app: pnpm dev
    5. Log in with test account (test@example.com)
    6. Verify:
       - Dashboard loads with correct case count
       - Case detail pages show all fields
       - Date calculations are accurate
       - Create new case works
       - Edit existing case works
       - Export CSV works

    **Production migration will be executed after v2 calendar fixes (32-02) are verified.**
  </how-to-verify>
  <resume-signal>Type "test migration verified" to confirm test environment migration works correctly, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All migration scripts work on test environment
- [ ] Record counts match source
- [ ] Sample data verification passes
- [ ] Calculations are correct post-migration
- [ ] App functionality works with migrated data
</verification>

<success_criteria>
- Migration scripts execute successfully on test environment
- Verification script confirms data integrity
- App works correctly with migrated data
- Test migration verified by human
- Ready for production execution (will happen in 32-04 after 32-02 calendar fixes)
</success_criteria>

<output>
After completion, create `.planning/phases/32-data-migration-go-live/32-03-SUMMARY.md`

**Note:** This plan verifies migration on TEST environment. Production execution happens in 32-04 after all pre-requisites are confirmed.
</output>
