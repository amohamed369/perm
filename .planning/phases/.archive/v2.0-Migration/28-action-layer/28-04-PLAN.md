---
phase: 28-action-layer
plan: 04
type: execute
---

<objective>
Add calendar, notification, and settings action tools to the chatbot.

Purpose: Enable chatbot to sync cases to calendar, manage notifications, and update user settings - completing the non-case action coverage.
Output: 8 tools (calendar sync, notification management, settings updates) with permission integration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-action-layer/28-CONTEXT.md
@.planning/phases/28-action-layer/28-01-SUMMARY.md
@.planning/phases/28-action-layer/28-02-SUMMARY.md
@.planning/phases/28-action-layer/28-03-SUMMARY.md

**Existing Convex mutations:**
@v2/convex/cases.ts - toggleCalendarSync, bulkUpdateCalendarSync
@v2/convex/notifications.ts - markAsRead, markAllAsRead, deleteNotification, clearAll
@v2/convex/users.ts - updateUserProfile

**Tool infrastructure:**
@v2/src/lib/ai/tools.ts
@v2/src/lib/ai/tool-permissions.ts
@v2/src/app/api/chat/route.ts

**Permission levels from 28-CONTEXT.md:**
- Calendar sync (single): CONFIRM tier
- Calendar sync (bulk): DESTRUCTIVE tier
- Notification mark read (single): CONFIRM tier
- Notification delete/clear all: DESTRUCTIVE tier
- Settings update: CONFIRM tier

**CRITICAL: Use existing Convex mutations - do NOT create duplicate implementations.**
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define calendar and notification tool schemas</name>
  <files>v2/src/lib/ai/tools.ts, v2/src/lib/ai/tool-permissions.ts</files>
  <exploration>
    Use Explore agent to find: existing calendar sync mutation arguments, notification mutation arguments, existing schema patterns.
  </exploration>
  <action>
    1. Add calendar tools to tools.ts:

    ```typescript
    // Calendar Sync Tools

    const SyncToCalendarInputSchema = z.object({
      caseId: z.string().describe("The Convex ID of the case to sync"),
    });

    export const syncToCalendarTool = tool({
      description: `Sync a case's deadlines to Google Calendar.

WHEN TO USE:
- User asks to "sync", "add to calendar" a case
- User wants case deadlines in their Google Calendar
- After creating a case, user wants it synced

WHEN NOT TO USE:
- User hasn't connected Google Calendar (check first)
- User wants to remove from calendar (use unsyncFromCalendar)

REQUIRES: User confirmation (CONFIRM tier)`,
      inputSchema: SyncToCalendarInputSchema,
    });

    const UnsyncFromCalendarInputSchema = z.object({
      caseId: z.string().describe("The Convex ID of the case to unsync"),
    });

    export const unsyncFromCalendarTool = tool({
      description: `Remove a case's deadlines from Google Calendar.

WHEN TO USE:
- User asks to "unsync", "remove from calendar" a case
- User no longer wants case deadlines in calendar

WHEN NOT TO USE:
- Case is not currently synced

REQUIRES: User confirmation (CONFIRM tier)`,
      inputSchema: UnsyncFromCalendarInputSchema,
    });
    ```

    2. Add notification tools:

    ```typescript
    // Notification Tools

    const MarkNotificationReadInputSchema = z.object({
      notificationId: z.string().describe("The Convex ID of the notification"),
    });

    export const markNotificationReadTool = tool({
      description: `Mark a notification as read.

WHEN TO USE:
- User asks to "mark as read", "dismiss" a notification
- After showing notification details

WHEN NOT TO USE:
- User wants to delete notification (use deleteNotification)
- User wants to mark all read (use markAllNotificationsRead)

REQUIRES: User confirmation (CONFIRM tier)`,
      inputSchema: MarkNotificationReadInputSchema,
    });

    const MarkAllNotificationsReadInputSchema = z.object({
      confirm: z.boolean().optional().describe("Confirmation flag"),
    });

    export const markAllNotificationsReadTool = tool({
      description: `Mark all notifications as read.

WHEN TO USE:
- User asks to "mark all as read", "dismiss all"
- User wants to clear notification count

⚠️ DESTRUCTIVE ACTION - Always requires confirmation

REQUIRES: User confirmation (DESTRUCTIVE tier)`,
      inputSchema: MarkAllNotificationsReadInputSchema,
    });

    const DeleteNotificationInputSchema = z.object({
      notificationId: z.string().describe("The Convex ID of the notification to delete"),
    });

    export const deleteNotificationTool = tool({
      description: `Delete a notification.

WHEN TO USE:
- User asks to "delete", "remove" a specific notification

WHEN NOT TO USE:
- User just wants to mark as read
- User wants to clear all (use clearAllNotifications)

REQUIRES: User confirmation (CONFIRM tier)`,
      inputSchema: DeleteNotificationInputSchema,
    });

    const ClearAllNotificationsInputSchema = z.object({
      confirm: z.boolean().optional().describe("Confirmation flag"),
    });

    export const clearAllNotificationsTool = tool({
      description: `Delete all notifications permanently.

⚠️ DESTRUCTIVE ACTION - Always requires confirmation

WHEN TO USE:
- User asks to "clear all", "delete all" notifications
- User wants fresh notification list

WHEN NOT TO USE:
- User just wants to mark as read

REQUIRES: User confirmation (DESTRUCTIVE tier)`,
      inputSchema: ClearAllNotificationsInputSchema,
    });
    ```

    3. Update tool-permissions.ts:
    ```typescript
    export const TOOL_PERMISSIONS: Record<string, PermissionLevel> = {
      // ... existing

      // Calendar
      syncToCalendar: 'confirm',
      unsyncFromCalendar: 'confirm',

      // Notifications
      markNotificationRead: 'confirm',
      markAllNotificationsRead: 'destructive',
      deleteNotification: 'confirm',
      clearAllNotifications: 'destructive',
    };
    ```

    4. Add to chatTools export.
  </action>
  <verify>TypeScript compiles, tools export correctly</verify>
  <done>6 calendar and notification tools defined with permission levels</done>
</task>

<task type="auto">
  <name>Task 2: Define settings tools and extend tool icons</name>
  <files>v2/src/lib/ai/tools.ts, v2/src/lib/ai/tool-permissions.ts, v2/src/components/chat/tool-icons.tsx, v2/src/components/chat/tool-result-summary.ts</files>
  <exploration>
    Use Explore agent to find: userProfile settings fields, existing settings page structure, icon library usage.
  </exploration>
  <action>
    1. Add settings tools to tools.ts:

    ```typescript
    // Settings Tools

    const UpdateSettingsInputSchema = z.object({
      settings: z.object({
        // Notification preferences
        emailNotificationsEnabled: z.boolean().optional(),
        pushNotificationsEnabled: z.boolean().optional(),
        emailDeadlineReminders: z.boolean().optional(),
        emailStatusUpdates: z.boolean().optional(),
        emailRfeAlerts: z.boolean().optional(),
        emailWeeklyDigest: z.boolean().optional(),
        urgentDeadlineDays: z.number().optional(),
        reminderDaysBefore: z.array(z.number()).optional(),

        // Calendar sync preferences
        calendarSyncEnabled: z.boolean().optional(),
        calendarSyncPwd: z.boolean().optional(),
        calendarSyncEta9089: z.boolean().optional(),
        calendarSyncI140: z.boolean().optional(),
        calendarSyncRfe: z.boolean().optional(),
        calendarSyncRfi: z.boolean().optional(),
        calendarSyncRecruitment: z.boolean().optional(),
        calendarSyncFilingWindow: z.boolean().optional(),

        // UI preferences
        darkModeEnabled: z.boolean().optional(),
      }).describe("Settings to update"),
    });

    export const updateSettingsTool = tool({
      description: `Update user settings and preferences.

WHEN TO USE:
- User asks to "change", "update", "set" settings
- User wants to enable/disable notifications
- User wants to change calendar sync preferences
- User wants to toggle dark mode

EXAMPLES:
- "Turn off email notifications"
- "Enable dark mode"
- "Set reminder days to 3, 7, and 14"
- "Sync PWD deadlines to calendar"

REQUIRES: User confirmation (CONFIRM tier)`,
      inputSchema: UpdateSettingsInputSchema,
    });

    const GetSettingsInputSchema = z.object({
      category: z.enum(['all', 'notifications', 'calendar', 'preferences'])
        .optional().default('all')
        .describe("Which settings to retrieve"),
    });

    export const getSettingsTool = tool({
      description: `Get current user settings.

WHEN TO USE:
- User asks "what are my settings"
- User wants to see notification preferences
- User asks about calendar sync status

AUTONOMOUS - No confirmation needed`,
      inputSchema: GetSettingsInputSchema,
    });
    ```

    2. Update tool-permissions.ts:
    ```typescript
    updateSettings: 'confirm',
    getSettings: 'autonomous',
    ```

    3. Update tool-icons.tsx:
    ```typescript
    import {
      // Add new icons
      CalendarSync, CalendarOff, BellRing, BellOff, CheckCheck,
      Trash, Settings, Eye,
    } from 'lucide-react';

    export const TOOL_ICONS: Record<string, LucideIcon> = {
      // ... existing
      // Calendar
      syncToCalendar: CalendarPlus,     // or use Calendar with plus
      unsyncFromCalendar: CalendarMinus, // or CalendarOff

      // Notifications
      markNotificationRead: Check,
      markAllNotificationsRead: CheckCheck,
      deleteNotification: Trash,
      clearAllNotifications: Trash2,

      // Settings
      updateSettings: Settings,
      getSettings: Eye,
    };

    export const TOOL_COLORS: Record<string, string> = {
      // Calendar
      syncToCalendar: 'text-teal-600',
      unsyncFromCalendar: 'text-slate-600',

      // Notifications
      markNotificationRead: 'text-blue-600',
      markAllNotificationsRead: 'text-blue-600',
      deleteNotification: 'text-red-600',
      clearAllNotifications: 'text-red-600',

      // Settings
      updateSettings: 'text-slate-600',
      getSettings: 'text-slate-500',
    };
    ```

    4. Update tool-result-summary.ts:
    ```typescript
    case 'syncToCalendar':
      return `Synced case to calendar`;
    case 'unsyncFromCalendar':
      return `Removed case from calendar`;
    case 'markNotificationRead':
      return `Marked as read`;
    case 'markAllNotificationsRead':
      return `Marked all as read`;
    case 'deleteNotification':
      return `Notification deleted`;
    case 'clearAllNotifications':
      return `All notifications cleared`;
    case 'updateSettings':
      const count = Object.keys(result.settings || {}).length;
      return `Updated ${count} setting${count !== 1 ? 's' : ''}`;
    case 'getSettings':
      return `Retrieved settings`;
    ```

    5. Update getToolPriorityKeys and display names.
  </action>
  <verify>Icons render, result summaries display correctly for all 8 tools</verify>
  <done>Settings tools defined, all 8 tool icons and summaries configured</done>
</task>

<task type="auto">
  <name>Task 3: Integrate tools with API route and Convex mutations</name>
  <files>v2/src/app/api/chat/route.ts</files>
  <exploration>
    Use Explore agent to find: existing notification mutations, calendar sync mutations, user profile update patterns.
  </exploration>
  <action>
    1. Add execute functions for calendar tools:
    ```typescript
    syncToCalendar: {
      description: syncToCalendarTool.description,
      inputSchema: SyncToCalendarInputSchema,
      execute: async (params) => {
        const actionMode = await getActionMode(token);

        if (requiresConfirmation('syncToCalendar', actionMode)) {
          return {
            requiresPermission: true,
            permissionType: 'confirm',
            toolName: 'syncToCalendar',
            arguments: params,
            description: `Sync case to Google Calendar`,
          };
        }

        try {
          await fetchAction(api.cases.toggleCalendarSync, {
            id: params.caseId as Id<'cases'>,
            enabled: true,
          }, { token });

          return {
            success: true,
            caseId: params.caseId,
            message: 'Case synced to calendar',
          };
        } catch (error) {
          return {
            error: 'Failed to sync to calendar',
            suggestion: error instanceof Error ? error.message : 'Please try again',
          };
        }
      },
    },

    unsyncFromCalendar: {
      // Similar pattern with enabled: false
    },
    ```

    2. Add execute functions for notification tools:
    ```typescript
    markNotificationRead: {
      execute: async (params) => {
        // Permission check, then:
        await fetchAction(api.notifications.markAsRead, {
          id: params.notificationId as Id<'notifications'>,
        }, { token });
        return { success: true, message: 'Marked as read' };
      },
    },

    markAllNotificationsRead: {
      execute: async (params) => {
        // ALWAYS requires confirmation (destructive)
        if (/* not approved */) {
          return {
            requiresPermission: true,
            permissionType: 'destructive',
            toolName: 'markAllNotificationsRead',
            arguments: params,
            description: 'Mark all notifications as read',
          };
        }

        await fetchAction(api.notifications.markAllAsRead, {}, { token });
        return { success: true, message: 'All notifications marked as read' };
      },
    },

    // Similar for deleteNotification, clearAllNotifications
    ```

    3. Add execute functions for settings tools:
    ```typescript
    updateSettings: {
      execute: async (params) => {
        const actionMode = await getActionMode(token);

        if (requiresConfirmation('updateSettings', actionMode)) {
          return {
            requiresPermission: true,
            permissionType: 'confirm',
            toolName: 'updateSettings',
            arguments: params,
            description: `Update ${Object.keys(params.settings).length} settings`,
          };
        }

        try {
          await fetchAction(api.users.updateUserProfile, params.settings, { token });
          return {
            success: true,
            settings: params.settings,
            message: 'Settings updated',
          };
        } catch (error) {
          return {
            error: 'Failed to update settings',
            suggestion: error instanceof Error ? error.message : 'Please try again',
          };
        }
      },
    },

    getSettings: {
      execute: async (params) => {
        // Autonomous - no permission needed
        const profile = await fetchQuery(api.users.currentUserProfile, {}, { token });
        return {
          success: true,
          settings: profile,
          category: params.category,
        };
      },
    },
    ```

    4. Add all 8 tools to the createTools function.
  </action>
  <verify>All 8 tools execute correctly, mutations called, permissions work</verify>
  <done>Calendar, notification, and settings tools integrated with Convex</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds in v2/
- [ ] 8 new tools appear in chatTools export
- [ ] Tool icons render correctly for all tools
- [ ] "Sync case X to calendar" triggers syncToCalendar with confirmation
- [ ] "Clear all notifications" shows destructive confirmation card
- [ ] "Turn off email notifications" triggers updateSettings
- [ ] "What are my settings" returns current settings (no confirmation)
- [ ] Mutations execute correctly after approval
- [ ] No TypeScript errors
</verification>

<success_criteria>
- 8 tools defined (2 calendar, 4 notification, 2 settings)
- Permission levels configured correctly
- Tools integrated with existing Convex mutations
- Destructive actions always require confirmation
- Autonomous tools (getSettings) work without confirmation
</success_criteria>

<output>
After completion, create `.planning/phases/28-action-layer/28-04-SUMMARY.md`:

# Phase 28 Plan 04: Calendar, Notifications & Settings Tools Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 28-05-PLAN.md (Bulk Operations & Polish)
</output>
