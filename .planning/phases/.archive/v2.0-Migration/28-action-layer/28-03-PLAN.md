---
phase: 28-action-layer
plan: 03
type: execute
---

<objective>
Add case CRUD action tools to the chatbot with permission handling.

Purpose: Enable chatbot to create, update, archive, reopen, and delete cases - the core case management actions.
Output: 5 case tools (create_case, update_case, archive_case, reopen_case, delete_case) with permission integration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-action-layer/28-CONTEXT.md
@.planning/phases/28-action-layer/28-01-SUMMARY.md
@.planning/phases/28-action-layer/28-02-SUMMARY.md

**Existing Convex mutations:**
@v2/convex/cases.ts - create, update, remove, restore, reopenCase

**Tool infrastructure:**
@v2/src/lib/ai/tools.ts
@v2/src/app/api/chat/route.ts

**Permission cards (from 28-01):**
@v2/src/components/chat/InChatConfirmationCard.tsx

**Permission levels from 28-CONTEXT.md:**
- create_case: CONFIRM tier
- update_case: CONFIRM tier
- archive_case: CONFIRM tier
- reopen_case: CONFIRM tier
- delete_case: DESTRUCTIVE (always requires confirmation, even in AUTO mode)

**Central validation:**
@v2/src/lib/validation/ - use existing validation functions
@perm_flow.md - case statuses, progress statuses

**CRITICAL: Use existing Convex mutations - do NOT create duplicate implementations.**
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define case CRUD tool schemas</name>
  <files>v2/src/lib/ai/tools.ts, v2/src/lib/ai/tool-permissions.ts</files>
  <exploration>
    Use Explore agent to find: existing Convex case mutation arguments, case field types from schema, validation schemas from lib/validation.
  </exploration>
  <action>
    1. Create tool-permissions.ts for permission metadata:
    ```typescript
    export type PermissionLevel = 'autonomous' | 'confirm' | 'destructive';

    export const TOOL_PERMISSIONS: Record<string, PermissionLevel> = {
      // Autonomous (no confirmation needed)
      queryCases: 'autonomous',
      searchKnowledge: 'autonomous',
      searchWeb: 'autonomous',
      navigate: 'autonomous',
      viewCase: 'autonomous',
      scrollTo: 'autonomous',
      refreshPage: 'autonomous',

      // Confirm (ask in CONFIRM mode, auto in AUTO mode)
      createCase: 'confirm',
      updateCase: 'confirm',
      archiveCase: 'confirm',
      reopenCase: 'confirm',

      // Destructive (always ask, even in AUTO mode)
      deleteCase: 'destructive',
    };

    export function getToolPermission(toolName: string): PermissionLevel {
      return TOOL_PERMISSIONS[toolName] ?? 'confirm';
    }

    export function requiresConfirmation(
      toolName: string,
      actionMode: 'off' | 'confirm' | 'auto'
    ): boolean {
      const permission = getToolPermission(toolName);
      if (permission === 'autonomous') return false;
      if (permission === 'destructive') return true; // Always confirm
      if (actionMode === 'auto') return false;
      return actionMode === 'confirm';
    }
    ```

    2. Add case CRUD tools to tools.ts:

    ```typescript
    // Case Management Tools

    const CreateCaseInputSchema = z.object({
      employerName: z.string().describe("Employer/company name (required)"),
      positionTitle: z.string().optional().describe("Job position title"),
      beneficiaryName: z.string().optional().describe("Beneficiary/employee name"),
      caseStatus: z.enum(["pwd", "recruitment", "eta_9089", "i_140", "complete", "closed"])
        .optional().describe("Initial case status (defaults to pwd)"),
      // Key dates (optional, can be added later)
      pwdFilingDate: z.string().optional().describe("PWD filing date (YYYY-MM-DD)"),
      pwdDeterminationDate: z.string().optional().describe("PWD determination date (YYYY-MM-DD)"),
    });

    export const createCaseTool = tool({
      description: `Create a new PERM case.

WHEN TO USE:
- User asks to "create", "add", "start" a new case
- User provides employer name and wants a case created
- After discussing case details, user confirms creation

WHEN NOT TO USE:
- User is just asking about creating cases
- User wants to edit existing case (use updateCase)

REQUIRES: User confirmation (CONFIRM tier)`,
      inputSchema: CreateCaseInputSchema,
    });

    const UpdateCaseInputSchema = z.object({
      caseId: z.string().describe("The Convex ID of the case to update"),
      updates: z.object({
        employerName: z.string().optional(),
        positionTitle: z.string().optional(),
        beneficiaryName: z.string().optional(),
        caseStatus: z.enum(["pwd", "recruitment", "eta_9089", "i_140", "complete", "closed"]).optional(),
        progressStatus: z.enum([
          "not_started", "in_progress", "filed", "pending",
          "certified", "denied", "rfi_pending", "rfe_pending"
        ]).optional(),
        // Date fields
        pwdFilingDate: z.string().optional(),
        pwdDeterminationDate: z.string().optional(),
        pwdExpirationDate: z.string().optional(),
        recruitmentStartDate: z.string().optional(),
        recruitmentEndDate: z.string().optional(),
        eta9089FilingDate: z.string().optional(),
        eta9089CertificationDate: z.string().optional(),
        i140FilingDate: z.string().optional(),
        i140ApprovalDate: z.string().optional(),
        // Flags
        isFavorite: z.boolean().optional(),
        isPinned: z.boolean().optional(),
        calendarSyncEnabled: z.boolean().optional(),
      }).describe("Fields to update"),
    });

    export const updateCaseTool = tool({
      description: `Update an existing PERM case.

WHEN TO USE:
- User asks to "update", "change", "set", "modify" a case field
- User provides new values for case fields
- After querying a case, user wants to change something

WHEN NOT TO USE:
- User wants to create new case (use createCase)
- User wants to delete case (use deleteCase)
- User wants to archive case (use archiveCase)

REQUIRES: User confirmation (CONFIRM tier)`,
      inputSchema: UpdateCaseInputSchema,
    });

    const ArchiveCaseInputSchema = z.object({
      caseId: z.string().describe("The Convex ID of the case to archive"),
      reason: z.string().optional().describe("Reason for archiving"),
    });

    export const archiveCaseTool = tool({
      description: `Archive/close a PERM case.

WHEN TO USE:
- User asks to "archive", "close", "complete" a case
- Case is finished and should be moved to archive
- User wants to hide case from active list

WHEN NOT TO USE:
- User wants to permanently delete (use deleteCase)
- Case is already closed (check status first)

REQUIRES: User confirmation (CONFIRM tier)`,
      inputSchema: ArchiveCaseInputSchema,
    });

    const ReopenCaseInputSchema = z.object({
      caseId: z.string().describe("The Convex ID of the case to reopen"),
      reason: z.string().optional().describe("Reason for reopening"),
    });

    export const reopenCaseTool = tool({
      description: `Reopen an archived/closed PERM case.

WHEN TO USE:
- User asks to "reopen", "unarchive", "restore" a closed case
- Case was archived but work is resuming

WHEN NOT TO USE:
- Case is already active
- Case was permanently deleted

REQUIRES: User confirmation (CONFIRM tier)`,
      inputSchema: ReopenCaseInputSchema,
    });

    const DeleteCaseInputSchema = z.object({
      caseId: z.string().describe("The Convex ID of the case to delete"),
      confirmPhrase: z.string().optional()
        .describe("Confirmation phrase (employer name) for safety"),
    });

    export const deleteCaseTool = tool({
      description: `PERMANENTLY delete a PERM case.

⚠️ DESTRUCTIVE ACTION - Always requires user confirmation

WHEN TO USE:
- User explicitly asks to "delete", "remove permanently" a case
- User confirms they want permanent deletion

WHEN NOT TO USE:
- User wants to archive (use archiveCase instead)
- User is unsure (suggest archiveCase first)

REQUIRES: User confirmation (DESTRUCTIVE tier - always asks)`,
      inputSchema: DeleteCaseInputSchema,
    });
    ```

    3. Add to chatTools export.
  </action>
  <verify>TypeScript compiles, tools export correctly</verify>
  <done>5 case CRUD tools defined with permission levels</done>
</task>

<task type="auto">
  <name>Task 2: Extend tool icons and integrate permission checking</name>
  <files>v2/src/components/chat/tool-icons.tsx, v2/src/components/chat/tool-result-summary.ts</files>
  <exploration>
    Use Explore agent to find: existing icon patterns, result summary patterns, how to get action mode in API context.
  </exploration>
  <action>
    1. Update tool-icons.tsx with case CRUD icons:
    ```typescript
    import {
      // Add case CRUD icons
      Plus, Pencil, Archive, RotateCcw, Trash2,
    } from 'lucide-react';

    export const TOOL_ICONS: Record<string, LucideIcon> = {
      // ... existing
      // Case CRUD
      createCase: Plus,
      updateCase: Pencil,
      archiveCase: Archive,
      reopenCase: RotateCcw,
      deleteCase: Trash2,
    };

    export const TOOL_COLORS: Record<string, string> = {
      // ... existing
      // Case CRUD - use status colors
      createCase: 'text-green-600',      // Create = positive
      updateCase: 'text-amber-600',      // Update = modification
      archiveCase: 'text-slate-600',     // Archive = neutral
      reopenCase: 'text-blue-600',       // Reopen = restore
      deleteCase: 'text-red-600',        // Delete = destructive
    };

    export const TOOL_DISPLAY_NAMES: Record<string, string> = {
      // ... existing
      createCase: 'Create Case',
      updateCase: 'Update Case',
      archiveCase: 'Archive Case',
      reopenCase: 'Reopen Case',
      deleteCase: 'Delete Case',
    };
    ```

    2. Update getToolLoadingMessage:
    ```typescript
    createCase: 'Creating case...',
    updateCase: 'Updating case...',
    archiveCase: 'Archiving case...',
    reopenCase: 'Reopening case...',
    deleteCase: 'Deleting case...',
    ```

    3. Update tool-result-summary.ts:
    ```typescript
    case 'createCase':
      return `Created case: ${result.employerName}`;
    case 'updateCase':
      const fields = Object.keys(result.updates || {}).length;
      return `Updated ${fields} field${fields !== 1 ? 's' : ''}`;
    case 'archiveCase':
      return `Case archived`;
    case 'reopenCase':
      return `Case reopened`;
    case 'deleteCase':
      return `Case deleted`;
    ```

    4. Update getToolPriorityKeys:
    ```typescript
    createCase: ['employerName', 'positionTitle', 'beneficiaryName'],
    updateCase: ['caseId', 'updates'],
    archiveCase: ['caseId', 'reason'],
    reopenCase: ['caseId', 'reason'],
    deleteCase: ['caseId'],
    ```
  </action>
  <verify>Icons render, result summaries display correctly</verify>
  <done>Tool icons, colors, and summaries extended for case CRUD tools</done>
</task>

<task type="auto">
  <name>Task 3: Integrate case tools with API route and Convex mutations</name>
  <files>v2/src/app/api/chat/route.ts</files>
  <exploration>
    Use Explore agent to find: how existing tools execute in API route, fetchAction pattern for mutations, error handling patterns.
  </exploration>
  <action>
    1. Import case tool schemas and permission helpers.

    2. Add execute functions for case CRUD tools:
    ```typescript
    createCase: {
      description: createCaseTool.description,
      inputSchema: CreateCaseInputSchema,
      execute: async (params: z.infer<typeof CreateCaseInputSchema>) => {
        // Check permission
        const permission = getToolPermission('createCase');
        const actionMode = await getActionMode(token);

        if (requiresConfirmation('createCase', actionMode)) {
          return {
            requiresPermission: true,
            permissionType: permission,
            toolName: 'createCase',
            arguments: params,
            description: `Create case for ${params.employerName}`,
          };
        }

        // Execute mutation
        try {
          const result = await fetchAction(api.cases.create, {
            employerName: params.employerName,
            positionTitle: params.positionTitle,
            beneficiaryName: params.beneficiaryName,
            caseStatus: params.caseStatus ?? 'pwd',
            pwdFilingDate: params.pwdFilingDate,
            pwdDeterminationDate: params.pwdDeterminationDate,
          }, { token });

          return {
            success: true,
            caseId: result._id,
            employerName: params.employerName,
            message: `Created case for ${params.employerName}`,
          };
        } catch (error) {
          return {
            error: 'Failed to create case',
            suggestion: error instanceof Error ? error.message : 'Please try again',
          };
        }
      },
    },

    updateCase: {
      description: updateCaseTool.description,
      inputSchema: UpdateCaseInputSchema,
      execute: async (params: z.infer<typeof UpdateCaseInputSchema>) => {
        const actionMode = await getActionMode(token);

        if (requiresConfirmation('updateCase', actionMode)) {
          return {
            requiresPermission: true,
            permissionType: 'confirm',
            toolName: 'updateCase',
            arguments: params,
            description: `Update case ${params.caseId}`,
          };
        }

        try {
          await fetchAction(api.cases.update, {
            id: params.caseId as Id<'cases'>,
            ...params.updates,
          }, { token });

          return {
            success: true,
            caseId: params.caseId,
            updates: params.updates,
            message: `Updated case`,
          };
        } catch (error) {
          return {
            error: 'Failed to update case',
            suggestion: error instanceof Error ? error.message : 'Please try again',
          };
        }
      },
    },

    // Similar patterns for archiveCase, reopenCase, deleteCase
    // deleteCase ALWAYS returns requiresPermission: true
    ```

    3. Handle permission responses in message handling:
    - When tool returns `requiresPermission: true`, add permission card to response
    - Store pending tool call state for resumption
    - When user approves, execute the tool

    4. Invalidate tool cache after mutations (cases change = queryCases cache invalid).
  </action>
  <verify>Case tools execute, mutations called, permissions checked correctly</verify>
  <done>Case CRUD tools integrated with Convex mutations and permission system</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds in v2/
- [ ] 5 case CRUD tools appear in chatTools export
- [ ] Tool icons render correctly for case tools
- [ ] "Create a case for Acme Corp" triggers createCase with permission card
- [ ] "Update case X to status recruitment" triggers updateCase
- [ ] "Delete case X" always shows destructive confirmation card
- [ ] Mutations execute correctly after approval
- [ ] Tool cache invalidated after case changes
- [ ] No TypeScript errors
</verification>

<success_criteria>
- 5 case CRUD tools defined with proper schemas
- Permission levels configured (confirm vs destructive)
- Tools integrated with existing Convex mutations
- Permission cards shown appropriately based on action mode
- Destructive actions always require confirmation
- Cache invalidation working
</success_criteria>

<output>
After completion, create `.planning/phases/28-action-layer/28-03-SUMMARY.md`:

# Phase 28 Plan 03: Case CRUD Tools Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 28-04-PLAN.md (Calendar, Notifications & Settings Tools)
</output>
