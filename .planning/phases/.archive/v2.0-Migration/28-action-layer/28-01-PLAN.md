---
phase: 28-action-layer
plan: 01
type: execute
---

<objective>
Build the permission infrastructure for chatbot action execution.

Purpose: Enable users to control how the chatbot takes actions - OFF (read-only), CONFIRM (ask first), or AUTO (execute immediately except destructive).
Output: Permission toggle in chat header, InChatConfirmationCard component, Convex storage for user preference.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-action-layer/28-CONTEXT.md

**Phase context gathered from /gsd:discuss-phase:**
- Three-tier permission system: OFF | CONFIRM | AUTO
- OFF = read-only, no action offers
- CONFIRM = inline permission cards for each action
- AUTO = immediate execution (except destructive which always confirm)
- Toggle always visible in chat header
- Inline cards in chat flow (non-blocking, can scroll past)

**Extends Phase 27 infrastructure:**
@v2/src/components/chat/ChatPanel.tsx
@v2/src/components/chat/ChatHeader.tsx
@v2/src/components/chat/ToolCallCard.tsx

**Existing confirmation patterns:**
@v2/src/components/demo/DeleteConfirmDialog.tsx
@v2/src/components/ui/dialog.tsx

**User profile storage:**
@v2/convex/users.ts

**Design system:**
- Neobrutalist: 2px borders, hard shadows (4px 4px 0px)
- Forest Green accent (#228B22)
- Space Grotesk headings, Inter body, JetBrains Mono for data
- Spring physics animations (motion/react)

**CRITICAL: All UI work MUST use frontend-design skill (plugin).**
Read `.planning/FRONTEND_DESIGN_SKILL.md` before implementing any visual components.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add actionMode field to userProfiles</name>
  <files>v2/convex/schema.ts, v2/convex/users.ts</files>
  <exploration>
    Use Explore agent to find: current userProfiles schema fields, existing preference storage patterns, how other settings are persisted.
  </exploration>
  <action>
    1. Add `actionMode` field to userProfiles table in schema.ts:
       ```typescript
       actionMode: v.optional(v.union(v.literal("off"), v.literal("confirm"), v.literal("auto"))),
       ```
       Default to "confirm" (safest default).

    2. Add mutation in users.ts:
       ```typescript
       export const updateActionMode = mutation({
         args: { actionMode: v.union(v.literal("off"), v.literal("confirm"), v.literal("auto")) },
         handler: async (ctx, args) => {
           const userId = await getCurrentUserId(ctx);
           const profile = await ctx.db.query("userProfiles").withIndex("by_userId", q => q.eq("userId", userId)).first();
           if (!profile) throw new Error("Profile not found");
           await ctx.db.patch(profile._id, { actionMode: args.actionMode });
           return { success: true, actionMode: args.actionMode };
         }
       });
       ```

    3. Add query to get current action mode:
       ```typescript
       export const getActionMode = query({
         handler: async (ctx) => {
           const userId = await getCurrentUserIdOrNull(ctx);
           if (!userId) return "confirm"; // Default for logged out
           const profile = await ctx.db.query("userProfiles").withIndex("by_userId", q => q.eq("userId", userId)).first();
           return profile?.actionMode ?? "confirm";
         }
       });
       ```

    4. Update ensureUserProfile to include actionMode with default "confirm".
  </action>
  <verify>npx convex dev runs without errors, new field appears in schema</verify>
  <done>actionMode field in userProfiles, updateActionMode mutation, getActionMode query working</done>
</task>

<task type="auto">
  <name>Task 2: Create ActionModeToggle component</name>
  <files>v2/src/components/chat/ActionModeToggle.tsx, v2/src/components/chat/ChatHeader.tsx</files>
  <exploration>
    Use Explore agent to find: existing toggle/segmented control patterns in v2, ChatHeader layout, how other settings toggles work.
    Read `.planning/FRONTEND_DESIGN_SKILL.md` for design guidance.
  </exploration>
  <action>
    1. Create ActionModeToggle.tsx - segmented control with three options:
       ```typescript
       interface ActionModeToggleProps {
         mode: "off" | "confirm" | "auto";
         onChange: (mode: "off" | "confirm" | "auto") => void;
         disabled?: boolean;
       }
       ```

    2. Visual design (neobrutalist):
       - Container: 2px black border, bg-white, rounded-none
       - Three segments: OFF | CONFIRM | AUTO
       - Active segment: bg-accent (Forest Green), text-white
       - Inactive: bg-white, text-ink, hover:bg-gray-100
       - Hard shadow on container (2px 2px 0px)
       - Transition: 150ms for segment switch

    3. Icons for each mode:
       - OFF: EyeOff (lucide-react) - read only
       - CONFIRM: ShieldCheck - permission required
       - AUTO: Zap - automatic execution

    4. Tooltip on hover explaining each mode:
       - OFF: "Read-only mode - I'll only answer questions"
       - CONFIRM: "I'll ask before taking actions"
       - AUTO: "I'll act immediately (destructive actions still ask)"

    5. Integrate into ChatHeader.tsx:
       - Position: right side of header, before close button
       - Use useQuery for getActionMode
       - Use useMutation for updateActionMode
       - Optimistic update on click

    6. Add motion animation for segment switch (scale pulse).
  </action>
  <verify>Toggle renders in chat header, clicking changes mode, persists to Convex</verify>
  <done>ActionModeToggle component working, integrated into ChatHeader, mode persists</done>
</task>

<task type="auto">
  <name>Task 3: Create InChatConfirmationCard component</name>
  <files>v2/src/components/chat/InChatConfirmationCard.tsx, v2/src/components/chat/index.ts</files>
  <exploration>
    Use Explore agent to find: ToolCallCard structure, existing card animations, DeleteConfirmDialog patterns.
    Read `.planning/FRONTEND_DESIGN_SKILL.md` for design guidance.
  </exploration>
  <action>
    1. Create InChatConfirmationCard.tsx:
       ```typescript
       interface InChatConfirmationCardProps {
         toolName: string;
         toolCallId: string;
         arguments: Record<string, unknown>;
         description: string;
         isDestructive?: boolean;
         status: "pending" | "approved" | "denied" | "executing" | "done" | "error";
         onApprove: () => void;
         onDeny: () => void;
         duration?: number; // ms, shown after done
         error?: string;
       }
       ```

    2. Visual design (from 28-CONTEXT.md):
       ```
       ┌─────────────────────────────────────────────────┐
       │ ┌──────┐                                        │
       │ │ Icon │  Tool Name                   ⏳ 234ms  │
       │ └──────┘                                        │
       ├─────────────────────────────────────────────────┤
       │ status: recruitment  caseId: abc123             │ <- Arguments (mono)
       ├─────────────────────────────────────────────────┤
       │ "Update case status to Recruitment"             │ <- Description
       ├─────────────────────────────────────────────────┤
       │ [Cancel]                          [Confirm ✓]   │ <- Actions
       └─────────────────────────────────────────────────┘
       ```

    3. Status-based styling:
       - pending: primary border (Forest Green), shimmer effect
       - approved: green left border, checkmark icon
       - denied: gray styling, X icon
       - executing: spinner, pulsing border
       - done: green styling, duration badge
       - error: red styling, error message

    4. Destructive variant:
       - Red left border (4px instead of 2px)
       - Red icon
       - Warning icon next to tool name
       - Delete button uses destructive variant

    5. Animation (motion/react):
       - Entry: spring animation (opacity 0→1, y: 8→0)
       - Status transition: scale pulse (1→1.02→1)
       - Exit: fade out

    6. Buttons:
       - Cancel: secondary variant, gray
       - Confirm: primary variant (or destructive for destructive tools)
       - Hide buttons after approval/denial

    7. Use existing tool-icons.tsx for icons and colors.

    8. Export from index.ts.
  </action>
  <verify>Component renders with all status states, buttons work, animations smooth</verify>
  <done>InChatConfirmationCard component complete with all states and animations</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev` runs without errors
- [ ] `pnpm build` succeeds in v2/
- [ ] ActionModeToggle visible in chat header
- [ ] Clicking toggle changes mode and persists to Convex
- [ ] InChatConfirmationCard renders correctly for all 6 status states
- [ ] Destructive variant has red styling
- [ ] Animations work (entry, status transition)
- [ ] No TypeScript errors
</verification>

<success_criteria>
- actionMode field in userProfiles with CONFIRM as default
- ActionModeToggle in chat header with 3 modes
- InChatConfirmationCard component ready for action tool integration
- All animations smooth and following design system
- TypeScript strict mode passing
</success_criteria>

<output>
After completion, create `.planning/phases/28-action-layer/28-01-SUMMARY.md`:

# Phase 28 Plan 01: Permission Infrastructure Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 28-02-PLAN.md (Navigation & Read Tools)
</output>
