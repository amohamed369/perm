---
phase: 16-deadline-validation-core
plan: 04
type: execute
domain: validation
---

<objective>
Implement the cascade reducer for real-time field recalculation and create the public API.

Purpose: Enable instant recalculation of downstream fields when upstream fields change.
Output: Cascade reducer, public perm-engine API, and comprehensive integration tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-deadline-validation-core/16-RESEARCH.md
@.planning/phases/16-deadline-validation-core/16-CONTEXT.md
@.planning/phases/16-deadline-validation-core/16-01-SUMMARY.md
@.planning/phases/16-deadline-validation-core/16-02-SUMMARY.md
@.planning/phases/16-deadline-validation-core/16-03-SUMMARY.md
@.planning/V2_VALIDATION_RULES.md

**Prior decisions affecting this phase:**
- Plan 01: types.ts with CaseData, FieldChange ready
- Plan 02: All calculators ready
- Plan 03: All validators ready
- Research: Cascade as directed acyclic graph (DAG) - no loops

**Cascade rules from V2_VALIDATION_RULES.md:**
- V-CASCADE-01: PWDDD → PWDED (auto-recalculate expiration)
- V-CASCADE-02: PWDDD/PWDED → All recruitment deadlines
- V-CASCADE-03: First recruitment → All recruitment deadlines
- V-CASCADE-04: Notice start → Notice end (extend-only)
- V-CASCADE-05: Job order start → Job order end (extend-only)

**Key requirements from CONTEXT:**
- Cascade works client-side for instant feedback AND server-side for authoritative validation
- DAG structure: never cascade back to upstream dependencies (avoid loops)
- "Extend-only" for Notice end and Job order end (can extend, not shorten)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement cascade reducer with TDD</name>
  <files>v2/src/lib/perm-engine/cascade.ts, v2/src/lib/perm-engine/cascade.test.ts</files>
  <action>
**TDD Approach: Write tests FIRST, then implement.**

1. Create `cascade.test.ts` with tests for all cascade rules:
```typescript
import { applyCascade, CascadeChange } from './cascade';
import type { CaseData } from './types';

const createEmptyCase = (): Partial<CaseData> => ({
  pwd_filing_date: null,
  pwd_determination_date: null,
  pwd_expiration_date: null,
  sunday_ad_first_date: null,
  sunday_ad_second_date: null,
  job_order_start_date: null,
  job_order_end_date: null,
  notice_of_filing_start_date: null,
  notice_of_filing_end_date: null,
  eta9089_filing_date: null,
  eta9089_certification_date: null,
  eta9089_expiration_date: null,
  i140_filing_date: null,
  i140_approval_date: null,
  is_professional_occupation: false,
  case_status: 'pwd',
  progress_status: 'working',
});

describe('applyCascade', () => {
  // V-CASCADE-01: PWDDD → PWDED
  test('V-CASCADE-01: PWDDD change recalculates PWDED', () => {
    const currentState = createEmptyCase();
    const change: CascadeChange = {
      field: 'pwd_determination_date',
      value: '2024-05-15',
    };

    const newState = applyCascade(currentState as CaseData, change);

    expect(newState.pwd_determination_date).toBe('2024-05-15');
    expect(newState.pwd_expiration_date).toBe('2024-08-13'); // 90 days
  });

  test('V-CASCADE-01: clearing PWDDD clears PWDED', () => {
    const currentState = {
      ...createEmptyCase(),
      pwd_determination_date: '2024-05-15',
      pwd_expiration_date: '2024-08-13',
    };
    const change: CascadeChange = {
      field: 'pwd_determination_date',
      value: null,
    };

    const newState = applyCascade(currentState as CaseData, change);

    expect(newState.pwd_determination_date).toBeNull();
    expect(newState.pwd_expiration_date).toBeNull();
  });

  // V-CASCADE-04: Notice start → Notice end (extend-only)
  test('V-CASCADE-04: notice start sets notice end to +10 business days', () => {
    const currentState = createEmptyCase();
    const change: CascadeChange = {
      field: 'notice_of_filing_start_date',
      value: '2025-01-15',
    };

    const newState = applyCascade(currentState as CaseData, change);

    expect(newState.notice_of_filing_start_date).toBe('2025-01-15');
    expect(newState.notice_of_filing_end_date).toBe('2025-01-29'); // +10 biz days
  });

  test('V-CASCADE-04: notice end extend-only - cannot shorten', () => {
    const currentState = {
      ...createEmptyCase(),
      notice_of_filing_start_date: '2025-01-15',
      notice_of_filing_end_date: '2025-02-15', // User extended to Feb 15
    };
    // If start doesn't change, end shouldn't shrink
    const change: CascadeChange = {
      field: 'notice_of_filing_start_date',
      value: '2025-01-15', // Same start
    };

    const newState = applyCascade(currentState as CaseData, change);

    // End should NOT shrink to Jan 29, keep user extension
    expect(newState.notice_of_filing_end_date).toBe('2025-02-15');
  });

  // V-CASCADE-05: Job order start → Job order end (extend-only)
  test('V-CASCADE-05: job order start sets end to +30 days', () => {
    const currentState = createEmptyCase();
    const change: CascadeChange = {
      field: 'job_order_start_date',
      value: '2024-04-01',
    };

    const newState = applyCascade(currentState as CaseData, change);

    expect(newState.job_order_start_date).toBe('2024-04-01');
    expect(newState.job_order_end_date).toBe('2024-05-01'); // +30 days
  });

  test('V-CASCADE-05: job order end extend-only - cannot shorten', () => {
    const currentState = {
      ...createEmptyCase(),
      job_order_start_date: '2024-04-01',
      job_order_end_date: '2024-06-01', // User extended to June 1
    };
    const change: CascadeChange = {
      field: 'job_order_start_date',
      value: '2024-04-01', // Same start
    };

    const newState = applyCascade(currentState as CaseData, change);

    // End should NOT shrink to May 1, keep user extension
    expect(newState.job_order_end_date).toBe('2024-06-01');
  });

  // ETA 9089 certification → expiration
  test('ETA certification sets expiration to +180 days', () => {
    const currentState = createEmptyCase();
    const change: CascadeChange = {
      field: 'eta9089_certification_date',
      value: '2024-10-01',
    };

    const newState = applyCascade(currentState as CaseData, change);

    expect(newState.eta9089_certification_date).toBe('2024-10-01');
    expect(newState.eta9089_expiration_date).toBe('2025-03-30'); // +180 days
  });

  // RFI received → due (strict 30 days)
  test('RFI received sets due to +30 days', () => {
    const currentState = createEmptyCase();
    const change: CascadeChange = {
      field: 'rfi_received_date',
      value: '2024-10-15',
    };

    const newState = applyCascade(currentState as CaseData, change);

    expect(newState.rfi_received_date).toBe('2024-10-15');
    expect(newState.rfi_due_date).toBe('2024-11-14'); // +30 days
  });

  // Non-cascade field changes
  test('non-cascade field does not trigger recalculation', () => {
    const currentState = {
      ...createEmptyCase(),
      pwd_expiration_date: '2024-06-30',
    };
    const change: CascadeChange = {
      field: 'sunday_ad_first_date',
      value: '2024-03-17',
    };

    const newState = applyCascade(currentState as CaseData, change);

    expect(newState.sunday_ad_first_date).toBe('2024-03-17');
    expect(newState.pwd_expiration_date).toBe('2024-06-30'); // Unchanged
  });

  // No cascade loops
  test('cascade does not create infinite loops', () => {
    const currentState = createEmptyCase();
    const change: CascadeChange = {
      field: 'pwd_determination_date',
      value: '2024-05-15',
    };

    // This should complete without timeout/error
    const newState = applyCascade(currentState as CaseData, change);
    expect(newState.pwd_determination_date).toBe('2024-05-15');
    expect(newState.pwd_expiration_date).toBe('2024-08-13');
  });
});
```

2. Implement `cascade.ts`:
```typescript
import type { CaseData } from './types';
import { calculatePWDExpiration } from './calculators/pwd';
import { calculateETA9089Expiration } from './calculators/eta9089';
import { calculateNoticeOfFilingEnd, calculateJobOrderEnd } from './calculators/recruitment';
import { calculateRFIDueDate } from './calculators/rfi';
import { addBusinessDays } from './business-days';
import { parseISO, isBefore, format, addDays } from 'date-fns';

export interface CascadeChange {
  field: keyof CaseData;
  value: string | null | boolean;
}

/**
 * Apply a field change and cascade to all dependent fields.
 * Implements the DAG: PWDDD → PWDED → recruitment deadlines (no loops)
 */
export function applyCascade(
  currentState: CaseData,
  change: CascadeChange
): CaseData {
  // Start with the changed field
  let newState: CaseData = { ...currentState, [change.field]: change.value };

  // V-CASCADE-01: PWDDD → PWDED
  if (change.field === 'pwd_determination_date') {
    if (change.value) {
      newState.pwd_expiration_date = calculatePWDExpiration(change.value as string);
    } else {
      newState.pwd_expiration_date = null;
    }
  }

  // V-CASCADE-04: Notice start → Notice end (extend-only)
  if (change.field === 'notice_of_filing_start_date') {
    if (change.value) {
      const minEnd = addBusinessDays(change.value as string, 10);
      const currentEnd = currentState.notice_of_filing_end_date;

      // Extend-only: only update if current end is null or less than minimum
      if (!currentEnd || isBefore(parseISO(currentEnd), parseISO(minEnd))) {
        newState.notice_of_filing_end_date = minEnd;
      }
    } else {
      newState.notice_of_filing_end_date = null;
    }
  }

  // V-CASCADE-05: Job order start → Job order end (extend-only)
  if (change.field === 'job_order_start_date') {
    if (change.value) {
      const minEnd = calculateJobOrderEnd(change.value as string);
      const currentEnd = currentState.job_order_end_date;

      // Extend-only: only update if current end is null or less than minimum
      if (!currentEnd || isBefore(parseISO(currentEnd), parseISO(minEnd))) {
        newState.job_order_end_date = minEnd;
      }
    } else {
      newState.job_order_end_date = null;
    }
  }

  // ETA 9089 certification → expiration
  if (change.field === 'eta9089_certification_date') {
    if (change.value) {
      newState.eta9089_expiration_date = calculateETA9089Expiration(change.value as string);
    } else {
      newState.eta9089_expiration_date = null;
    }
  }

  // RFI received → due (strict 30 days, NOT extend-only)
  if (change.field === 'rfi_received_date') {
    if (change.value) {
      newState.rfi_due_date = calculateRFIDueDate(change.value as string);
    } else {
      newState.rfi_due_date = null;
    }
  }

  return newState;
}

/**
 * Apply multiple changes sequentially.
 * Useful for form submission with multiple field updates.
 */
export function applyCascadeMultiple(
  currentState: CaseData,
  changes: CascadeChange[]
): CaseData {
  return changes.reduce(
    (state, change) => applyCascade(state, change),
    currentState
  );
}
```
  </action>
  <verify>
- `cd v2 && pnpm test cascade` passes all tests (15+ tests)
- Cascade rules match V2_VALIDATION_RULES.md
- Extend-only behavior verified for Notice and Job order end dates
- No infinite loops possible
  </verify>
  <done>Cascade reducer implemented with TDD, all 5 cascade rules covered, extend-only enforced</done>
</task>

<task type="auto">
  <name>Task 2: Create public API and integration tests</name>
  <files>v2/src/lib/perm-engine/index.ts, v2/src/lib/perm-engine/integration.test.ts</files>
  <action>
1. Update `index.ts` to be the clean public API:
```typescript
// =============================================================================
// PERM Engine - Public API
// =============================================================================
// Isomorphic TypeScript library for PERM deadline calculations and validation.
// Runs on both client (React) and server (Convex).
// =============================================================================

// Types
export type {
  ValidationSeverity,
  ValidationIssue,
  ValidationResult,
  CaseData,
  CaseStatus,
  ProgressStatus,
  FieldChange,
  RecruitmentDeadlines,
  Holiday,
} from './types';

// Utilities
export { getFederalHolidays, isFederalHoliday, isBusinessDay } from './holidays';
export { addBusinessDays, countBusinessDays } from './business-days';

// Calculators
export {
  calculatePWDExpiration,
} from './calculators/pwd';

export {
  calculateETA9089Window,
  calculateETA9089Expiration,
  calculateRecruitmentEnd,
} from './calculators/eta9089';

export {
  calculateRecruitmentDeadlines,
  calculateNoticeOfFilingEnd,
  calculateJobOrderEnd,
  lastSundayOnOrBefore,
} from './calculators/recruitment';

export {
  calculateI140FilingDeadline,
} from './calculators/i140';

export {
  calculateRFIDueDate,
} from './calculators/rfi';

// Validators
export { validatePWDDates } from './validators/pwd';
export { validateRecruitmentDates } from './validators/recruitment';
export { validateETA9089Dates } from './validators/eta9089';
export { validateI140Dates } from './validators/i140';
export { validateRFIDates } from './validators/rfi';
export { validateRFEDates } from './validators/rfe';
export { validateCase } from './validators/validate-case';

// Cascade
export { applyCascade, applyCascadeMultiple } from './cascade';
export type { CascadeChange } from './cascade';
```

2. Create `integration.test.ts` with end-to-end tests:
```typescript
import {
  calculatePWDExpiration,
  calculateRecruitmentDeadlines,
  applyCascade,
  validateCase,
  isBusinessDay,
  isFederalHoliday,
} from './index';
import type { CaseData, CascadeChange } from './index';

describe('perm-engine integration', () => {
  describe('full case lifecycle', () => {
    test('PWD → Recruitment → ETA 9089 → I-140 workflow', () => {
      // Step 1: PWD determination triggers expiration calculation
      let caseData: Partial<CaseData> = {
        pwd_filing_date: '2024-01-15',
        pwd_determination_date: null,
        pwd_expiration_date: null,
      };

      // PWD determined - cascade calculates expiration
      caseData = applyCascade(caseData as CaseData, {
        field: 'pwd_determination_date',
        value: '2024-05-15',
      });
      expect(caseData.pwd_expiration_date).toBe('2024-08-13');

      // Step 2: Recruitment begins
      caseData = applyCascade(caseData as CaseData, {
        field: 'job_order_start_date',
        value: '2024-05-20',
      });
      expect(caseData.job_order_end_date).toBe('2024-06-19'); // +30 days

      // Step 3: Validate the case
      const validationResult = validateCase({
        ...caseData,
        sunday_ad_first_date: '2024-05-26', // Sunday
        sunday_ad_second_date: '2024-06-02', // Sunday
      } as CaseData);

      // Should have no errors for this valid case
      expect(validationResult.errors.length).toBe(0);
    });
  });

  describe('edge cases', () => {
    test('PWD determined on April 1 uses June 30 same year rule', () => {
      const expiration = calculatePWDExpiration('2024-04-01');
      expect(expiration).toBe('2024-06-30');
    });

    test('PWD determined on April 2 uses 90-day rule', () => {
      const expiration = calculatePWDExpiration('2024-04-02');
      expect(expiration).toBe('2024-07-01');
    });

    test('recruitment deadlines tight timeline', () => {
      // First recruitment Mar 1, PWD expires Apr 30 (60 days)
      const deadlines = calculateRecruitmentDeadlines('2024-03-01', '2024-04-30');

      // All deadlines constrained by PWD expiration
      expect(deadlines.notice_of_filing_deadline).toBe('2024-03-31');
    });
  });

  describe('holiday awareness', () => {
    test('MLK Day 2025 is not a business day', () => {
      expect(isFederalHoliday('2025-01-20')).toBe(true);
      expect(isBusinessDay('2025-01-20')).toBe(false);
    });

    test('Inauguration Day 2025 is a holiday', () => {
      // Jan 20, 2025 is both MLK Day and Inauguration Day
      expect(isFederalHoliday('2025-01-20')).toBe(true);
    });

    test('Inauguration Day 2024 is NOT a holiday', () => {
      // 2024 is not an inauguration year
      expect(isFederalHoliday('2024-01-20')).toBe(false);
    });
  });

  describe('validation rule coverage', () => {
    test('validates all PWD rules', () => {
      const result = validateCase({
        pwd_filing_date: '2024-02-01',
        pwd_determination_date: '2024-01-15', // V-PWD-01: filing >= determination
        pwd_expiration_date: '2024-06-30',
        // ... other fields null
      } as CaseData);

      expect(result.errors.some(e => e.ruleId === 'V-PWD-01')).toBe(true);
    });

    test('validates Sunday ad rules', () => {
      const result = validateCase({
        pwd_filing_date: null,
        pwd_determination_date: null,
        pwd_expiration_date: null,
        sunday_ad_first_date: '2024-03-15', // Friday - not Sunday!
        sunday_ad_second_date: null,
        // ... other fields null
      } as CaseData);

      expect(result.errors.some(e => e.ruleId === 'V-REC-01')).toBe(true);
    });
  });
});
```

3. Verify all exports work correctly by importing from the public API.
  </action>
  <verify>
- `cd v2 && pnpm test integration` passes all tests (15+ tests)
- All exports from index.ts work correctly
- Full case lifecycle test passes
- Holiday awareness verified
  </verify>
  <done>Public API created, integration tests pass, perm-engine ready for use</done>
</task>

<task type="auto">
  <name>Task 3: Final test count verification and documentation</name>
  <files>v2/src/lib/perm-engine/README.md, v2/TEST_README.md</files>
  <action>
1. Run full test suite and verify test count:
```bash
cd v2 && pnpm test --reporter=verbose 2>&1 | grep -E "^(PASS|FAIL|✓|✗)" | wc -l
```

Target: 100+ tests across all perm-engine files

2. Create `v2/src/lib/perm-engine/README.md`:
```markdown
# PERM Engine

Isomorphic TypeScript library for PERM deadline calculations and validation.

## Usage

```typescript
import {
  calculatePWDExpiration,
  validateCase,
  applyCascade,
} from '@/lib/perm-engine';

// Calculate PWD expiration
const expiration = calculatePWDExpiration('2024-05-15');
// Returns: '2024-08-13'

// Validate a case
const result = validateCase(caseData);
if (!result.valid) {
  console.log(result.errors);
}

// Apply cascade (real-time recalculation)
const newState = applyCascade(currentState, {
  field: 'pwd_determination_date',
  value: '2024-05-15',
});
// newState.pwd_expiration_date is automatically set
```

## API Reference

### Calculators
- `calculatePWDExpiration(determinationDate)` - PWD expiration per 20 CFR § 656.40(c)
- `calculateRecruitmentDeadlines(firstDate, pwdExpiration)` - All recruitment step deadlines
- `calculateETA9089Window(recruitmentEnd)` - 30-180 day filing window
- `calculateETA9089Expiration(certificationDate)` - 180 days after certification
- `calculateI140FilingDeadline(certificationDate)` - 180 days after ETA certification
- `calculateRFIDueDate(receivedDate)` - Strict 30 days (not editable)

### Validators
- `validateCase(caseData)` - Validate all 44 rules
- `validatePWDDates(dates)` - V-PWD-01 to V-PWD-04
- `validateRecruitmentDates(dates)` - V-REC-01 to V-REC-12
- `validateETA9089Dates(dates)` - V-ETA-01 to V-ETA-05
- `validateI140Dates(dates)` - V-I140-01 to V-I140-03
- `validateRFIDates(dates)` - V-RFI-01 to V-RFI-05
- `validateRFEDates(dates)` - V-RFE-01 to V-RFE-05

### Cascade
- `applyCascade(currentState, change)` - Apply single change with cascade
- `applyCascadeMultiple(currentState, changes)` - Apply multiple changes

### Utilities
- `addBusinessDays(date, days)` - Add N business days (excludes holidays)
- `countBusinessDays(start, end)` - Count business days between dates
- `isFederalHoliday(date)` - Check if date is a federal holiday
- `isBusinessDay(date)` - Check if date is a business day

## Validation Rules

44 rules across 8 categories:
- PWD (4): V-PWD-01 to V-PWD-04
- Recruitment (12): V-REC-01 to V-REC-12
- ETA 9089 (5): V-ETA-01 to V-ETA-05
- I-140 (3): V-I140-01 to V-I140-03
- RFI (5): V-RFI-01 to V-RFI-05
- RFE (5): V-RFE-01 to V-RFE-05
- Cascade (5): V-CASCADE-01 to V-CASCADE-05
- System (5): V-SYS-01 to V-SYS-05

See `.planning/V2_VALIDATION_RULES.md` for complete documentation.

## Testing

```bash
pnpm test              # Run all tests
pnpm test holidays     # Run holiday tests only
pnpm test validators   # Run validator tests only
```

## Architecture

```
src/lib/perm-engine/
├── index.ts           # Public API
├── types.ts           # TypeScript types
├── holidays.ts        # Federal holiday detection
├── business-days.ts   # Business day calculations
├── cascade.ts         # Cascade reducer
├── calculators/
│   ├── pwd.ts         # PWD expiration
│   ├── recruitment.ts # Recruitment deadlines
│   ├── eta9089.ts     # ETA 9089 window/expiration
│   ├── i140.ts        # I-140 deadline
│   └── rfi.ts         # RFI due date
└── validators/
    ├── pwd.ts         # PWD validation
    ├── recruitment.ts # Recruitment validation
    ├── eta9089.ts     # ETA 9089 validation
    ├── i140.ts        # I-140 validation
    ├── rfi.ts         # RFI validation
    ├── rfe.ts         # RFE validation
    └── validate-case.ts # Master validator
```
```

3. Update `v2/TEST_README.md` to include perm-engine test information.

4. Run final test count verification:
```bash
cd v2 && pnpm test -- --coverage
```
  </action>
  <verify>
- `cd v2 && pnpm test` runs all tests successfully
- Test count: 100+ tests total
- README.md created with complete API documentation
- All perm-engine functionality documented
  </verify>
  <done>Phase 16 complete - perm-engine ready with 100+ tests, full documentation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd v2 && pnpm test` runs ALL perm-engine tests
- [ ] Test count: 100+ tests (holidays, calculators, validators, cascade, integration)
- [ ] All exports from index.ts work correctly
- [ ] README.md documents all public API
- [ ] Cascade reducer handles extend-only correctly
- [ ] No infinite loops in cascade
- [ ] Full case lifecycle test passes
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Phase 16 complete: Central TypeScript validation module ready
- perm-engine can be used by both client (React) and server (Convex)
</success_criteria>

<output>
After completion, create `.planning/phases/16-deadline-validation-core/16-04-SUMMARY.md`:

# Phase 16 Plan 04: Cascade Reducer + Public API Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- Cascade reducer with all 5 V-CASCADE rules
- Extend-only behavior for Notice and Job order end dates
- Public API in index.ts with clean exports
- Integration tests for full case lifecycle
- README.md with complete API documentation

## Files Created/Modified

- `v2/src/lib/perm-engine/cascade.ts` + tests
- `v2/src/lib/perm-engine/index.ts` - Public API
- `v2/src/lib/perm-engine/integration.test.ts`
- `v2/src/lib/perm-engine/README.md`
- `v2/TEST_README.md` (updated)

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Phase 16 Complete

Central TypeScript validation module shipped with:
- 44 validation rules implemented
- Pure date calculators using date-fns
- Federal holiday detection (11-12 holidays/year)
- Business day calculations
- Cascade reducer for real-time recalculation
- 100+ tests

Ready for Phase 17 (Design System)
</output>
