---
phase: 16-deadline-validation-core
plan: 02
type: execute
domain: validation
---

<objective>
Implement all date calculation functions (PWD, recruitment, ETA 9089, I-140).

Purpose: Create pure calculator functions that compute deadlines and expiration dates.
Output: Calculator modules with comprehensive test coverage.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-deadline-validation-core/16-RESEARCH.md
@.planning/phases/16-deadline-validation-core/16-CONTEXT.md
@.planning/phases/16-deadline-validation-core/16-01-SUMMARY.md
@.planning/V2_DEADLINE_FLOWS.md
@.planning/V2_BUSINESS_RULES.md

**Prior decisions affecting this phase:**
- Plan 01: date-fns installed, types.ts, holidays.ts, business-days.ts ready
- Research: Pure functions accepting ISO strings, returning ISO strings
- DEADLINE_FLOWS: PWD expiration formula with Apr 2-Jun 30 special case

**Key formulas from V2_DEADLINE_FLOWS.md:**
- PWD expiration: 90 days if Apr 2-Jun 30, else June 30 same/next year
- ETA 9089 window: recruitment_end + 30 to recruitment_end + 180
- ETA 9089 expiration: certification + 180 days
- I-140 deadline: certification + 180 days

**Key formulas from CONTEXT (perm_flow.md):**
- Notice deadline: min(first+150, pwded-30)
- Job order START deadline: min(first+120, pwded-60)
- 1st Sunday: lastSunday(min(first+143, pwded-37))
- 2nd Sunday: lastSunday(min(first+150, pwded-30))
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PWD and ETA 9089 calculators with TDD</name>
  <files>v2/src/lib/perm-engine/calculators/pwd.ts, v2/src/lib/perm-engine/calculators/pwd.test.ts, v2/src/lib/perm-engine/calculators/eta9089.ts, v2/src/lib/perm-engine/calculators/eta9089.test.ts</files>
  <action>
**TDD Approach: Write tests FIRST, then implement.**

1. Create calculators directory: `v2/src/lib/perm-engine/calculators/`

2. Create `pwd.test.ts` with tests from V2_DEADLINE_FLOWS.md examples:
```typescript
describe('calculatePWDExpiration', () => {
  // Case 1: April 2 - June 30 (90-day rule)
  test('May 15 determination → August 13 expiration (90 days)', () => {
    expect(calculatePWDExpiration('2024-05-15')).toBe('2024-08-13');
  });

  test('April 2 determination → July 1 expiration (90 days)', () => {
    expect(calculatePWDExpiration('2024-04-02')).toBe('2024-07-01');
  });

  test('June 30 determination → September 28 expiration (90 days)', () => {
    expect(calculatePWDExpiration('2024-06-30')).toBe('2024-09-28');
  });

  // Case 2: July 1 - December 31 (June 30 next year)
  test('September 10 determination → June 30 next year', () => {
    expect(calculatePWDExpiration('2024-09-10')).toBe('2025-06-30');
  });

  test('July 1 determination → June 30 next year', () => {
    expect(calculatePWDExpiration('2024-07-01')).toBe('2025-06-30');
  });

  test('December 31 determination → June 30 next year', () => {
    expect(calculatePWDExpiration('2024-12-31')).toBe('2025-06-30');
  });

  // Case 3: January 1 - April 1 (June 30 same year)
  test('February 5 determination → June 30 same year', () => {
    expect(calculatePWDExpiration('2024-02-05')).toBe('2024-06-30');
  });

  test('April 1 determination → June 30 same year (NOT 90 days)', () => {
    expect(calculatePWDExpiration('2024-04-01')).toBe('2024-06-30');
  });

  test('January 1 determination → June 30 same year', () => {
    expect(calculatePWDExpiration('2024-01-01')).toBe('2024-06-30');
  });

  // Leap year edge case
  test('handles leap year correctly (Feb 29 in calculation)', () => {
    // April 2, 2024 + 90 days crosses no leap issues
    // But test a case where 90 days might cross Feb
    expect(calculatePWDExpiration('2023-12-01')).toBe('2024-06-30'); // Jan-Apr rule
  });
});
```

3. Implement `pwd.ts`:
```typescript
import { parseISO, format, addDays } from 'date-fns';

export function calculatePWDExpiration(determinationDate: string): string {
  const date = parseISO(determinationDate);
  const month = date.getMonth(); // 0-indexed (0=Jan, 3=Apr, 5=Jun)
  const day = date.getDate();
  const year = date.getFullYear();

  // Case 1: April 2 - June 30 → determination + 90 days
  if ((month === 3 && day >= 2) || month === 4 || (month === 5 && day <= 30)) {
    return format(addDays(date, 90), 'yyyy-MM-dd');
  }

  // Case 2: July 1 - December 31 → June 30 of following year
  if (month >= 6) {
    return `${year + 1}-06-30`;
  }

  // Case 3: January 1 - April 1 → June 30 of same year
  return `${year}-06-30`;
}
```

4. Create `eta9089.test.ts`:
```typescript
describe('calculateETA9089Window', () => {
  test('recruitment end June 30 → window July 30 to Dec 27', () => {
    const window = calculateETA9089Window('2024-06-30');
    expect(window.opens).toBe('2024-07-30');
    expect(window.closes).toBe('2024-12-27');
  });
});

describe('calculateETA9089Expiration', () => {
  test('certification + 180 days', () => {
    expect(calculateETA9089Expiration('2024-10-01')).toBe('2025-03-30');
  });
});

describe('calculateRecruitmentEnd', () => {
  test('returns latest of second Sunday and job order end', () => {
    expect(calculateRecruitmentEnd('2024-03-10', '2024-03-31')).toBe('2024-03-31');
    expect(calculateRecruitmentEnd('2024-04-15', '2024-03-31')).toBe('2024-04-15');
  });

  test('handles null values', () => {
    expect(calculateRecruitmentEnd('2024-03-10', null)).toBe('2024-03-10');
    expect(calculateRecruitmentEnd(null, '2024-03-31')).toBe('2024-03-31');
    expect(calculateRecruitmentEnd(null, null)).toBeNull();
  });
});
```

5. Implement `eta9089.ts`:
```typescript
import { parseISO, format, addDays, max } from 'date-fns';

export function calculateETA9089Window(recruitmentEndDate: string): {
  opens: string;
  closes: string;
} {
  const date = parseISO(recruitmentEndDate);
  return {
    opens: format(addDays(date, 30), 'yyyy-MM-dd'),
    closes: format(addDays(date, 180), 'yyyy-MM-dd'),
  };
}

export function calculateETA9089Expiration(certificationDate: string): string {
  const date = parseISO(certificationDate);
  return format(addDays(date, 180), 'yyyy-MM-dd');
}

export function calculateRecruitmentEnd(
  secondSundayAdDate: string | null,
  jobOrderEndDate: string | null
): string | null {
  if (!secondSundayAdDate && !jobOrderEndDate) return null;
  if (!secondSundayAdDate) return jobOrderEndDate;
  if (!jobOrderEndDate) return secondSundayAdDate;

  const second = parseISO(secondSundayAdDate);
  const jobOrder = parseISO(jobOrderEndDate);
  return format(max([second, jobOrder]), 'yyyy-MM-dd');
}
```

6. Export from calculators/index.ts and perm-engine/index.ts.
  </action>
  <verify>
- `cd v2 && pnpm test pwd` passes all tests (10+ tests)
- `cd v2 && pnpm test eta9089` passes all tests (5+ tests)
  </verify>
  <done>PWD and ETA 9089 calculators implemented with TDD, all edge cases covered</done>
</task>

<task type="auto">
  <name>Task 2: Implement recruitment deadline calculators with TDD</name>
  <files>v2/src/lib/perm-engine/calculators/recruitment.ts, v2/src/lib/perm-engine/calculators/recruitment.test.ts</files>
  <action>
**TDD Approach: Write tests FIRST, then implement.**

1. Create `recruitment.test.ts` with tests from V2_DEADLINE_FLOWS.md:
```typescript
describe('calculateRecruitmentDeadlines', () => {
  test('basic case - first recruitment far from PWD expiration', () => {
    // First: Jan 15, PWD expires: Dec 31 (11.5 months away)
    // All deadlines driven by first recruitment + N days
    const deadlines = calculateRecruitmentDeadlines('2024-01-15', '2024-12-31');

    // Notice: min(first+150, pwded-30) = min(Jun 13, Dec 1) = Jun 13
    expect(deadlines.notice_of_filing_deadline).toBe('2024-06-13');

    // Job order START: min(first+120, pwded-60) = min(May 14, Nov 1) = May 14
    expect(deadlines.job_order_start_deadline).toBe('2024-05-14');

    // 2nd Sunday: lastSunday(min(first+150, pwded-30)) = lastSunday(Jun 13) = Jun 9
    expect(deadlines.second_sunday_ad_deadline).toBe('2024-06-09');

    // 1st Sunday: lastSunday(min(first+143, pwded-37)) = lastSunday(Jun 6) = Jun 2
    expect(deadlines.first_sunday_ad_deadline).toBe('2024-06-02');
  });

  test('tight timeline - PWD expiring soon drives deadlines', () => {
    // First: Mar 1, PWD expires: Apr 30 (60 days away)
    // PWD constraint dominates
    const deadlines = calculateRecruitmentDeadlines('2024-03-01', '2024-04-30');

    // Notice: min(first+150, pwded-30) = min(Jul 29, Mar 31) = Mar 31
    expect(deadlines.notice_of_filing_deadline).toBe('2024-03-31');

    // Job order START: min(first+120, pwded-60) = min(Jun 29, Mar 1) = Mar 1
    expect(deadlines.job_order_start_deadline).toBe('2024-03-01');

    // 2nd Sunday: lastSunday(Mar 31) = Mar 31 is Sunday in 2024
    expect(deadlines.second_sunday_ad_deadline).toBe('2024-03-31');

    // 1st Sunday: lastSunday(min(first+143, pwded-37)) = lastSunday(Mar 24) = Mar 24
    expect(deadlines.first_sunday_ad_deadline).toBe('2024-03-24');
  });
});

describe('lastSundayOnOrBefore', () => {
  test('returns same day if Sunday', () => {
    expect(lastSundayOnOrBefore('2024-03-31')).toBe('2024-03-31'); // Sunday
  });

  test('returns previous Sunday for Monday', () => {
    expect(lastSundayOnOrBefore('2024-04-01')).toBe('2024-03-31'); // Monday → prev Sunday
  });

  test('returns previous Sunday for Saturday', () => {
    expect(lastSundayOnOrBefore('2024-04-06')).toBe('2024-03-31'); // Saturday → prev Sunday
  });
});

describe('calculateNoticeOfFilingEnd', () => {
  test('adds 10 business days from start', () => {
    // Jan 15, 2025 (Wednesday) + 10 business days
    // Skip MLK Day (Jan 20), weekends
    expect(calculateNoticeOfFilingEnd('2025-01-15')).toBe('2025-01-29');
  });
});

describe('calculateJobOrderEnd', () => {
  test('adds 30 calendar days from start', () => {
    expect(calculateJobOrderEnd('2024-03-01')).toBe('2024-03-31');
  });

  test('handles month boundary', () => {
    expect(calculateJobOrderEnd('2024-01-15')).toBe('2024-02-14');
  });
});
```

2. Implement `recruitment.ts`:
```typescript
import { parseISO, format, addDays, min, getDay } from 'date-fns';
import { addBusinessDays } from '../business-days';

export interface RecruitmentDeadlines {
  notice_of_filing_deadline: string;
  job_order_start_deadline: string;
  first_sunday_ad_deadline: string;
  second_sunday_ad_deadline: string;
  recruitment_window_closes: string;
}

export function calculateRecruitmentDeadlines(
  firstRecruitmentDate: string,
  pwdExpirationDate: string
): RecruitmentDeadlines {
  const first = parseISO(firstRecruitmentDate);
  const pwded = parseISO(pwdExpirationDate);

  // Notice of Filing deadline: min(first+150, pwded-30)
  const noticeDeadline = min([
    addDays(first, 150),
    addDays(pwded, -30)
  ]);

  // Job Order START deadline: min(first+120, pwded-60)
  const jobOrderStartDeadline = min([
    addDays(first, 120),
    addDays(pwded, -60)
  ]);

  // 2nd Sunday deadline: lastSunday(min(first+150, pwded-30))
  const secondSundayMax = min([
    addDays(first, 150),
    addDays(pwded, -30)
  ]);
  const secondSundayDeadline = lastSundayOnOrBeforeDate(secondSundayMax);

  // 1st Sunday deadline: lastSunday(min(first+143, pwded-37))
  const firstSundayMax = min([
    addDays(first, 143),
    addDays(pwded, -37)
  ]);
  const firstSundayDeadline = lastSundayOnOrBeforeDate(firstSundayMax);

  return {
    notice_of_filing_deadline: format(noticeDeadline, 'yyyy-MM-dd'),
    job_order_start_deadline: format(jobOrderStartDeadline, 'yyyy-MM-dd'),
    first_sunday_ad_deadline: format(firstSundayDeadline, 'yyyy-MM-dd'),
    second_sunday_ad_deadline: format(secondSundayDeadline, 'yyyy-MM-dd'),
    recruitment_window_closes: format(noticeDeadline, 'yyyy-MM-dd'),
  };
}

function lastSundayOnOrBeforeDate(date: Date): Date {
  const dayOfWeek = getDay(date); // 0=Sunday, 6=Saturday
  return addDays(date, -dayOfWeek);
}

export function lastSundayOnOrBefore(dateStr: string): string {
  const date = parseISO(dateStr);
  return format(lastSundayOnOrBeforeDate(date), 'yyyy-MM-dd');
}

export function calculateNoticeOfFilingEnd(startDate: string): string {
  return addBusinessDays(startDate, 10);
}

export function calculateJobOrderEnd(startDate: string): string {
  const date = parseISO(startDate);
  return format(addDays(date, 30), 'yyyy-MM-dd');
}
```

3. Export from calculators/index.ts.
  </action>
  <verify>
- `cd v2 && pnpm test recruitment` passes all tests (12+ tests)
- Deadline formulas match V2_DEADLINE_FLOWS.md exactly
  </verify>
  <done>Recruitment calculators implemented with TDD, formulas match specifications</done>
</task>

<task type="auto">
  <name>Task 3: Implement I-140 calculator and RFI due date with TDD</name>
  <files>v2/src/lib/perm-engine/calculators/i140.ts, v2/src/lib/perm-engine/calculators/i140.test.ts, v2/src/lib/perm-engine/calculators/rfi.ts, v2/src/lib/perm-engine/calculators/rfi.test.ts</files>
  <action>
**TDD Approach: Write tests FIRST, then implement.**

1. Create `i140.test.ts`:
```typescript
describe('calculateI140FilingDeadline', () => {
  test('returns certification + 180 days', () => {
    expect(calculateI140FilingDeadline('2024-10-01')).toBe('2025-03-30');
  });

  test('handles year boundary', () => {
    expect(calculateI140FilingDeadline('2024-07-15')).toBe('2025-01-11');
  });

  test('handles leap year', () => {
    expect(calculateI140FilingDeadline('2024-08-31')).toBe('2025-02-27');
  });
});
```

2. Implement `i140.ts`:
```typescript
import { parseISO, format, addDays } from 'date-fns';

export function calculateI140FilingDeadline(eta9089CertificationDate: string): string {
  const date = parseISO(eta9089CertificationDate);
  return format(addDays(date, 180), 'yyyy-MM-dd');
}
```

3. Create `rfi.test.ts`:
```typescript
describe('calculateRFIDueDate', () => {
  test('returns received + 30 days (strict, not editable)', () => {
    expect(calculateRFIDueDate('2024-10-15')).toBe('2024-11-14');
  });

  test('handles month boundary', () => {
    expect(calculateRFIDueDate('2024-01-31')).toBe('2024-03-01'); // 31 days in Jan, +30 = Mar 1
  });

  test('handles year boundary', () => {
    expect(calculateRFIDueDate('2024-12-15')).toBe('2025-01-14');
  });
});

// Note: RFE due date is USER-EDITABLE, not calculated
// No calculator needed for RFE
```

4. Implement `rfi.ts`:
```typescript
import { parseISO, format, addDays } from 'date-fns';

/**
 * Calculate RFI due date (STRICT 30 days, NOT editable)
 * Per V2_VALIDATION_RULES.md V-RFI-02
 */
export function calculateRFIDueDate(receivedDate: string): string {
  const date = parseISO(receivedDate);
  return format(addDays(date, 30), 'yyyy-MM-dd');
}
```

5. Create `calculators/index.ts` to export all calculators:
```typescript
export * from './pwd';
export * from './recruitment';
export * from './eta9089';
export * from './i140';
export * from './rfi';
```

6. Update `perm-engine/index.ts` to export calculators:
```typescript
// Types
export * from './types';

// Utilities
export * from './holidays';
export * from './business-days';

// Calculators
export * from './calculators';
```
  </action>
  <verify>
- `cd v2 && pnpm test i140` passes all tests (3+ tests)
- `cd v2 && pnpm test rfi` passes all tests (3+ tests)
- `cd v2 && pnpm test calculators` passes ALL calculator tests
  </verify>
  <done>I-140 and RFI calculators implemented with TDD, all calculators exported from index</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd v2 && pnpm test` runs all calculator tests
- [ ] pwd.test.ts: 10+ tests covering all 3 cases + edge cases
- [ ] recruitment.test.ts: 12+ tests covering deadline formulas
- [ ] eta9089.test.ts: 5+ tests
- [ ] i140.test.ts: 3+ tests
- [ ] rfi.test.ts: 3+ tests
- [ ] All deadline formulas match V2_DEADLINE_FLOWS.md exactly
- [ ] Public exports work: `import { calculatePWDExpiration } from '@/lib/perm-engine'`
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- TDD followed (tests written before implementation)
- Calculators ready for validators (Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/16-deadline-validation-core/16-02-SUMMARY.md`:

# Phase 16 Plan 02: Date Calculators Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- PWD expiration calculator with 3-case logic
- Recruitment deadline calculators (notice, job order, Sunday ads)
- ETA 9089 window and expiration calculators
- I-140 filing deadline calculator
- RFI due date calculator (strict 30 days)

## Files Created/Modified

- `v2/src/lib/perm-engine/calculators/pwd.ts` + tests
- `v2/src/lib/perm-engine/calculators/recruitment.ts` + tests
- `v2/src/lib/perm-engine/calculators/eta9089.ts` + tests
- `v2/src/lib/perm-engine/calculators/i140.ts` + tests
- `v2/src/lib/perm-engine/calculators/rfi.ts` + tests
- `v2/src/lib/perm-engine/calculators/index.ts`
- `v2/src/lib/perm-engine/index.ts`

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 16-03-PLAN.md (Validators)
</output>
