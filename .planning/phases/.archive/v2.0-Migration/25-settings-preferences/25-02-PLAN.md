---
phase: 25-settings-preferences
plan: 02
type: execute
---

<objective>
Build Notification Preferences section with all email/push controls and reminder configuration.

Purpose: Give users granular control over when and how they receive notifications. This connects directly to Phase 24's notification system.

Output: Fully functional notification preferences UI that controls email, push, and reminder settings.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-settings-preferences/25-CONTEXT.md
@.planning/phases/25-settings-preferences/25-01-SUMMARY.md

**Design Reference (MANDATORY):**
@.planning/FRONTEND_DESIGN_SKILL.md

**Notification System Integration:**
@v2/convex/lib/notificationHelpers.ts (shouldSendEmail, quiet hours logic)
@v2/convex/notifications.ts
@v2/convex/pushNotifications.ts
@v2/convex/pushSubscriptions.ts

**Schema Fields (userProfiles):**
- emailNotificationsEnabled: boolean (master toggle)
- pushNotificationsEnabled: boolean
- pushSubscription: string (JSON)
- emailDeadlineReminders: boolean
- emailStatusUpdates: boolean
- emailRfeAlerts: boolean
- urgentDeadlineDays: int64
- reminderDaysBefore: array<int64> (e.g., [1, 3, 7, 14, 30])

**Prior Phase Context:**
- Phase 24 implemented full notification system
- shouldSendEmail() checks master + type-specific + quiet hours
- Urgent priority bypasses quiet hours
- Push notifications use VAPID/web-push
</context>

## Required Reading (MANDATORY for all implementers)
- `.planning/FRONTEND_DESIGN_SKILL.md`
- `v2/CLAUDE.md` (notification system section)
- `v2/convex/lib/notificationHelpers.ts`

## Implementation Rules
1. Explore existing code BEFORE creating anything new
2. No clashing, duplicate, or non-integrated implementations
3. Settings must ACTUALLY control notification behavior (not orphaned)
4. Use existing Switch component from shadcn/ui
5. Clean up thoroughly after

## Subagent Instructions
All Task and Explore subagents MUST receive these rules in their prompts.

<tasks>

<task type="auto">
  <name>Task 1: Create NotificationPreferencesSection component</name>
  <files>v2/src/components/settings/NotificationPreferencesSection.tsx</files>
  <exploration>
    Use Explore agent to:
    - Find Switch component usage patterns (DeadlineEnforcementToggle)
    - Understand how shouldSendEmail() uses these settings
    - Check Label component for accessibility
    - Find toast/notification feedback patterns
  </exploration>
  <action>
    **Create NotificationPreferencesSection component:**

    1. **Master Email Toggle:**
       - Switch for emailNotificationsEnabled
       - When OFF: disable all email-specific toggles below
       - Warning text when disabled: "All email notifications are turned off"

    2. **Email Notification Types (3 sub-toggles):**
       - Deadline Reminders (emailDeadlineReminders)
       - Status Updates (emailStatusUpdates)
       - RFI/RFE Alerts (emailRfeAlerts)
       - Each with descriptive text explaining what it controls
       - Disabled state when master toggle is off

    3. **Test Email Button:**
       - Button to send test email to verify delivery
       - Uses existing email sending action
       - Shows success/error toast

    **Layout:**
    - Card container matching ProfileSection styling
    - Toggle rows with label on left, switch on right
    - Descriptive text below each toggle
    - Visual hierarchy: master toggle prominent, sub-toggles indented

    **State Management:**
    - useMutation for updateUserProfile
    - Optimistic updates for snappy feel
    - Toast feedback on save
  </action>
  <verify>
    - Section renders with all toggles
    - Master toggle disables sub-toggles when off
    - Changes save to database
    - Test email button works (sends email)
    - Matches neobrutalist styling
  </verify>
  <done>Email notification preferences section fully functional with master toggle, type toggles, and test email</done>
</task>

<task type="auto">
  <name>Task 2: Add push notification controls</name>
  <files>v2/src/components/settings/NotificationPreferencesSection.tsx, v2/src/lib/pushNotifications.ts</files>
  <exploration>
    Use Explore agent to:
    - Find existing push notification subscription logic
    - Check savePushSubscription/removePushSubscription mutations
    - Find service worker registration patterns
    - Understand VAPID key usage
  </exploration>
  <action>
    **Add Push Notification Section:**

    1. **Push Toggle with Subscription Management:**
       - Switch for pushNotificationsEnabled
       - When toggling ON:
         - Request browser permission
         - Subscribe to push notifications via service worker
         - Save subscription to database
       - When toggling OFF:
         - Unsubscribe from push
         - Remove subscription from database

    2. **Permission Status Display:**
       - Show current permission state (granted/denied/default)
       - If denied: show instructions to enable in browser
       - Visual indicator (green dot = subscribed, gray = not)

    3. **Test Push Button:**
       - Button to send test push notification
       - Verifies subscription is working
       - Shows toast on success/failure

    **Create helper (if not exists):**
    ```typescript
    // v2/src/lib/pushNotifications.ts
    export async function subscribeToPush(): Promise<PushSubscription | null>
    export async function unsubscribeFromPush(): Promise<void>
    export function getPushPermissionState(): 'granted' | 'denied' | 'default'
    ```

    **Error Handling:**
    - Handle case where service worker not supported
    - Handle permission denied gracefully
    - Handle subscription failures
  </action>
  <verify>
    - Push toggle appears in section
    - Toggling ON requests browser permission
    - Subscription saved to database
    - Test push notification received
    - Toggling OFF removes subscription
    - Works on supported browsers, graceful fallback on unsupported
  </verify>
  <done>Push notification toggle with subscription management, permission handling, and test functionality</done>
</task>

<task type="auto">
  <name>Task 3: Add reminder configuration controls</name>
  <files>v2/src/components/settings/NotificationPreferencesSection.tsx</files>
  <action>
    **Add Reminder Configuration Section:**

    1. **Reminder Days Checkboxes:**
       - Field: reminderDaysBefore array
       - Checkbox group: 1 day, 3 days, 7 days, 14 days, 30 days
       - Multiple selection allowed
       - At least one must be selected (validation)
       - Default: [7, 14, 30]

    2. **Urgent Deadline Threshold:**
       - Field: urgentDeadlineDays (int64)
       - Input with number validation (1-30 range)
       - Label: "Mark deadlines as urgent when within X days"
       - Default: 7 days
       - Explanation text: "Urgent deadlines bypass quiet hours"

    **Layout:**
    - Subsection within Notification Preferences
    - Clear grouping with subtle divider
    - Checkbox group in horizontal flow (wraps on mobile)
    - Number input with stepper buttons

    **Validation:**
    - At least one reminder day selected
    - Urgent days between 1-30
    - Show inline validation errors
  </action>
  <verify>
    - Reminder day checkboxes work
    - Multiple days can be selected
    - Urgent threshold input validates range
    - Changes save to database
    - reminderDaysBefore array updates correctly
    - urgentDeadlineDays updates correctly
  </verify>
  <done>Reminder configuration with day selection and urgent threshold controls</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds without errors
- [ ] `pnpm tsc --noEmit` passes
- [ ] Notification preferences section visible at /settings
- [ ] Master email toggle controls sub-toggles
- [ ] Push notification subscription works
- [ ] Test email/push buttons functional
- [ ] Reminder days save as array
- [ ] Urgent threshold saves correctly
- [ ] All settings actually affect notification behavior (verify via notificationHelpers.ts)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- All notification settings connected to Phase 24 system
- Push notifications properly managed
- Reminder configuration saves correctly
</success_criteria>

<output>
After completion, create `.planning/phases/25-settings-preferences/25-02-SUMMARY.md`:

# Phase 25 Plan 02: Notification Preferences Summary

**[One-liner describing what shipped]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale]

## Issues Encountered
[Problems and resolutions]

## Next Step
Ready for 25-03-PLAN.md (Quiet Hours + Calendar Sync + Auto-Close sections)
</output>
