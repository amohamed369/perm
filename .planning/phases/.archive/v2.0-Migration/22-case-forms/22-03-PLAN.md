---
phase: 22-case-forms
plan: 03
type: execute
domain: forms
---

<objective>
Build second half of form sections: ETA 9089, I-140, and dynamic RFI/RFE entry sections.

Purpose: Complete all case form sections including complex dynamic entries for RFI/RFE.
Output: ETA9089Section, I140Section, RFIRFESection components with tests and stories.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<cascading_requirements>
## CRITICAL: These Requirements Apply to ALL Work in This Plan

### Mandatory Documentation (Must Read Before Any Work)

| Document | Path | Purpose |
|----------|------|---------|
| **perm_flow.md** | `/perm_flow.md` | **SOURCE OF TRUTH** - Case statuses, progress statuses, date validation, deadline logic |
| **FRONTEND_DESIGN_SKILL.md** | `.planning/FRONTEND_DESIGN_SKILL.md` | Design guidance, neobrutalist aesthetic, status colors |
| **Design Inspiration 1-5** | `.planning/phases/17-design-system/design1-5` | Design examples, hard shadows, animations |
| **Phase Context** | `.planning/phases/22-case-forms/22-CONTEXT.md` | Phase requirements |
| **V2 Design System** | `v2/docs/DESIGN_SYSTEM.md` | Component library, utility classes |

### Code Quality Standards (Non-Negotiable)

- **Clean** - No clutter, no dead code
- **Organized** - Logical structure, proper separation of concerns
- **Minimal** - No over-engineering, no unnecessary abstraction
- **Abstractable** - Reusable patterns where appropriate
- **Scalable** - Handles growth without refactoring
- **Maintainable** - Easy to modify and extend
- **Readable** - Self-documenting, clear naming
- **Global fixes** - Fix at the source, never repeat patterns

### TDD Requirements

- Tests BEFORE implementation (red-green-refactor)
- Full coverage of validation logic
- Edge case coverage

### Subagent/Task Tool Requirements

**ALL Task tools and subagents MUST have these instructions explicitly in their prompts:**

```
CRITICAL REQUIREMENTS:
1. Read these docs FIRST: perm_flow.md, .planning/FRONTEND_DESIGN_SKILL.md,
   .planning/phases/17-design-system/design1-5, .planning/phases/22-case-forms/22-CONTEXT.md
2. perm_flow.md is SOURCE OF TRUTH for all case logic
3. V1 feature parity - all features must be preserved
4. Code quality: clean, organized, minimal, abstractable, scalable, maintainable, readable
5. Global fixes only - no repeated patterns
6. Full TDD - tests before implementation
7. UI: animations, transitions, microinteractions per design docs
8. Use Explore and Task subagents for research and complex work
```
</cascading_requirements>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-case-forms/22-CONTEXT.md
@.planning/FRONTEND_DESIGN_SKILL.md
@perm_flow.md

**Prior plan context:**
@.planning/phases/22-case-forms/22-01-SUMMARY.md
@.planning/phases/22-case-forms/22-02-SUMMARY.md

**Infrastructure from 22-01:**
@v2/src/lib/forms/case-form-schema.ts
@v2/src/components/forms/FormField.tsx
@v2/src/components/forms/DateInput.tsx
@v2/src/hooks/useFormCalculations.ts

**Sections from 22-02:**
@v2/src/components/forms/sections/BasicInfoSection.tsx
@v2/src/components/forms/sections/PWDSection.tsx
@v2/src/components/forms/sections/RecruitmentSection.tsx

**perm-engine calculators:**
@v2/src/lib/perm-engine/calculators/eta9089.ts
@v2/src/lib/perm-engine/calculators/i140.ts
@v2/src/lib/perm-engine/calculators/rfi.ts

**V1 Features (from 22-CONTEXT.md):**
- ETA 9089: filing_date, certification_date, expiration_date (auto), filing window indicator
- I-140: filing_date, receipt_date, approval_date, denial_date, category, service_center, premium_processing
- RFI: received_date, response_due (auto +30), submitted_date, title, description, notes (dynamic add/remove)
- RFE: received_date, response_due (manual), submitted_date, title, description, notes (dynamic add/remove)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ETA9089Section with filing window indicator</name>
  <files>
    v2/src/components/forms/sections/ETA9089Section.tsx
    v2/src/components/forms/sections/__tests__/ETA9089Section.test.tsx
    v2/src/components/forms/sections/ETA9089Section.stories.tsx
  </files>
  <exploration>
    Use Explore agent to:
    - Study calculateETA9089Window, calculateETA9089Expiration from perm-engine
    - Check perm_flow.md for ETA 9089 filing window rules
    - Review FilingWindowIndicator pattern from v1 (30-180 days after recruitment)
    - Look at v1 add-case.html ETA 9089 section
  </exploration>
  <action>
    Create ETA9089Section with filing window:

    1. **Fields from v1:**
       - `eta9089FilingDate` - Date input
       - `eta9089AuditDate` - Date input (optional)
       - `eta9089CertificationDate` - Date input
       - `eta9089ExpirationDate` - Date input (AUTO-CALCULATE: cert + 180 days)
       - `eta9089CaseNumber` - Text input (optional)

    2. **Filing Window Indicator:**
       - Visual badge showing filing window status:
         - "Not yet open" (gray) - <30 days after recruitment
         - "Open" (green) - 30-180 days after recruitment, before PWD expiration
         - "Closing soon" (orange) - <14 days left in window
         - "Closed" (red) - >180 days or past PWD expiration
       - Show window dates: "Open: [date] - [date]"
       - Countdown if closing soon

    3. **Auto-calculation (from perm_flow.md):**
       - eta9089ExpirationDate = certificationDate + 180 days
       - Show pulse animation on auto-fill

    4. **Validation (from perm_flow.md):**
       - Filing date must be 30-180 days after last recruitment step
       - Filing date must be before PWD expiration
       - Certification date must be after filing date
       - Show warning if filing outside window

    5. **Layout:**
       - FormSection with title "ETA 9089"
       - Orange status indicator (yellow when working)
       - Filing window badge prominently displayed
       - Dates in logical order

    TDD: Write tests FIRST covering:
    - Expiration auto-calculates from certification
    - Filing window indicator shows correct status
    - Validation catches filing outside 30-180 day window
    - Validation catches filing after PWD expiration
    - Audit date is optional
  </action>
  <verify>npm run test -- v2/src/components/forms/sections/__tests__/ETA9089Section.test.tsx</verify>
  <done>ETA9089Section shows filing window, auto-calculates, validates per perm_flow.md</done>
</task>

<task type="auto">
  <name>Task 2: Create I140Section with filing deadline indicator</name>
  <files>
    v2/src/components/forms/sections/I140Section.tsx
    v2/src/components/forms/sections/__tests__/I140Section.test.tsx
    v2/src/components/forms/sections/I140Section.stories.tsx
  </files>
  <exploration>
    Use Explore agent to:
    - Study calculateI140FilingDeadline from perm-engine
    - Check perm_flow.md for I-140 rules
    - Review v1 add-case.html I-140 section fields
    - Look at category options (EB-1, EB-2, EB-3)
  </exploration>
  <action>
    Create I140Section with filing deadline:

    1. **Fields from v1:**
       - `i140FilingDate` - Date input
       - `i140ReceiptDate` - Date input (optional)
       - `i140ReceiptNumber` - Text input (optional)
       - `i140ApprovalDate` - Date input (triggers "Complete" celebration!)
       - `i140DenialDate` - Date input (optional)
       - `i140Category` - Select: EB-1, EB-2, EB-3
       - `i140ServiceCenter` - Text input (optional)
       - `i140PremiumProcessing` - Checkbox

    2. **Filing Deadline Indicator:**
       - Visual badge showing filing status:
         - "Window open" (green) - ETA cert exists, within 180 days
         - "Due soon" (orange) - <30 days left
         - "Urgent" (red) - <7 days left
         - "Past deadline" (red/striped) - >180 days from cert
       - Show deadline date and countdown
       - Use ETA 9089 expiration as deadline

    3. **Validation (from perm_flow.md):**
       - Filing date must be after ETA 9089 certification
       - Filing date must be before ETA 9089 expiration (180 days)
       - Approval date must be after filing date
       - Denial date must be after filing date
       - Only one of approval/denial can be set

    4. **Special UX:**
       - When approval date set, show celebration indicator
       - "Complete" badge appears
       - Premium processing checkbox with explanation tooltip

    5. **Layout:**
       - FormSection with title "I-140 Immigrant Petition"
       - Green status indicator
       - Filing deadline prominently displayed
       - Category and processing options in separate row

    TDD: Write tests FIRST covering:
    - Filing deadline calculates from ETA 9089 expiration
    - Validation catches filing after deadline
    - Approval/denial mutual exclusivity
    - Premium processing checkbox works
    - Category dropdown has all options
  </action>
  <verify>npm run test -- v2/src/components/forms/sections/__tests__/I140Section.test.tsx</verify>
  <done>I140Section shows filing deadline, validates per perm_flow.md, tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Create RFIRFESection with dynamic entries</name>
  <files>
    v2/src/components/forms/sections/RFIRFESection.tsx
    v2/src/components/forms/sections/RFIEntry.tsx
    v2/src/components/forms/sections/RFEEntry.tsx
    v2/src/components/forms/sections/__tests__/RFIRFESection.test.tsx
    v2/src/components/forms/sections/__tests__/RFIEntry.test.tsx
    v2/src/components/forms/sections/RFIRFESection.stories.tsx
  </files>
  <exploration>
    Use Explore agent to:
    - Study calculateRFIDueDate from perm-engine (strict +30 days)
    - Check perm_flow.md for RFI/RFE rules
    - Review v1 add-case.html RFI/RFE dynamic entry pattern
    - Look at Framer Motion patterns for add/remove animations
  </exploration>
  <action>
    Create RFIRFESection with dynamic add/remove:

    1. **RFI Entry fields (from perm_flow.md):**
       - `rfiReceivedDate` - Date input (must be after filing date)
       - `rfiResponseDueDate` - Date input (AUTO-CALCULATE: +30 days, NOT editable)
       - `rfiResponseSubmittedDate` - Date input (after received, before due)
       - `rfiTitle` - Text input (optional)
       - `rfiDescription` - Textarea (optional)
       - `rfiNotes` - Textarea (optional)

    2. **RFE Entry fields (from perm_flow.md):**
       - `rfeReceivedDate` - Date input (must be after I-140 filing)
       - `rfeResponseDueDate` - Date input (MANUAL, editable, hint: ~87 days)
       - `rfeResponseSubmittedDate` - Date input (after received, before due)
       - `rfeTitle` - Text input (optional)
       - `rfeDescription` - Textarea (optional)
       - `rfeNotes` - Textarea (optional)

    3. **Key difference (from perm_flow.md):**
       - RFI: Response due is STRICT 30 days, not editable
       - RFE: Response due is editable (suggest ~87 days as hint)

    4. **Dynamic entry behavior:**
       - "Add RFI" / "Add RFE" buttons
       - Only ONE active RFI at a time (must submit before adding another)
       - Only ONE active RFE at a time (must submit before adding another)
       - Remove button with confirmation
       - Framer Motion slide-in/fade-out animations

    5. **Status indicators:**
       - Active RFI/RFE shows red "Active RFI" / "Active RFE" badge
       - Completed entries show green checkmark
       - Urgency coloring based on due date

    6. **Validation (from perm_flow.md):**
       - Received date after filing date (RFI after ETA 9089, RFE after I-140)
       - Submitted date after received, before due
       - Cannot add new while one is active (not submitted)

    7. **Layout:**
       - Two collapsible subsections: RFI, RFE
       - Each entry is a card with all fields
       - Add button below entries
       - Disabled add button if active entry exists (with tooltip)

    TDD: Write tests FIRST covering:
    - RFI due date auto-calculates +30 days
    - RFI due date is not editable
    - RFE due date IS editable
    - Cannot add second RFI while first is active
    - Animation triggers on add/remove
    - Validation catches submitted after due
  </action>
  <verify>npm run test -- v2/src/components/forms/sections/__tests__/RFIRFESection.test.tsx</verify>
  <done>RFIRFESection handles dynamic entries, validates per perm_flow.md, animations work</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run test -- v2/src/components/forms/sections/` passes all tests
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors
- [ ] ETA 9089 filing window indicator works correctly
- [ ] I-140 filing deadline indicator works correctly
- [ ] RFI due date is auto-calculated and NOT editable (strict 30 days)
- [ ] RFE due date IS editable
- [ ] Dynamic add/remove with animations works
- [ ] Only one active RFI/RFE at a time enforced
- [ ] Storybook stories render: `npm run storybook`
</verification>

<success_criteria>
- All tests pass (expect 30+ new tests)
- Three form sections complete with all v1 fields
- Filing window and deadline indicators match v1
- RFI 30-day strict rule enforced (key difference from RFE)
- Dynamic entries with smooth animations
- Components reusable and well-organized
</success_criteria>

<output>
After completion, create `.planning/phases/22-case-forms/22-03-SUMMARY.md`:

# Phase 22-03: Form Sections Part 2 Summary

**[Substantive one-liner]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale]

## Issues Encountered
[Problems and resolutions]

## Next Step
Ready for 22-04-PLAN.md (Add/Edit Pages)
</output>
