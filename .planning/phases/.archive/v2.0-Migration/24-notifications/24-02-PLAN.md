---
phase: 24-notifications
plan: 02
type: execute
---

<objective>
Build the notification bell component with real-time badge and dropdown for the header.

Purpose: Give users instant visibility into notifications from anywhere in the app.
Output: NotificationBell and NotificationDropdown components integrated into Header.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/FRONTEND_DESIGN_SKILL.md
@.planning/phases/24-notifications/24-CONTEXT.md
@.planning/phases/24-notifications/24-RESEARCH.md

**Depends on:** 24-01-PLAN.md (data layer must be complete)

**Existing UI patterns:**
@v2/src/components/layout/Header.tsx - Where bell will be added
@v2/src/components/dashboard/AutoClosureAlertBanner.tsx - Notification display pattern
@v2/docs/DESIGN_SYSTEM.md - Design system reference

**From 24-CONTEXT.md specifics:**
- Red circular badge with unread count (99+ if over 99)
- Badge hidden when count is 0
- Positioned right side of header, before theme toggle
- Neobrutalist design matching existing header
- Dropdown shows 5 most recent notifications
- "+X more" link to full page if more exist
- Each item: urgency color bar, icon, title, message, relative time, delete X on hover
- "Mark All Read" button in header
- Clicking notification → mark as read + navigate to case
</context>

<orchestration>
## CRITICAL: Execution & Subagent Directive

**THIS SECTION MUST PERSIST THROUGH ALL COMPACTIONS. ALL AGENTS AND SUBAGENTS MUST FOLLOW THIS.**

### Mandatory Reading (BEFORE any implementation)
All agents/subagents MUST read and understand these files:
- `.planning/phases/24-notifications/24-CONTEXT.md` - Phase vision, specifics, boundaries
- `.planning/phases/24-notifications/24-RESEARCH.md` - Tech stack, patterns, pitfalls
- `.planning/PROJECT.md` - Overall project context
- `.planning/ROADMAP.md` - Where this phase fits
- `/Users/adammohamed/cc/perm-tracker-test/perm_flow.md` - PERM workflow (SOURCE OF TRUTH)
- `.planning/phases/17-design-system/design*.md` (design-1 through design-5) - UI/design docs for any frontend work
- `.planning/FRONTEND_DESIGN_SKILL.md` - Frontend design patterns

### Execution Pattern (Orchestrator Role)
The executing agent acts as an **orchestrator**:
1. **Explore First**: Spawn Explore subagent(s) to fully understand current implementation and what's needed
2. **Review Findings**: Look over findings yourself if small, delegate if large
3. **Implement**: Spawn Task subagent(s) to implement with explicit instructions
4. **Verify & Review**: Verify implementation, run tests, review quality
5. **Follow Up**: Fix issues, iterate as needed
6. **Repeat**: Until all tasks complete

### Code Quality Standards
For each issue, fully explore to understand:
- Current implementation state
- What's needed to achieve the goal
- **NO clashing, duplicate, or non-seamless implementations**

Implementation rules:
- **Work within existing code** as much as possible
- **Keep it minimal and simple** - DRY and KISS
- **Use what's already built** - leverage existing code, built-ins, standards
- **Create new only when needed** - don't reinvent
- **Refactor as you go** - fix issues, make it easier for future
- **Ensure fixes are global** - don't repeat fixes in multiple places
- **Keep it clean** - organized, minimal, abstractable, scalable, maintainable, readable
- **Ensure all v1 features exist** - no feature regression
- **Follow perm_flow.md** - the source of truth for PERM logic

### JSON Tracking File
Create and maintain: `.planning/phases/24-notifications/tracking.json`
```json
{
  "phase": "24-notifications",
  "plan": "02",
  "lastUpdated": "ISO-timestamp",
  "issues": [
    {
      "id": "02-T1",
      "task": "Create NotificationBell component",
      "status": "pending|in_progress|complete|blocked",
      "notes": "",
      "blockers": []
    }
  ]
}
```
Update this file throughout execution.

### Subagent Instructions Template
**ALL Task/Explore subagents MUST receive this in their prompt:**

```
CRITICAL INSTRUCTIONS FOR THIS SUBAGENT:

1. READ THESE DOCS FIRST (mandatory):
   - .planning/phases/24-notifications/24-CONTEXT.md
   - .planning/phases/24-notifications/24-RESEARCH.md
   - /Users/adammohamed/cc/perm-tracker-test/perm_flow.md
   - [For UI work: .planning/phases/17-design-system/design*.md (design-1 through design-5)]
   - .planning/FRONTEND_DESIGN_SKILL.md

2. EXPLORE THOROUGHLY before implementing:
   - Understand the entire v2/ directory structure
   - Understand the .planning/ directory structure
   - Find all related existing implementations
   - Identify patterns already in use

3. IMPLEMENTATION STANDARDS:
   - NO clashing or duplicate implementations
   - Work within existing code when possible
   - Keep minimal, simple, DRY, KISS
   - Use existing patterns and abstractions
   - Ensure seamless integration
   - Refactor as needed to maintain quality
   - Ensure fixes are global, not repeated

4. QUALITY CHECKLIST:
   - Clean, organized code
   - Abstractable and scalable
   - Maintainable and readable
   - All v1 features preserved
   - Follows perm_flow.md
   - Matches neobrutalist design system

5. CLEANUP: Remove any temporary files, unused code, or debug artifacts
```

### Cleanup Protocol
After each task completion:
- Remove temporary files
- Delete unused code
- Clean up debug artifacts
- Verify no leftover test data
- Update tracking.json

### Verification
Before marking any task complete:
- All tests pass
- No TypeScript errors
- No console errors
- Feature works as specified
- No regression in existing features
- UI matches design system

### CRITICAL: Commit Workflow (AFTER PLAN COMPLETE)
**This workflow is MANDATORY after completing ALL tasks in this plan:**

1. **STAGE** - Stage all changes: `git add -A`
2. **CODE REVIEW** - Run code reviewer agent:
   ```
   Task(subagent_type="pr-review-toolkit:code-reviewer", prompt="Review staged changes for quality, bugs, and adherence to project standards")
   ```
3. **FIX** - Address ALL issues found by code reviewer
4. **RE-REVIEW** - If significant fixes made, run code reviewer again
5. **COMMIT** - Create commit with conventional commit message:
   ```
   git commit -m "feat(notifications): <plan description>"
   ```

**DO NOT skip this workflow. The plan is NOT complete until code review passes and changes are committed.**
</orchestration>

<tasks>

<task type="auto">
  <name>Task 1: Create NotificationBell component</name>
  <files>v2/src/components/notifications/NotificationBell.tsx</files>
  <exploration>
    Read @.planning/FRONTEND_DESIGN_SKILL.md for design system requirements.
    Check Header.tsx for existing component patterns (ThemeToggle, user dropdown).
    Review AutoClosureAlertBanner.tsx for notification display patterns.
  </exploration>
  <action>
Create NotificationBell component:

```tsx
// Key features:
// 1. Real-time badge via useQuery(api.notifications.getUnreadCount)
// 2. Dropdown toggle state
// 3. Neobrutalist styling matching header

interface NotificationBellProps {
  className?: string;
}

export function NotificationBell({ className }: NotificationBellProps) {
  const [isOpen, setIsOpen] = useState(false);
  const count = useQuery(api.notifications.getUnreadCount);

  // ... implementation
}
```

**Badge requirements:**
- Red circular badge (#DC2626)
- Position: top-right corner of bell icon
- Size: 18px diameter for 1-2 digits, expand for 99+
- Display "99+" if count > 99
- Hidden (not rendered) when count === 0
- Animate in/out with scale transition

**Bell icon:**
- Use lucide-react Bell icon
- Size: 20px (matching other header icons)
- Hover state: slight scale + color change
- Active state (dropdown open): filled or highlighted

**Dropdown trigger:**
- Click to toggle dropdown
- Click outside to close (use useClickOutside hook or Radix)
- Escape key to close

Use Radix UI Popover or custom implementation matching existing dropdowns.
  </action>
  <verify>Component renders, badge shows correct count, dropdown toggles</verify>
  <done>NotificationBell component with real-time badge</done>
</task>

<task type="auto">
  <name>Task 2: Create NotificationDropdown component</name>
  <files>v2/src/components/notifications/NotificationDropdown.tsx</files>
  <action>
Create NotificationDropdown component:

**Structure:**
```tsx
<div className="notification-dropdown">
  <header>
    <h3>Notifications</h3>
    <Button onClick={markAllRead}>Mark All Read</Button>
  </header>

  <div className="notification-list">
    {notifications.map(n => <NotificationItem key={n._id} {...n} />)}
  </div>

  {hasMore && (
    <footer>
      <Link href="/notifications">+{remainingCount} more</Link>
    </footer>
  )}

  {isEmpty && <EmptyState />}
</div>
```

**Dropdown styling (neobrutalist):**
- Width: 360px
- Max-height: 400px with scroll
- Background: var(--background)
- Border: 2px solid black
- Shadow: 4px 4px 0 black
- Position: below bell, right-aligned

**Header:**
- "Notifications" title (Space Grotesk, bold)
- "Mark All Read" button (text button, right side)
- Border-bottom separator

**Empty state:**
- Bell icon (muted)
- "No notifications" text
- "You're all caught up!" subtext

**Footer:**
- Only shows if more than 5 notifications
- "+X more" as link to /notifications page
- Centered, slightly muted text
  </action>
  <verify>Dropdown renders with correct layout, empty state works</verify>
  <done>NotificationDropdown with header, list area, footer</done>
</task>

<task type="auto">
  <name>Task 3: Create NotificationItem component</name>
  <files>v2/src/components/notifications/NotificationItem.tsx</files>
  <action>
Create NotificationItem for dropdown display:

**Layout:**
```
┌─────────────────────────────────────────────┐
│ ▌ [icon] Title (bold if unread)      2h ago │
│ ▌       Message text truncated to 2 lines   │
│ ▌       at maximum with ellipsis...    [X]  │
└─────────────────────────────────────────────┘
```

**Features:**
- Left color bar (4px) based on priority:
  - urgent: #DC2626 (red)
  - high: #F97316 (orange)
  - normal: #2563EB (blue)
  - low: #6B7280 (gray)

- Icon based on notification type (from helper)

- Title:
  - Bold if unread
  - Normal weight if read
  - Single line, truncate with ellipsis

- Message:
  - 2 lines max, truncate
  - Muted text color

- Relative time:
  - "Just now", "2m ago", "1h ago", "Yesterday", "Dec 15"
  - Use date-fns formatDistanceToNow or similar

- Delete button:
  - X icon, appears on hover
  - Positioned right side
  - Stops propagation (doesn't trigger row click)

**Interactions:**
- Hover: subtle background highlight
- Click: mark as read + navigate to case (if caseId exists)
- Delete click: remove notification with optimistic update

Use useMutation for markAsRead and deleteNotification.
  </action>
  <verify>Items render correctly, hover states work, click navigation works</verify>
  <done>NotificationItem with all states and interactions</done>
</task>

<task type="auto">
  <name>Task 4: Integrate into Header</name>
  <files>v2/src/components/layout/Header.tsx</files>
  <action>
Add NotificationBell to Header:

**Position:** After nav links, before user dropdown (around line 109-112)

```tsx
// In Header.tsx nav section:
<nav className="...">
  {/* Existing nav links */}
  <NavLink href="/dashboard">Dashboard</NavLink>
  <NavLink href="/cases">Cases</NavLink>
  <NavLink href="/timeline">Timeline</NavLink>
  <NavLink href="/calendar">Calendar</NavLink>

  {/* ADD: Notification Bell */}
  <NotificationBell />

  {/* Existing user dropdown */}
  <UserDropdown />

  {/* Theme toggle */}
  <ThemeToggle />
</nav>
```

**Spacing:**
- Match spacing of other header elements
- Use consistent gap (likely gap-4 or gap-6)

**Mobile considerations:**
- Bell should be visible on mobile
- Dropdown should be responsive (full-width on small screens)

Import NotificationBell and add to header JSX.
  </action>
  <verify>Bell appears in header at correct position, dropdown works</verify>
  <done>NotificationBell integrated into Header</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Notification bell with real-time badge and dropdown in header</what-built>
  <how-to-verify>
    1. Run: npm run dev (in v2/)
    2. Visit: http://localhost:3000/dashboard
    3. Check header: Notification bell should appear before user menu
    4. If no notifications: Badge should be hidden
    5. Create a test notification (or use existing auto_closure from dashboard)
    6. Verify: Badge appears with count
    7. Click bell: Dropdown opens with neobrutalist styling
    8. Verify dropdown: Header with "Mark All Read", notification items, footer link
    9. Hover notification: Delete X appears
    10. Click notification: Navigates to case, marks as read
    11. Test "Mark All Read": All notifications become read, badge updates
    12. Mobile: Resize browser, verify bell still visible and dropdown responsive
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] NotificationBell component with real-time badge
- [ ] NotificationDropdown with header, list, footer
- [ ] NotificationItem with all states
- [ ] Header integration complete
- [ ] Human verification approved
- [ ] No TypeScript errors
- [ ] Responsive design works
</verification>

<success_criteria>
- Bell shows real-time unread count
- Dropdown displays recent notifications
- Clicking notification marks as read and navigates
- Mark All Read works
- Neobrutalist design matches existing UI
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/24-notifications/24-02-SUMMARY.md`:

# Phase 24 Plan 02: Bell + Dropdown UI Summary

**[One-liner describing what shipped]**

## Accomplishments
- NotificationBell with real-time badge
- NotificationDropdown with recent notifications
- NotificationItem with interactions
- Header integration

## Files Created/Modified
- `v2/src/components/notifications/NotificationBell.tsx`
- `v2/src/components/notifications/NotificationDropdown.tsx`
- `v2/src/components/notifications/NotificationItem.tsx`
- `v2/src/components/layout/Header.tsx`

## Decisions Made
[Any decisions during implementation]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 24-03-PLAN.md (Full Notifications Page)
</output>
