---
phase: 25-settings-preferences
plan: 04
type: execute
---

<objective>
Build Account Management and Support sections, plus final polish and testing.

Purpose: Complete the settings page with account deletion (soft delete with grace period), privacy mode, data export link, support/contact options, and comprehensive testing.

Output: Complete settings page with all 7 sections functional, polished UI, and full test coverage.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-settings-preferences/25-CONTEXT.md
@.planning/phases/25-settings-preferences/25-01-SUMMARY.md
@.planning/phases/25-settings-preferences/25-02-SUMMARY.md
@.planning/phases/25-settings-preferences/25-03-SUMMARY.md

**Design Reference (MANDATORY):**
@.planning/FRONTEND_DESIGN_SKILL.md

**Schema Fields:**
- privacyModeEnabled: boolean
- deletedAt: number (for soft delete)

**Phase 21 Export:**
@v2/src/lib/export/caseExport.ts (existing export functionality)

**GitHub Integration (from v1):**
- Bug report: GitHub Issues link
- Feature request: GitHub Enhancement link
</context>

## Required Reading (MANDATORY for all implementers)
- `.planning/FRONTEND_DESIGN_SKILL.md`
- `v2/CLAUDE.md`

## Implementation Rules
1. Explore existing code BEFORE creating anything new
2. Account deletion must use SOFT DELETE with grace period
3. Data export LINKS to existing Phase 21 functionality (no duplication)
4. Support section links to GitHub issues
5. Clean up thoroughly after

## Subagent Instructions
All Task and Explore subagents MUST receive these rules in their prompts.

<tasks>

<task type="auto">
  <name>Task 1: Create AccountManagementSection component</name>
  <files>v2/src/components/settings/AccountManagementSection.tsx, v2/convex/users.ts</files>
  <exploration>
    Use Explore agent to:
    - Find existing soft delete patterns (cases have deletedAt?)
    - Check Dialog component for confirmation modals
    - Find email sending patterns for confirmation emails
    - Look for export link patterns (SelectionBar?)
  </exploration>
  <action>
    **Create AccountManagementSection component:**

    1. **Privacy Mode Toggle:**
       - Switch for privacyModeEnabled
       - Description: "Hide beneficiary names on dashboard and case cards"
       - Already works with existing dashboard logic

    2. **Data Export Link:**
       - Button linking to case list with export modal
       - Text: "Export your data"
       - Route to /cases with export action
       - OR trigger export directly (all cases CSV/JSON)
       - Uses existing exportCasesCSV/JSON from Phase 21

    3. **Account Deletion:**
       - "Delete Account" button (destructive styling)
       - Opens confirmation dialog with:
         - Warning about what will be deleted
         - Grace period explanation (7-30 days)
         - Email confirmation requirement
         - Type "DELETE" to confirm
       - On confirm:
         - Set deletedAt timestamp on userProfiles
         - Schedule deletion email
         - Sign out user
         - Show "Account scheduled for deletion" message

    **Backend Mutation (add to users.ts if not exists):**
    ```typescript
    export const requestAccountDeletion = mutation({
      args: {},
      handler: async (ctx) => {
        const userId = await getCurrentUserId(ctx);
        const profile = await ctx.db
          .query("userProfiles")
          .withIndex("by_user_id", (q) => q.eq("userId", userId))
          .unique();

        if (!profile) throw new Error("Profile not found");

        // Soft delete - set deletedAt
        await ctx.db.patch(profile._id, {
          deletedAt: Date.now() + (30 * 24 * 60 * 60 * 1000), // 30 days from now
          updatedAt: Date.now(),
        });

        // Schedule confirmation email
        // ...
      },
    });
    ```

    **Recovery Option:**
    - Users logging in during grace period see "Account scheduled for deletion"
    - "Cancel deletion" button clears deletedAt
  </action>
  <verify>
    - Privacy mode toggle works
    - Export data button triggers export
    - Delete account shows confirmation dialog
    - Confirmation requires typing "DELETE"
    - Soft delete sets deletedAt (not permanent)
    - Grace period of 30 days applied
  </verify>
  <done>Account management section with privacy toggle, data export, and soft-delete account deletion</done>
</task>

<task type="auto">
  <name>Task 2: Create SupportSection component</name>
  <files>v2/src/components/settings/SupportSection.tsx</files>
  <action>
    **Create SupportSection component:**

    1. **Contact Support:**
       - Email link: support@permtracker.app
       - Or contact form (if exists)
       - Icon: Mail or HelpCircle

    2. **Report a Bug:**
       - Link to GitHub Issues
       - URL: https://github.com/amohamed369/perm/issues/new?labels=bug
       - Pre-filled template if possible
       - Icon: Bug

    3. **Request a Feature:**
       - Link to GitHub Issues with enhancement label
       - URL: https://github.com/amohamed369/perm/issues/new?labels=enhancement
       - Icon: Lightbulb or Sparkles

    4. **App Version:**
       - Display current version (from package.json or env)
       - Build date if available

    **Layout:**
    - Card container matching other sections
    - 3 action buttons/links in a row (responsive grid)
    - Version info at bottom (subtle text)

    **Styling:**
    - Each link as a card/button with icon
    - Hover effects matching neobrutalist theme
    - External links open in new tab
  </action>
  <verify>
    - Support section renders with all links
    - GitHub issue links work (open in new tab)
    - Email link opens mail client
    - Styling consistent with other sections
  </verify>
  <done>Support section with contact, bug report, and feature request links</done>
</task>

<task type="auto">
  <name>Task 3: Write tests and final polish</name>
  <files>v2/src/components/settings/__tests__/*.test.tsx, v2/convex/users.test.ts</files>
  <exploration>
    Use Explore agent to:
    - Find existing component test patterns
    - Check convex-test setup for mutation tests
    - Find test utilities and mocks
  </exploration>
  <action>
    **Component Tests:**

    1. **SettingsLayout.test.tsx:**
       - Renders all 7 sections
       - Tab navigation works
       - Loading state displays skeleton
       - Auth context integration

    2. **ProfileSection.test.tsx:**
       - Displays user data
       - Name field editable
       - Email field read-only
       - Timezone selector works
       - Save mutation called on change

    3. **NotificationPreferencesSection.test.tsx:**
       - Master toggle controls sub-toggles
       - Push subscription workflow
       - Reminder days selection
       - Save mutations called

    4. **AccountManagementSection.test.tsx:**
       - Privacy toggle works
       - Delete account flow
       - Confirmation dialog
       - Soft delete mutation

    **Convex Tests (users.test.ts additions):**
    - requestAccountDeletion mutation
    - Soft delete sets correct deletedAt
    - Profile updates work

    **Final Polish:**
    - Review all sections for consistency
    - Fix any spacing/alignment issues
    - Ensure all animations are snappy
    - Verify dark mode compatibility
    - Mobile responsiveness check
  </action>
  <verify>
    - All tests pass: `pnpm test:run`
    - Coverage adequate for settings components
    - No console errors/warnings
    - Dark mode works for all sections
    - Mobile layout works
  </verify>
  <done>Settings page fully tested, polished, and production-ready</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Settings page with 7 sections: Profile, Notifications, Quiet Hours, Calendar Sync, Auto-Close, Account, and Support</what-built>
  <how-to-verify>
    1. Run: `cd v2 && pnpm dev` (and `npx convex dev` in another terminal)
    2. Visit: http://localhost:3000/settings
    3. Verify each section:
       - **Profile:** Edit name, check timezone dropdown, verify save
       - **Notifications:** Toggle master switch, check sub-toggles, test push subscription
       - **Quiet Hours:** Enable and set times, verify timezone display
       - **Calendar Sync:** Check all 7 deadline type toggles work
       - **Auto-Close:** Verify DeadlineEnforcementToggle works
       - **Account:** Check privacy toggle, export link, delete account modal
       - **Support:** Verify all external links work
    4. Check:
       - Tab navigation is smooth
       - Animations are snappy (150-200ms)
       - All toggles save immediately
       - Neobrutalist styling consistent
       - Mobile responsive (resize browser)
       - Dark mode works
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm build` succeeds without errors
- [ ] `pnpm tsc --noEmit` passes
- [ ] `pnpm test:run` passes all tests
- [ ] All 7 settings sections functional
- [ ] Account deletion soft-delete works
- [ ] Export links to Phase 21 functionality
- [ ] Support links work
- [ ] Mobile responsive
- [ ] Dark mode compatible
- [ ] Human verification approved
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human approval received
- No TypeScript errors
- Complete settings page ready for production
- Phase 25 complete
</success_criteria>

<output>
After completion, create `.planning/phases/25-settings-preferences/25-04-SUMMARY.md`:

# Phase 25 Plan 04: Account Management + Support + Polish Summary

**[One-liner describing what shipped]**

## Accomplishments
- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified
- `path/to/file.ts` - Description

## Decisions Made
[Key decisions and rationale]

## Issues Encountered
[Problems and resolutions]

## Next Step
Phase 25 complete. Ready for Phase 26 (Chat Foundation).

---

Also update STATE.md with Phase 25 completion.
</output>
