---
phase: 16-deadline-validation-core
plan: 01
type: execute
domain: validation
---

<objective>
Establish the perm-engine foundation with types, federal holidays, and business day utilities.

Purpose: Create the foundational layer that all calculators and validators depend on.
Output: `v2/src/lib/perm-engine/` with types.ts, holidays.ts, and comprehensive tests.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-deadline-validation-core/16-RESEARCH.md
@.planning/phases/16-deadline-validation-core/16-CONTEXT.md
@.planning/V2_VALIDATION_RULES.md
@.planning/V2_BUSINESS_RULES.md

**Prior decisions affecting this phase:**
- Phase 15: Test utilities in `test-utils/` not `convex/` (Vite-specific import.meta.glob)
- Phase 15: Use `@ts-expect-error` for surgical TypeScript suppression
- Research: Use date-fns v4+ for date math, pure TypeScript for business logic
- Research: Math-based federal holiday detection (no external APIs)

**Key requirements from CONTEXT:**
- Date protocol: ISO strings (YYYY-MM-DD) for storage/API
- Timezones: Ignored. Dates are absolute calendar values.
- TDD mandatory: Tests before implementation

**Federal holidays to support (5 U.S.C. 6103):**
- Fixed: New Year, Juneteenth, Independence Day, Veterans Day, Christmas
- Floating: MLK Day, Presidents Day, Memorial Day, Labor Day, Columbus Day, Thanksgiving
- Special: Inauguration Day (Jan 20 every 4 years starting 2021)
- Weekend shift: Saturday → Friday, Sunday → Monday
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install date-fns and create types.ts</name>
  <files>v2/package.json, v2/src/lib/perm-engine/types.ts</files>
  <action>
1. Install date-fns:
   ```bash
   cd v2 && pnpm add date-fns
   ```

2. Create the perm-engine directory structure:
   ```
   v2/src/lib/perm-engine/
   ├── index.ts              # Public API (empty for now)
   ├── types.ts              # TypeScript types/interfaces
   ```

3. In types.ts, define all types following the research patterns:

```typescript
// Validation types
export type ValidationSeverity = 'error' | 'warning';

export interface ValidationIssue {
  ruleId: string;          // V-PWD-01, V-REC-03, etc.
  severity: ValidationSeverity;
  field: string;           // Field that triggered the issue
  message: string;         // User-facing message
  regulation?: string;     // CFR reference if applicable
}

export interface ValidationResult {
  valid: boolean;          // false if any errors (warnings OK)
  errors: ValidationIssue[];
  warnings: ValidationIssue[];
}

// Case data types (partial - fields relevant to validation)
export interface CaseData {
  // PWD fields
  pwd_filing_date: string | null;
  pwd_determination_date: string | null;
  pwd_expiration_date: string | null;

  // Recruitment fields
  sunday_ad_first_date: string | null;
  sunday_ad_second_date: string | null;
  job_order_start_date: string | null;
  job_order_end_date: string | null;
  notice_of_filing_start_date: string | null;
  notice_of_filing_end_date: string | null;
  is_professional_occupation: boolean;

  // ETA 9089 fields
  eta9089_filing_date: string | null;
  eta9089_certification_date: string | null;
  eta9089_expiration_date: string | null;

  // I-140 fields
  i140_filing_date: string | null;
  i140_approval_date: string | null;

  // RFI fields (single active)
  rfi_received_date: string | null;
  rfi_due_date: string | null;
  rfi_submitted_date: string | null;

  // RFE fields (single active)
  rfe_received_date: string | null;
  rfe_due_date: string | null;
  rfe_submitted_date: string | null;

  // Status
  case_status: CaseStatus;
  progress_status: ProgressStatus;
}

export type CaseStatus = 'pwd' | 'recruitment' | 'eta9089' | 'i140' | 'closed';
export type ProgressStatus = 'working' | 'waiting_intake' | 'filed' | 'approved' | 'under_review' | 'rfi_rfe';

// Cascade types
export type FieldChange = {
  field: keyof CaseData;
  value: string | null;
};

// Recruitment deadline output
export interface RecruitmentDeadlines {
  notice_of_filing_deadline: string;
  job_order_start_deadline: string;
  first_sunday_ad_deadline: string;
  second_sunday_ad_deadline: string;
  recruitment_window_closes: string;
}

// Holiday type
export interface Holiday {
  name: string;
  date: string; // ISO string
}
```

4. Create empty index.ts for public API.
  </action>
  <verify>
- `pnpm list date-fns` shows date-fns installed
- TypeScript compiles: `cd v2 && npx tsc --noEmit`
  </verify>
  <done>date-fns installed, types.ts created with all interfaces, TypeScript compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Implement holidays.ts with TDD</name>
  <files>v2/src/lib/perm-engine/holidays.ts, v2/src/lib/perm-engine/holidays.test.ts</files>
  <action>
**TDD Approach: Write tests FIRST, then implement.**

1. Create `holidays.test.ts` with tests covering:
   - All 11 federal holidays for multiple years (2024, 2025, 2026)
   - Weekend shift rules (Saturday → Friday, Sunday → Monday)
   - Inauguration Day (Jan 20, 2025 and 2029, NOT 2024 or 2026)
   - `isFederalHoliday()` function
   - `isBusinessDay()` function

2. Test cases to include:
```typescript
describe('getFederalHolidays', () => {
  test('returns 11 holidays for non-inauguration year', () => {
    const holidays = getFederalHolidays(2024);
    expect(holidays.length).toBe(11);
  });

  test('returns 12 holidays for inauguration year', () => {
    const holidays = getFederalHolidays(2025);
    expect(holidays.length).toBe(12);
  });

  test('MLK Day 2025 is January 20', () => {
    const holidays = getFederalHolidays(2025);
    const mlk = holidays.find(h => h.name === 'MLK Day');
    expect(mlk?.date).toBe('2025-01-20');
  });

  // Note: MLK Day and Inauguration Day both fall on Jan 20, 2025
  // Inauguration Day takes precedence (or both are holidays)

  test('Independence Day 2026 shifts from Saturday to Friday', () => {
    // July 4, 2026 is Saturday
    const holidays = getFederalHolidays(2026);
    const july4 = holidays.find(h => h.name === 'Independence Day');
    expect(july4?.date).toBe('2026-07-03'); // Friday
  });
});

describe('isFederalHoliday', () => {
  test('returns true for Christmas 2024', () => {
    expect(isFederalHoliday('2024-12-25')).toBe(true);
  });

  test('returns false for regular day', () => {
    expect(isFederalHoliday('2024-08-15')).toBe(false);
  });
});

describe('isBusinessDay', () => {
  test('returns false for Saturday', () => {
    expect(isBusinessDay('2024-12-21')).toBe(false); // Saturday
  });

  test('returns false for Sunday', () => {
    expect(isBusinessDay('2024-12-22')).toBe(false); // Sunday
  });

  test('returns false for Christmas', () => {
    expect(isBusinessDay('2024-12-25')).toBe(false); // Wednesday but holiday
  });

  test('returns true for regular Wednesday', () => {
    expect(isBusinessDay('2024-12-18')).toBe(true);
  });
});
```

3. Implement `holidays.ts` following the research code examples exactly:
   - `nthWeekdayOfMonth()` helper for floating holidays
   - `lastWeekdayOfMonth()` helper for Memorial Day
   - `shiftWeekendHoliday()` for Saturday/Sunday shifts
   - `getFederalHolidays(year)` returns all holidays with weekend shifts applied
   - `isFederalHoliday(dateStr)` checks if ISO date string is a holiday
   - `isBusinessDay(dateStr)` checks if date is a business day (not weekend, not holiday)

4. Export all public functions from index.ts.
  </action>
  <verify>
- `cd v2 && pnpm test holidays` passes all tests
- At least 15 test cases covering all scenarios
  </verify>
  <done>holidays.ts implemented with TDD, all tests pass, covers all federal holidays + weekend shifts + Inauguration Day</done>
</task>

<task type="auto">
  <name>Task 3: Implement business day utilities with TDD</name>
  <files>v2/src/lib/perm-engine/business-days.ts, v2/src/lib/perm-engine/business-days.test.ts</files>
  <action>
**TDD Approach: Write tests FIRST, then implement.**

1. Create `business-days.test.ts` with tests covering:
   - `addBusinessDays(dateStr, days)` - add N business days
   - `countBusinessDays(startStr, endStr)` - count business days between dates
   - Edge cases: spans holidays, spans weekends, starts on weekend

2. Test cases to include:
```typescript
describe('addBusinessDays', () => {
  test('adds 10 business days (Notice of Filing)', () => {
    // Starting January 15, 2025 (Wednesday)
    // Skip weekends, skip MLK Day (Jan 20)
    const result = addBusinessDays('2025-01-15', 10);
    // Count: 16,17=2, skip 18-19 weekend, skip 20 MLK, 21-24=4, skip 25-26 weekend, 27-29=3, total=10
    expect(result).toBe('2025-01-29');
  });

  test('handles starting on Saturday', () => {
    const result = addBusinessDays('2024-12-21', 1); // Saturday
    expect(result).toBe('2024-12-23'); // Monday
  });

  test('handles Thanksgiving week', () => {
    // Nov 28, 2024 is Thanksgiving
    const result = addBusinessDays('2024-11-25', 5); // Monday before Thanksgiving
    // 25=1, 26=2, 27=3, skip 28 Thanksgiving, 29=4, skip 30 Sat, skip 1 Sun, 2=5
    expect(result).toBe('2024-12-02');
  });
});

describe('countBusinessDays', () => {
  test('counts business days excluding holidays', () => {
    // Jan 1-10, 2025: skip Jan 1 (New Year), skip weekends (4-5)
    // Business days: 2,3,6,7,8,9,10 = 7 days
    const count = countBusinessDays('2025-01-01', '2025-01-10');
    expect(count).toBe(7);
  });

  test('returns 0 for same day weekend', () => {
    const count = countBusinessDays('2024-12-21', '2024-12-21');
    expect(count).toBe(0); // Saturday
  });

  test('returns 1 for same day business day', () => {
    const count = countBusinessDays('2024-12-18', '2024-12-18');
    expect(count).toBe(1); // Wednesday
  });
});
```

3. Implement `business-days.ts`:
```typescript
import { parseISO, format, addDays, isWeekend } from 'date-fns';
import { isFederalHoliday, isBusinessDay } from './holidays';

export function addBusinessDays(startDate: string, days: number): string {
  let date = parseISO(startDate);
  let added = 0;

  while (added < days) {
    date = addDays(date, 1);
    const dateStr = format(date, 'yyyy-MM-dd');
    if (isBusinessDay(dateStr)) {
      added++;
    }
  }

  return format(date, 'yyyy-MM-dd');
}

export function countBusinessDays(startDate: string, endDate: string): number {
  let count = 0;
  let current = parseISO(startDate);
  const end = parseISO(endDate);

  while (current <= end) {
    const dateStr = format(current, 'yyyy-MM-dd');
    if (isBusinessDay(dateStr)) {
      count++;
    }
    current = addDays(current, 1);
  }

  return count;
}
```

4. Export from index.ts.
  </action>
  <verify>
- `cd v2 && pnpm test business-days` passes all tests
- At least 10 test cases covering holiday interactions
  </verify>
  <done>business-days.ts implemented with TDD, all tests pass, correctly handles federal holidays</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm list date-fns` shows version 4.x installed
- [ ] `cd v2 && npx tsc --noEmit` succeeds
- [ ] `cd v2 && pnpm test` runs all perm-engine tests
- [ ] holidays.test.ts has 15+ passing tests
- [ ] business-days.test.ts has 10+ passing tests
- [ ] All 11 federal holidays correctly calculated for 2024, 2025, 2026
- [ ] Inauguration Day only appears in inauguration years
- [ ] Weekend shift rules correctly applied
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- TDD followed (tests written before implementation)
- Foundation ready for calculators (Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/16-deadline-validation-core/16-01-SUMMARY.md`:

# Phase 16 Plan 01: Foundation (Types, Holidays, Business Days) Summary

**[Substantive one-liner about what shipped]**

## Accomplishments

- date-fns installed
- types.ts with all validation/case interfaces
- holidays.ts with federal holiday detection
- business-days.ts with addBusinessDays and countBusinessDays

## Files Created/Modified

- `v2/package.json` - Added date-fns
- `v2/src/lib/perm-engine/index.ts` - Public API
- `v2/src/lib/perm-engine/types.ts` - TypeScript interfaces
- `v2/src/lib/perm-engine/holidays.ts` - Holiday detection
- `v2/src/lib/perm-engine/holidays.test.ts` - Holiday tests
- `v2/src/lib/perm-engine/business-days.ts` - Business day utils
- `v2/src/lib/perm-engine/business-days.test.ts` - Business day tests

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 16-02-PLAN.md (Date Calculators)
</output>
