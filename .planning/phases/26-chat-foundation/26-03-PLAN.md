# 26-03: Chat UI Core

## Objective

Build the core chat UI components with neobrutalist design: floating widget, expandable panel, message bubbles, input area, and typing indicator. This creates the visual foundation for the chat experience.

## Execution Context

```yaml
references:
  - .planning/phases/26-chat-foundation/26-CONTEXT.md
  - .planning/FRONTEND_DESIGN_SKILL.md
  - v2/docs/DESIGN_SYSTEM.md
  - v2/docs/ANIMATION_STORYBOARD.md
  - v2/src/lib/animations.ts

patterns:
  - v2/src/components/ui/dialog.tsx        # Z-index patterns
  - v2/src/components/notifications/NotificationDropdown.tsx  # Dropdown patterns
  - v2/src/components/ui/button.tsx        # Button styling
```

## Context

### What We're Building
- `ChatWidget` - Floating bubble + expandable panel container
- `ChatPanel` - Main chat interface (header, messages, input)
- `ChatMessage` - Individual message bubble component
- `ChatInput` - Text input with send button
- `TypingIndicator` - Animated dots during AI response

### Design Requirements (from 26-CONTEXT.md)
- **Position:** Bottom-right floating (z-40, below dialogs at z-50)
- **Size:** ~400x600px panel
- **Colors:** Forest Green accents, hard shadows (2px border, no blur)
- **Animations:** Spring physics, fade-in-up for panel, staggered message reveals
- **Typography:** JetBrains Mono for timestamps, Space Grotesk for headers

### Key Design Tokens
```css
--primary: #2ECC40 (Lime Green)
--border: #000000 (light) / #FAFAFA (dark)
--shadow-hard: 4px 4px 0px var(--border)
```

## Tasks

### Task 1: Create ChatMessage Component

**File:** `v2/src/components/chat/ChatMessage.tsx`

```tsx
/**
 * ChatMessage Component
 *
 * Individual message bubble with:
 * - Role-based styling (user vs assistant)
 * - Neobrutalist design (hard shadows, borders)
 * - Timestamp display
 * - Markdown support for assistant messages
 */

'use client';

import { cn } from '@/lib/utils';
import { format } from 'date-fns';

interface ChatMessageProps {
  role: 'user' | 'assistant';
  content: string;
  timestamp?: number;
  isStreaming?: boolean;
}

export function ChatMessage({
  role,
  content,
  timestamp,
  isStreaming = false,
}: ChatMessageProps) {
  const isUser = role === 'user';

  return (
    <div
      className={cn(
        'flex w-full',
        isUser ? 'justify-end' : 'justify-start'
      )}
    >
      <div
        className={cn(
          'max-w-[85%] rounded-none border-2 px-4 py-3',
          isUser
            ? 'bg-primary text-primary-foreground border-primary shadow-hard-sm'
            : 'bg-card text-card-foreground border-border shadow-hard-sm',
          isStreaming && 'animate-pulse'
        )}
      >
        {/* Message content */}
        <div className={cn(
          'whitespace-pre-wrap break-words text-sm',
          isUser ? 'text-right' : 'text-left'
        )}>
          {content}
          {isStreaming && content.length > 0 && (
            <span className="inline-block ml-1 w-2 h-4 bg-current animate-blink" />
          )}
        </div>

        {/* Timestamp */}
        {timestamp && (
          <div
            className={cn(
              'mt-2 font-mono text-xs opacity-60',
              isUser ? 'text-right' : 'text-left'
            )}
          >
            {format(timestamp, 'h:mm a')}
          </div>
        )}
      </div>
    </div>
  );
}
```

**Add animation keyframe to globals.css:**
```css
@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}
.animate-blink {
  animation: blink 1s infinite;
}
```

### Task 2: Create TypingIndicator Component

**File:** `v2/src/components/chat/TypingIndicator.tsx`

```tsx
/**
 * TypingIndicator Component
 *
 * Animated dots indicating AI is processing.
 * Shows during "submitted" and "streaming" status.
 */

'use client';

import { motion } from 'motion/react';

export function TypingIndicator() {
  return (
    <div className="flex items-center gap-1 px-4 py-3 bg-muted border-2 border-border shadow-hard-sm max-w-[100px]">
      {[0, 1, 2].map((i) => (
        <motion.span
          key={i}
          className="w-2 h-2 bg-muted-foreground rounded-full"
          animate={{
            y: [0, -6, 0],
          }}
          transition={{
            duration: 0.6,
            repeat: Infinity,
            delay: i * 0.15,
            ease: 'easeInOut',
          }}
        />
      ))}
    </div>
  );
}
```

### Task 3: Create ChatInput Component

**File:** `v2/src/components/chat/ChatInput.tsx`

```tsx
/**
 * ChatInput Component
 *
 * Text input with:
 * - Multi-line support (textarea)
 * - Send on Enter (Shift+Enter for newline)
 * - Disabled state during streaming
 * - Neobrutalist styling
 */

'use client';

import { useRef, KeyboardEvent } from 'react';
import { Button } from '@/components/ui/button';
import { Send } from 'lucide-react';
import { cn } from '@/lib/utils';

interface ChatInputProps {
  value: string;
  onChange: (value: string) => void;
  onSend: () => void;
  disabled?: boolean;
  placeholder?: string;
}

export function ChatInput({
  value,
  onChange,
  onSend,
  disabled = false,
  placeholder = 'Type a message...',
}: ChatInputProps) {
  const textareaRef = useRef<HTMLTextAreaElement>(null);

  const handleKeyDown = (e: KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      if (value.trim() && !disabled) {
        onSend();
      }
    }
  };

  // Auto-resize textarea
  const handleChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    onChange(e.target.value);

    // Reset height to auto to recalculate
    if (textareaRef.current) {
      textareaRef.current.style.height = 'auto';
      textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 120)}px`;
    }
  };

  return (
    <div className="flex gap-2 p-3 border-t-2 border-border bg-background">
      <textarea
        ref={textareaRef}
        value={value}
        onChange={handleChange}
        onKeyDown={handleKeyDown}
        disabled={disabled}
        placeholder={placeholder}
        rows={1}
        className={cn(
          'flex-1 resize-none px-3 py-2 text-sm',
          'border-2 border-border bg-background rounded-none',
          'focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-0',
          'placeholder:text-muted-foreground',
          'disabled:opacity-50 disabled:cursor-not-allowed'
        )}
      />
      <Button
        onClick={onSend}
        disabled={disabled || !value.trim()}
        size="icon"
        className="shrink-0 shadow-hard-sm"
        aria-label="Send message"
      >
        <Send className="h-4 w-4" />
      </Button>
    </div>
  );
}
```

### Task 4: Create ChatPanel Component

**File:** `v2/src/components/chat/ChatPanel.tsx`

```tsx
/**
 * ChatPanel Component
 *
 * Main chat interface containing:
 * - Header with title and close button
 * - Scrollable message area
 * - Input area at bottom
 */

'use client';

import { useRef, useEffect } from 'react';
import { motion } from 'motion/react';
import { X, MessageSquare } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { ChatMessage } from './ChatMessage';
import { ChatInput } from './ChatInput';
import { TypingIndicator } from './TypingIndicator';
import { fadeInUp, springConfig } from '@/lib/animations';
import { cn } from '@/lib/utils';

interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  timestamp?: number;
}

interface ChatPanelProps {
  messages: Message[];
  input: string;
  onInputChange: (value: string) => void;
  onSend: () => void;
  onClose: () => void;
  status: 'ready' | 'submitted' | 'streaming' | 'error';
  streamingContent?: string;
}

export function ChatPanel({
  messages,
  input,
  onInputChange,
  onSend,
  onClose,
  status,
  streamingContent,
}: ChatPanelProps) {
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // Auto-scroll to bottom on new messages
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, streamingContent]);

  const isProcessing = status === 'submitted' || status === 'streaming';

  return (
    <motion.div
      initial={{ opacity: 0, y: 24, scale: 0.95 }}
      animate={{ opacity: 1, y: 0, scale: 1 }}
      exit={{ opacity: 0, y: 24, scale: 0.95 }}
      transition={springConfig}
      className={cn(
        'fixed bottom-20 right-4 z-40',
        'w-[380px] h-[560px] max-h-[80vh]',
        'flex flex-col',
        'bg-background border-2 border-border shadow-hard-lg',
        'overflow-hidden'
      )}
    >
      {/* Header */}
      <div className="flex items-center justify-between px-4 py-3 border-b-2 border-border bg-muted">
        <div className="flex items-center gap-2">
          <MessageSquare className="h-5 w-5 text-primary" />
          <h2 className="font-heading font-semibold text-sm">
            PERM Assistant
          </h2>
        </div>
        <Button
          variant="ghost"
          size="icon"
          onClick={onClose}
          className="h-8 w-8"
          aria-label="Close chat"
        >
          <X className="h-4 w-4" />
        </Button>
      </div>

      {/* Messages Area */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.length === 0 ? (
          <div className="flex flex-col items-center justify-center h-full text-center text-muted-foreground">
            <MessageSquare className="h-12 w-12 mb-4 opacity-30" />
            <p className="text-sm">Start a conversation</p>
            <p className="text-xs mt-1 opacity-70">
              Ask about PERM process, deadlines, or the app
            </p>
          </div>
        ) : (
          <>
            {messages.map((message, index) => (
              <motion.div
                key={message.id}
                initial={{ opacity: 0, y: 12 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{
                  ...springConfig,
                  delay: index * 0.05,
                }}
              >
                <ChatMessage
                  role={message.role}
                  content={message.content}
                  timestamp={message.timestamp}
                />
              </motion.div>
            ))}

            {/* Streaming message */}
            {status === 'streaming' && streamingContent && (
              <ChatMessage
                role="assistant"
                content={streamingContent}
                isStreaming
              />
            )}

            {/* Typing indicator */}
            {status === 'submitted' && <TypingIndicator />}
          </>
        )}
        <div ref={messagesEndRef} />
      </div>

      {/* Input Area */}
      <ChatInput
        value={input}
        onChange={onInputChange}
        onSend={onSend}
        disabled={isProcessing}
        placeholder={isProcessing ? 'Thinking...' : 'Type a message...'}
      />
    </motion.div>
  );
}
```

### Task 5: Create ChatWidget Container

**File:** `v2/src/components/chat/ChatWidget.tsx`

```tsx
/**
 * ChatWidget Component
 *
 * Floating chat bubble that expands to ChatPanel.
 * Renders in authenticated layout only.
 *
 * States:
 * - Collapsed: Shows floating bubble
 * - Expanded: Shows full ChatPanel
 */

'use client';

import { useState } from 'react';
import { motion, AnimatePresence } from 'motion/react';
import { MessageSquare } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { ChatPanel } from './ChatPanel';
import { popIn, springConfig } from '@/lib/animations';
import { cn } from '@/lib/utils';

interface ChatWidgetProps {
  // These props will be connected to useChatWithPersistence in 26-04
  messages?: Array<{
    id: string;
    role: 'user' | 'assistant';
    content: string;
    timestamp?: number;
  }>;
  input?: string;
  onInputChange?: (value: string) => void;
  onSend?: () => void;
  status?: 'ready' | 'submitted' | 'streaming' | 'error';
  streamingContent?: string;
}

export function ChatWidget({
  messages = [],
  input = '',
  onInputChange = () => {},
  onSend = () => {},
  status = 'ready',
  streamingContent,
}: ChatWidgetProps) {
  const [isOpen, setIsOpen] = useState(false);

  return (
    <>
      {/* Floating Bubble */}
      <AnimatePresence>
        {!isOpen && (
          <motion.div
            initial={{ opacity: 0, scale: 0 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0 }}
            transition={springConfig}
            className="fixed bottom-4 right-4 z-40"
          >
            <Button
              onClick={() => setIsOpen(true)}
              size="lg"
              className={cn(
                'h-14 w-14 rounded-none p-0',
                'bg-primary hover:bg-primary/90',
                'border-2 border-border shadow-hard',
                'transition-transform duration-150',
                'hover:-translate-y-1 active:translate-y-0'
              )}
              aria-label="Open chat"
            >
              <MessageSquare className="h-6 w-6" />
            </Button>

            {/* Unread indicator (future enhancement) */}
            {/* <span className="absolute -top-1 -right-1 h-4 w-4 bg-destructive border border-border rounded-full" /> */}
          </motion.div>
        )}
      </AnimatePresence>

      {/* Chat Panel */}
      <AnimatePresence>
        {isOpen && (
          <ChatPanel
            messages={messages}
            input={input}
            onInputChange={onInputChange}
            onSend={onSend}
            onClose={() => setIsOpen(false)}
            status={status}
            streamingContent={streamingContent}
          />
        )}
      </AnimatePresence>
    </>
  );
}
```

### Task 6: Create Index Export

**File:** `v2/src/components/chat/index.ts`

```typescript
/**
 * Chat Component Exports
 */

export { ChatWidget } from './ChatWidget';
export { ChatPanel } from './ChatPanel';
export { ChatMessage } from './ChatMessage';
export { ChatInput } from './ChatInput';
export { TypingIndicator } from './TypingIndicator';
```

### Task 7: Add Animations to animations.ts

**Update:** `v2/src/lib/animations.ts` (add popIn variant if missing)

```typescript
/**
 * Pop in from center (scale 0 → 1)
 * Used for floating buttons, badges
 */
export const popIn: Variants = {
  hidden: {
    opacity: 0,
    scale: 0,
  },
  visible: {
    opacity: 1,
    scale: 1,
    transition: springConfig,
  },
};
```

### Task 8: Add CSS Utilities

**Update:** `v2/src/app/globals.css` (add if missing)

```css
/* Typing cursor blink animation */
@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}

.animate-blink {
  animation: blink 1s infinite;
}
```

### Task 9: Write Component Tests

**File:** `v2/src/components/chat/__tests__/ChatMessage.test.tsx`

```tsx
import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import { ChatMessage } from '../ChatMessage';

describe('ChatMessage', () => {
  it('renders user message with correct styling', () => {
    render(<ChatMessage role="user" content="Hello!" />);

    const message = screen.getByText('Hello!');
    expect(message).toBeInTheDocument();

    // Check parent container has user styling
    const container = message.closest('div[class*="bg-primary"]');
    expect(container).toBeInTheDocument();
  });

  it('renders assistant message with correct styling', () => {
    render(<ChatMessage role="assistant" content="Hi there!" />);

    const message = screen.getByText('Hi there!');
    expect(message).toBeInTheDocument();

    // Check parent container has assistant styling
    const container = message.closest('div[class*="bg-card"]');
    expect(container).toBeInTheDocument();
  });

  it('shows timestamp when provided', () => {
    const timestamp = new Date('2024-01-15T14:30:00').getTime();
    render(<ChatMessage role="user" content="Test" timestamp={timestamp} />);

    // Should show time in h:mm a format
    expect(screen.getByText(/2:30 PM/i)).toBeInTheDocument();
  });

  it('shows streaming cursor when streaming', () => {
    render(<ChatMessage role="assistant" content="Typing" isStreaming />);

    // Should have animate-blink class element
    const cursor = document.querySelector('.animate-blink');
    expect(cursor).toBeInTheDocument();
  });
});
```

**File:** `v2/src/components/chat/__tests__/ChatInput.test.tsx`

```tsx
import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { ChatInput } from '../ChatInput';

describe('ChatInput', () => {
  it('renders input and send button', () => {
    render(
      <ChatInput
        value=""
        onChange={() => {}}
        onSend={() => {}}
      />
    );

    expect(screen.getByPlaceholderText('Type a message...')).toBeInTheDocument();
    expect(screen.getByRole('button', { name: /send/i })).toBeInTheDocument();
  });

  it('calls onChange when typing', async () => {
    const onChange = vi.fn();
    render(
      <ChatInput
        value=""
        onChange={onChange}
        onSend={() => {}}
      />
    );

    const input = screen.getByPlaceholderText('Type a message...');
    await userEvent.type(input, 'Hello');

    expect(onChange).toHaveBeenCalled();
  });

  it('calls onSend when clicking send button', async () => {
    const onSend = vi.fn();
    render(
      <ChatInput
        value="Hello"
        onChange={() => {}}
        onSend={onSend}
      />
    );

    await userEvent.click(screen.getByRole('button', { name: /send/i }));
    expect(onSend).toHaveBeenCalled();
  });

  it('calls onSend on Enter key', async () => {
    const onSend = vi.fn();
    render(
      <ChatInput
        value="Hello"
        onChange={() => {}}
        onSend={onSend}
      />
    );

    const input = screen.getByPlaceholderText('Type a message...');
    await userEvent.type(input, '{Enter}');

    expect(onSend).toHaveBeenCalled();
  });

  it('does not call onSend on Shift+Enter', async () => {
    const onSend = vi.fn();
    render(
      <ChatInput
        value="Hello"
        onChange={() => {}}
        onSend={onSend}
      />
    );

    const input = screen.getByPlaceholderText('Type a message...');
    await userEvent.type(input, '{Shift>}{Enter}{/Shift}');

    expect(onSend).not.toHaveBeenCalled();
  });

  it('disables input when disabled prop is true', () => {
    render(
      <ChatInput
        value=""
        onChange={() => {}}
        onSend={() => {}}
        disabled
      />
    );

    expect(screen.getByPlaceholderText('Type a message...')).toBeDisabled();
    expect(screen.getByRole('button', { name: /send/i })).toBeDisabled();
  });
});
```

## Verification

```bash
# 1. TypeScript compiles
pnpm build

# 2. Run component tests
pnpm test src/components/chat/__tests__

# 3. Visual check (with dev server running)
# - Import ChatWidget into authenticated layout
# - Verify bubble appears in bottom-right
# - Click to expand panel
# - Check styling matches design system
```

## Success Criteria

- [ ] ChatMessage renders user/assistant bubbles with correct styling
- [ ] ChatInput handles Enter/Shift+Enter correctly
- [ ] TypingIndicator shows animated dots
- [ ] ChatPanel combines all components with proper layout
- [ ] ChatWidget toggles between bubble and panel
- [ ] Animations use spring physics from `animations.ts`
- [ ] All component tests pass
- [ ] Styling matches neobrutalist design (hard shadows, borders)

## Output

```
v2/src/components/chat/
├── ChatWidget.tsx       # Floating container
├── ChatPanel.tsx        # Full chat interface
├── ChatMessage.tsx      # Message bubble
├── ChatInput.tsx        # Text input + send button
├── TypingIndicator.tsx  # Animated dots
├── index.ts             # Exports
└── __tests__/
    ├── ChatMessage.test.tsx
    └── ChatInput.test.tsx
```

## Notes

- Components are presentational only - no data fetching
- Data/state management handled in 26-04 (Integration)
- Z-index 40 ensures chat appears above content but below modals (z-50)
- Mobile responsive behavior to be added in 26-04

---

**Next Plan:** 26-04 (Integration & Polish)
