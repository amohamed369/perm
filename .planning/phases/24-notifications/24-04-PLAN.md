---
phase: 24-notifications
plan: 04
type: execute
---

<objective>
Build email integration with React Email templates and Resend sending actions.

Purpose: Send email notifications for deadlines, status changes, and alerts.
Output: Email templates and Convex actions for sending notification emails.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-notifications/24-CONTEXT.md
@.planning/phases/24-notifications/24-RESEARCH.md

**Depends on:** 24-01-PLAN.md (data layer with helpers)

**Existing Resend patterns:**
@v2/convex/ResendOTP.ts - Email sending pattern
@v2/convex/ResendPasswordReset.ts - Template pattern

**From RESEARCH.md:**
- Use Resend SDK directly (already installed v6.6.0)
- React Email for templates (@react-email/components)
- API key: AUTH_RESEND_KEY environment variable
- Sender: notifications@permtracker.app

**Email types needed:**
- DeadlineReminder - Upcoming deadline alerts
- StatusChange - Case status updates
- RfiAlert - RFI response deadline
- RfeAlert - RFE response deadline
- DailyDigest - Summary of upcoming deadlines (optional for Phase 25)
</context>

<orchestration>
## CRITICAL: Execution & Subagent Directive

**THIS SECTION MUST PERSIST THROUGH ALL COMPACTIONS. ALL AGENTS AND SUBAGENTS MUST FOLLOW THIS.**

### Mandatory Reading (BEFORE any implementation)
All agents/subagents MUST read and understand these files:
- `.planning/phases/24-notifications/24-CONTEXT.md` - Phase vision, specifics, boundaries
- `.planning/phases/24-notifications/24-RESEARCH.md` - Tech stack, patterns, pitfalls
- `.planning/PROJECT.md` - Overall project context
- `.planning/ROADMAP.md` - Where this phase fits
- `/Users/adammohamed/cc/perm-tracker-test/perm_flow.md` - PERM workflow (SOURCE OF TRUTH)
- `.planning/phases/17-design-system/design*.md` (design-1 through design-5) - UI/design docs for any frontend work
- `.planning/FRONTEND_DESIGN_SKILL.md` - Frontend design patterns

### Execution Pattern (Orchestrator Role)
The executing agent acts as an **orchestrator**:
1. **Explore First**: Spawn Explore subagent(s) to fully understand current implementation and what's needed
2. **Review Findings**: Look over findings yourself if small, delegate if large
3. **Implement**: Spawn Task subagent(s) to implement with explicit instructions
4. **Verify & Review**: Verify implementation, run tests, review quality
5. **Follow Up**: Fix issues, iterate as needed
6. **Repeat**: Until all tasks complete

### Code Quality Standards
For each issue, fully explore to understand:
- Current implementation state
- What's needed to achieve the goal
- **NO clashing, duplicate, or non-seamless implementations**

Implementation rules:
- **Work within existing code** as much as possible
- **Keep it minimal and simple** - DRY and KISS
- **Use what's already built** - leverage existing code, built-ins, standards
- **Create new only when needed** - don't reinvent
- **Refactor as you go** - fix issues, make it easier for future
- **Ensure fixes are global** - don't repeat fixes in multiple places
- **Keep it clean** - organized, minimal, abstractable, scalable, maintainable, readable
- **Ensure all v1 features exist** - no feature regression
- **Follow perm_flow.md** - the source of truth for PERM logic

### JSON Tracking File
Create and maintain: `.planning/phases/24-notifications/tracking.json`
```json
{
  "phase": "24-notifications",
  "plan": "04",
  "lastUpdated": "ISO-timestamp",
  "issues": [
    {
      "id": "04-T1",
      "task": "Install React Email and create templates directory",
      "status": "pending|in_progress|complete|blocked",
      "notes": "",
      "blockers": []
    }
  ]
}
```
Update this file throughout execution.

### Subagent Instructions Template
**ALL Task/Explore subagents MUST receive this in their prompt:**

```
CRITICAL INSTRUCTIONS FOR THIS SUBAGENT:

1. READ THESE DOCS FIRST (mandatory):
   - .planning/phases/24-notifications/24-CONTEXT.md
   - .planning/phases/24-notifications/24-RESEARCH.md
   - /Users/adammohamed/cc/perm-tracker-test/perm_flow.md
   - [For UI work: .planning/phases/17-design-system/design*.md (design-1 through design-5)]

2. EXPLORE THOROUGHLY before implementing:
   - Understand the entire v2/ directory structure
   - Understand the .planning/ directory structure
   - Find all related existing implementations
   - Identify patterns already in use

3. IMPLEMENTATION STANDARDS:
   - NO clashing or duplicate implementations
   - Work within existing code when possible
   - Keep minimal, simple, DRY, KISS
   - Use existing patterns and abstractions
   - Ensure seamless integration
   - Refactor as needed to maintain quality
   - Ensure fixes are global, not repeated

4. QUALITY CHECKLIST:
   - Clean, organized code
   - Abstractable and scalable
   - Maintainable and readable
   - All v1 features preserved
   - Follows perm_flow.md

5. CLEANUP: Remove any temporary files, unused code, or debug artifacts
```

### Cleanup Protocol
After each task completion:
- Remove temporary files
- Delete unused code
- Clean up debug artifacts
- Verify no leftover test data
- Update tracking.json

### Verification
Before marking any task complete:
- All tests pass
- No TypeScript errors
- No console errors
- Feature works as specified
- No regression in existing features

### CRITICAL: Commit Workflow (AFTER PLAN COMPLETE)
**This workflow is MANDATORY after completing ALL tasks in this plan:**

1. **STAGE** - Stage all changes: `git add -A`
2. **CODE REVIEW** - Run code reviewer agent:
   ```
   Task(subagent_type="pr-review-toolkit:code-reviewer", prompt="Review staged changes for quality, bugs, and adherence to project standards")
   ```
3. **FIX** - Address ALL issues found by code reviewer
4. **RE-REVIEW** - If significant fixes made, run code reviewer again
5. **COMMIT** - Create commit with conventional commit message:
   ```
   git commit -m "feat(notifications): <plan description>"
   ```

**DO NOT skip this workflow. The plan is NOT complete until code review passes and changes are committed.**
</orchestration>

<tasks>

<task type="auto">
  <name>Task 1: Install React Email and create templates directory</name>
  <files>v2/package.json, v2/src/emails/</files>
  <action>
Install React Email components:
```bash
cd v2 && npm install @react-email/components
```

Create email templates directory structure:
```
v2/src/emails/
├── components/
│   ├── EmailLayout.tsx      # Shared layout wrapper
│   ├── EmailButton.tsx      # CTA button component
│   └── EmailHeader.tsx      # Header with logo
├── DeadlineReminder.tsx
├── StatusChange.tsx
├── RfiAlert.tsx
├── RfeAlert.tsx
└── index.ts                 # Barrel export
```

**EmailLayout component:**
- Consistent branding (PERM Tracker)
- Footer with unsubscribe/settings link
- Responsive container (max-width 600px)
- Neobrutalist-inspired styling where appropriate
  </action>
  <verify>npm install succeeds, directory structure created</verify>
  <done>React Email installed, email directory structure ready</done>
</task>

<task type="auto">
  <name>Task 2: Create DeadlineReminder email template</name>
  <files>v2/src/emails/DeadlineReminder.tsx</files>
  <action>
Create deadline reminder email template:

```tsx
import {
  Html,
  Head,
  Body,
  Container,
  Heading,
  Text,
  Button,
  Hr,
  Section,
} from "@react-email/components";

interface DeadlineReminderProps {
  employerName: string;
  beneficiaryName: string;
  deadlineType: string;        // Human-readable: "PWD Expiration"
  deadlineDate: string;        // Formatted: "January 15, 2025"
  daysUntil: number;
  caseUrl: string;
  settingsUrl: string;
}

export function DeadlineReminder(props: DeadlineReminderProps) {
  // Urgency colors based on daysUntil
  const urgencyColor = props.daysUntil <= 0 ? "#DC2626"   // Overdue - red
                     : props.daysUntil <= 7 ? "#DC2626"   // Urgent - red
                     : props.daysUntil <= 14 ? "#F97316"  // High - orange
                     : "#2563EB";                         // Normal - blue

  const urgencyText = props.daysUntil <= 0 ? "OVERDUE"
                    : props.daysUntil === 1 ? "Tomorrow"
                    : `${props.daysUntil} days`;

  return (
    <Html>
      <Head />
      <Body style={styles.body}>
        <Container style={styles.container}>
          {/* Header */}
          <Section style={styles.header}>
            <Text style={styles.logo}>PERM Tracker</Text>
          </Section>

          {/* Urgency banner */}
          <Section style={{ ...styles.urgencyBanner, backgroundColor: urgencyColor }}>
            <Text style={styles.urgencyText}>
              {urgencyText} - {props.deadlineType}
            </Text>
          </Section>

          {/* Content */}
          <Section style={styles.content}>
            <Heading style={styles.heading}>
              Deadline Reminder
            </Heading>

            <Text style={styles.caseInfo}>
              <strong>{props.employerName}</strong> - {props.beneficiaryName}
            </Text>

            <Text style={styles.deadlineInfo}>
              <strong>{props.deadlineType}</strong> is due on{" "}
              <strong>{props.deadlineDate}</strong>.
            </Text>

            <Button href={props.caseUrl} style={styles.button}>
              View Case Details
            </Button>
          </Section>

          <Hr style={styles.hr} />

          {/* Footer */}
          <Section style={styles.footer}>
            <Text style={styles.footerText}>
              <a href={props.settingsUrl} style={styles.link}>
                Manage notification preferences
              </a>
            </Text>
          </Section>
        </Container>
      </Body>
    </Html>
  );
}

const styles = {
  body: { backgroundColor: "#f4f4f4", fontFamily: "system-ui, sans-serif" },
  container: { maxWidth: "600px", margin: "0 auto", backgroundColor: "#fff" },
  // ... complete styles
};
```

Include complete inline styles for email client compatibility.
  </action>
  <verify>Template exports correctly, renders valid HTML</verify>
  <done>DeadlineReminder template with urgency colors</done>
</task>

<task type="auto">
  <name>Task 3: Create StatusChange and RFI/RFE email templates</name>
  <files>v2/src/emails/StatusChange.tsx, v2/src/emails/RfiAlert.tsx, v2/src/emails/RfeAlert.tsx</files>
  <action>
Create remaining email templates:

**StatusChange.tsx:**
```tsx
interface StatusChangeProps {
  employerName: string;
  beneficiaryName: string;
  previousStatus: string;
  newStatus: string;
  changedAt: string;
  caseUrl: string;
  settingsUrl: string;
}

// Show status progression: "PWD → Recruitment"
// Include congratulatory message for positive changes
// Warning styling for concerning changes (e.g., auto-closure)
```

**RfiAlert.tsx:**
```tsx
interface RfiAlertProps {
  employerName: string;
  beneficiaryName: string;
  rfiReceivedDate: string;
  rfiDueDate: string;
  daysUntil: number;
  caseUrl: string;
  settingsUrl: string;
}

// Always urgent styling (RFIs are time-sensitive)
// Clear due date callout
// Link to case for response tracking
```

**RfeAlert.tsx:**
```tsx
interface RfeAlertProps {
  employerName: string;
  beneficiaryName: string;
  rfeReceivedDate: string;
  rfeDueDate: string;
  daysUntil: number;
  caseUrl: string;
  settingsUrl: string;
}

// Similar to RFI but for RFE
// May have different urgency (RFEs often have longer windows)
```

All templates should:
- Use shared EmailLayout for consistency
- Include case identification (employer + beneficiary)
- Have clear CTA button
- Include settings link in footer
  </action>
  <verify>All templates export correctly, valid HTML output</verify>
  <done>StatusChange, RfiAlert, RfeAlert templates created</done>
</task>

<task type="auto">
  <name>Task 4: Create email sending Convex actions</name>
  <files>v2/convex/notificationActions.ts</files>
  <exploration>
    Check existing ResendOTP.ts for Resend SDK usage pattern.
    Review how to render React Email templates to HTML.
  </exploration>
  <action>
Create Convex actions for sending emails:

```typescript
// v2/convex/notificationActions.ts
import { internalAction } from "./_generated/server";
import { v } from "convex/values";
import { Resend } from "resend";
import { render } from "@react-email/render";
import { DeadlineReminder } from "../src/emails/DeadlineReminder";
import { StatusChange } from "../src/emails/StatusChange";
import { RfiAlert } from "../src/emails/RfiAlert";
import { RfeAlert } from "../src/emails/RfeAlert";
import { internal } from "./_generated/api";

const resend = new Resend(process.env.AUTH_RESEND_KEY);

export const sendDeadlineReminderEmail = internalAction({
  args: {
    to: v.string(),
    employerName: v.string(),
    beneficiaryName: v.string(),
    deadlineType: v.string(),
    deadlineDate: v.string(),
    daysUntil: v.number(),
    caseId: v.string(),
    notificationId: v.id("notifications"),
  },
  handler: async (ctx, args) => {
    const caseUrl = `${process.env.NEXT_PUBLIC_APP_URL}/cases/${args.caseId}`;
    const settingsUrl = `${process.env.NEXT_PUBLIC_APP_URL}/settings/notifications`;

    const html = await render(
      DeadlineReminder({
        employerName: args.employerName,
        beneficiaryName: args.beneficiaryName,
        deadlineType: args.deadlineType,
        deadlineDate: args.deadlineDate,
        daysUntil: args.daysUntil,
        caseUrl,
        settingsUrl,
      })
    );

    const subject = args.daysUntil <= 0
      ? `OVERDUE: ${args.deadlineType} for ${args.employerName}`
      : args.daysUntil <= 7
      ? `Urgent: ${args.deadlineType} in ${args.daysUntil} days`
      : `Reminder: ${args.deadlineType} in ${args.daysUntil} days`;

    const { error } = await resend.emails.send({
      from: "PERM Tracker <notifications@permtracker.app>",
      to: [args.to],
      subject,
      html,
    });

    if (error) {
      console.error("Failed to send deadline reminder email:", error);
      throw new Error(`Email failed: ${error.message}`);
    }

    // Mark notification as emailed
    await ctx.runMutation(internal.notifications.markEmailSent, {
      notificationId: args.notificationId,
    });
  },
});

// Similar actions for:
// - sendStatusChangeEmail
// - sendRfiAlertEmail
// - sendRfeAlertEmail
```

Also add `markEmailSent` internal mutation:
```typescript
export const markEmailSent = internalMutation({
  args: { notificationId: v.id("notifications") },
  handler: async (ctx, { notificationId }) => {
    await ctx.db.patch(notificationId, {
      emailSent: true,
      emailSentAt: Date.now(),
    });
  },
});
```
  </action>
  <verify>Actions deploy without errors, can be called from other functions</verify>
  <done>Email sending actions for all notification types</done>
</task>

<task type="auto">
  <name>Task 5: Create notification triggers on case updates</name>
  <files>v2/convex/cases.ts</files>
  <exploration>
    Find existing case update mutations in v2/convex/cases.ts.
    Understand how to trigger notifications after case changes.
  </exploration>
  <action>
Add notification triggers to case mutations:

**On status change:**
```typescript
// In updateCase mutation, after updating status:
if (args.status && args.status !== existingCase.status) {
  // Create status_change notification
  const notificationId = await ctx.db.insert("notifications", {
    userId: existingCase.userId,
    caseId: existingCase._id,
    type: "status_change",
    title: generateNotificationTitle("status_change", {
      previousStatus: existingCase.status,
      newStatus: args.status,
    }),
    message: generateNotificationMessage("status_change", {
      employerName: existingCase.employer_name,
      beneficiaryName: existingCase.beneficiary_last_name,
      previousStatus: existingCase.status,
      newStatus: args.status,
    }),
    priority: "normal",
    isRead: false,
    emailSent: false,
    createdAt: Date.now(),
    updatedAt: Date.now(),
  });

  // Schedule email if enabled
  const userProfile = await ctx.db.get(existingCase.userId);
  if (userProfile?.emailStatusUpdates) {
    await ctx.scheduler.runAfter(0, internal.notificationActions.sendStatusChangeEmail, {
      to: userProfile.email,
      // ... other args
      notificationId,
    });
  }
}
```

**On RFI/RFE creation:**
- In createRfiRfe mutation or wherever RFI/RFE entries are added
- Create rfi_alert or rfe_alert notification
- Schedule email if enabled

**On case deletion:**
- Call cleanupCaseNotifications to remove related notifications
- Remove any scheduled emails for this case

Use `ctx.scheduler.runAfter(0, ...)` to send emails non-blocking.
  </action>
  <verify>Status changes create notifications, emails are scheduled</verify>
  <done>Notification triggers integrated with case mutations</done>
</task>

<task type="auto">
  <name>Task 6: Write email tests</name>
  <files>v2/src/emails/__tests__/templates.test.tsx, v2/convex/notificationActions.test.ts</files>
  <action>
Create tests for email functionality:

**Template tests (v2/src/emails/__tests__/templates.test.tsx):**
- DeadlineReminder renders without errors
- DeadlineReminder shows correct urgency color for different daysUntil
- DeadlineReminder includes all required information
- StatusChange shows status progression
- RfiAlert includes due date prominently
- RfeAlert renders correctly
- All templates include settings link

**Action tests (v2/convex/notificationActions.test.ts):**
- sendDeadlineReminderEmail constructs correct subject for overdue
- sendDeadlineReminderEmail constructs correct subject for urgent
- sendDeadlineReminderEmail marks notification as emailed on success
- sendDeadlineReminderEmail throws on Resend error
- sendStatusChangeEmail includes both statuses
- Email actions respect user preferences (mock userProfile)

Use snapshot testing for template HTML if desired.
  </action>
  <verify>npm test passes for email tests</verify>
  <done>Email templates and actions tested</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] @react-email/components installed
- [ ] 4 email templates created (DeadlineReminder, StatusChange, RfiAlert, RfeAlert)
- [ ] Email sending actions deployed
- [ ] Case mutations trigger notifications and emails
- [ ] markEmailSent tracks sent status
- [ ] Tests pass
- [ ] No TypeScript errors
</verification>

<success_criteria>
- Email templates render correctly
- Emails sent via Resend on notification creation
- User preferences respected (only send if enabled)
- Email sent status tracked in database
- Tests verify email functionality
</success_criteria>

<output>
After completion, create `.planning/phases/24-notifications/24-04-SUMMARY.md`:

# Phase 24 Plan 04: Email Integration Summary

**[One-liner describing what shipped]**

## Accomplishments
- React Email templates for 4 notification types
- Resend integration for sending emails
- Case mutation triggers for notifications
- Email tracking (sent status)

## Files Created/Modified
- `v2/src/emails/DeadlineReminder.tsx`
- `v2/src/emails/StatusChange.tsx`
- `v2/src/emails/RfiAlert.tsx`
- `v2/src/emails/RfeAlert.tsx`
- `v2/src/emails/components/EmailLayout.tsx`
- `v2/convex/notificationActions.ts`
- `v2/convex/cases.ts` (trigger integration)
- `v2/convex/notifications.ts` (markEmailSent)

## Decisions Made
[Any decisions during implementation]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 24-05-PLAN.md (Scheduled Functions + Push)
</output>
