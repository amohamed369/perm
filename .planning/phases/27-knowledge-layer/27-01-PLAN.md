---
phase: 27-knowledge-layer
plan: 01
type: execute
domain: rag-embeddings
---

<objective>
Set up Convex RAG component with Gemini embeddings and ingest PERM knowledge.

Purpose: Establish the vector search infrastructure that enables semantic retrieval of PERM regulations and app documentation. This is the foundation for knowledge-aware chatbot responses.

Output:
- Convex RAG component configured with Gemini embeddings
- PERM knowledge sections chunked and embedded (~15 sections)
- Semantic search function for knowledge retrieval
- Tests for RAG search functionality
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-knowledge-layer/27-RESEARCH.md
@.planning/phases/27-knowledge-layer/27-CONTEXT.md
@perm_flow.md

**Prior decisions affecting this phase:**
- Phase 26: Chat API route with probe-before-stream fallback pattern established
- Phase 26: Message schema includes citations metadata ready for use
- All free-tier only (Gemini embeddings 1500 RPD)

**Codebase constraints:**
- Convex cloud deployment (no local-only mode)
- TypeScript strict mode
- TDD approach

**From 27-RESEARCH.md + Best Practices Research:**
- Use @convex-dev/rag component (handles chunking, versioning, similarity search)
- Use Gemini `gemini-embedding-001` (768 dimensions - best quality/storage balance)
- NOTE: `text-embedding-004` deprecated Aug 2025 - use `gemini-embedding-001`
- Chunk PERM knowledge: 400-512 tokens with 10-20% overlap
- Include metadata: source, section, CFR reference for citations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Convex RAG component</name>
  <files>v2/convex/convex.config.ts, v2/convex/lib/rag/index.ts, v2/package.json</files>
  <exploration>
    Use researcher agent to verify: Latest @convex-dev/rag installation and configuration patterns.
    Check v2/convex/convex.config.ts if it exists for current component setup.
  </exploration>
  <action>
    1. Install RAG component: `npx convex component add @convex-dev/rag`
    2. Install AI SDK Google provider: `pnpm add @ai-sdk/google`
    3. Create convex/lib/rag/index.ts with RAG initialization:
       ```typescript
       import { components } from "../../_generated/api";
       import { RAG } from "@convex-dev/rag";
       import { google } from "@ai-sdk/google";

       export const rag = new RAG(components.rag, {
         textEmbeddingModel: google.embedding("gemini-embedding-001"),
         embeddingDimension: 768,  // Best quality/storage balance (0.26% loss vs 3072)
       });
       ```
    4. Update convex.config.ts to use the RAG component:
       ```typescript
       import { defineApp } from "convex/server";
       import rag from "@convex-dev/rag/convex.config.js";

       const app = defineApp();
       app.use(rag);
       export default app;
       ```
    5. Run `npx convex codegen` to generate types
    6. Add GOOGLE_GENERATIVE_AI_API_KEY to .env.example (for Gemini embeddings)

    AVOID: Don't use `text-embedding-004` (deprecated Aug 2025). Use `gemini-embedding-001`.
  </action>
  <verify>
    - `pnpm convex dev` starts without errors
    - RAG component appears in Convex dashboard
    - No TypeScript errors in convex/lib/rag/index.ts
  </verify>
  <done>RAG component installed and configured with Gemini embeddings</done>
</task>

<task type="auto">
  <name>Task 2: Create PERM knowledge sections and ingestion action</name>
  <files>v2/convex/lib/rag/permKnowledge.ts, v2/convex/lib/rag/ingest.ts</files>
  <exploration>
    Read perm_flow.md to identify logical sections for chunking.
    Each section should be 400-512 tokens with 10-20% overlap for context preservation.
  </exploration>
  <action>
    1. Create convex/lib/rag/permKnowledge.ts with structured PERM sections:
       - PWD Stage (filing, determination, expiration calculation)
       - Recruitment Requirements (Sunday ads, job order, notice of filing)
       - Recruitment Deadlines (143/150 day rules, PWD expiration constraints)
       - Professional Occupation (3 additional methods requirement)
       - ETA 9089 (30-day wait, 180-day window, filing requirements)
       - I-140 (filing window, approval)
       - RFI/RFE Rules (30-day strict for RFI, editable for RFE)
       - Case Status Types (5 statuses: PWD, Recruitment, ETA 9089, I-140, Closed)
       - Progress Status Types (6 statuses: Working on it, Waiting, Filed, Approved, Under review, RFI/RFE)
       - Edge Cases (PWD expiration consequences, missed deadlines)
       - Date Validation Rules (comprehensive validation logic)
       - App Features (deadlines widget, calendar sync, notifications)

    2. Each section includes metadata:
       - source: "perm_flow.md" or "app_docs"
       - section: slug identifier
       - cfr: regulation reference if applicable (e.g., "20 CFR 656.17")

    3. Create convex/lib/rag/ingest.ts with internalAction:
       - ingestPERMKnowledge() - Ingests all PERM sections
       - Uses rag.add() with namespace "perm_knowledge"
       - Logs progress for debugging

    4. Export a function to check if ingestion is needed (empty namespace check)

    AVOID: Don't embed user case data - only static knowledge. Keep sections 400-512 tokens with overlap.
  </action>
  <verify>
    - TypeScript compiles without errors
    - At least 12 sections defined with proper metadata
    - Each section has title, content, and metadata fields
  </verify>
  <done>PERM knowledge sections structured and ingestion action ready</done>
</task>

<task type="auto">
  <name>Task 3: Create knowledge search function with tests</name>
  <files>v2/convex/knowledge.ts, v2/convex/__tests__/knowledge.test.ts</files>
  <action>
    1. Create convex/knowledge.ts with:
       - searchKnowledge action: Takes query string, returns relevant context + sources
         - Uses rag.search() with namespace "perm_knowledge"
         - limit: 5 results
         - chunkContext: { before: 1, after: 1 } for context
         - vectorScoreThreshold: 0.5 to filter low-relevance results
         - Returns { context: string, sources: Array<{title, source, cfr?}> }

       - triggerIngestion internalAction: One-time setup to run ingestion
         - Checks if namespace is empty first
         - Calls ingestPERMKnowledge if needed

       - getIngestionStatus query: Check if knowledge is ingested

    2. Create convex/__tests__/knowledge.test.ts with tests:
       - Test searchKnowledge returns results for PERM-related queries
       - Test empty query returns empty results
       - Test sources include metadata (source, section)
       - Test getIngestionStatus returns correct state

    3. Add exports to convex index if needed

    AVOID: Don't expose ingestion externally - use internal action only.
  </action>
  <verify>
    - `pnpm test convex/__tests__/knowledge.test.ts` passes
    - searchKnowledge compiles with correct return type
    - API appears in Convex dashboard
  </verify>
  <done>Knowledge search function working with tests passing</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pnpm convex dev` runs without errors
- [ ] RAG component visible in Convex dashboard
- [ ] PERM knowledge sections defined (12+ sections)
- [ ] searchKnowledge action returns results
- [ ] All tests pass: `pnpm test convex/__tests__/knowledge.test.ts`
- [ ] No TypeScript errors
</verification>

<success_criteria>
- RAG component installed and configured with Gemini embeddings
- PERM knowledge chunked into 12+ sections with proper metadata
- Semantic search returns relevant results for PERM queries
- All tests passing
- Ready for ingestion trigger (will run on first use or manually)
</success_criteria>

<output>
After completion, create `.planning/phases/27-knowledge-layer/27-01-SUMMARY.md`:

# Phase 27 Plan 01: RAG Infrastructure Summary

**[One-liner describing what shipped]**

## Accomplishments
- Convex RAG component configured
- Gemini embeddings integrated
- PERM knowledge sections defined
- Semantic search function implemented

## Files Created/Modified
- `v2/convex/convex.config.ts` - RAG component configuration
- `v2/convex/lib/rag/index.ts` - RAG initialization
- `v2/convex/lib/rag/permKnowledge.ts` - PERM knowledge sections
- `v2/convex/lib/rag/ingest.ts` - Ingestion action
- `v2/convex/knowledge.ts` - Search functions
- `v2/convex/__tests__/knowledge.test.ts` - Tests

## Decisions Made
[Any decisions made during implementation]

## Issues Encountered
[Problems and resolutions, or "None"]

## Next Step
Ready for 27-02-PLAN.md (Web Search with Multi-Provider Fallback)
</output>
